# Story 2.1: Prescription Upload Interface

## Status
Done

## Story
**As a** Patient/Caregiver,  
**I want** a simple interface to upload a prescription by photo, file, or drag-and-drop,  
**so that** I can easily submit it.

## Acceptance Criteria
1. UI has options for camera, file browse
2. Web UI supports drag-and-drop  
3. User can preview image before upload

## Tasks / Subtasks
- [x] Create prescription upload component with file input options (AC: 1, 2)
  - [x] Implement file browse button for local file selection
  - [x] Add camera capture functionality for mobile devices
  - [x] Implement drag-and-drop zone for web interface
  - [x] Add file type validation (images only: jpg, png, pdf)
  - [x] Add file size validation and error handling
- [x] Implement image preview functionality (AC: 3)
  - [x] Display selected/captured image in preview area
  - [x] Add option to retake/reselect image before upload
  - [x] Show file name and size information
  - [x] Provide clear option to proceed or cancel
- [x] Integrate with backend API for file upload (AC: 1, 2, 3)
  - [x] Connect to /orders POST endpoint for prescription submission
  - [x] Upload files to Google Cloud Storage securely
  - [x] Handle upload progress indicators and error states
  - [x] Create PrescriptionOrder record in Firestore
- [x] Add comprehensive testing for upload functionality
  - [x] Unit tests for upload component validation logic
  - [x] Integration tests for file upload flow
  - [x] E2E tests for complete prescription submission process
  - [x] Test camera functionality on mobile devices

## Dev Notes

### Previous Story Insights
Epic 1 completed the foundational authentication system:
- Firebase Authentication fully integrated across all user roles
- Role-based access control through ProtectedRoute component working
- User model supports flexible authentication (email/phone)
- Zustand store manages authentication state with proper token handling
- All portals (Patient, Caregiver, Doctor, Pharmacist) have authentication gates

**Key Context:** The authentication foundation is solid, so prescription upload will be accessed through authenticated Patient/Caregiver portals. Users are already logged in and their identity is available through the auth store.

### Data Models
Current data structures relevant to prescription upload:
```typescript
interface PrescriptionOrder {
  orderId: string;
  patientProfileId: string;
  status: 'pending_verification' | 'awaiting_payment' | 'preparing' | 'out_for_delivery' | 'delivered' | 'rejected';
  originalImageUrl: string;
  medicationDetails: {
    name: string;
    dosage: string;
    quantity: number;
  };
  cost: number;
  createdAt: Date;
}
```

```typescript
interface User {
  uid: string;
  role: 'patient' | 'caregiver' | 'doctor' | 'pharmacist';
  email?: string;
  phoneNumber?: string;
  displayName: string;
  createdAt: Date;
}
```
[Source: architecture/data-models.md#prescriptionorder-model]

### API Specifications
Relevant endpoints for prescription upload functionality:
- `/orders` POST - Create a new prescription order (main endpoint for upload)
- Authentication via Firebase ID tokens (already implemented)
- File uploads handled through Google Cloud Storage integration

**Implementation Notes:** The upload component will need to:
1. Accept file uploads and send to Google Cloud Storage
2. Create PrescriptionOrder record via /orders POST endpoint  
3. Set initial status to 'pending_verification'
4. Associate with current user's patientProfileId
[Source: architecture/api-spec.md]

### Technology Stack Context
Current frontend technology stack:
- **Frontend Framework:** React ~18.3 with Vite for fast, modern UI
- **Language:** TypeScript ~5.4 for type safety and maintainability
- **Styling:** Tailwind CSS ~3.4 for rapid, custom UI development
- **State Management:** Zustand ~4.5 for simple global UI state
- **Server State:** TanStack Query ~5.35 for server state and data fetching
- **File Storage:** Google Cloud Storage for prescription images

**Integration Points:** Upload component should use TanStack Query for API calls and integrate with existing Zustand auth store for user context.
[Source: architecture/tech-stack.md]

### Architecture Context
System architecture relevant to file uploads:
- **Platform:** Google Cloud Platform with serverless functions
- **File Storage:** Google Cloud Storage for securely storing prescription images
- **Database:** Firestore for PrescriptionOrder metadata storage
- **Authentication:** Firebase Auth (already implemented and working)

**File Upload Flow:** 
1. User selects/captures image in React component
2. File uploaded to Google Cloud Storage bucket
3. Storage URL saved in PrescriptionOrder.originalImageUrl
4. Order metadata saved to Firestore via /orders API
[Source: architecture/overview.md]

### File Locations
Based on project structure, new upload components should be located:
- **Main Upload Component:** `apps/web/src/components/PrescriptionUpload.tsx`
- **Upload Feature Directory:** `apps/web/src/features/prescriptions/` (create if needed)
- **Shared Types:** Extend existing types in `packages/shared-types/index.ts`
- **Integration Point:** Import into Patient and Caregiver portals in `apps/web/src/components/portals/`

**Existing Patterns:** Follow established component patterns seen in LoginForm and RegisterForm components.
[Source: architecture/project-structure.md]

### Technical Constraints
Established technical requirements:
- TypeScript ~5.4 for type safety (all components must be typed)
- React ~18.3 with functional components and hooks
- Tailwind CSS ~3.4 for styling (maintain consistency with existing portal designs)
- Firebase Auth integration (user context available through existing auth store)
- Responsive design patterns (must work on mobile and desktop)

**File Handling:** Use modern File API with proper validation for file types (jpg, png, pdf) and size limits.
[Source: architecture/tech-stack.md]

### Project Structure Notes
Upload functionality aligns with established monorepo structure:
- Component files in `apps/web/src/components/`
- Feature-specific logic in `apps/web/src/features/prescriptions/`
- Shared types in `packages/shared-types/`
- Integration with existing portal routing structure

No structural conflicts identified. Upload component should integrate seamlessly with existing Patient and Caregiver portals.

### Testing
**Test Standards:** Following established patterns from previous stories:
- **Test file location:** Co-located with implementation files (`.test.tsx` suffix)
- **Testing frameworks:** Vitest for unit/integration tests, Playwright for E2E tests
- **Test standards:** Unit tests for all upload components, integration tests for file upload flow
- **Specific requirements:** 
  - File validation testing (type, size, format)
  - Upload progress and error handling tests
  - Mobile camera functionality testing
  - Drag-and-drop interaction testing
  - Integration with authentication system testing

**Architecture Note:** Follow testing patterns established in previous Epic 1 stories for consistency.
[Source: Previous story patterns from Epic 1]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| Initial | 1.0 | Story created in draft status | Bob (SM) |

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet (Dev Agent - James)

### Debug Log References
- Created PrescriptionUpload component with comprehensive file handling
- Integrated real-time upload progress and cancellation functionality
- Added comprehensive validation for file types and sizes
- Successfully implemented drag-and-drop with visual feedback
- Created robust error handling for network failures and API errors
- 2025-01-15: Dev Agent verified complete implementation - all tasks validated
- 2025-01-15: Confirmed file browse, camera capture, drag-and-drop functionality implemented
- 2025-01-15: Verified image preview with file info display and clear/cancel options
- 2025-01-15: Validated backend integration with Google Cloud Storage and progress tracking
- 2025-01-15: Confirmed comprehensive test coverage including unit, integration tests
- 2025-01-15: Verified portal integration in both PatientPortal and CaregiverPortal via PrescriptionFlow
- 2025-01-15: All acceptance criteria met, implementation working correctly, lint checks pass

### Completion Notes List
- ✅ All acceptance criteria met for prescription upload interface
- ✅ File browse, camera capture, and drag-and-drop all functional
- ✅ Image preview with file information display implemented
- ✅ Backend integration with Google Cloud Storage upload workflow
- ✅ Comprehensive testing suite including unit, integration, and E2E tests
- ✅ Mobile-responsive design with camera capture support
- ✅ Upload progress indicators and cancellation functionality
- ✅ Seamless integration into both Patient and Caregiver portals

### File List
- `packages/shared-types/src/index.ts` - Added PrescriptionOrder types and file validation functions
- `apps/web/src/components/PrescriptionUpload.tsx` - Main upload component with full functionality
- `apps/web/src/components/PrescriptionUpload.test.tsx` - Comprehensive unit tests
- `apps/web/src/services/prescriptionService.ts` - Backend API integration service
- `apps/web/src/services/prescriptionService.test.ts` - Service integration tests
- `apps/web/src/components/portals/PatientPortal.tsx` - Added upload modal integration
- `apps/web/src/components/portals/CaregiverPortal.tsx` - Added upload modal integration
- `e2e/prescription-upload.spec.ts` - End-to-end test suite for complete prescription flow

## QA Results
[To be completed by QA Agent] 