# Story 3.2: Real-Time Delivery Tracking

## Status
Done

## Story
**As a** Patient/Caregiver,
**I want** to track my delivery's location on a map,
**so that** I know when it will arrive.

## Acceptance Criteria
1. Map view with delivery person's location and an ETA is available for orders "Out for Delivery"
2. User receives notifications on approach/arrival

## Tasks / Subtasks
- [x] Task 1: Add mapping library and geolocation tracking infrastructure (AC: 1)
  - [x] Research and add appropriate mapping library (Google Maps, Leaflet, or Mapbox)
  - [x] Create delivery location data model and API endpoints for location updates
  - [x] Set up geolocation permissions and browser API integration
  - [x] Create base map component with location tracking capabilities
- [x] Task 2: Implement DeliveryTracking component with real-time location updates (AC: 1)
  - [x] Create DeliveryTracking component with map display
  - [x] Implement real-time location polling using TanStack Query patterns
  - [x] Add delivery person location marker and ETA calculation
  - [x] Add route visualization and estimated arrival time display
- [x] Task 3: Integrate delivery tracking with existing order status system (AC: 1)
  - [x] Extend existing order status hooks to include delivery tracking data
  - [x] Add delivery tracking link/button to order status displays
  - [x] Update OrderStatusDisplay component to show tracking option for "Out for Delivery" orders
  - [x] Connect delivery tracking to existing real-time polling mechanisms
- [x] Task 4: Implement approach/arrival notification system (AC: 2)
  - [x] Create useDeliveryNotifications hook for proximity alerts
  - [x] Implement notification triggers for delivery approach (within 10 minutes)
  - [x] Add arrival notification when delivery person reaches destination
  - [x] Integrate with existing notification patterns and status change callbacks
- [x] Task 5: Add comprehensive testing
  - [x] Unit tests for DeliveryTracking component with map mocking
  - [x] Integration tests for delivery location API endpoints
  - [x] E2E tests for complete delivery tracking user flow
  - [x] Test notification system for approach/arrival alerts

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (Dev Agent - James)

### Debug Log References
- Google Maps integration with React components
- TanStack Query real-time polling implementation
- Browser notification API integration
- TypeScript type definitions for delivery tracking

### Completion Notes
- ✅ Successfully implemented Google Maps-only delivery tracking solution
- ✅ Created comprehensive real-time tracking with 15-second polling intervals
- ✅ Integrated seamlessly with existing OrderStatusDisplay component
- ✅ Implemented browser notifications for approach/arrival alerts
- ✅ Added comprehensive testing suite (unit, integration, E2E)
- ✅ Followed established TanStack Query patterns for consistency
- ✅ Maintained type safety with shared TypeScript interfaces

### File List
**New Files Created:**
- `packages/shared-types/src/deliveryTracking.types.ts` - Type definitions for delivery tracking
- `apps/api/src/features/deliveryTrackingRoutes.ts` - API endpoints for tracking data
- `apps/web/src/features/prescriptions/components/DeliveryTracking.tsx` - Main tracking component
- `apps/web/src/features/prescriptions/hooks/useDeliveryTracking.ts` - Real-time tracking hook
- `apps/web/src/features/prescriptions/hooks/useDeliveryNotifications.ts` - Notification system
- `apps/web/src/features/prescriptions/pages/DeliveryTrackingPage.tsx` - Full tracking page
- `apps/web/src/features/prescriptions/components/DeliveryTracking.test.tsx` - Component tests
- `apps/api/src/features/deliveryTrackingRoutes.test.ts` - API endpoint tests
- `tests/e2e/delivery-tracking.spec.ts` - End-to-end tests

**Modified Files:**
- `packages/shared-types/src/index.ts` - Added delivery tracking exports
- `apps/web/package.json` - Added Google Maps dependencies
- `apps/api/src/index.ts` - Registered delivery tracking routes
- `apps/web/src/features/prescriptions/components/OrderStatusDisplay.tsx` - Added tracking integration

### Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| Today | 2.0 | Implemented complete Google Maps delivery tracking system with real-time updates, notifications, and comprehensive testing | James (Dev Agent) |

## Dev Notes

### Previous Story Insights
Key learnings from Story 3.1 implementation:
- Real-time notification patterns established with polling every 15-30 seconds work excellently
- Service Layer Design patterns with clean method interfaces should be followed
- Shared types package ensures consistency across frontend/backend boundaries
- Comprehensive error handling with graceful degradation is expected
- Excellent testing architecture with mocking strategies should be followed
- TanStack Query patterns with `refetchInterval` and `refetchIntervalInBackground` are the standard

### Data Models
**Order Status Values** [Source: docs/architecture/data-models.md#36]:
```typescript
status: 'pending_verification' | 'awaiting_payment' | 'preparing' | 'out_for_delivery' | 'delivered' | 'rejected'
```
- Story will focus on 'out_for_delivery' status when delivery tracking is active
- Need to extend PrescriptionOrder model with delivery tracking fields

**Required New Data Models** [Source: Analysis of delivery tracking requirements]:
```typescript
interface DeliveryTrackingInfo {
  orderId: string;
  deliveryPersonId: string;
  currentLocation: {
    latitude: number;
    longitude: number;
    timestamp: Date;
  };
  destinationLocation: {
    latitude: number;
    longitude: number;
    address: string;
  };
  estimatedArrival: Date;
  status: 'assigned' | 'picked_up' | 'in_transit' | 'approaching' | 'delivered';
  route?: {
    coordinates: Array<[number, number]>; // [lng, lat] format for mapping libraries
    distance: number; // in meters
    duration: number; // in seconds
  };
}
```

### API Specifications
**Existing Order Status Endpoint** [Source: apps/api/src/features/prescriptionOrderRoutes.ts#175]:
- Endpoint: `PUT /orders/:orderId/status` (existing, no changes needed)
- Used for updating order status to 'out_for_delivery'

**Required New API Endpoints** [Source: Delivery tracking requirements analysis]:
- Endpoint: `GET /orders/:orderId/delivery-tracking`
- Response: DeliveryTrackingInfo object with current location and ETA
- Endpoint: `POST /orders/:orderId/delivery-notifications` 
- For updating user notification preferences and handling proximity alerts

### Component Specifications
**Existing OrderStatusDisplay Component** [Source: Story 3.1 implementation]:
- Located at `apps/web/src/features/prescriptions/components/OrderStatusDisplay.tsx`
- Currently shows order status progress with visual indicators
- Integration point for adding "Track Delivery" button when status is 'out_for_delivery'

**New DeliveryTracking Component** [Source: Project structure analysis]:
- Location: `apps/web/src/features/prescriptions/components/DeliveryTracking.tsx`
- Should display map with delivery person location and route
- Include ETA display and proximity notifications
- Follow existing component patterns with TypeScript and Tailwind CSS

### File Locations
Based on project structure [Source: docs/architecture/project-structure.md]:
- **Frontend Components**: 
  - `apps/web/src/features/prescriptions/components/DeliveryTracking.tsx` (new main component)
  - `apps/web/src/features/prescriptions/components/OrderStatusDisplay.tsx` (extend existing)
- **Hooks**: 
  - `apps/web/src/features/prescriptions/hooks/useDeliveryTracking.ts` (new hook)
  - `apps/web/src/features/prescriptions/hooks/useDeliveryNotifications.ts` (new hook)
  - `apps/web/src/features/prescriptions/hooks/useOrderStatus.ts` (extend existing)
- **Pages**: `apps/web/src/features/prescriptions/pages/DeliveryTrackingPage.tsx` (new page)
- **Types**: `packages/shared-types/src/` (extend with delivery tracking types)
- **Backend Routes**: `apps/api/src/features/deliveryTrackingRoutes.ts` (new routes file)

### Testing Requirements
Following established patterns [Source: Story 3.1 testing architecture]:
- **Unit Tests**: Component testing with map library mocking strategies
- **Integration Tests**: API endpoint testing with geolocation mock data
- **E2E Tests**: Complete delivery tracking flow with Playwright
- **Test Files**: Co-located `.test.ts` files (e.g., `DeliveryTracking.test.tsx`)
- **Mocking Strategies**: Mock geolocation APIs, map libraries, and real-time location updates

### Technical Constraints
**Real-time Updates** [Source: apps/web/src/features/prescriptions/hooks/usePaymentNotification.ts#86]:
- Use existing polling mechanism with TanStack Query
- 15-30 second polling intervals established as standard for real-time location updates
- `refetchInterval` and `refetchIntervalInBackground` patterns to follow
- More frequent polling (10-15 seconds) may be needed for active delivery tracking

**Tech Stack Constraints** [Source: docs/architecture/tech-stack.md]:
- Frontend: React 18.3 with TypeScript 5.4, Tailwind CSS for styling
- State Management: TanStack Query for server state, Zustand for global UI state
- Testing: Vitest for unit tests, Playwright for E2E tests
- Backend: Express.js with TypeScript, Google Firestore database

**Mapping Library Selection** [Source: No specific guidance found in architecture docs]:
- Need to evaluate and select appropriate mapping solution (Google Maps, Leaflet, or Mapbox)
- Consider licensing costs, feature requirements, and integration complexity
- Should integrate well with React and TypeScript ecosystem

**Geolocation and Privacy** [Source: Browser API requirements analysis]:
- Require user permission for location access
- Implement fallback for users who deny location permissions
- Handle location accuracy and update frequency considerations
- Ensure privacy compliance for location data storage

### Performance Considerations
- Optimize map rendering and location update frequency to prevent excessive battery drain
- Implement efficient caching for route calculations and map tiles
- Use background polling strategies that don't impact user experience
- Consider service worker integration for location updates when app is backgrounded

### Project Structure Notes
The existing project structure aligns well with delivery tracking requirements:
- Feature-based organization in `apps/web/src/features/prescriptions/`
- Clear separation of components, hooks, pages, and services
- Shared types package for cross-application consistency
- Established patterns for real-time polling and notification systems

No structural conflicts identified. The delivery tracking feature fits naturally into the existing prescription order flow architecture.

## Testing

### Testing Standards
**Test File Locations** [Source: established patterns]:
- Unit tests: Co-located with components (e.g., `DeliveryTracking.test.tsx`)
- Integration tests: `apps/api/src/features/deliveryTrackingRoutes.test.ts` (new file)
- E2E tests: `tests/e2e/delivery-tracking.spec.ts` (new file)

**Testing Frameworks and Patterns** [Source: docs/architecture/tech-stack.md]:
- **Unit Testing**: Vitest with React Testing Library
- **E2E Testing**: Playwright for critical user flows
- **Mocking**: Comprehensive API and geolocation mocking strategies

**Specific Testing Requirements**:
- Test map component rendering with mocked geolocation data
- Mock mapping library (Google Maps/Leaflet) API calls for unit tests
- Test real-time location polling with various update scenarios
- E2E test for complete delivery tracking user experience from order status to arrival notification
- Test notification system triggers for approach and arrival alerts
- Test error handling for location permission denied and network failures

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| Today | 1.0 | Initial story creation with comprehensive technical analysis | Bob (SM) |

## QA Results

### Review Date: December 19, 2024
### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment
**EXCELLENT** - This implementation demonstrates senior-level code quality with excellent architecture, comprehensive testing, and proper integration patterns. The developer has created a robust, scalable delivery tracking system that seamlessly integrates with the existing PharmaRx architecture.

### Refactoring Performed
- **File**: `apps/web/src/features/prescriptions/hooks/useDeliveryTracking.ts`
  - **Change**: Enhanced error handling with better retry logic and error type checking
  - **Why**: Improved resilience against network failures and better user experience
  - **How**: Added proper error type checking and exponential backoff retry strategy

- **File**: `apps/web/src/features/prescriptions/hooks/useDeliveryNotifications.ts`
  - **Change**: Improved notification permission handling with better user feedback
  - **Why**: Better user experience when notification permissions are denied
  - **How**: Added proper permission state management and user-friendly error handling

- **File**: `apps/web/src/features/prescriptions/components/DeliveryTracking.tsx`
  - **Change**: Enhanced Google Maps cleanup and error boundary handling
  - **Why**: Prevent memory leaks and improve component lifecycle management
  - **How**: Added proper cleanup in useEffect and better error state handling

### Compliance Check
- Coding Standards: ✓ **Excellent** - Follows established patterns perfectly
- Project Structure: ✓ **Perfect** - All files in correct locations per architecture
- Testing Strategy: ✓ **Outstanding** - Comprehensive unit, integration, and E2E tests
- All ACs Met: ✓ **Fully Implemented** - Both acceptance criteria completely satisfied

### Improvements Checklist
- [x] Enhanced error handling in delivery tracking hook (useDeliveryTracking.ts)
- [x] Improved notification permission handling (useDeliveryNotifications.ts)
- [x] Better Google Maps cleanup and error handling (DeliveryTracking.tsx)
- [x] Verified all API endpoints are properly registered and tested
- [x] Confirmed Google Maps dependencies are correctly added to package.json
- [x] Validated shared types are properly exported and used consistently
- [x] Reviewed comprehensive test coverage across all components and hooks

### Security Review
✓ **No Security Issues Found**
- Proper API key handling with environment variables
- Input validation on all API endpoints
- Secure notification permission handling
- No sensitive data exposure in client-side code

### Performance Considerations
✓ **Well Optimized**
- Efficient 15-second polling intervals for real-time updates
- Proper TanStack Query caching strategies (10s stale time, 5min cache)
- Google Maps component cleanup prevents memory leaks
- Background polling enabled for better user experience
- Optimized re-renders with proper dependency arrays

### Technical Excellence Highlights
1. **Architecture**: Perfect separation of concerns with hooks, components, and services
2. **Real-time Integration**: Seamless integration with existing TanStack Query patterns
3. **Google Maps**: Professional implementation with proper error handling and loading states
4. **Testing**: Outstanding test coverage with comprehensive mocking strategies
5. **Type Safety**: Excellent TypeScript usage with shared types across boundaries
6. **Error Handling**: Robust error handling with graceful degradation
7. **User Experience**: Smooth real-time updates with proper loading and error states

### Final Status
✓ **Approved - Ready for Done**

This implementation represents senior-level development work with excellent code quality, comprehensive testing, and proper integration with existing systems. The delivery tracking feature is production-ready and demonstrates best practices in React/TypeScript development.