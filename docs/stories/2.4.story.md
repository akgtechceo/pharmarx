# Story 2.4: Pharmacist Verification Portal

## Status
Pending

## Story
**As a** Pharmacist,
**I want** a queue of submitted prescriptions,
**so that** I can review and verify them.

## Acceptance Criteria
1. Pharmacist Portal lists pending prescriptions in a queue format
2. Pharmacist can view prescription image and user-confirmed data side by side
3. Pharmacist can approve, reject (with reason), or edit the order details

## Tasks / Subtasks
- [ ] Task 1: Create pharmacist prescription queue interface (AC: 1)
  - [ ] Build PharmacistQueue component in apps/web/src/features/prescriptions/
  - [ ] Display list of orders with status 'awaiting_verification'
  - [ ] Show order summary (patient name, medication, submission time)
  - [ ] Implement sorting and filtering options (by date, medication type, urgency)
  - [ ] Add pagination for handling large volumes of prescriptions
- [ ] Task 2: Build prescription review interface (AC: 2)
  - [ ] Create PrescriptionReview component with image and data display
  - [ ] Show original prescription image alongside extracted/verified data
  - [ ] Display user verification history (what they confirmed/edited)
  - [ ] Include patient information and submission timestamp
  - [ ] Add professional review checklist for pharmacist workflow
- [ ] Task 3: Implement pharmacist action controls (AC: 3)
  - [ ] Create approve button with confirmation dialog
  - [ ] Build reject functionality with required reason field
  - [ ] Add edit capability for medication details (name, dosage, quantity)
  - [ ] Implement cost calculation and pricing input
  - [ ] Add notes field for pharmacist observations
- [ ] Task 4: Integrate with order management system (AC: 1, 2, 3)
  - [ ] Connect to backend API for fetching pending prescriptions
  - [ ] Implement real-time updates when new prescriptions arrive
  - [ ] Update order status workflow: 'awaiting_verification' → 'awaiting_payment' or 'rejected'
  - [ ] Add audit trail for all pharmacist actions
  - [ ] Ensure proper role-based access control for pharmacist portal
- [ ] Task 5: Add comprehensive testing for pharmacist workflow
  - [ ] Unit tests for queue component and filtering logic
  - [ ] Integration tests for prescription review and actions
  - [ ] E2E tests for complete pharmacist verification workflow
  - [ ] Test error handling for API failures and edge cases
  - [ ] Mock data for testing various prescription scenarios

## Dev Notes

### Previous Story Insights
Story 2.3 successfully completed the user verification system:
- PrescriptionVerification component with side-by-side image/form layout implemented
- Dual workflow options (Confirm/Skip) with proper validation and API integration
- Complete order status flow from 'pending_verification' to 'awaiting_payment'
- Comprehensive testing coverage with unit, integration, and E2E tests
- Production-ready implementation with accessibility and responsive design
- Users can now review and confirm extracted OCR data before sending to pharmacists
[Source: Story 2.3 Dev Agent Record and QA Results]

### Data Models
**PrescriptionOrder Interface** (extended from previous stories):
```typescript
interface PrescriptionOrder {
  orderId: string;
  patientProfileId: string;
  status: 'pending_verification' | 'awaiting_verification' | 'awaiting_payment' | 'preparing' | 'out_for_delivery' | 'delivered' | 'rejected';
  originalImageUrl: string;
  extractedText: string;
  ocrConfidence: number;
  ocrStatus: 'pending' | 'processing' | 'completed' | 'failed';
  medicationDetails: {
    name: string;
    dosage: string;
    quantity: number;
  };
  userVerified: boolean;
  userVerificationNotes?: string;
  pharmacistReview?: {
    reviewedBy: string;
    reviewedAt: Date;
    approved: boolean;
    rejectionReason?: string;
    editedDetails?: {
      name?: string;
      dosage?: string;
      quantity?: number;
    };
    pharmacistNotes?: string;
    calculatedCost?: number;
  };
  cost: number;
  createdAt: Date;
  updatedAt: Date;
}
```
[Source: architecture/data-models.md, Story 2.2-2.3 implementation]

### API Specifications
**New API endpoints** for pharmacist workflow:
- `GET /pharmacist/orders` - Retrieve pending prescriptions for review
- `PUT /pharmacist/orders/{orderId}/approve` - Approve prescription with cost
- `PUT /pharmacist/orders/{orderId}/reject` - Reject prescription with reason
- `PUT /pharmacist/orders/{orderId}/edit` - Edit prescription details before approval
- Status flow: 'awaiting_verification' → 'awaiting_payment' (approved) or 'rejected'
[Source: architecture/api-spec.md extension]

### Component Architecture
**Pharmacist Portal Structure** following project patterns:
```
apps/web/src/features/prescriptions/
├── components/
│   ├── PharmacistQueue.tsx
│   ├── PrescriptionReview.tsx
│   ├── ReviewActions.tsx
│   └── RejectDialog.tsx
├── hooks/
│   ├── usePharmacistQueue.ts
│   └── usePrescriptionReview.ts
├── pages/
│   └── PharmacistDashboard.tsx
└── types/
    └── pharmacist.types.ts
```
[Source: architecture/project-structure.md]

### Integration Points
**Portal Integration** requirements:
- Pharmacist role authentication and authorization
- Real-time queue updates (WebSocket or polling)
- Integration with existing order management system
- Audit logging for regulatory compliance
- Professional workflow optimization for high-volume processing
[Source: Epic 2 goals, Story 1.5 role-based portals]

### Technical Constraints
**Pharmacist Workflow Requirements**:
- HIPAA-compliant handling of prescription data
- Professional review tools and validation checklists
- Audit trail for all pharmacist decisions and edits
- Real-time updates to avoid duplicate reviews
- High-performance interface for processing large prescription volumes
- Mobile-responsive design for pharmacist mobility
[Source: architecture/deployment.md#security, functional requirements FR5, FR8]

### Testing Requirements
**Testing Strategy** for pharmacist functionality:
- **Unit/Integration**: Vitest 1.6 for component and workflow testing
- **E2E Testing**: Playwright 1.44 for complete pharmacist verification flows
- **Test Location**: `apps/web/src/features/prescriptions/__tests__/`
- **Mock Data**: Various prescription scenarios (clear, unclear, edge cases)
- **Performance**: Load testing for queue handling and real-time updates
[Source: architecture/deployment.md#testing-strategy]

### Security and Compliance
**Healthcare Data Protection**:
- Role-based access control for pharmacist portal access only
- Secure handling of prescription images and patient data
- Audit logging for regulatory compliance and accountability
- Data encryption for all prescription information
- Session management and timeout for pharmacist workstations
[Source: NFR4 data privacy compliance, FR5 pharmacist approval requirement]

## Testing

### Testing Standards
**Test Framework**: Vitest 1.6 for unit and integration tests
**Test Location**: `apps/web/src/features/prescriptions/__tests__/PharmacistQueue.test.tsx`
**E2E Framework**: Playwright 1.44 for end-to-end pharmacist workflow testing
**Test Patterns**:
- Queue rendering with mock prescription data
- Prescription review component with image and data display
- Action buttons and workflow state management
- API integration with mocked pharmacist endpoints
- Error handling and edge case scenarios
- Real-time updates and queue refresh functionality
[Source: architecture/deployment.md#testing-strategy]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| January 2025 | 1.0 | Initial story creation with comprehensive architecture context | Bob (SM) |

## Dev Agent Record
*Pending implementation*

## QA Results
*Pending implementation and testing*