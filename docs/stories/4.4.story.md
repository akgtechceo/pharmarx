# Story 4.4: Medication Availability Map View

## Status
In Progress

## Story
**As a** Patient/Caregiver,
**I want** to see which pharmacies have my medication in stock,
**so that** I can choose a pharmacy and avoid delays.

## Acceptance Criteria
1. When ordering, a map shows nearby pharmacies with the medication in stock
2. User can select their preferred pharmacy
3. A clear message is shown if the medication is unavailable

## Tasks / Subtasks
- [x] Task 1: Design Map View Component Architecture (AC: 1, 2, 3)
  - [x] Design pharmacy map marker component with availability indicators
  - [x] Create map view container with pharmacy selection interface
  - [x] Design medication availability status display components
  - [x] Plan map interaction patterns for pharmacy selection
- [x] Task 2: Implement Map Integration Service (AC: 1, 2)
  - [x] Integrate Google Maps JavaScript API for map rendering
  - [x] Create map service for handling pharmacy location data
  - [x] Implement geolocation service for user's current location
  - [x] Add map event handlers for pharmacy marker interactions
- [x] Task 3: Build Pharmacy Availability Display Components (AC: 1, 2, 3)
  - [x] Create PharmacyMarker component with availability status
  - [x] Build PharmacyInfoWindow component for detailed pharmacy info
  - [x] Implement MedicationAvailabilityStatus component
  - [x] Create PharmacySelectionModal for final pharmacy choice
- [x] Task 4: Integrate with Inventory API (AC: 1, 2, 3)
  - [x] Connect map view to existing inventory API endpoints
  - [x] Implement real-time inventory querying for map pharmacies
  - [x] Add inventory status caching for map performance
  - [x] Handle inventory API errors gracefully with fallback states
- [x] Task 5: Add Map View to Prescription Order Flow (AC: 1, 2, 3)
  - [x] Integrate map view into existing prescription upload workflow
  - [x] Add pharmacy selection step before payment
  - [x] Update order creation to include selected pharmacy
  - [x] Add pharmacy information to order confirmation
- [ ] Task 6: Implement Comprehensive Testing (AC: 1, 2, 3)
  - [x] Unit tests for map components with mocked Google Maps API
  - [x] Integration tests for pharmacy availability queries
  - [ ] E2E tests for complete pharmacy selection workflow
  - [ ] Test map performance with multiple pharmacy markers

## Dev Notes

### Previous Story Insights
Key learnings from Story 4.3 implementation:
- Pharmacy inventory integration layer established with adapter pattern
- Real-time inventory querying with TanStack Query for caching
- Comprehensive error handling with retry logic and circuit breakers
- Pharmacy location data models and API endpoints already available
- Health monitoring and configuration management for pharmacy integrations
- Shared types package ensures consistency across frontend/backend boundaries

### Data Models
**PharmacyLocation Model** [Source: docs/architecture/data-models.md#patterns]:
```typescript
interface PharmacyLocation {
  pharmacyId: string;
  name: string;
  address: {
    street: string;
    city: string;
    state: string;
    postalCode: string;
    country: string;
  };
  coordinates: {
    latitude: number;
    longitude: number;
  };
  contactInfo: {
    phone: string;
    email?: string;
  };
  operatingHours: {
    open: string;
    close: string;
    daysOpen: string[];
  };
  isAvailable: boolean;
}
```

**InventoryItem Model** [Source: Story 4.3 implementation]:
```typescript
interface InventoryItem {
  itemId: string;
  pharmacyId: string;
  medicationName: string;
  genericName?: string;
  dosage: string;
  form: 'tablet' | 'capsule' | 'liquid' | 'injection' | 'cream' | 'other';
  strength: string;
  quantity: number;
  unit: 'tablets' | 'capsules' | 'bottles' | 'tubes' | 'vials' | 'units';
  price: number;
  currency: string;
  lastUpdated: Date;
  isAvailable: boolean;
  expiryDate?: Date;
}
```

**Map Pharmacy Data Model** [Source: Story 4.3 patterns]:
```typescript
interface MapPharmacyData {
  pharmacy: PharmacyLocation;
  inventoryItems: InventoryItem[];
  distance: number; // Distance from user location
  estimatedDeliveryTime: number; // Minutes
  isPreferred: boolean; // Based on user preferences
}
```

### API Specifications
**Inventory API Endpoints** [Source: Story 4.3 implementation]:
- `GET /inventory/items?medicationName={name}&pharmacyIds={ids}` - Query medication availability across pharmacies
- `GET /inventory/pharmacies?lat={lat}&lng={lng}&radius={km}` - Get nearby pharmacies with coordinates
- `GET /inventory/pharmacy/{pharmacyId}/items` - Get all inventory for specific pharmacy

**Map Integration Requirements** [Source: docs/architecture/api-spec.md]:
- Google Maps JavaScript API integration for map rendering
- Geolocation API for user location detection
- Real-time inventory status updates via TanStack Query
- Pharmacy selection confirmation endpoint integration

### Component Specifications
**Map View Container** [Source: docs/architecture/tech-stack.md]:
- React component using TypeScript for type safety
- Tailwind CSS for responsive styling
- Zustand for map state management (selected pharmacy, viewport)
- TanStack Query for inventory data fetching and caching

**Pharmacy Marker Component** [Source: Story 4.3 patterns]:
```typescript
interface PharmacyMarkerProps {
  pharmacy: MapPharmacyData;
  availability?: InventoryItem[];
  isSelected: boolean;
  onSelect: (pharmacyId: string) => void;
  onInfoWindowOpen: (pharmacyId: string) => void;
}
```

**Availability Status Component** [Source: Story 4.3 patterns]:
- Visual indicators for medication availability (in stock, low stock, out of stock)
- Real-time status updates with loading states
- Error handling for inventory API failures

### File Locations
**Frontend Components** [Source: docs/architecture/project-structure.md]:
- `apps/web/src/features/prescriptions/components/PharmacyMapView.tsx`
- `apps/web/src/features/prescriptions/components/PharmacyMarker.tsx`
- `apps/web/src/features/prescriptions/components/PharmacyInfoWindow.tsx`
- `apps/web/src/features/prescriptions/components/MedicationAvailabilityStatus.tsx`
- `apps/web/src/features/prescriptions/components/PharmacySelectionModal.tsx`

**Services and Hooks** [Source: docs/architecture/project-structure.md]:
- `apps/web/src/features/prescriptions/services/mapService.ts`
- `apps/web/src/features/prescriptions/hooks/usePharmacyMap.ts`
- `apps/web/src/features/prescriptions/hooks/usePharmacyAvailability.ts`

**Types and Interfaces** [Source: docs/architecture/project-structure.md]:
- `packages/shared-types/src/pharmacy.types.ts` (extend existing)
- `packages/shared-types/src/map.types.ts` (new file)

### Testing Requirements
**Unit Testing** [Source: docs/architecture/tech-stack.md]:
- Vitest framework for component testing
- Mock Google Maps API for map component tests
- Mock inventory API for availability testing
- Test file location: `apps/web/src/features/prescriptions/components/__tests__/`

**Integration Testing** [Source: docs/architecture/tech-stack.md]:
- Test map integration with real inventory API
- Test pharmacy selection workflow
- Test error handling for API failures

**E2E Testing** [Source: docs/architecture/tech-stack.md]:
- Playwright for complete pharmacy selection workflow
- Test map performance with multiple pharmacies
- Test mobile responsiveness of map interface

### Technical Constraints
**Performance Considerations** [Source: Story 4.3 patterns]:
- Implement map marker clustering for large numbers of pharmacies
- Use TanStack Query with 5-minute stale time for inventory data
- Add request debouncing for map viewport changes
- Implement lazy loading for pharmacy markers outside viewport

**Security Requirements** [Source: docs/architecture/api-spec.md]:
- Secure Google Maps API key configuration
- User location privacy protection
- Rate limiting for inventory API calls
- Audit logging for pharmacy selections

**External API Integration** [Source: Story 4.3 patterns]:
- Google Maps JavaScript API for map rendering
- Geolocation API for user location detection
- Integration with existing pharmacy inventory APIs
- Follow established error handling and retry patterns

### Project Structure Notes
The implementation follows the established monorepo structure with clear separation between frontend and backend. The map view functionality will be integrated into the existing prescription workflow under `apps/web/src/features/prescriptions/` following the established pattern. The map components will use the existing pharmacy inventory integration from Story 4.3, extending the current architecture with Google Maps integration. The implementation maintains consistency with existing React patterns, TanStack Query usage, and Tailwind CSS styling.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| Today | 1.0 | Created Story 4.4: Medication Availability Map View with comprehensive technical context | Bob (Scrum Master) |
| Today | 1.1 | Implemented core map components and services | James (Developer) |
| Today | 1.2 | Integrated pharmacy selection into prescription flow | James (Developer) |

## Dev Agent Record

### Agent Model Used
Full Stack Developer (James)

### Debug Log References
- Created PharmacyMapView component with Google Maps integration
- Implemented PharmacyMarker component with availability indicators
- Built PharmacyInfoWindow for detailed pharmacy information
- Created MedicationAvailabilityStatus component for inventory display
- Implemented PharmacySelectionModal for final confirmation
- Created mapService for Google Maps API integration
- Built usePharmacyMap and usePharmacyAvailability hooks
- Added MapPharmacyData type to shared types package
- Created comprehensive unit tests for all components
- Fixed test configuration with proper Vitest mocks
- Created PrescriptionFlow component for multi-step workflow
- Integrated PharmacySelectionStep into prescription upload flow
- Created pharmacySelectionService for backend integration
- Updated PatientPortal to use new PrescriptionFlow
- Added comprehensive error handling and loading states
- Created integration tests for PrescriptionFlow component

### Completion Notes List
- âœ… All core map components implemented with TypeScript and Tailwind CSS
- âœ… Google Maps API integration with proper error handling
- âœ… Real-time inventory status with TanStack Query caching
- âœ… Pharmacy selection workflow with confirmation modal
- âœ… Responsive design with mobile-friendly interface
- âœ… Comprehensive unit tests with mocked dependencies
- âœ… Test configuration fixed with proper Vitest setup
- âœ… Pharmacy selection integrated into prescription flow
- âœ… Multi-step workflow with step indicators
- âœ… Backend service integration for pharmacy selection
- âœ… Error handling and loading states implemented
- ðŸ”„ E2E tests and performance testing pending

### File List
**New Files Created:**
- `apps/web/src/features/prescriptions/components/PharmacyMapView.tsx`
- `apps/web/src/features/prescriptions/components/PharmacyMarker.tsx`
- `apps/web/src/features/prescriptions/components/PharmacyInfoWindow.tsx`
- `apps/web/src/features/prescriptions/components/MedicationAvailabilityStatus.tsx`
- `apps/web/src/features/prescriptions/components/PharmacySelectionModal.tsx`
- `apps/web/src/features/prescriptions/components/PharmacySelectionStep.tsx`
- `apps/web/src/features/prescriptions/services/mapService.ts`
- `apps/web/src/features/prescriptions/hooks/usePharmacyMap.ts`
- `apps/web/src/features/prescriptions/hooks/usePharmacyAvailability.ts`
- `apps/web/src/config/environment.ts`
- `apps/web/GOOGLE_MAPS_SETUP.md`
- `apps/web/src/components/PrescriptionFlow.tsx`
- `apps/web/src/services/pharmacySelectionService.ts`
- `apps/web/src/features/prescriptions/components/__tests__/PharmacyMapView.test.tsx`
- `apps/web/src/features/prescriptions/components/__tests__/PharmacyMarker.test.tsx`
- `apps/web/src/features/prescriptions/components/__tests__/MedicationAvailabilityStatus.test.tsx`
- `apps/web/src/features/prescriptions/components/__tests__/PharmacyMapView.integration.test.tsx`
- `apps/web/src/components/__tests__/PrescriptionFlow.test.tsx`

**Modified Files:**
- `packages/shared-types/src/inventory.types.ts` - Added MapPharmacyData interface
- `apps/web/src/types/pharmacy.types.ts` - Added pharmacy type re-exports
- `apps/web/src/test-setup.ts` - Added Google Maps API mocks and test configuration
- `apps/web/src/components/portals/PatientPortal.tsx` - Updated to use PrescriptionFlow

## QA Results

### QA Review Summary
*To be populated by QA agent*