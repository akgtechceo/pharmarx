# Story 1.3: Multi-Role Registration

## Status
Approved

## Story
**As a** new User,
**I want** to register with either my email or phone number by selecting my role,
**so that** I can access the platform.

## Acceptance Criteria
1. UI provides role choice (Patient/Caregiver, Doctor, Pharmacist)
2. User can register with email OR phone number and a password
3. User record is created with the correct role
4. Password is hashed

## Dev Notes

### Previous Story Insights
Story 1.2 completed comprehensive user model and database setup with excellent patterns established:
- Singleton database service pattern implemented for optimal connection management
- User model with proper validation for email/phoneNumber (one required)
- Firestore security rules enforcing user-specific data access
- Comprehensive testing patterns with proper mocking strategies
- Production-ready error handling and security implementation

### Data Models
Based on the established User interface from Story 1.2 [Source: architecture/data-models.md]:

```typescript
interface User {
  uid: string;
  role: 'patient' | 'caregiver' | 'doctor' | 'pharmacist';
  email?: string;
  phoneNumber?: string;
  displayName: string;
  createdAt: Date;
}
```

Key validation requirements:
- Either `email` OR `phoneNumber` must be provided (one is required)
- Role must be one of the four defined values
- `displayName` and `createdAt` are required fields [Source: architecture/data-models.md]

### API Specifications
Registration endpoint defined in API specification [Source: architecture/api-spec.md]:
- **POST /auth/register**: Register a new user endpoint
- Expected to handle user registration with role selection
- Should integrate with Firebase Authentication for secure user management [Source: architecture/overview.md]

### Component Specifications
Frontend registration components to be created in React/TypeScript [Source: architecture/tech-stack.md]:
- **Technology Stack**: React 18.3 with TypeScript 5.4, Vite for build tooling
- **UI Styling**: Tailwind CSS 3.4 for rapid custom UI development
- **State Management**: Zustand 4.5 for lightweight global state if needed
- **Authentication**: Firebase Auth for multi-role user authentication [Source: architecture/tech-stack.md]

### File Locations
Based on project structure [Source: architecture/project-structure.md]:
- **Frontend Components**: `apps/web/src/components/` for reusable UI components
- **Frontend Features**: `apps/web/src/features/` for registration-specific logic
- **Backend API**: `apps/api/src/features/` for user registration endpoints
- **Shared Types**: `packages/shared-types/src/index.ts` for shared interfaces (User model already exists)

### Testing Requirements
Based on established patterns from Story 1.2:
- **Frontend Testing**: Component testing with Vitest 1.6 [Source: architecture/tech-stack.md]
- **Backend Testing**: API endpoint testing with proper mock strategies
- **Integration Testing**: Registration flow testing with Firebase Auth mocking
- **E2E Testing**: Playwright 1.44 for critical registration user flows [Source: architecture/tech-stack.md]

### Technical Constraints
Authentication and security requirements [Source: architecture/overview.md]:
- **Firebase Authentication**: Must integrate with Firebase Auth for user management
- **Password Security**: Passwords must be properly hashed (handled by Firebase Auth)
- **Database Security**: Leverage existing Firestore security rules from Story 1.2
- **Input Validation**: Enforce email/phone number validation patterns
- **Role-based Access**: Implement proper role assignment and validation

### Project Structure Notes
All file locations align with the established monorepo structure. The existing user model and database service from Story 1.2 provide the foundation for registration functionality.

## Tasks / Subtasks

### Task 1: Create Registration UI Components (AC: 1, 2)
- [x] Create `RegisterForm` component in `apps/web/src/components/`
  - [x] Role selection dropdown with Patient/Caregiver, Doctor, Pharmacist options
  - [x] Email/phone number toggle input field with validation
  - [x] Password input with strength requirements
  - [x] Display name input field
  - [x] Form validation and error display
- [x] Create registration page in `apps/web/src/features/auth/`
- [x] Implement responsive design with Tailwind CSS
- [x] Add proper TypeScript interfaces for registration form data
- **References**: [Source: architecture/tech-stack.md], [Source: architecture/data-models.md]

### Task 2: Implement Frontend Registration Logic (AC: 2, 3)
- [x] Create registration service using Firebase Auth
  - [x] Integrate with Firebase Auth `createUserWithEmailAndPassword`
  - [x] Handle email and phone number registration patterns
  - [x] Implement proper error handling for auth failures
- [x] Create Zustand store for registration state management if needed
- [x] Add form validation for email/phone number (one required)
- [x] Implement role selection persistence
- **References**: [Source: architecture/overview.md], [Source: architecture/tech-stack.md]

### Task 3: Create Backend Registration API (AC: 3, 4)
- [x] Implement `POST /auth/register` endpoint in `apps/api/src/features/`
- [x] Integrate with existing database service from Story 1.2
- [x] Create user record with proper role assignment
- [x] Leverage existing User model validation logic
- [x] Implement proper error responses and status codes
- [x] Add middleware for request validation
- **References**: [Source: architecture/api-spec.md], [Source: architecture/project-structure.md]

### Task 4: Integrate Firebase Authentication (AC: 4)
- [x] Configure Firebase Auth in frontend application
- [x] Set up Firebase Auth in backend for token verification
- [x] Implement custom claims for user roles
- [x] Ensure password hashing is handled by Firebase Auth
- [x] Create auth state management in frontend
- **References**: [Source: architecture/overview.md], [Source: architecture/tech-stack.md]

### Task 5: Unit Testing for Registration Components (AC: 1, 2, 3, 4)
- [x] Write component tests for `RegisterForm` using Vitest
  - [x] Test role selection functionality
  - [x] Test email/phone validation logic
  - [x] Test form submission and error states
  - [x] Test password validation requirements
- [x] Write unit tests for registration service
- [x] Mock Firebase Auth for testing environment
- [x] Test backend registration API endpoint
- **References**: Previous Story 1.2 testing patterns

### Task 6: Integration Testing for Registration Flow (AC: 1, 2, 3, 4)
- [x] Create E2E tests using Playwright for complete registration flow
  - [x] Test Patient/Caregiver registration with email
  - [x] Test Doctor registration with phone number
  - [x] Test Pharmacist registration with email
  - [x] Test validation error scenarios
- [x] Test API integration between frontend and backend
- [x] Verify user record creation in Firestore
- [x] Test auth state persistence after registration
- **References**: [Source: architecture/tech-stack.md] 

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (via Cursor)

### File List
**Frontend Files:**
- `apps/web/src/components/RegisterForm.tsx` - Main registration form component with role selection and validation
- `apps/web/src/features/auth/RegisterPage.tsx` - Registration page with form integration and navigation
- `apps/web/src/services/registrationService.ts` - Firebase Auth and backend API integration service
- `apps/web/src/config/firebase.ts` - Firebase configuration for authentication
- `apps/web/src/App.tsx` - Updated with React Router and registration routes
- `apps/web/src/components/RegisterForm.test.tsx` - Comprehensive unit tests for RegisterForm component
- `apps/web/src/services/registrationService.test.ts` - Unit tests for registration service

**Backend Files:**
- `apps/api/src/features/authRoutes.ts` - Authentication routes with registration endpoint
- `apps/api/src/index.ts` - Updated main API with auth routes
- `apps/api/src/features/authRoutes.test.ts` - Unit tests for auth routes

**E2E Test Files:**
- `e2e/registration.spec.ts` - Comprehensive E2E tests for registration flow across all user roles
- `e2e/api-integration.spec.ts` - API integration tests, user record creation, and auth state persistence

### Completion Notes
1. **Multi-Role Registration System**: Successfully implemented comprehensive registration system supporting Patient/Caregiver, Doctor, and Pharmacist roles with proper UI/UX patterns
2. **Firebase Integration**: Complete Firebase Authentication integration with custom claims for role-based access control
3. **Email/Phone Flexibility**: Implemented toggle between email and phone number registration with proper validation
4. **Backend API**: Created secure registration endpoint with Firebase token verification and user record creation
5. **Comprehensive Testing**: Written extensive unit tests covering component logic, service integration, and API endpoints
6. **Production-Ready Security**: Implemented proper password hashing, token verification, and input validation
7. **E2E Test Coverage**: Created comprehensive Playwright E2E tests covering all user registration scenarios, API integration, user record persistence, and auth state management

### Debug Log References
No critical debugging was required. Implementation followed established patterns from Story 1.2.

### Change Log
- Created complete multi-role registration flow with frontend components and backend API
- Integrated Firebase Auth with role-based custom claims
- Added comprehensive test coverage for all components including unit and E2E tests
- Updated application routing to support registration flow
- Implemented comprehensive E2E testing with Playwright covering all registration scenarios
- Maintained compatibility with existing User model and database service from Story 1.2

### Status
Ready for Review