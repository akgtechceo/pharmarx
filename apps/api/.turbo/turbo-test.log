[?9001h[?1004h[?25l[2J[m[H]0;npm[?25h]0;npm run test[?25l
> @pharmarx/api@1.0.0 test
> vitest[5;1H[?25h[K]0;C:\WINDOWS\system32\cmd.exe ]0;node (vitest)[?25l[44m[1m
 DEV [m [34mv3.2.4 [90mC:/Users/akgte/PharmaRx/apps/api[?2026h[m[2m[9;1H Test Files [32m[22m[1m0 passed[90m[22m (21)[m[2m
      Tests [32m[22m[1m0 passed[90m[22m (0)[m[2m
   Start at [22m08:15:18[2m
   Duration [22m878ms[?2026l]0;node (vitest 3)]0;node (vitest 1)]0;node (vitest 2)]0;node (vitest 4)]0;node (vitest 5)]0;node (vitest 6)[?2026h
[K[77C[11;1H[K
[K[77C[9;1H[K
[K[77C[8;1H[K[77C[?2026l[2m
 Test Files [32m[22m[1m0 passed[90m[22m (21)[m[2m
      Tests [32m[22m[1m0 passed[90m[22m (0)[m[2m
   Start at [22m08:15:18[2m
   Duration [22m1.85s[?2026h
[K[77C[12;1H[K[77C[11;1H[K[77C[10;1H[K[77C[9;1H[K[77C[8;1H[K[77C[2m
 Test Files [32m[22m[1m0 passed[90m[22m (21)[m[2m
      Tests [32m[22m[1m0 passed[90m[22m (0)[m[2m
   Start at [22m08:15:18[2m
   Duration [22m2.89s[?2026l[?2026h[8;1H[K[33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m [queued][22m[K
[K[2m
 Test Files [32m[22m[1m0 passed[90m[22m (21)[K[m[2m
      Tests [32m[22m[1m0 passed[90m[22m (0)[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m3.75s[K[60C[?2026l
[77C[?2026h[5;1H[K[33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m [queued][22m[K
[K[2m
 Test Files [32m[22m[1m0 passed[90m[22m (21)[K[m[2m
      Tests [32m[22m[1m0 passed[90m[22m (0)[K[53C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m4.13s[K[60C[?2026l
[77C[?2026h[?2026l[2;1H[K[33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m [queued][22m[K
[K[2m
 Test Files [32m[22m[1m0 passed[90m[22m (21)[K[m[2m
      Tests [32m[22m[1m0 passed[90m[22m (0)[K[m[2m
   Start at [22m08:15:18[K[2m
   Duration [22m4.51s[K
[K[77C[?2026h[90m[2;1Hstdout[2m | src/features/ocrService.test.ts[m[K
OCR Service initialized successfully[K
[K[90m
stdout[2m | src/features/ocrIntegration.test.ts[m[K
OCR Service initialized successfully[K
[K
[K
[K
[K
[K
[K
[K
[K[77C[33m[1m[9;1H ❯ [msrc/features/authRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 0/17[33m[22m[1m
 ❯ [msrc/features/paymentService.test.ts[2m [queued][22m
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [32m[22m[1m0 passed[90m[22m (17)[K[52C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m4.88s[K[60C[?2026l
[77C[?2026h[90m[2;1Hstdout[2m | src/features/ocrService.test.ts > OCRService > processImage > should successfully extract text from image[m[K
OCR Service initialized successfully[K
[K[90m
stdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Real-world prescription text extraction > should extract text from prescription image[m[K
OCR Service initialized successfully[K
[K[90m
stdout[2m | src/features/ocrService.test.ts > OCRService > processImage > should successfully extract text from image[m[K
Starting OCR processing for order test-order-123[K
OCR attempt 1/3 for image: https://example.com/test-image.jpg[K[16C
[77C
[90mstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Real-w[m
[90m[2m[13;77Hworld prescription text extraction > should extract text from prescription ima[m
[90m[2m[13;77Hage[22m[K[75C[m
Starting OCR processing for order prescription-order-123[21C
OCR attempt 1/3 for image: https://storage.googleapis.com/prescriptions/presc
[13;77Hcription-001.jpg[62C
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m [queued][22m[K[34C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m [queued][22m[K[22C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 0/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][22m[K[35C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 0/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m [queued][22m[K[30C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [32m[22m[1m0 passed[90m[22m (36)[K[52C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m5.12s[K[60C[?2026l
[77C[?2026h[11;1H[K
[K
[K
[K[77C[7;1H[K
[K
[K
[K[77C[2;1H[K
[K
[K
[K
[K[77C[90m[2;1Hstderr[2m | src/features/ocrService.test.ts > OCRService > processImage > should successfully extract text from image[m
OCR attempt 1 failed: (intermediate value) is not iterable[90m[6;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Real-world prescription text extraction > should extract text from prescription image[m
OCR attempt 1 failed: (intermediate value) is not iterable[33m[1m[12;1H ❯ [msrc/features/authRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 0/19[22m
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][22m[K[35C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 0/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m [queued][22m[K[30C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [32m[22m[1m0 passed[90m[22m (36)[K[52C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m5.12s[K[60C[?2026l
[77C[?2026h[K[77C[13;1H[K[77C[12;1H[K[77C[11;1H[K[77C[10;1H[K[77C[9;1H[K[77C[8;1H[K[77C[7;1H[K[77C[6;1H[K[77C[4;1H[K
[K[77C[2;1H[K
[K[77C[90m[2;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Real-world prescription text extraction > should extract text from prescription image[m
OCR attempt 2/3 for image: https://storage.googleapis.com/prescriptions/prescription-001.jpg[90m[8;1Hstdout[2m | src/features/ocrService.test.ts > OCRService > processImage > should successfully extract text from image[m
OCR attempt 2/3 for image: https://example.com/test-image.jpg[33m[1m[13;1H ❯ [msrc/features/authRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m [queued][22m
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 0/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][22m[K[35C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 0/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m [queued][22m[K[30C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [32m[22m[1m0 passed[90m[22m (36)[K[52C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m5.45s[K[60C[?2026l[?2026h
[13;1H                                                                             
[77C[90m[2;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Real-world prescription text extraction > should extract text from prescription image[m[K
OCR attempt 2 failed: (intermediate value) is not iterable[K
[K[90m
stderr[2m | src/features/ocrService.test.ts > OCRService > processImage > should successfully extract text from image[m[K
OCR attempt 2 failed: (intermediate value) is not iterable[K
[K
[K[33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 0/19[22m
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][22m[K[35C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 0/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m [queued][22m[K[30C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [32m[22m[1m0 passed[90m[22m (36)[K[52C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m5.45s[K[60C[?2026l[?2026h
[11;1H                                                                             
                                                                             
                                                                             
[77C[90m[2;1Hstdout[2m | src/features/ocrService.test.ts > OCRService > processImage > should successfully extract text from image[m[K
OCR attempt 3/3 for image: https://example.com/test-image.jpg[K
[K[90m
stdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Real-world prescription text extraction > should extract text from prescription image[m[K
OCR attempt 3/3 for image: https://storage.googleapis.com/prescriptions/prescription-001.jpg[K[33m[1m[13;1H ❯ [msrc/features/authRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m [queued][22m
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 0/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][22m[K[35C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 0/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m [queued][22m[K[30C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [32m[22m[1m0 passed[90m[22m (36)[K[52C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m5.45s[K[60C[?2026l[?2026h
[90m[2;1Hstderr[2m | src/features/ocrService.test.ts > OCRService > processImage > should successfully extract text from image[m                                        
OCR attempt 3 failed: (intermediate value) is not iterable                   
                                                                             [90m
stderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Real-world prescription text extraction > should extract text from prescription image[m                                                                           
OCR attempt 3 failed: (intermediate value) is not iterable                   
                                                                             [90m
stderr[2m | src/features/ocrService.test.ts > OCRService > processImage > should successfully extract text from image[m                                        
OCR processing failed for order test-order-123: Error: OCR failed after 3 attempts. Last error: (intermediate value) is not iterable[22C
    at OCRService.extractTextWithRetry [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\
[13;77H\features\ocrService.ts:103:11[90m)[K[47C[m
    at OCRService.processImage [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features
[13;77Hs\ocrService.ts:34:32[90m)[K[56C[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.test.ts:68:22
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:20[61C
[77C
[90mstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Real-w[m
[90m[2m[13;77Hworld prescription text extraction > should extract text from prescription ima[m
[90m[2m[13;77Hage[22m[K[75C[m
OCR processing failed for order prescription-order-123: Error: OCR failed aft
[13;77Hter 3 attempts. Last error: (intermediate value) is not iterable[14C
    at OCRService.extractTextWithRetry [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\
[13;77H\features\ocrService.ts:103:11[90m)[K[47C[m
    at OCRService.processImage [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features
[13;77Hs\ocrService.ts:34:32[90m)[K[56C[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrIntegration.test.ts:9
[13;77H95:22[73C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:20[61C
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m [queued][22m[K[34C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m [queued][22m[K[22C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 0/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][22m[K[35C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 0/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m [queued][22m[K[30C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [32m[22m[1m0 passed[90m[22m (36)[K[52C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m5.45s[K[60C
[77C[?2026l[?2026h[90m[2;1Hstdout[2m | src/features/ocrService.test.ts > OCRService > processImage > should handle empty text detection results[m[K
OCR Service initialized successfully[K
[K[90m
stdout[2m | src/features/ocrService.test.ts > OCRService > processImage > should handle empty text detection results[m[K
Starting OCR processing for order test-order-123[K
OCR attempt 1/3 for image: https://example.com/test-image.jpg[K
[K
[K[33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 0/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][22m[K[35C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 0/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m [queued][22m[K[30C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [32m[22m[1m0 passed[90m[22m (36)[K[52C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m5.45s[K[60C[?2026l[?2026h
[90m[2;1Hstderr[2m | src/features/ocrService.test.ts > OCRService > processImage > should handle empty text detection results[m                                         
OCR attempt 1 failed: (intermediate value) is not iterable                   
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m [queued][22m                                  [33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m [queued][22m                      [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 0/19[22m                                  [33m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][22m                                   [33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 0/17[22m                                      [33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m [queued][22m                              
                                                                             [2m
 Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [32m[22m[1m0 passed[90m[22m (36)[K[52C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m5.45s[K[60C[?2026l[?2026h
[77C[90m[2;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Real-world prescription text extraction > should handle handwritten prescription with lower confidence[m[K
OCR Service initialized successfully[K
[K[90m
stdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Real-world prescription text extraction > should handle handwritten prescription with lower confidence[m[K
Starting OCR processing for order handwritten-prescription-456[K
OCR attempt 1/3 for image: https://storage.googleapis.com/prescriptions/handwritten-001.jpg[K
[K
[K[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m [queued][22m[K[34C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m [queued][22m[K[22C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 0/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][22m[K[35C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 0/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m [queued][22m[K[30C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [32m[22m[1m0 passed[90m[22m (36)[K[52C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m5.45s[K[60C[?2026l[?2026h
[90m[2;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Real-world prescription text extraction > should handle handwritten prescription with lower confidence[m                                                          
OCR attempt 1 failed: (intermediate value) is not iterable                   
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
[77C[33m[1m[8;1H ❯ [msrc/features/authRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 0/19[33m[22m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 0/17[33m[22m[1m
 ❯ [msrc/features/paymentService.test.ts[2m [queued][22m

[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [32m[22m[1m0 passed[90m[22m (36)[K[52C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m5.45s[K[60C[?2026l
[77C[?2026h[90m[2;1Hstdout[2m | src/features/ocrService.test.ts > OCRService > processImage > should handle empty text detection results[m[K
OCR attempt 2/3 for image: https://example.com/test-image.jpg[K
[K[90m
stdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Real-world prescription text extraction > should handle handwritten prescription with lower confidence[m[K
OCR attempt 2/3 for image: https://storage.googleapis.com/prescriptions/handwritten-001.jpg[K
[K
[K[33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m [queued][22m[K[22C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 2/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][22m[K[35C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 2/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m [queued][22m[K[30C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (36)[K[41C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m6.15s[K[60C[?2026l[?2026h
[77C[90m[2;1Hstderr[2m | src/features/ocrService.test.ts > OCRService > processImage > should handle empty text detection results[m[K
OCR attempt 2 failed: (intermediate value) is not iterable[K
[K[90m
stderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Real-world prescription text extraction > should handle handwritten prescription with lower confidence[m[K
OCR attempt 2 failed: (intermediate value) is not iterable[K
[K
[K[33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 2/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][22m[K[35C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 2/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m [queued][22m[K[30C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (36)[K[41C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m6.15s[K[60C[?2026l[?2026h
[11;1H                                                                             
                                                                             
                                                                             
[77C[90m[2;1Hstdout[2m | src/features/ocrService.test.ts > OCRService > processImage > should handle empty text detection results[m[K
OCR attempt 3/3 for image: https://example.com/test-image.jpg[K
[K[90m
stdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Real-world prescription text extraction > should handle handwritten prescription with lower confidence[m[K
OCR attempt 3/3 for image: https://storage.googleapis.com/prescriptions/handwritten-001.jpg[K[33m[1m[13;1H ❯ [msrc/features/authRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m [queued][22m
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 2/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][22m[K[35C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 2/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m [queued][22m[K[30C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (36)[K[41C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m6.15s[K[60C[?2026l[?2026h
[13;1H                                                                             
[77C[90m[2;1Hstderr[2m | src/features/ocrService.test.ts > OCRService > processImage > should handle empty text detection results[m[K
OCR attempt 3 failed: (intermediate value) is not iterable[K
[K[90m
stderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Real-world prescription text extraction > should handle handwritten prescription with lower confidence[m[K
OCR attempt 3 failed: (intermediate value) is not iterable[K
[K[90m
stderr[2m | src/features/ocrService.test.ts > OCRService > processImage > should handle empty text detection results[m[K
OCR processing failed for order test-order-123: Error: OCR failed after 3 attempts. Last error: (intermediate value) is not iterable
    at OCRService.extractTextWithRetry [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\
[13;77H\features\ocrService.ts:103:11[90m)[K[47C[m
    at OCRService.processImage [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features
[13;77Hs\ocrService.ts:34:32[90m)[K[56C[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.test.ts:84:22
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:20[61C
[77C
[90mstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Real-w[m
[90m[2m[13;77Hworld prescription text extraction > should handle handwritten prescription wi[m
[90m[2m[13;77Hith lower confidence[22m[K[58C[m
OCR processing failed for order handwritten-prescription-456: Error: OCR fail
[13;77Hled after 3 attempts. Last error: (intermediate value) is not iterable        
    at OCRService.extractTextWithRetry [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\
[13;77H\features\ocrService.ts:103:11[90m)[K[47C[m
    at OCRService.processImage [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features
[13;77Hs\ocrService.ts:34:32[90m)[K[56C[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrIntegration.test.ts:1
[13;77H126:22[72C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:20[61C
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m [queued][22m[K[34C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m [queued][22m[K[22C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 2/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][22m[K[35C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 2/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m [queued][22m[K[30C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (36)[K[41C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m6.15s[K[60C[?2026l[?2026h
[7;1H                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
[77C[90m[2;1Hstdout[2m | src/features/ocrService.test.ts > OCRService > processImage > should handle empty extracted text[m[K
OCR Service initialized successfully[K
[K[90m
stdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Real-world prescription text extraction > should handle poor quality image with partial text[m
OCR Service initialized successfully[90m[11;1Hstdout[2m | src/features/ocrService.test.ts > OCRService > processImage > should handle empty extracted text[m
Starting OCR processing for order test-order-123
OCR attempt 1/3 for image: https://example.com/test-image.jpg
[77C
[90mstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Real-w[m
[90m[2m[13;77Hworld prescription text extraction > should handle poor quality image with par[m
[90m[2m[13;77Hrtial text[22m[K[68C[m
Starting OCR processing for order poor-quality-789[27C
OCR attempt 1/3 for image: https://storage.googleapis.com/prescriptions/poor-
[13;77H-quality-001.jpg[62C
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m [queued][22m[K[34C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m [queued][22m[K[22C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 2/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][22m[K[35C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 2/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m [queued][22m[K[30C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (36)[K[41C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m6.15s[K[60C[?2026l[?2026h
[90m[2;1Hstderr[2m | src/features/ocrService.test.ts > OCRService > processImage > should handle empty extracted text[m                                                 
OCR attempt 1 failed: (intermediate value) is not iterable                   
                                                                             [90m
stderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Real-world prescription text extraction > should handle poor quality image with partial text[m                                                                    
OCR attempt 1 failed: (intermediate value) is not iterable                   
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m [queued][22m                                  [33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m [queued][22m                      [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 2/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][22m[K[35C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 2/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m [queued][22m[K[30C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (36)[K[41C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m6.15s[K[60C[?2026l[?2026h
[90m[2;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Real-world prescription text extraction > should handle poor quality image with partial text[m                                                                    
OCR attempt 2/3 for image: https://storage.googleapis.com/prescriptions/poor-quality-001.jpg                                                              
                                                                             [90m
stdout[2m | src/features/ocrService.test.ts > OCRService > processImage > should handle empty extracted text[m                                                 
OCR attempt 2/3 for image: https://example.com/test-image.jpg                
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m [queued][22m                                  [33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m [queued][22m[K[22C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 2/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][22m[K[35C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 2/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m [queued][22m[K[30C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (36)[K[41C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m6.15s[K[60C[?2026l[?2026h
[90m[2;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Real-world prescription text extraction > should handle poor quality image with partial text[m                                                                    
OCR attempt 2 failed: (intermediate value) is not iterable                   
                                                                             [90m
stderr[2m | src/features/ocrService.test.ts > OCRService > processImage > should handle empty extracted text[m                                                 
OCR attempt 2 failed: (intermediate value) is not iterable                   
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m [queued][22m                                  [33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m [queued][22m                      [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 2/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][22m[K[35C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 2/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m [queued][22m[K[30C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (36)[K[41C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m6.15s[K[60C[?2026l
[77C[?2026h[10;1H[K
[K
[K
[K
[K[77C[5;1H[K
[K
[K
[K
[K[77C[90m[2;1Hstdout[2m | src/features/ocrService.test.ts > OCRService > processImage > should handle empty extracted text[m[K
OCR attempt 3/3 for image: https://example.com/test-image.jpg[K[33m[1m[7;1H ❯ [msrc/features/authRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 3/19[33m[22m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 2/17[33m[22m[1m
 ❯ [msrc/features/paymentService.test.ts[2m [queued][14;1H Test Files [32m[22m[1m0 passed[90m[22m (21)[m
[2m      Tests [31m[22m[1m5 failed[m[2m | [32m[22m[1m0 passed[90m[22m (36)[K[41C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m6.43s[K[60C[?2026l
[77C[?2026h[4;1H[K
[K
[K
[K
[K
[K
[K
[K
[K
[K
[K[77C[90m[2;1Hstderr[2m | src/features/ocrService.test.ts > OCRService > processImage > should handle empty extracted text[m[K
OCR attempt 3 failed: (intermediate value) is not iterable[90m[6;1Hstderr[2m | src/features/ocrService.test.ts > OCRService > processImage > should handle empty extracted text[m
OCR processing failed for order test-order-123: Error: OCR failed after 3 attempts. Last error: (intermediate value) is not iterable
    at OCRService.extractTextWithRetry [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.ts:103:11[90m)[m
    at OCRService.processImage [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.ts:34:32[90m)[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.test.ts:98:22
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:20[61C
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m [queued][22m[K[34C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m [queued][22m[K[22C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 3/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][22m[K[35C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 2/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m [queued][22m[K[30C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m5 failed[m[2m | [32m[22m[1m0 passed[90m[22m (36)[K[41C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m6.43s[K[60C[?2026l[?2026h
[13;1H                                                                             
[77C[8;1H[K
[K
[K
[K
[K[77C[90m[2;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Real-world prescription text extraction > should handle poor quality image with partial text[m[K
OCR attempt 3/3 for image: https://storage.googleapis.com/prescriptions/poor-quality-001.jpg[K
[K[33m[1m[9;1H ❯ [msrc/features/authRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 3/19[33m[22m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 2/17[33m[22m[1m
 ❯ [msrc/features/paymentService.test.ts[2m [queued][22m
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m5 failed[m[2m | [32m[22m[1m0 passed[90m[22m (36)[K[41C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m6.43s[K[60C[?2026l[?2026h
[77C[7;1H[K
[K
[K
[K
[K
[K
[K
[K[77C[90m[2;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Real-world prescription text extraction > should handle poor quality image with partial text[m[K
OCR attempt 3 failed: (intermediate value) is not iterable[K
[K[33m[1m[8;1H ❯ [msrc/features/authRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 3/19[33m[22m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 2/17[33m[22m[1m
 ❯ [msrc/features/paymentService.test.ts[2m [queued][22m

[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m5 failed[m[2m | [32m[22m[1m0 passed[90m[22m (36)[K[41C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m6.43s[K[60C[?2026l[?2026h
[2;1H                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
[77C[90m[2;1Hstdout[2m | src/features/ocrService.test.ts > OCRService > processImage > should retry on transient failures[m
OCR Service initialized successfully[90m[6;1Hstdout[2m | src/features/ocrService.test.ts > OCRService > processImage > should retry on transient failures[m
Starting OCR processing for order test-order-123
OCR attempt 1/3 for image: https://example.com/test-image.jpg[33m[1m[12;1H ❯ [msrc/features/authRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 3/19[22m
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][22m[K[35C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 2/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m [queued][22m[K[30C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m5 failed[m[2m | [32m[22m[1m0 passed[90m[22m (36)[K[41C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m6.43s[K[60C
[77C[?2026l[?2026h[13;1H[K
[K[77C[8;1H[K
[K
[K
[K
[K[77C[7;1H[K[77C[6;1H[K[77C[2;1H[K
[K
[K
[K[77C[90m[2;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Real-world prescription text extraction > should handle poor quality image with partial text[m
OCR processing failed for order poor-quality-789: Error: OCR failed after 3 attempts. Last error: (intermediate value) is not iterable
    at OCRService.extractTextWithRetry [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.ts:103:11[90m)[m
    at OCRService.processImage [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.ts:34:32[90m)[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrIntegration.test.ts:153:22
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20
[77C
[90mstderr[2m | src/features/ocrService.test.ts > OCRService > processImage > should[m
[90m[2m[13;77Hd retry on transient failures[22m[K[49C[m
OCR attempt 1 failed: (intermediate value) is not iterable[19C
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m [queued][22m[K[34C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m [queued][22m[K[22C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 3/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][22m[K[35C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 2/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m [queued][22m[K[30C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m5 failed[m[2m | [32m[22m[1m0 passed[90m[22m (36)[K[41C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m6.43s[K[60C[?2026l[?2026h
[4;1H                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
[77C[90m[2;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Google Cloud Vision API error scenarios > should handle QUOTA_EXCEEDED error[m       
OCR Service initialized successfully[90m[6;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Google Cloud Vision API error scenarios > should handle QUOTA_EXCEEDED error[m
Starting OCR processing for order quota-test
OCR attempt 1/3 for image: https://example.com/test.jpg[33m[1m[12;1H ❯ [msrc/features/authRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 3/19[22m
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][22m[K[35C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 2/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m [queued][22m[K[30C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m5 failed[m[2m | [32m[22m[1m0 passed[90m[22m (36)[K[41C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m6.43s[K[60C[?2026l[?2026h
[90m[2;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Google Cloud Vision API error scenarios > should handle QUOTA_EXCEEDED error[m       
OCR attempt 1 failed: (intermediate value) is not iterable                   
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m [queued][22m                                  [33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m [queued][22m                      [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 3/19[22m                                  [33m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][22m                                   [33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 2/17[22m                                      [33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m [queued][22m                              
                                                                             [2m
 Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m5 failed[m[2m | [32m[22m[1m0 passed[90m[22m (36)[K[41C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m6.43s[K[60C[?2026l
[77C[?2026h[90m[2;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Google Cloud Vision API error scenarios > should handle QUOTA_EXCEEDED error[m       
OCR attempt 2/3 for image: https://example.com/test.jpg[K
[K[90m
stdout[2m | src/features/ocrService.test.ts > OCRService > processImage > should retry on transient failures[m[K
OCR attempt 2/3 for image: https://example.com/test-image.jpg[K
[K
[K[33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 0/20[22m[K[33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 4/19[22m[K[33m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][22m[K[35C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 4/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m8 failed[m[2m | [32m[22m[1m0 passed[90m[22m (73)[K[41C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m6.92s[K[60C[?2026l[?2026h
[90m[2;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Google Cloud Vision API error scenarios > should handle QUOTA_EXCEEDED error[m       
OCR attempt 2 failed: (intermediate value) is not iterable                   
                                                                             [90m
stderr[2m | src/features/ocrService.test.ts > OCRService > processImage > should retry on transient failures[m                                                 
OCR attempt 2 failed: (intermediate value) is not iterable                   
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m [queued][22m                                  [33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 0/20[22m                          [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 4/19[22m                                  [33m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][22m[K[35C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 4/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m8 failed[m[2m | [32m[22m[1m0 passed[90m[22m (73)[K[41C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m6.92s[K[60C[?2026l[?2026h
[90m[2;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Google Cloud Vision API error scenarios > should handle QUOTA_EXCEEDED error[m       
OCR attempt 3/3 for image: https://example.com/test.jpg                      
                                                                             [90m
stdout[2m | src/features/ocrService.test.ts > OCRService > processImage > should retry on transient failures[m                                                 
OCR attempt 3/3 for image: https://example.com/test-image.jpg                
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m [queued][22m                                  [33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 0/20[22m                          [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 4/19[22m                                  [33m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][22m[K[35C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 4/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m8 failed[m[2m | [32m[22m[1m0 passed[90m[22m (73)[K[41C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m6.92s[K[60C[?2026l[?2026h
[9;1H                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
[77C[90m[2;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Google Cloud Vision API error scenarios > should handle QUOTA_EXCEEDED error[m       
OCR attempt 3 failed: (intermediate value) is not iterable[K
[K[90m
stderr[2m | src/features/ocrService.test.ts > OCRService > processImage > should retry on transient failures[m[K
OCR attempt 3 failed: (intermediate value) is not iterable[K[90m[10;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Google Cloud Vision API error scenarios > should handle QUOTA_EXCEEDED error[m
OCR processing failed for order quota-test: Error: OCR failed after 3 attempts. Last error: (intermediate value) is not iterable
    at OCRService.extractTextWithRetry [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\
[13;77H\features\ocrService.ts:103:11[90m)[K[47C[m
    at OCRService.processImage [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features
[13;77Hs\ocrService.ts:34:32[90m)[K[56C[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrIntegration.test.ts:1
[13;77H174:22[72C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:20[61C
[77C
[90mstderr[2m | src/features/ocrService.test.ts > OCRService > processImage > should[m
[90m[2m[13;77Hd retry on transient failures[22m[K[49C[m
OCR processing failed for order test-order-123: Error: OCR failed after 3 att
[13;77Htempts. Last error: (intermediate value) is not iterable[22C
    at OCRService.extractTextWithRetry [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\
[13;77H\features\ocrService.ts:103:11[90m)[K[47C[m
    at OCRService.processImage [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features
[13;77Hs\ocrService.ts:34:32[90m)[K[56C[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.test.ts:116:2
[13;77H22[76C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:20[61C
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m [queued][22m[K[34C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 0/20[22m[K[26C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 4/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][22m[K[35C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 4/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m8 failed[m[2m | [32m[22m[1m0 passed[90m[22m (73)[K[41C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m6.92s[K[60C[?2026l[?2026h
[90m[2;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Google Cloud Vision API error scenarios > should handle PERMISSION_DENIED error[m    
OCR Service initialized successfully                                         
                                                                             [90m
stdout[2m | src/features/ocrService.test.ts > OCRService > processImage > should fail after max retries[m                                                      
OCR Service initialized successfully                                         
                                                                             [90m
stdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Google Cloud Vision API error scenarios > should handle PERMISSION_DENIED error[m    
Starting OCR processing for order permission-test                            
OCR attempt 1/3 for image: https://example.com/test.jpg                      
[77C
[90mstdout[2m | src/features/ocrService.test.ts > OCRService > processImage > should[m
[90m[2m[13;77Hd fail after max retries[22m[K[54C[m
Starting OCR processing for order test-order-123[29C
OCR attempt 1/3 for image: https://example.com/test-image.jpg[16C
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m [queued][22m[K[34C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 0/20[22m[K[26C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 4/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][22m[K[35C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 4/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m8 failed[m[2m | [32m[22m[1m0 passed[90m[22m (73)[K[41C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m6.92s[K[60C[?2026l[?2026h
[9;1H                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
[77C[90m[2;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Google Cloud Vision API error scenarios > should handle PERMISSION_DENIED error[m    
OCR attempt 1 failed: (intermediate value) is not iterable[K
[K[90m
stderr[2m | src/features/ocrService.test.ts > OCRService > processImage > should fail after max retries[m[K
OCR attempt 1 failed: (intermediate value) is not iterable[K[33m[1m[11;1H ❯ [msrc/features/authRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 0/20[33m[22m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 4/19[33m[22m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][22m
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 4/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m8 failed[m[2m | [32m[22m[1m0 passed[90m[22m (73)[K[41C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m6.92s[K[60C[?2026l[?2026h
[90m[2;1Hstdout[2m | src/features/ocrService.test.ts > OCRService > processImage > should fail after max retries[m                                                      
OCR attempt 2/3 for image: https://example.com/test-image.jpg                
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m [queued][22m                                  [33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 0/20[22m                          [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 4/19[22m                                  [33m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][22m                                   [33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 4/17[22m                                      [33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m                                  
                                                                             [2m
 Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m8 failed[m[2m | [32m[22m[1m0 passed[90m[22m (73)[K[41C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m6.92s[K[60C[?2026l[?2026h
[3;1H                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
[77C[90m[2;1Hstderr[2m | src/features/ocrService.test.ts > OCRService > processImage > should fail after max retries[m
OCR attempt 2 failed: (intermediate value) is not iterable[33m[1m[7;1H ❯ [msrc/features/authRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 0/20[33m[22m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 4/19[33m[22m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 4/17[33m[22m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 0/17[14;1H Test Files [32m[22m[1m0 passed[90m[22m (21)[m
[2m      Tests [31m[22m[1m8 failed[m[2m | [32m[22m[1m0 passed[90m[22m (73)[K[41C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m6.92s[K[60C[?2026l[?2026h
[90m[2;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Google Cloud Vision API error scenarios > should handle PERMISSION_DENIED error[m    
OCR attempt 2/3 for image: https://example.com/test.jpg                      
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m [queued][22m                                  [33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 0/20[22m                          [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 4/19[22m                                  [33m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][22m                                   [33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 4/17[22m                                      [33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m                                  
                                                                             [2m
 Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m8 failed[m[2m | [32m[22m[1m0 passed[90m[22m (73)[K[41C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m6.92s[K[60C[?2026l[?2026h
[90m[2;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Google Cloud Vision API error scenarios > should handle PERMISSION_DENIED error[m    
OCR attempt 2 failed: (intermediate value) is not iterable                   
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m [queued][22m                                  [33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 0/20[22m                          [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 4/19[22m                                  [33m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m [queued][22m                                   [33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 4/17[22m                                      [33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m                                  
                                                                             [2m
 Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m8 failed[m[2m | [32m[22m[1m0 passed[90m[22m (73)[K[41C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m6.92s[K[60C[?2026l
[77C[?2026h[90m[2;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Google Cloud Vision API error scenarios > should handle PERMISSION_DENIED error[m    
OCR attempt 3/3 for image: https://example.com/test.jpg[K
[K
[K[33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 0/26[22m[K[33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 0/20[22m[K[33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 4/19[22m[K[33m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m 0/18[22m[K[33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 5/17[22m[K[33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K
[K[2m
 Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m9 failed[m[2m | [32m[22m[1m0 passed[90m[22m (117)[K[40C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m7.30s[K[60C[?2026l[?2026h
[11;1H                                                                             
                                                                             
                                                                             
[77C[90m[2;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Google Cloud Vision API error scenarios > should handle PERMISSION_DENIED error[m    
OCR attempt 3 failed: (intermediate value) is not iterable[K
[K[90m
stderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Google Cloud Vision API error scenarios > should handle PERMISSION_DENIED error[m    
OCR processing failed for order permission-test: Error: OCR failed after 3 attempts. Last error: (intermediate value) is not iterable[K
    at OCRService.extractTextWithRetry [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.ts:103:11[90m)[m
    at OCRService.processImage [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.ts:34:32[90m)[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrIntegration.test.ts:1
[13;77H192:22[72C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:20[61C
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 0/26[22m[K[38C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 0/20[22m[K[26C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 4/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 0/18[22m[K[39C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 5/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m9 failed[m[2m | [32m[22m[1m0 passed[90m[22m (117)[K[40C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m7.30s[K[60C[?2026l
[77C[?2026h[90m[2;1Hstdout[2m | src/features/ocrService.test.ts > OCRService > processImage > should fail after max retries[m[K
OCR attempt 3/3 for image: https://example.com/test-image.jpg[K
[K
[K[33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 0/26[22m[K[33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 0/20[22m[K[33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 4/19[22m[K[33m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m 0/18[22m[K[33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 5/17[22m[K[33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K
[K[2m
 Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m9 failed[m[2m | [32m[22m[1m0 passed[90m[22m (117)[K[40C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m7.30s[K[60C[?2026l[?2026h
[10;1H                                                                             
                                                                             
                                                                             
                                                                             
[77C[90m[2;1Hstderr[2m | src/features/ocrService.test.ts > OCRService > processImage > should fail after max retries[m[K
OCR attempt 3 failed: (intermediate value) is not iterable[K
[K[90m
stderr[2m | src/features/ocrService.test.ts > OCRService > processImage > should fail after max retries[m[K
OCR processing failed for order test-order-123: Error: OCR failed after 3 attempts. Last error: (intermediate value) is not iterable[K
    at OCRService.extractTextWithRetry [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.ts:103:11[90m)[m
    at OCRService.processImage [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.ts:34:32[90m)[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.test.ts:127:2
[13;77H22[76C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:20[61C
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 0/26[22m[K[38C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 0/20[22m[K[26C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 4/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 0/18[22m[K[39C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 5/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m9 failed[m[2m | [32m[22m[1m0 passed[90m[22m (117)[K[40C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m7.30s[K[60C[?2026l[?2026h
[9;1H                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
[77C[90m[2;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Google Cloud Vision API error scenarios > should handle INVALID_ARGUMENT for unsupported image format[m[K
OCR Service initialized successfully[K
[K[90m
stdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Google Cloud Vision API error scenarios > should handle INVALID_ARGUMENT for unsupported image format[m
Starting OCR processing for order invalid-format-test
OCR attempt 1/3 for image: https://example.com/document.tiff[33m[1m[14;1H ❯ [msrc/features/authRoutes.test.ts[2m 0/26[22m
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 0/20[22m[K[26C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 4/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 0/18[22m[K[39C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 5/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m9 failed[m[2m | [32m[22m[1m0 passed[90m[22m (117)[K[40C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m7.30s[K[60C[?2026l[?2026h
[90m[2;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Google Cloud Vision API error scenarios > should handle INVALID_ARGUMENT for unsupported image format[m                                                           
OCR attempt 1 failed: (intermediate value) is not iterable                   
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 0/26[22m                                      [33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 0/20[22m                          [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 4/19[22m                                  [33m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m 0/18[22m                                       [33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 5/17[22m                                      [33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m                                  
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m9 failed[m[2m | [32m[22m[1m0 passed[90m[22m (117)[K[40C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m7.30s[K[60C[?2026l[?2026h
[7;1H                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
[77C[90m[2;1Hstdout[2m | src/features/ocrService.test.ts > OCRService > processImage > should handle Vision API errors gracefully[m[K
OCR Service initialized successfully[K
[K[90m
stdout[2m | src/features/ocrService.test.ts > OCRService > processImage > should handle Vision API errors gracefully[m
Starting OCR processing for order test-order-123
OCR attempt 1/3 for image: https://example.com/test-image.jpg[33m[1m[12;1H ❯ [msrc/features/authRoutes.test.ts[2m 0/26[33m[22m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 0/20[33m[22m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 4/19[22m
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 0/18[22m[K[39C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 5/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m9 failed[m[2m | [32m[22m[1m0 passed[90m[22m (117)[K[40C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m7.30s[K[60C[?2026l[?2026h
[90m[2;1Hstderr[2m | src/features/ocrService.test.ts > OCRService > processImage > should handle Vision API errors gracefully[m                                         
OCR attempt 1 failed: (intermediate value) is not iterable                   
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 0/26[22m                                      [33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 0/20[22m                          [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 4/19[22m                                  [33m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m 0/18[22m                                       [33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 5/17[22m                                      [33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m                                  
                                                                             [2m
 Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m9 failed[m[2m | [32m[22m[1m0 passed[90m[22m (117)[K[40C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m7.30s[K[60C[?2026l[?2026h
[90m[2;1Hstdout[2m | src/features/ocrRoutes.test.ts > OCR Routes > POST /orders/:orderId/process-ocr > should start OCR processing for valid order[m                    
Received OCR processing request for order: test-order-123                    
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 0/26[22m                                      [33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 0/20[22m                          [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 4/19[22m                                  [33m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m 0/18[22m                                       [33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 5/17[22m                                      [33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m                                  
                                                                             [2m
 Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m9 failed[m[2m | [32m[22m[1m0 passed[90m[22m (117)[K[40C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m7.30s[K[60C[?2026l[?2026h
[77C[90m[2;1Hstderr[2m | src/features/ocrRoutes.test.ts > OCR Routes > POST /orders/:orderId/process-ocr > should start OCR processing for valid order[m[K
Unexpected error during async OCR processing setup for order: test-order-123 TypeError: __vite_ssr_import_1__.ocrService.processImageAndUpdateOrder is not a function[K
    at processOCRAsync [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrRoutes.ts:183:22[90m)[K[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrRoutes.ts:79:5       [90m
    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
[K
[K[33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 0/26[22m[K[33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 0/20[22m
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 4/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 0/18[22m[K[39C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 5/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m9 failed[m[2m | [32m[22m[1m0 passed[90m[22m (117)[K[40C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m7.30s[K[60C[?2026l
[77C[?2026h[90m[2;1Hstdout[2m | src/features/ocrService.test.ts > OCRService > processImage > should handle Vision API errors gracefully[m[K
OCR attempt 2/3 for image: https://example.com/test-image.jpg[K
[K[90m
stdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Google Cloud Vision API error scenarios > should handle INVALID_ARGUMENT for unsupported image format[m[K
OCR attempt 2/3 for image: https://example.com/document.tiff[K
[K[90m
stdout[2m | src/features/ocrRoutes.test.ts > OCR Routes > POST /orders/:orderId/process-ocr > should return 404 for non-existent order[m[K
Received OCR processing request for order: test-order-123[K
[K[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 0/26[22m[K[38C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 3/20[22m[K[26C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 5/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 4/18[22m[K[39C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 5/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m10 failed[m[2m | [32m[22m[1m7 passed[90m[22m (117)[K[39C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m7.53s[K[60C[?2026l[?2026h
[77C[90m[2;1Hstderr[2m | src/features/ocrService.test.ts > OCRService > processImage > should handle Vision API errors gracefully[m[K
OCR attempt 2 failed: (intermediate value) is not iterable[K
[K[90m
stderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Google Cloud Vision API error scenarios > should handle INVALID_ARGUMENT for unsupported image format[m[K
OCR attempt 2 failed: (intermediate value) is not iterable[K
[K
[K[33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 0/26[22m[K[33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 3/20[22m[K[33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 5/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 4/18[22m[K[39C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 5/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m10 failed[m[2m | [32m[22m[1m7 passed[90m[22m (117)[K[39C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m7.53s[K[60C[?2026l[?2026h
[2;1H                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
[77C[90m[2;1Hstdout[2m | src/features/ocrRoutes.test.ts > OCR Routes > POST /orders/:orderId/process-ocr > should return 400 for order without image URL[m
Received OCR processing request for order: test-order-123[33m[1m[7;1H ❯ [msrc/features/authRoutes.test.ts[2m 0/26[33m[22m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 3/20[33m[22m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 5/19[33m[22m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m 4/18[33m[22m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 5/17[33m[22m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 0/17[14;1H Test Files [32m[22m[1m0 passed[90m[22m (21)[m
[2m      Tests [31m[22m[1m10 failed[m[2m | [32m[22m[1m7 passed[90m[22m (117)[K[39C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m7.53s[K[60C[?2026l[?2026h
[90m[2;1Hstderr[2m | src/features/authRoutes.test.ts > Auth Routes > POST /auth/register > successfully registers a new user with email[m                               
Error in POST /auth/register: TypeError: Cannot read properties of undefined (reading 'uid')                                                              
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\authRoutes.ts:85:19     
    at Layer.handle [as handle_request] (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\layer.js:95:5)                                           
    at next (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\route.js:149:13)                                                                     
    at verifyFirebaseToken [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\authRoutes.ts:39:5[90m)                                                             
    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 0/26[22m[K[38C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 3/20[22m[K[26C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 5/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 4/18[22m[K[39C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 5/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m10 failed[m[2m | [32m[22m[1m7 passed[90m[22m (117)[K[39C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m7.53s[K[60C[?2026l[?2026h
[90m[2;1Hstdout[2m | src/features/ocrRoutes.test.ts > OCR Routes > POST /orders/:orderId/process-ocr > should return 409 if OCR already in progress[m                   
Received OCR processing request for order: test-order-123                    
                                                                             [90m
stdout[2m | src/features/ocrRoutes.test.ts > OCR Routes > POST /orders/:orderId/process-ocr > should return completed OCR if already processed[m               
Received OCR processing request for order: test-order-123                    
                                                                             [90m
stdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Google Cloud Vision API error scenarios > should handle INVALID_ARGUMENT for unsupported image format[m                                                           
OCR attempt 3/3 for image: https://example.com/document.tiff                 
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 0/26[22m[K[38C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 3/20[22m[K[26C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 5/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 4/18[22m[K[39C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 5/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m10 failed[m[2m | [32m[22m[1m7 passed[90m[22m (117)[K[39C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m7.53s[K[60C[?2026l[?2026h
[90m[2;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Google Cloud Vision API error scenarios > should handle INVALID_ARGUMENT for unsupported image format[m                                                           
OCR attempt 3 failed: (intermediate value) is not iterable                   
                                                                             [90m
stderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Google Cloud Vision API error scenarios > should handle INVALID_ARGUMENT for unsupported image format[m                                                           
OCR processing failed for order invalid-format-test: Error: OCR failed after 3 attempts. Last error: (intermediate value) is not iterable                 
    at OCRService.extractTextWithRetry [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.ts:103:11[90m)                                               [m
    at OCRService.processImage [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features
[13;77Hs\ocrService.ts:34:32[90m)[K[56C[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrIntegration.test.ts:2
[13;77H210:22[72C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:20[61C
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 0/26[22m[K[38C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 3/20[22m[K[26C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 5/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 4/18[22m[K[39C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 5/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m10 failed[m[2m | [32m[22m[1m7 passed[90m[22m (117)[K[39C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m7.53s[K[60C[?2026l[?2026h
[90m[2;1Hstdout[2m | src/features/ocrService.test.ts > OCRService > processImage > should handle Vision API errors gracefully[m                                         
OCR attempt 3/3 for image: https://example.com/test-image.jpg                
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 0/26[22m                                      [33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 3/20[22m                          [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 5/19[22m                                  [33m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m 4/18[22m                                       [33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 5/17[22m                                      [33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m                                  
                                                                             [2m
 Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m10 failed[m[2m | [32m[22m[1m7 passed[90m[22m (117)[K[39C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m7.53s[K[60C[?2026l
[77C[?2026h[90m[2;1Hstderr[2m | src/features/ocrService.test.ts > OCRService > processImage > should handle Vision API errors gracefully[m[K
OCR attempt 3 failed: (intermediate value) is not iterable[K
[K[90m
stderr[2m | src/features/ocrService.test.ts > OCRService > processImage > should handle Vision API errors gracefully[m[K
OCR processing failed for order test-order-123: Error: OCR failed after 3 attempts. Last error: (intermediate value) is not iterable[K
    at OCRService.extractTextWithRetry [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.ts:103:11[90m)[K[m
    at OCRService.processImage [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.ts:34:32[90m)[K[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.test.ts:137:2
[13;77H22[76C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:20[61C
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 0/26[22m[K[38C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 3/20[22m[K[26C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 5/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 4/18[22m[K[39C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 5/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m10 failed[m[2m | [32m[22m[1m7 passed[90m[22m (117)[K[39C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m7.53s[K[60C[?2026l[?2026h
[90m[2;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Google Cloud Vision API error scenarios > should handle network timeout errors[m     
OCR Service initialized successfully                                         
                                                                             [90m
stdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Google Cloud Vision API error scenarios > should handle network timeout errors[m     
Starting OCR processing for order timeout-test                               
OCR attempt 1/3 for image: https://example.com/large-image.jpg               
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 0/26[22m                                      [33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 3/20[22m                          [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 5/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 4/18[22m[K[39C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 5/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m10 failed[m[2m | [32m[22m[1m7 passed[90m[22m (117)[K[39C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m7.53s[K[60C[?2026l[?2026h
[90m[2;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Google Cloud Vision API error scenarios > should handle network timeout errors[m     
OCR attempt 1 failed: (intermediate value) is not iterable                   
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
[77C[33m[1m[7;1H ❯ [msrc/features/authRoutes.test.ts[2m 0/26[33m[22m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 3/20[33m[22m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 5/19[33m[22m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m 4/18[33m[22m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 5/17[33m[22m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 0/17[14;1H Test Files [32m[22m[1m0 passed[90m[22m (21)[m
[2m      Tests [31m[22m[1m10 failed[m[2m | [32m[22m[1m7 passed[90m[22m (117)[K[39C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m7.53s[K[60C[?2026l[?2026h
[90m[2;1Hstdout[2m | src/features/ocrRoutes.test.ts > OCR Routes > POST /orders/:orderId/process-ocr > should return 400 for invalid image URL[m                        
Received OCR processing request for order: test-order-123                    
                                                                             [90m
stdout[2m | src/features/ocrService.test.ts > OCRService > validateImageForOCR > should validate correct image URLs[m                                          
OCR Service initialized successfully                                         
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 0/26[22m                                      [33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 3/20[22m                          [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 5/19[22m                                  [33m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m 4/18[22m[K[39C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 5/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m10 failed[m[2m | [32m[22m[1m7 passed[90m[22m (117)[K[39C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m7.53s[K[60C[?2026l
[77C[?2026h[K[77C[11;1H[K
[K
[K[77C[7;1H[K
[K
[K
[K[77C[90m[2;1Hstderr[2m | src/features/authRoutes.test.ts > Auth Routes > POST /auth/register > successfully registers a new user with phone number[m[K
Error in POST /auth/register: TypeError: Cannot read properties of undefined (reading 'uid')[K
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\authRoutes.ts:85:19     
    at Layer.handle [as handle_request] (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\layer.js:95:5)
    at next (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\route.js:149:13)
    at verifyFirebaseToken [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\authRoutes.ts:39:5[90m)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)[m

[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 3/26[22m[K[38C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 6/20[22m[K[26C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 6/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 9/18[22m[K[39C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 7/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m15 failed[m[2m | [32m[22m[1m16 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m7.80s[K[60C[?2026l[?2026h
[12;1H                                                                             
                                                                             
[77C[90m[2;1Hstdout[2m | src/features/ocrRoutes.test.ts > OCR Routes > POST /orders/:orderId/process-ocr > should handle database errors[m[K
Received OCR processing request for order: test-order-123[K
[K[90m
stdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Google Cloud Vision API error scenarios > should handle network timeout errors[m     
OCR attempt 2/3 for image: https://example.com/large-image.jpg[K
[K
[K[33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 3/26[22m[K[33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 6/20[33m[22m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 6/19[33m[22m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m 9/18[22m
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 7/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m15 failed[m[2m | [32m[22m[1m16 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m7.80s[K[60C[?2026l[?2026h
[90m[2;1Hstderr[2m | src/features/ocrRoutes.test.ts > OCR Routes > POST /orders/:orderId/process-ocr > should handle database errors[m                                  
Error processing OCR request: Error: Database connection failed              
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrRoutes.test.ts:209:40
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:155:11                                                             
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:26                                                             
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1897:20                                                            
    at new Promise (<anonymous>)                                             
    at runWithTimeout (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1863:10)[43C
    at runTest (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/d
[13;77Hdist/chunk-hooks.js:1574:12)[50C
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 3/26[22m[K[38C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 6/20[22m[K[26C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 6/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 9/18[22m[K[39C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 7/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m15 failed[m[2m | [32m[22m[1m16 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m7.80s[K[60C[?2026l[?2026h
[12;1H                                                                             
                                                                             
[77C[90m[2;1Hstdout[2m | src/features/ocrService.test.ts > OCRService > validateImageForOCR > should reject empty or invalid URLs[m[K
OCR Service initialized successfully[K
[K
[K[33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 3/26[22m[K[33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 6/20[22m[K[33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 6/19[22m[K[33m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m 9/18[22m[K[33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 7/17[22m[K[33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 0/17[14;1H Test Files [32m[22m[1m0 passed[90m[22m (21)[m
[2m      Tests [31m[22m[1m15 failed[m[2m | [32m[22m[1m16 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m7.80s[K[60C[?2026l[?2026h
[90m[2;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Google Cloud Vision API error scenarios > should handle network timeout errors[m     
OCR attempt 2 failed: (intermediate value) is not iterable                   
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 3/26[22m                                      [33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 6/20[22m                          [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 6/19[22m                                  [33m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m 9/18[22m                                       [33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 7/17[22m                                      [33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m                                  
                                                                             [2m
 Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m15 failed[m[2m | [32m[22m[1m16 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m7.80s[K[60C[?2026l[?2026h
[90m[2;1Hstdout[2m | src/features/ocrRoutes.test.ts > OCR Routes > GET /orders/:orderId/ocr-status > should return OCR status for existing order[m                      
Checking OCR status for order: test-order-456                                
                                                                             [90m
stdout[2m | src/features/ocrRoutes.test.ts > OCR Routes > GET /orders/:orderId/ocr-status > should return 404 for non-existent order[m                         
Checking OCR status for order: test-order-456                                
                                                                             [90m
stdout[2m | src/features/ocrService.test.ts > OCRService > validateImageForOCR > should reject unsupported file types[m                                        
OCR Service initialized successfully                                         
                                                                             [90m
stdout[2m | src/features/ocrService.test.ts > OCRService > validateImageForOCR >[m
[90m[2m[13;77H> should accept supported file types[22m[K[42C[m
OCR Service initialized successfully[41C
[77C
[90mstdout[2m | src/features/ocrService.test.ts > OCRService > healthCheck > should [m
[90m[2m[13;77H return true when service is healthy[22m[K[42C[m
OCR Service initialized successfully[41C
[77C
[90mstdout[2m | src/features/ocrRoutes.test.ts > OCR Routes > GET /orders/:orderId/o[m
[90m[2m[13;77Hocr-status > should return pending status for orders without OCR data[22m[K[9C[m
Checking OCR status for order: test-order-456[32C
[77C
[90mstdout[2m | src/features/ocrService.test.ts > OCRService > healthCheck > should [m
[90m[2m[13;77H return false when service is unhealthy[22m[K[39C[m
OCR Service initialized successfully[41C
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 3/26[22m[K[38C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 6/20[22m[K[26C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 6/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 9/18[22m[K[39C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 7/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m15 failed[m[2m | [32m[22m[1m16 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m7.80s[K[60C[?2026l[?2026h
[90m[2;1Hstderr[2m | src/features/authRoutes.test.ts > Auth Routes > POST /auth/register > returns 401 with invalid token[m                                             
Error in POST /auth/register: TypeError: Cannot read properties of undefined (reading 'uid')                                                              
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\authRoutes.ts:85:19     
    at Layer.handle [as handle_request] (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\layer.js:95:5)                                           
    at next (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\route.js:149:13)                                                                     
    at verifyFirebaseToken [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\authRoutes.ts:39:5[90m)                                                             
    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 3/26[22m[K[38C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 6/20[22m[K[26C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 6/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 9/18[22m[K[39C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 7/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m15 failed[m[2m | [32m[22m[1m16 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m7.80s[K[60C[?2026l[?2026h
[90m[2;1Hstdout[2m | src/features/ocrService.test.ts > OCRService > error scenarios > should handle malformed Vision API responses[m                                    
OCR Service initialized successfully                                         
                                                                             [90m
stdout[2m | src/features/ocrService.test.ts > OCRService > error scenarios > should handle malformed Vision API responses[m                                    
Starting OCR processing for order test-order                                 
OCR attempt 1/3 for image: https://example.com/image.jpg                     
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 3/26[22m                                      [33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 6/20[22m                          [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 6/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 9/18[22m[K[39C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 7/17[22m[K[38C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m15 failed[m[2m | [32m[22m[1m16 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m7.80s[K[60C[?2026l[?2026h
[5;1H                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
[77C[90m[2;1Hstderr[2m | src/features/ocrService.test.ts > OCRService > error scenarios > should handle malformed Vision API responses[m[K
OCR attempt 1 failed: (intermediate value) is not iterable[K[33m[1m[7;1H ❯ [msrc/features/authRoutes.test.ts[2m 3/26[33m[22m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 6/20[33m[22m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 6/19[33m[22m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m 9/18[33m[22m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 7/17[33m[22m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 0/17[14;1H Test Files [32m[22m[1m0 passed[90m[22m (21)[m
[2m      Tests [31m[22m[1m15 failed[m[2m | [32m[22m[1m16 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m7.80s[K[60C[?2026l[?2026h
[90m[2;1Hstdout[2m | src/features/ocrRoutes.test.ts > OCR Routes > GET /orders/:orderId/ocr-status > should return failed status with error message[m                   
Checking OCR status for order: test-order-456                                
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 3/26[22m                                      [33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 6/20[22m                          [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 6/19[22m                                  [33m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m 9/18[22m                                       [33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 7/17[22m                                      [33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m                                  
                                                                             [2m
 Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m15 failed[m[2m | [32m[22m[1m16 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m7.80s[K[60C[?2026l
[77C[?2026h[90m[2;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Google Cloud Vision API error scenarios > should handle network timeout errors[m     
OCR attempt 3/3 for image: https://example.com/large-image.jpg[K
[K[90m
stdout[2m | src/features/ocrService.test.ts > OCRService > error scenarios > should handle malformed Vision API responses[m[K
OCR attempt 2/3 for image: https://example.com/image.jpg[K
[K
[K[33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 7/26[22m[K[33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 11/20[22m[K[33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 7/19[22m[K[33m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m 15/18[22m[K[38C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 12/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m22 failed[m[2m | [32m[22m[1m30 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m8.03s[K[60C[?2026l[?2026h
[77C[90m[2;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Google Cloud Vision API error scenarios > should handle network timeout errors[m     
OCR attempt 3 failed: (intermediate value) is not iterable[K
[K[90m
stderr[2m | src/features/ocrRoutes.test.ts > OCR Routes > GET /ocr/health > should handle health check errors[m[K
Error checking OCR health: Error: Health check failed[K
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrRoutes.test.ts:366:52
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:155:11[K
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:26[K
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:1897:20[60C
    at new Promise (<anonymous>)[45C
    at runWithTimeout (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/r
[13;77Hrunner/dist/chunk-hooks.js:1863:10)[43C
    at runTest (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/d
[13;77Hdist/chunk-hooks.js:1574:12)[50C
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
[77C
[90mstderr[2m | src/features/ocrService.test.ts > OCRService > error scenarios > sho[m
[90m[2m[13;77Hould handle malformed Vision API responses[22m[K[36C[m
OCR attempt 2 failed: (intermediate value) is not iterable[19C
[77C
[90mstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Google[m
[90m[2m[13;77He Cloud Vision API error scenarios > should handle network timeout errors[22m     [m
OCR processing failed for order timeout-test: Error: OCR failed after 3 attem
[13;77Hmpts. Last error: (intermediate value) is not iterable[24C
    at OCRService.extractTextWithRetry [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\
[13;77H\features\ocrService.ts:103:11[90m)[K[47C[m
    at OCRService.processImage [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features
[13;77Hs\ocrService.ts:34:32[90m)[K[56C[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrIntegration.test.ts:2
[13;77H228:22[72C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:20[61C
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 7/26[22m[K[38C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 11/20[22m[K[25C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 7/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 15/18[22m[K[38C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 12/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m22 failed[m[2m | [32m[22m[1m30 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m8.03s[K[60C[?2026l[?2026h
[90m[2;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Retry logic with transient failures > should succeed after transient network error[m 
OCR Service initialized successfully                                         
                                                                             [90m
stdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Retry logic with transient failures > should succeed after transient network error[m 
Starting OCR processing for order retry-success-test                         
OCR attempt 1/3 for image: https://example.com/prescription.jpg              
                                                                             [90m
stdout[2m | src/features/ocrRoutes.test.ts > OCR Routes > async OCR processing > should process OCR and update order on success[m                              
Received OCR processing request for order: async-test-order                  
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 7/26[22m[K[38C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 11/20[22m[K[25C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 7/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 15/18[22m[K[38C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 12/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m22 failed[m[2m | [32m[22m[1m30 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m8.03s[K[60C[?2026l[?2026h
[90m[2;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Retry logic with transient failures > should succeed after transient network error[m 
OCR attempt 1 failed: (intermediate value) is not iterable                   
                                                                             [90m
stderr[2m | src/features/ocrRoutes.test.ts > OCR Routes > async OCR processing > should process OCR and update order on success[m                              
Unexpected error during async OCR processing setup for order: async-test-order TypeError: __vite_ssr_import_1__.ocrService.processImageAndUpdateOrder is not a function                                                                
    at processOCRAsync [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrRoutes.ts:183:22[90m)                                                                [m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrRoutes.ts:79:5       [90m
    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 7/26[22m[K[38C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 11/20[22m[K[25C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 7/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 15/18[22m[K[38C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 12/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m22 failed[m[2m | [32m[22m[1m30 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m8.03s[K[60C[?2026l[?2026h
[13;1H                                                                             
[77C[90m[2;1Hstdout[2m | src/features/ocrRoutes.test.ts > OCR Routes > error handling > should handle invalid JSON in request body[m[K
Received OCR processing request for order: test[K
[K
[K[33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 7/26[22m[K[33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 11/20[22m[K[33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 7/19[22m[K[33m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m 15/18[22m[K[33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 12/17[22m[K[33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[2m[14;1H Test Files [32m[22m[1m0 passed[90m[22m (21)[m
[2m      Tests [31m[22m[1m22 failed[m[2m | [32m[22m[1m30 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m8.03s[K[60C[?2026l[?2026h
[90m[2;1Hstderr[2m | src/features/ocrRoutes.test.ts > OCR Routes > error handling > should handle invalid JSON in request body[m                                        
Error processing OCR request: TypeError: Cannot read properties of undefined (reading 'doc')                                                              
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrRoutes.ts:19:56      
    at Layer.handle [as handle_request] (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\layer.js:95:5)                                           
    at next (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\route.js:149:13)                                                                     
    at Route.dispatch (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\route.js:119:3)                                                            
    at Layer.handle [as handle_request] (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\layer.js:95:5)[K[43C
    at C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\index.js:284:1
[13;77H15[76C
    at param (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\index.j
[13;77Hjs:365:14)[68C
    at param (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\index.j
[13;77Hjs:376:14)[68C
    at Function.process_params (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\
[13;77H\lib\router\index.js:421:3)[51C
    at next (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\index.js
[13;77Hs:280:10)[69C
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 7/26[22m[K[38C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 11/20[22m[K[25C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 7/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 15/18[22m[K[38C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 12/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [32m[22m[1m0 passed[90m[22m (21)[K[52C[m
[2m      Tests [31m[22m[1m22 failed[m[2m | [32m[22m[1m30 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m8.03s[K[60C[?2026l
[77C[?2026h[90m[2;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Retry logic with transient failures > should succeed after transient network error[m 
OCR attempt 2/3 for image: https://example.com/prescription.jpg[K
[K
[K[33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 10/26[22m[K[33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 15/20[22m[K[33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 7/19[22m[K[33m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m 18/18[22m[K[33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 13/17[22m[K[33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K
[K[2m
 Test Files [31m[22m[1m1 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m26 failed[m[2m | [32m[22m[1m37 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m8.15s[K[60C[?2026l[?2026h
[90m[2;1Hstderr[2m | src/features/authRoutes.test.ts > Auth Routes > POST /auth/register > returns 403 when token UID does not match request UID[m                      
Error in POST /auth/register: TypeError: Cannot read properties of undefined (reading 'uid')                                                              
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\authRoutes.ts:85:19     
    at Layer.handle [as handle_request] (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\layer.js:95:5)                                           
    at next (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\route.js:149:13)                                                                     
    at verifyFirebaseToken [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\authRoutes.ts:39:5[90m)                                                             
    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 10/26[22m[K[37C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 15/20[22m[K[25C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 7/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 18/18[22m[K[38C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 13/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m1 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m26 failed[m[2m | [32m[22m[1m37 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m8.15s[K[60C
[77C[?2026l[?2026h[90m[2;1Hstdout[2m | src/features/ocrRoutes.test.ts > OCR Routes > error handling > should handle database connection failures gracefully[m[K
Received OCR processing request for order: test[K
[K[90m
stdout[2m | src/features/ocrService.test.ts > OCRService > error scenarios > should handle malformed Vision API responses[m[K
OCR attempt 3/3 for image: https://example.com/image.jpg[K
[K
[K[33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 10/26[22m[K[33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 15/20[22m[K[33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 7/19[22m[K[33m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m 18/18[22m[K[38C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 13/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m1 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m26 failed[m[2m | [32m[22m[1m37 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m8.15s[K[60C[?2026l[?2026h
[90m[2;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Retry logic with transient failures > should succeed after transient network error[m 
OCR attempt 2 failed: (intermediate value) is not iterable                   
                                                                             [90m
stderr[2m | src/features/ocrRoutes.test.ts > OCR Routes > error handling > should handle database connection failures gracefully[m                             
Error processing OCR request: Error: Database unavailable                    
    at Object.<anonymous> [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrRoutes.test.ts:435:15[90m)                                                        [m
    at Object.mockCall (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/spy/dist/index.js:96:15)                                                     
    at Object.spy [as collection] (file:///C:/Users/akgte/PharmaRx/node_modules/[4mtinyspy[24m/dist/index.js:47:103)[K[45C
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrRoutes.ts:19:25      
    at Layer.handle [as handle_request] (C:\Users\akgte\PharmaRx\node_modules
[13;77Hs\[4mexpress[24m\lib\router\layer.js:95:5)[K[43C
    at next (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\route.js
[13;77Hs:149:13)[69C
    at Route.dispatch (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\route
[13;77Her\route.js:119:3)[60C
    at Layer.handle [as handle_request] (C:\Users\akgte\PharmaRx\node_modules
[13;77Hs\[4mexpress[24m\lib\router\layer.js:95:5)[K[43C
    at C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\index.js:284:1
[13;77H15[76C
    at param (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\index.j
[13;77Hjs:365:14)[68C
[77C
[90mstderr[2m | src/features/ocrService.test.ts > OCRService > error scenarios > sho[m
[90m[2m[13;77Hould handle malformed Vision API responses[22m[K[36C[m
OCR attempt 3 failed: (intermediate value) is not iterable[19C
[77C
[90mstderr[2m | src/features/ocrService.test.ts > OCRService > error scenarios > sho[m
[90m[2m[13;77Hould handle malformed Vision API responses[22m[K[36C[m
OCR processing failed for order test-order: Error: OCR failed after 3 attempt
[13;77Hts. Last error: (intermediate value) is not iterable[26C
    at OCRService.extractTextWithRetry [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\
[13;77H\features\ocrService.ts:103:11[90m)[K[47C[m
    at OCRService.processImage [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features
[13;77Hs\ocrService.ts:34:32[90m)[K[56C[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.test.ts:227:2
[13;77H22[76C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:20[61C
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 10/26[22m[K[37C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 15/20[22m[K[25C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 7/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 18/18[22m[K[38C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 13/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m1 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m26 failed[m[2m | [32m[22m[1m37 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m8.15s[K[60C[?2026l[?2026h
[2;1H [31m❯ [msrc/features/ocrRoutes.test.ts [2m(18 tests | [31m[22m1 failed[m[2m)[33m[22m 990[2mms[m                
   [32m✓ [mOCR Routes[2m > [22mPOST /orders/:orderId/process-ocr[2m > [22mshould start OCR processing for valid order [32m267[2mms[m                                                   
   [32m✓ [mOCR Routes[2m > [22mPOST /orders/:orderId/process-ocr[2m > [22mshould return 404 for non-existent order [32m47[2mms[m                                                       
   [32m✓ [mOCR Routes[2m > [22mPOST /orders/:orderId/process-ocr[2m > [22mshould return 400 for order without image URL [32m39[2mms[m                                                  
   [32m✓ [mOCR Routes[2m > [22mPOST /orders/:orderId/process-ocr[2m > [22mshould return 409 if OCR already in progress [32m37[2mms[m                                                   
   [32m✓ [mOCR Routes[2m > [22mPOST /orders/:orderId/process-ocr[2m > [22mshould return completed OCR if already processed [32m43[2mms[m                                               
   [32m✓ [mOCR Routes[2m > [22mPOST /orders/:orderId/process-ocr[2m > [22mshould return 400 for invalid image URL [32m44[2mms[m[K[56C
   [32m✓ [mOCR Routes[2m > [22mPOST /orders/:orderId/process-ocr[2m > [22mshould handle database 
[13;77H errors [32m37[2mms[m[K[66C
   [32m✓ [mOCR Routes[2m > [22mGET /orders/:orderId/ocr-status[2m > [22mshould return OCR status 
[13;77H for existing order [32m36[2mms[m[K[54C
   [32m✓ [mOCR Routes[2m > [22mGET /orders/:orderId/ocr-status[2m > [22mshould return 404 for non
[13;77Hn-existent order [32m65[2mms[m[K[57C
   [32m✓ [mOCR Routes[2m > [22mGET /orders/:orderId/ocr-status[2m > [22mshould return pending sta
[13;77Hatus for orders without OCR data [32m41[2mms[m[K[41C
   [32m✓ [mOCR Routes[2m > [22mGET /orders/:orderId/ocr-status[2m > [22mshould return failed stat
[13;77Htus with error message [32m31[2mms[m[K[51C
   [32m✓ [mOCR Routes[2m > [22mGET /ocr/health[2m > [22mshould return healthy status when service
[13;77He is operational [32m39[2mms[m[K[57C
   [32m✓ [mOCR Routes[2m > [22mGET /ocr/health[2m > [22mshould return unhealthy status when servi
[13;77Hice is down [32m23[2mms[m[K[62C
   [32m✓ [mOCR Routes[2m > [22mGET /ocr/health[2m > [22mshould handle health check errors [32m66[2mms[m   
   [32m✓ [mOCR Routes[2m > [22masync OCR processing[2m > [22mshould process OCR and update order 
[13;77H on success [32m48[2mms[m[K[62C
   [32m✓ [mOCR Routes[2m > [22merror handling[2m > [22mshould handle malformed request parameters
[13;77Hs[32m 31[2mms[22m[K[72C[m
[31m   × OCR Routes[2m > [22merror handling[2m > [22mshould handle invalid JSON in request body[m
[31m[13;77Hy[32m 54[2mms[22m[K[72C[m
[31m     → expected 400 "Bad Request", got 500 "Internal Server Error"[11C[m
   [32m✓ [mOCR Routes[2m > [22merror handling[2m > [22mshould handle database connection failures
[13;77Hs gracefully [32m28[2mms[m[K[61C
[90mstdout[2m | src/features/ocrService.test.ts > OCRService > error scenarios > sho[m
[90m[2m[13;77Hould handle null/undefined responses[22m[K[42C[m
OCR Service initialized successfully[41C
[77C
[90mstdout[2m | src/features/ocrService.test.ts > OCRService > error scenarios > sho[m
[90m[2m[13;77Hould handle null/undefined responses[22m[K[42C[m
Starting OCR processing for order test-order[33C
OCR attempt 1/3 for image: https://example.com/image.jpg[21C
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 10/26[22m[K[37C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 15/20[22m[K[25C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 7/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 18/18[22m[K[38C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 13/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m1 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m26 failed[m[2m | [32m[22m[1m37 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m8.15s[K[60C[?2026l[?2026h
[90m[2;1Hstderr[2m | src/features/ocrService.test.ts > OCRService > error scenarios > should handle null/undefined responses[m                                          
OCR attempt 1 failed: (intermediate value) is not iterable                   
                                                                             [90m
stderr[2m | src/features/authRoutes.test.ts > Auth Routes > POST /auth/register > returns 409 when user already exists[m                                       
Error in POST /auth/register: TypeError: Cannot read properties of undefined (reading 'uid')                                                              
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\authRoutes.ts:85:19     
    at Layer.handle [as handle_request] (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\layer.js:95:5)                                           
    at next (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\route.js:149:13)[69C
    at verifyFirebaseToken [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\aut
[13;77HthRoutes.ts:39:5[90m)[K[61C[m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 10/26[22m[K[37C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 15/20[22m[K[25C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 7/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 18/18[22m[K[38C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 13/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m1 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m26 failed[m[2m | [32m[22m[1m37 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m8.15s[K[60C[?2026l
[77C[?2026h[8;1H[K
[K
[K
[K
[K
[K
[K[77C[90m[2;1Hstdout[2m | src/features/ocrService.test.ts > OCRService > error scenarios > should handle null/undefined responses[m[K
OCR attempt 2/3 for image: https://example.com/image.jpg[K
[K[90m
stdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Retry logic with transient failures > should succeed after transient network error[m 
OCR attempt 3/3 for image: https://example.com/prescription.jpg[33m[1m[11;1H ❯ [msrc/features/authRoutes.test.ts[2m 11/26[33m[22m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 20/20[33m[22m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 8/19[33m[22m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m 18/18[22m
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 13/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m1 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m29 failed[m[2m | [32m[22m[1m41 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m8.40s[K[60C[?2026l[?2026h
[2;1H                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
[77C[90m[2;1Hstderr[2m | src/features/authRoutes.test.ts > Auth Routes > POST /auth/register > handles user service validation errors[m
Error in POST /auth/register: TypeError: Cannot read properties of undefined (reading 'uid')
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\authRoutes.ts:85:19
    at Layer.handle [as handle_request] (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\layer.js:95:5)
    at next (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\route.js:149:13)
    at verifyFirebaseToken [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\authRoutes.ts:39:5[90m)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)[m

[90mstderr[2m | src/features/ocrService.test.ts > OCRService > error scenarios > sho[m
[90m[2m[13;77Hould handle null/undefined responses[22m[K[42C[m
OCR attempt 2 failed: (intermediate value) is not iterable[19C
[77C
[90mstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Retry [m
[90m[2m[13;77H logic with transient failures > should succeed after transient network error[22m [m
OCR attempt 3 failed: (intermediate value) is not iterable[19C
[77C
[90mstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Retry [m
[90m[2m[13;77H logic with transient failures > should succeed after transient network error[22m [m
OCR processing failed for order retry-success-test: Error: OCR failed after 3
[13;77H3 attempts. Last error: (intermediate value) is not iterable[18C
    at OCRService.extractTextWithRetry [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\
[13;77H\features\ocrService.ts:103:11[90m)[K[47C[m
    at OCRService.processImage [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features
[13;77Hs\ocrService.ts:34:32[90m)[K[56C[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrIntegration.test.ts:2
[13;77H255:22[72C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:20[61C
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 11/26[22m[K[37C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 20/20[22m[K[25C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 8/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 18/18[22m[K[38C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 13/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m1 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m29 failed[m[2m | [32m[22m[1m41 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m8.40s[K[60C[?2026l[?2026h
[90m[2;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Retry logic with transient failures > should fail after max retries with persistent error[m                                                                       
OCR Service initialized successfully                                         
                                                                             [90m
stdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Retry logic with transient failures > should fail after max retries with persistent error[m                                                                       
Starting OCR processing for order persistent-error-test                      
OCR attempt 1/3 for image: https://example.com/prescription.jpg              
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 11/26[22m[K[37C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 20/20[22m[K[25C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 8/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 18/18[22m[K[38C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 13/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m1 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m29 failed[m[2m | [32m[22m[1m41 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m8.40s[K[60C[?2026l[?2026h
[90m[2;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Retry logic with transient failures > should fail after max retries with persistent error[m                                                                       
OCR attempt 1 failed: (intermediate value) is not iterable                   
                                                                             [90m
stderr[2m | src/features/authRoutes.test.ts > Auth Routes > POST /auth/register > handles user service general errors[m                                        
Error in POST /auth/register: TypeError: Cannot read properties of undefined (reading 'uid')                                                              
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\authRoutes.ts:85:19     
    at Layer.handle [as handle_request] (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\layer.js:95:5)                                           
    at next (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\route.js
[13;77Hs:149:13)[69C
    at verifyFirebaseToken [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\aut
[13;77HthRoutes.ts:39:5[90m)[K[61C[m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
[77C
[90mstderr[2m | src/features/authRoutes.test.ts > Auth Routes > POST /auth/register [m
[90m[2m[13;77H > continues registration even if custom claims fail[22m[K[26C[m
Error in POST /auth/register: TypeError: Cannot read properties of undefined 
[13;77H (reading 'uid')[62C
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\authRoutes.ts:85:19     
    at Layer.handle [as handle_request] (C:\Users\akgte\PharmaRx\node_modules
[13;77Hs\[4mexpress[24m\lib\router\layer.js:95:5)[K[43C
    at next (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\route.js
[13;77Hs:149:13)[69C
    at verifyFirebaseToken [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\aut
[13;77HthRoutes.ts:39:5[90m)[K[61C[m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 11/26[22m[K[37C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 20/20[22m[K[25C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 8/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 18/18[22m[K[38C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 13/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m1 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m29 failed[m[2m | [32m[22m[1m41 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m8.40s[K[60C[?2026l
[77C[?2026h[5;1H[K
[K
[K
[K
[K
[K
[K
[K
[K
[K[77C[2;1H [31m❯ [msrc/features/deliveryTrackingRoutes.test.ts [2m(20 tests | [31m[22m5 failed[m[2m)[33m[22m 1313[2mms[m  
   [32m✓ [mDelivery Tracking Routes[2m > [22mGET /orders/:orderId/delivery-tracking[2m > [22mshould return delivery tracking info for valid order ID [32m237[2mms[m[K
   [32m✓ [mDelivery Tracking Routes[2m > [22mGET /orders/:orderId/delivery-tracking[2m > [22mshould return tracking info with valid coordinate format [32m52[2mms[m
   [32m✓ [mDelivery Tracking Routes[2m > [22mGET /orders/:orderId/delivery-tracking[2m > [22mshould return estimated arrival as a valid date [32m32[2mms[m
   [32m✓ [mDelivery Tracking Routes[2m > [22mGET /orders/:orderId/delivery-tracking[2m > [22mshould handle different order IDs correctly [32m100[2mms[31m[22m
   × Delivery Tracking Routes[2m > [22mGET /orders/:orderId/delivery-tracking[2m > [22mshould handle server errors gracefully [32m80[2mms[31m[22m
     → expected undefined to be false // Object.is equality[m
   [32m✓ [mDelivery Tracking Routes[2m > [22mPOST /orders/:orderId/delivery-location[2m > [22msho
[13;77Hould update delivery location with valid coordinates [32m97[2mms[m[K[21C
   [32m✓ [mDelivery Tracking Routes[2m > [22mPOST /orders/:orderId/delivery-location[2m > [22msho
[13;77Hould reject requests without latitude [32m40[2mms[m[K[36C
   [32m✓ [mDelivery Tracking Routes[2m > [22mPOST /orders/:orderId/delivery-location[2m > [22msho
[13;77Hould reject requests without longitude [32m36[2mms[m[K[35C
[31m   × Delivery Tracking Routes[2m > [22mPOST /orders/:orderId/delivery-location[2m > [22msho[m
[31m[13;77Hould reject requests with invalid coordinates [32m38[2mms[31m[22m[K[28C[m
[31m     → expected 400 "Bad Request", got 200 "OK"[30C[m
[31m   × Delivery Tracking Routes[2m > [22mPOST /orders/:orderId/delivery-location[2m > [22msho[m
[31m[13;77Hould handle extreme but valid coordinate values [32m81[2mms[31m[22m[K[26C[m
[31m     → expected 200 "OK", got 400 "Bad Request"[30C[m
[31m   × Delivery Tracking Routes[2m > [22mPOST /orders/:orderId/delivery-location[2m > [22msho[m
[31m[13;77Hould handle server errors during location update [32m37[2mms[31m[22m[K[25C[m
[31m     → expected undefined to be false // Object.is equality[18C[m
   [32m✓ [mDelivery Tracking Routes[2m > [22mPOST /orders/:orderId/delivery-notifications[2m [22m
[2m[13;77H > [22mshould update notification preferences with valid data [32m32[2mms[m[K[16C
   [32m✓ [mDelivery Tracking Routes[2m > [22mPOST /orders/:orderId/delivery-notifications[2m [22m
[2m[13;77H > [22mshould handle different preference combinations [32m95[2mms[m[K[23C
   [32m✓ [mDelivery Tracking Routes[2m > [22mPOST /orders/:orderId/delivery-notifications[2m [22m
[2m[13;77H > [22mshould reject invalid boolean values for notifications [32m42[2mms[m[K[16C
   [32m✓ [mDelivery Tracking Routes[2m > [22mPOST /orders/:orderId/delivery-notifications[2m [22m
[2m[13;77H > [22mshould reject invalid threshold values [32m45[2mms[m[K[32C
   [32m✓ [mDelivery Tracking Routes[2m > [22mPOST /orders/:orderId/delivery-notifications[2m [22m
[2m[13;77H > [22mshould reject missing required fields [32m84[2mms[m[K[33C
[31m   × Delivery Tracking Routes[2m > [22mPOST /orders/:orderId/delivery-notifications[2m [m
[31m[2m[13;77H > [22mshould handle server errors during preference update [32m42[2mms[31m[22m[K[18C[m
[31m     → expected undefined to be false // Object.is equality[18C[m
   [32m✓ [mDelivery Tracking Routes[2m > [22mRoute Parameter Validation[2m > [22mshould handle sp
[13;77Hpecial characters in order IDs [32m80[2mms[m[K[43C
   [32m✓ [mDelivery Tracking Routes[2m > [22mRoute Parameter Validation[2m > [22mshould handle UR
[13;77HRL-encoded order IDs [32m21[2mms[m[K[53C
   [32m✓ [mDelivery Tracking Routes[2m > [22mRoute Parameter Validation[2m > [22mshould handle ve
[13;77Hery long order IDs [32m24[2mms[m[K[55C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 15/26[22m[K[37C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 20/20[22m[K[25C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 8/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 18/18[22m[K[38C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 13/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m2 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m31 failed[m[2m | [32m[22m[1m43 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m8.51s[K[60C
[77C[?2026l[?2026h[11;1H[K
[K
[K
[K[77C[2;1H[K
[K
[K
[K
[K
[K
[K
[K
[K[77C[90m[2;1Hstderr[2m | src/features/authRoutes.test.ts > Auth Routes > GET /auth/me > returns current user profile[m
Error in GET /auth/me: TypeError: Cannot read properties of undefined (reading 'uid')
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\authRoutes.ts:152:27
    at Layer.handle [as handle_request] (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\layer.js:95:5)
    at next (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\route.js:149:13)
    at verifyFirebaseToken [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\authRoutes.ts:39:5[90m)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)[m

[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 15/26[22m[K[37C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 20/20[22m[K[25C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 8/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 18/18[22m[K[38C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 13/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m2 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m31 failed[m[2m | [32m[22m[1m43 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m8.51s[K[60C[?2026l[?2026h
[77C[11;1H[K
[K
[K
[K[77C[2;1H[K
[K
[K
[K
[K
[K
[K
[K
[K[77C[90m[2;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Retry logic with transient failures > should fail after max retries with persistent error[m
OCR attempt 2/3 for image: https://example.com/prescription.jpg[33m[1m[8;1H ❯ [msrc/features/authRoutes.test.ts[2m 15/26[33m[22m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 20/20[33m[22m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 8/19[33m[22m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m 18/18[33m[22m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 13/17[33m[22m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m

[2m Test Files [31m[22m[1m2 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m31 failed[m[2m | [32m[22m[1m43 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m8.51s[K[60C[?2026l[?2026h
[90m[2;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Retry logic with transient failures > should fail after max retries with persistent error[m                                                                       
OCR attempt 2 failed: (intermediate value) is not iterable                   
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 15/26[22m                                     [33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 20/20[22m                         [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 8/19[22m                                  [33m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m 18/18[22m                                      [33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 13/17[22m                                     [33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m                                  
[77C
[2m Test Files [31m[22m[1m2 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m31 failed[m[2m | [32m[22m[1m43 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m8.51s[K[60C[?2026l[?2026h
[90m[2;1Hstdout[2m | src/features/ocrService.test.ts > OCRService > error scenarios > should handle null/undefined responses[m                                          
OCR attempt 3/3 for image: https://example.com/image.jpg                     
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 15/26[22m                                     [33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 20/20[22m                         [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 8/19[22m                                  [33m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m 18/18[22m                                      [33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 13/17[22m                                     [33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m                                  
                                                                             [2m
 Test Files [31m[22m[1m2 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m31 failed[m[2m | [32m[22m[1m43 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m8.51s[K[60C[?2026l[?2026h
[90m[2;1Hstderr[2m | src/features/ocrService.test.ts > OCRService > error scenarios > should handle null/undefined responses[m                                          
OCR attempt 3 failed: (intermediate value) is not iterable                   
                                                                             [90m
stderr[2m | src/features/ocrService.test.ts > OCRService > error scenarios > should handle null/undefined responses[m                                          
OCR processing failed for order test-order: Error: OCR failed after 3 attempts. Last error: (intermediate value) is not iterable                          
    at OCRService.extractTextWithRetry [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.ts:103:11[90m)                                               [m
    at OCRService.processImage [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.ts:34:32[90m)                                                        [m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.test.ts:239:2
[13;77H22[76C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:20[61C
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 15/26[22m[K[37C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 20/20[22m[K[25C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 8/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 18/18[22m[K[38C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 13/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m2 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m31 failed[m[2m | [32m[22m[1m43 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m8.51s[K[60C[?2026l[?2026h
[9;1H                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
[77C[90m[2;1Hstdout[2m | src/features/ocrService.test.ts > OCRService > error scenarios > should handle network timeouts[m[K
OCR Service initialized successfully[K
[K[90m
stdout[2m | src/features/ocrService.test.ts > OCRService > error scenarios > should handle network timeouts[m[K
Starting OCR processing for order test-order[K
OCR attempt 1/3 for image: https://example.com/image.jpg[33m[1m[12;1H ❯ [msrc/features/authRoutes.test.ts[2m 15/26[33m[22m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 20/20[33m[22m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 8/19[22m
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 18/18[22m[K[38C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 13/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m2 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m31 failed[m[2m | [32m[22m[1m43 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m8.51s[K[60C[?2026l[?2026h
[90m[2;1Hstderr[2m | src/features/ocrService.test.ts > OCRService > error scenarios > should handle network timeouts[m                                                  
OCR attempt 1 failed: (intermediate value) is not iterable                   
                                                                             [90m
stderr[2m | src/features/authRoutes.test.ts > Auth Routes > GET /auth/me > returns 404 when user profile not found[m                                           
Error in GET /auth/me: TypeError: Cannot read properties of undefined (reading 'uid')                                                                     
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\authRoutes.ts:152:27    
    at Layer.handle [as handle_request] (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\layer.js:95:5)                                           
    at next (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\route.js:149:13)[69C
    at verifyFirebaseToken [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\aut
[13;77HthRoutes.ts:39:5[90m)[K[61C[m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
[77C
[90mstderr[2m | src/features/authRoutes.test.ts > Auth Routes > PUT /auth/profile > [m
[90m[2m[13;77H successfully updates user profile[22m[K[44C[m
Error in PUT /auth/profile: TypeError: Cannot read properties of undefined (r
[13;77Hreading 'uid')[64C
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\authRoutes.ts:209:27    
    at Layer.handle [as handle_request] (C:\Users\akgte\PharmaRx\node_modules
[13;77Hs\[4mexpress[24m\lib\router\layer.js:95:5)[K[43C
    at next (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\route.js
[13;77Hs:149:13)[69C
    at verifyFirebaseToken [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\aut
[13;77HthRoutes.ts:39:5[90m)[K[61C[m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 15/26[22m[K[37C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 20/20[22m[K[25C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 8/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 18/18[22m[K[38C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 13/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m2 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m31 failed[m[2m | [32m[22m[1m43 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m8.51s[K[60C[?2026l
[77C[?2026h[90m[2;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Retry logic with transient failures > should fail after max retries with persistent error[m[K
OCR attempt 3/3 for image: https://example.com/prescription.jpg[K
[K[90m
stdout[2m | src/features/ocrService.test.ts > OCRService > error scenarios > should handle network timeouts[m[K
OCR attempt 2/3 for image: https://example.com/image.jpg[K
[K
[K[33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 19/26[22m[K[33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 20/20[22m[K[33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 9/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 18/18[22m[K[38C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 15/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m2 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m37 failed[m[2m | [32m[22m[1m44 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m8.83s[K[60C
[77C[?2026l[?2026h[K[77C[90m[2;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Retry logic with transient failures > should fail after max retries with persistent error[m[K
OCR attempt 3 failed: (intermediate value) is not iterable[K
[K[90m
stderr[2m | src/features/ocrService.test.ts > OCRService > error scenarios > should handle network timeouts[m[K
OCR attempt 2 failed: (intermediate value) is not iterable[K
[K[90m
stderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Retry logic with transient failures > should fail after max retries with persistent error[m[K
OCR processing failed for order persistent-error-test: Error: OCR failed afte
[13;77Her 3 attempts. Last error: (intermediate value) is not iterable[15C
    at OCRService.extractTextWithRetry [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\
[13;77H\features\ocrService.ts:103:11[90m)[K[47C[m
    at OCRService.processImage [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features
[13;77Hs\ocrService.ts:34:32[90m)[K[56C[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrIntegration.test.ts:2
[13;77H276:22[72C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:20[61C
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 19/26[22m[K[37C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 20/20[22m[K[25C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 9/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 18/18[22m[K[38C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 15/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m2 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m37 failed[m[2m | [32m[22m[1m44 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m8.83s[K[60C[?2026l
[77C[?2026h[90m[2;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Image format handling > should process JPEG images successfully[m[K
OCR Service initialized successfully[K
[K[90m
stdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Image format handling > should process JPEG images successfully[m[K
Starting OCR processing for order jpeg-test[K
OCR attempt 1/3 for image: https://example.com/prescription.jpg[K
[K
[K[33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 19/26[22m[K[33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 20/20[22m[K[33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 9/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 18/18[22m[K[38C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 15/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m2 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m37 failed[m[2m | [32m[22m[1m44 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m8.83s[K[60C[?2026l[?2026h
[5;1H                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
[77C[90m[2;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Image format handling > should process JPEG images successfully[m[K
OCR attempt 1 failed: (intermediate value) is not iterable[K[90m[6;1Hstderr[2m | src/features/authRoutes.test.ts > Auth Routes > PUT /auth/profile > removes uid from update data[m
Error in PUT /auth/profile: TypeError: Cannot read properties of undefined (reading 'uid')
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\authRoutes.ts:209:27
    at Layer.handle [as handle_request] (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\layer.js:95:5)
    at next (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\route.js:149:13)
    at verifyFirebaseToken [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\aut
[13;77HthRoutes.ts:39:5[90m)[K[61C[m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
[77C
[90mstderr[2m | src/features/authRoutes.test.ts > Auth Routes > PUT /auth/profile > [m
[90m[2m[13;77H returns 404 when user not found[22m[K[46C[m
Error in PUT /auth/profile: TypeError: Cannot read properties of undefined (r
[13;77Hreading 'uid')[64C
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\authRoutes.ts:209:27    
    at Layer.handle [as handle_request] (C:\Users\akgte\PharmaRx\node_modules
[13;77Hs\[4mexpress[24m\lib\router\layer.js:95:5)[K[43C
    at next (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\route.js
[13;77Hs:149:13)[69C
    at verifyFirebaseToken [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\aut
[13;77HthRoutes.ts:39:5[90m)[K[61C[m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 19/26[22m[K[37C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 20/20[22m[K[25C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 9/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 18/18[22m[K[38C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 15/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m2 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m37 failed[m[2m | [32m[22m[1m44 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m8.83s[K[60C[?2026l[?2026h
[90m[2;1Hstdout[2m | src/features/ocrService.test.ts > OCRService > error scenarios > should handle network timeouts[m                                                  
OCR attempt 3/3 for image: https://example.com/image.jpg                     
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 19/26[22m                                     [33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 20/20[22m                         [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 9/19[22m                                  [33m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m 18/18[22m                                      [33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 15/17[22m                                     [33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m                                  
                                                                             [2m
 Test Files [31m[22m[1m2 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m37 failed[m[2m | [32m[22m[1m44 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m8.83s[K[60C
[77C[?2026l[?2026h[90m[2;1Hstderr[2m | src/features/ocrService.test.ts > OCRService > error scenarios > should handle network timeouts[m[K
OCR attempt 3 failed: (intermediate value) is not iterable[K
[K[90m
stderr[2m | src/features/ocrService.test.ts > OCRService > error scenarios > should handle network timeouts[m[K
OCR processing failed for order test-order: Error: OCR failed after 3 attempts. Last error: (intermediate value) is not iterable[K
    at OCRService.extractTextWithRetry [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.ts:103:11[90m)[K[m
    at OCRService.processImage [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.ts:34:32[90m)[K[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.test.ts:250:2
[13;77H22[76C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:20[61C
[77C
[90mstderr[2m | src/features/authRoutes.test.ts > Auth Routes > POST /auth/login > s[m
[90m[2m[13;77Hsuccessfully returns user profile for authenticated user[22m[K[22C[m
Error in POST /auth/login: TypeError: Cannot read properties of undefined (re
[13;77Heading 'uid')[65C
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\authRoutes.ts:180:27    
    at Layer.handle [as handle_request] (C:\Users\akgte\PharmaRx\node_modules
[13;77Hs\[4mexpress[24m\lib\router\layer.js:95:5)[K[43C
    at next (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\route.js
[13;77Hs:149:13)[69C
    at verifyFirebaseToken [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\aut
[13;77HthRoutes.ts:39:5[90m)[K[61C[m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 19/26[22m[K[37C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 20/20[22m[K[25C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 9/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 18/18[22m[K[38C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 15/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m2 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m37 failed[m[2m | [32m[22m[1m44 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m8.83s[K[60C[?2026l[?2026h
[90m[2;1Hstdout[2m | src/features/ocrService.test.ts > OCRService > performance considerations > should process image within reasonable time[m                          
OCR Service initialized successfully                                         
                                                                             [90m
stdout[2m | src/features/ocrService.test.ts > OCRService > performance considerations > should process image within reasonable time[m                          
Starting OCR processing for order perf-test                                  
OCR attempt 1/3 for image: https://example.com/image.jpg                     
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 19/26[22m                                     [33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 20/20[22m                         [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 9/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 18/18[22m[K[38C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 15/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m2 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m37 failed[m[2m | [32m[22m[1m44 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m8.83s[K[60C[?2026l[?2026h
[6;1H                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
[77C[90m[2;1Hstderr[2m | src/features/ocrService.test.ts > OCRService > performance considerations > should process image within reasonable time[m[K
OCR attempt 1 failed: (intermediate value) is not iterable[K
[K[33m[1m[7;1H ❯ [msrc/features/authRoutes.test.ts[2m 19/26[33m[22m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 20/20[33m[22m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 9/19[33m[22m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m 18/18[33m[22m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 15/17[33m[22m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 0/17[14;1H Test Files [31m[22m[1m2 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[m
[2m      Tests [31m[22m[1m37 failed[m[2m | [32m[22m[1m44 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m8.83s[K[60C[?2026l[?2026h
[90m[2;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Image format handling > should process JPEG images successfully[m                    
OCR attempt 2/3 for image: https://example.com/prescription.jpg              
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 19/26[22m                                     [33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 20/20[22m                         [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 9/19[22m                                  [33m[1m
 ❯ [msrc/features/ocrRoutes.test.ts[2m 18/18[22m                                      [33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 15/17[22m                                     [33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m                                  
                                                                             [2m
 Test Files [31m[22m[1m2 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m37 failed[m[2m | [32m[22m[1m44 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m8.83s[K[60C[?2026l[?2026h
[90m[2;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Image format handling > should process JPEG images successfully[m                    
OCR attempt 2 failed: (intermediate value) is not iterable                   
                                                                             [90m
stderr[2m | src/features/authRoutes.test.ts > Auth Routes > POST /auth/login > returns 401 when invalid token[m                                                
Error in POST /auth/login: TypeError: Cannot read properties of undefined (reading 'uid')                                                                 
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\authRoutes.ts:180:27    
    at Layer.handle [as handle_request] (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\layer.js:95:5)                                           
    at next (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\route.js:149:13)[69C
    at verifyFirebaseToken [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\aut
[13;77HthRoutes.ts:39:5[90m)[K[61C[m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 19/26[22m[K[37C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 20/20[22m[K[25C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 9/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrRoutes.test.ts[2m 18/18[22m[K[38C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 15/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 0/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m2 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m37 failed[m[2m | [32m[22m[1m44 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m8.83s[K[60C[?2026l
[77C[?2026h[11;1H[K
[K
[K
[K[77C[90m[2;1Hstderr[2m | src/features/authRoutes.test.ts > Auth Routes > POST /auth/login > returns 404 when user profile not found[m[K
Error in POST /auth/login: TypeError: Cannot read properties of undefined (reading 'uid')[K
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\authRoutes.ts:180:27    
    at Layer.handle [as handle_request] (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\layer.js:95:5)[K
    at next (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\route.js:149:13)[K
    at verifyFirebaseToken [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\authRoutes.ts:39:5[90m)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)[m

[90mstderr[2m | src/features/paymentService.test.ts > PaymentService > processPaymen[m
[90m[2m[13;77Hnt > should successfully process a Stripe payment[22m[K[29C[m
Failed to generate receipt for payment: mock-doc-id TypeError: this.receiptsC
[13;77HCollection.where(...).where(...).orderBy is not a function[20C
    at ReceiptService.generateReceiptNumber [90m(C:\Users\akgte\PharmaRx\apps\api[m
[90m[13;77Hi\[msrc\features\receiptService.ts:146:8[90m)[K[39C[m
    at ReceiptService.generateReceipt [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\f
[13;77Hfeatures\receiptService.ts:78:38[90m)[K[45C[m
    at PaymentService.processPayment [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\fe
[13;77Heatures\paymentService.ts:118:34[90m)[K[45C[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\paymentService.test.ts:7
[13;77H77:22[73C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:20[61C
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 24/26[22m[K[37C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 20/20[22m[K[25C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 9/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 15/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 1/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m2 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m41 failed[m[2m | [32m[22m[1m46 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m9.14s[K[60C[?2026l[?2026h
[4;1H                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
[77C[90m[3;1Hstdout[2m | src/features/ocrService.test.ts > OCRService > performance considerations > should process image within reasonable time[m
OCR attempt 2/3 for image: https://example.com/image.jpg[33m[1m[8;1H ❯ [msrc/features/authRoutes.test.ts[2m 24/26[33m[22m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 20/20[33m[22m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 9/19[33m[22m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 15/17[33m[22m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 1/17[14;1H Test Files [31m[22m[1m2 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[m
[2m      Tests [31m[22m[1m41 failed[m[2m | [32m[22m[1m46 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m9.14s[K[60C[?2026l[?2026h
[90m[3;1Hstderr[2m | src/features/ocrService.test.ts > OCRService > performance considerations > should process image within reasonable time[m                          
OCR attempt 2 failed: (intermediate value) is not iterable                   
                                                                             [90m
stderr[2m | src/features/authRoutes.test.ts > Auth Routes > POST /auth/login > handles database errors gracefully[m                                            
Error in POST /auth/login: TypeError: Cannot read properties of undefined (reading 'uid')                                                                 
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\authRoutes.ts:180:27    
    at Layer.handle [as handle_request] (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\layer.js:95:5)                                           
    at next (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\route.js
[13;77Hs:149:13)[69C
    at verifyFirebaseToken [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\aut
[13;77HthRoutes.ts:39:5[90m)[K[61C[m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 24/26[22m[K[37C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 20/20[22m[K[25C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 9/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 15/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 1/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m2 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m41 failed[m[2m | [32m[22m[1m46 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m9.14s[K[60C[?2026l[?2026h
[90m[3;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Image format handling > should process JPEG images successfully[m                    
OCR attempt 3/3 for image: https://example.com/prescription.jpg              
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 24/26[22m                                     [33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 20/20[22m                         [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 9/19[22m                                  [33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 15/17[22m                                     [33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 1/17[22m                                  
                                                                             [2m
 Test Files [31m[22m[1m2 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m41 failed[m[2m | [32m[22m[1m46 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m9.14s[K[60C[?2026l[?2026h
[3;1H                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
[77C[90m[3;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Image format handling > should process JPEG images successfully[m
OCR attempt 3 failed: (intermediate value) is not iterable[90m[7;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Image format handling > should process JPEG images successfully[m
OCR processing failed for order jpeg-test: Error: OCR failed after 3 attempts. Last error: (intermediate value) is not iterable
    at OCRService.extractTextWithRetry [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.ts:103:11[90m)[m
    at OCRService.processImage [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.ts:34:32[90m)[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrIntegration.test.ts:2
[13;77H297:22[72C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:20[61C
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 24/26[22m[K[37C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 20/20[22m[K[25C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 9/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 15/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 1/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m2 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m41 failed[m[2m | [32m[22m[1m46 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m9.14s[K[60C[?2026l[?2026h
[90m[3;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Image format handling > should process PNG images successfully[m                     
OCR Service initialized successfully                                         
                                                                             [90m
stdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Image format handling > should process PNG images successfully[m                     
Starting OCR processing for order png-test                                   
OCR attempt 1/3 for image: https://example.com/prescription.png              
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 24/26[22m                                     [33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 20/20[22m[K[25C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 9/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 15/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 1/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m2 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m41 failed[m[2m | [32m[22m[1m46 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m9.14s[K[60C[?2026l[?2026h
[12;1H                                                                             
                                                                             
[77C[90m[3;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Image format handling > should process PNG images successfully[m[K
OCR attempt 1 failed: (intermediate value) is not iterable[K
[K[90m
stderr[2m | src/features/authRoutes.test.ts > Auth Routes > POST /auth/login > handles unexpected errors[m[K
Error in POST /auth/login: TypeError: Cannot read properties of undefined (reading 'uid')[K
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\authRoutes.ts:180:27    
    at Layer.handle [as handle_request] (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\layer.js:95:5)
    at next (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\route.js
[13;77Hs:149:13)[69C
    at verifyFirebaseToken [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\aut
[13;77HthRoutes.ts:39:5[90m)[K[61C[m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
[77C
[90mstderr[2m | src/features/authRoutes.test.ts > Auth Routes > POST /auth/login > v[m
[90m[2m[13;77Hverifies Firebase token with correct parameters[22m[K[31C[m
Error in POST /auth/login: TypeError: Cannot read properties of undefined (re
[13;77Heading 'uid')[65C
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\authRoutes.ts:180:27    
    at Layer.handle [as handle_request] (C:\Users\akgte\PharmaRx\node_modules
[13;77Hs\[4mexpress[24m\lib\router\layer.js:95:5)[K[43C
    at next (C:\Users\akgte\PharmaRx\node_modules\[4mexpress[24m\lib\router\route.js
[13;77Hs:149:13)[69C
    at verifyFirebaseToken [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\aut
[13;77HthRoutes.ts:39:5[90m)[K[61C[m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 24/26[22m[K[37C
[33m[1m ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 20/20[22m[K[25C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 9/19[22m[K[34C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 15/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 1/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m2 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m41 failed[m[2m | [32m[22m[1m46 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m9.14s[K[60C[?2026l[?2026h
[90m[3;1Hstdout[2m | src/features/ocrService.test.ts > OCRService > performance considerations > should process image within reasonable time[m                          
OCR attempt 3/3 for image: https://example.com/image.jpg                     
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 24/26[22m                                     [33m[1m
 ❯ [msrc/features/deliveryTrackingRoutes.test.ts[2m 20/20[22m                         [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 9/19[22m                                  [33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 15/17[22m                                     [33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 1/17[22m                                  
                                                                             [2m
 Test Files [31m[22m[1m2 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m41 failed[m[2m | [32m[22m[1m46 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m9.14s[K[60C[?2026l
[77C[?2026h[3;1H [31m❯ [msrc/features/authRoutes.test.ts [2m(26 tests | [31m[22m18 failed[m[2m)[33m[22m 1964[2mms[m[K[31m
   × Auth Routes[2m > [22mPOST /auth/register[2m > [22msuccessfully registers a new user with email [33m373[2mms[m[K[31m
     → expected 500 to be 201 // Object.is equality[K
   × Auth Routes[2m > [22mPOST /auth/register[2m > [22msuccessfully registers a new user with phone number [32m49[2mms[m[K[31m
     → expected 500 to be 201 // Object.is equality[K[m
   [32m✓ [mAuth Routes[2m > [22mPOST /auth/register[2m > [22mreturns 401 without authorization header [32m126[2mms[m[K[31m
   × Auth Routes[2m > [22mPOST /auth/register[2m > [22mreturns 401 with invalid token [32m51[2mms[m [31m
     → expected 500 to be 401 // Object.is equality[K[m
   [32m✓ [mAuth Routes[2m > [22mPOST /auth/register[2m > [22mreturns 400 without uid [32m44[2mms[m        
   [32m✓ [mAuth Routes[2m > [22mPOST /auth/register[2m > [22mreturns 400 with invalid role [32m122[2mms[m 
   [32m✓ [mAuth Routes[2m > [22mPOST /auth/register[2m > [22mreturns 400 without display name [32m27[2mm[m
[32m[2m[13;77Hms[22m[K[76C[m
   [32m✓ [mAuth Routes[2m > [22mPOST /auth/register[2m > [22mreturns 400 without email or phone n
[13;77Hnumber [32m29[2mms[m[K[67C
[31m   × Auth Routes[2m > [22mPOST /auth/register[2m > [22mreturns 403 when token UID does not [m
[31m[13;77H match request UID [32m65[2mms[31m[22m[K[55C[m
[31m     → expected 500 to be 403 // Object.is equality[26C[m
[31m   × Auth Routes[2m > [22mPOST /auth/register[2m > [22mreturns 409 when user already exists[m
[31m[13;77Hs[32m 129[2mms[22m[K[71C[m
[31m     → expected 500 to be 409 // Object.is equality[26C[m
[31m   × Auth Routes[2m > [22mPOST /auth/register[2m > [22mhandles user service validation erro[m
[31m[13;77Hors [32m58[2mms[31m[22m[K[70C[m
[31m     → expected 500 to be 400 // Object.is equality[26C[m
   [32m✓ [mAuth Routes[2m > [22mPOST /auth/register[2m > [22mhandles user service general errors 
[32m[13;77H 96[2mms[22m[K[73C[m
[31m   × Auth Routes[2m > [22mPOST /auth/register[2m > [22mcontinues registration even if custo[m
[31m[13;77Hom claims fail [32m35[2mms[31m[22m[K[59C[m
[31m     → expected 500 to be 201 // Object.is equality[26C[m
[31m   × Auth Routes[2m > [22mGET /auth/me[2m > [22mreturns current user profile [32m36[2mms[m[K[10C
[31m     → expected 500 to be 200 // Object.is equality[26C[m
   [32m✓ [mAuth Routes[2m > [22mGET /auth/me[2m > [22mreturns 401 without valid token [32m72[2mms[m       
[31m   × Auth Routes[2m > [22mGET /auth/me[2m > [22mreturns 404 when user profile not found [32m32[2mm[m
[32m[2m[13;77Hms[22m[K[76C[m
[31m     → expected 500 to be 404 // Object.is equality[26C[m
[31m   × Auth Routes[2m > [22mPUT /auth/profile[2m > [22msuccessfully updates user profile [32m60[2mms[m
[31m     → expected 400 to be 200 // Object.is equality[26C[m
[31m   × Auth Routes[2m > [22mPUT /auth/profile[2m > [22mremoves uid from update data [32m169[2mms[m    
[31m     → expected "spy" to be called with arguments: [ 'test-uid-123', …(1) ]  [m
[90m[77C[m
[90mNumber of calls: [1m0[22m[K[59C[m
[90m[77C[m
[31m   × Auth Routes[2m > [22mPUT /auth/profile[2m > [22mreturns 404 when user not found [32m30[2mms[m  
[31m     → expected 400 to be 404 // Object.is equality[26C[m
[31m   × Auth Routes[2m > [22mPOST /auth/login[2m > [22msuccessfully returns user profile for a[m
[31m[13;77Hauthenticated user [32m30[2mms[31m[22m[K[55C[m
[31m     → expected 500 to be 200 // Object.is equality[26C[m
   [32m✓ [mAuth Routes[2m > [22mPOST /auth/login[2m > [22mreturns 401 when no authorization heade
[13;77Her [32m23[2mms[m[K[71C
[31m   × Auth Routes[2m > [22mPOST /auth/login[2m > [22mreturns 401 when invalid token [32m29[2mms[m    
[31m     → expected 500 to be 401 // Object.is equality[26C[m
[31m   × Auth Routes[2m > [22mPOST /auth/login[2m > [22mreturns 404 when user profile not found[m
[31m[13;77Hd[32m 58[2mms[22m[K[72C[m
[31m     → expected 500 to be 404 // Object.is equality[26C[m
[31m   × Auth Routes[2m > [22mPOST /auth/login[2m > [22mhandles database errors gracefully [32m142[2mm[m
[32m[2m[13;77Hms[22m[K[76C[m
[31m     → expected { Object (error) } to deeply equal { error: 'Database connect[m
[31m[13;77Htion failed' }[64C[m
[31m   × Auth Routes[2m > [22mPOST /auth/login[2m > [22mhandles unexpected errors [32m31[2mms[m[K[9C
[31m     → expected { Object (error) } to deeply equal { Object (error) }        [m
[31m   × Auth Routes[2m > [22mPOST /auth/login[2m > [22mverifies Firebase token with correct pa[m
[31m[13;77Harameters [32m26[2mms[31m[22m[K[64C[m
[31m     → expected "spy" to be called with arguments: [ 'mock-firebase-token' ] [m
[90m[77C[m
[90mNumber of calls: [1m0[22m[K[59C[m
[90m[77C[m
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 26/26[22m[K[37C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 11/19[22m[K[33C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 16/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 1/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m3 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m46 failed[m[2m | [32m[22m[1m46 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m9.45s[K[60C[?2026l[?2026h
[90m[4;1Hstderr[2m | src/features/ocrService.test.ts > OCRService > performance considerations > should process image within reasonable time[m                          
OCR attempt 3 failed: (intermediate value) is not iterable                   
                                                                             [90m
stderr[2m | src/features/ocrService.test.ts > OCRService > performance considerations > should process image within reasonable time[m                          
OCR processing failed for order perf-test: Error: OCR failed after 3 attempts. Last error: (intermediate value) is not iterable                           
    at OCRService.extractTextWithRetry [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.ts:103:11[90m)                                               [m
    at OCRService.processImage [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features
[13;77Hs\ocrService.ts:34:32[90m)[K[56C[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.test.ts:268:2
[13;77H22[76C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:20[61C
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 26/26[22m[K[37C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 11/19[22m[K[33C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 16/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 1/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m3 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m46 failed[m[2m | [32m[22m[1m46 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m9.45s[K[60C[?2026l
[77C[?2026h[90m[4;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Image format handling > should process PNG images successfully[m[K
OCR attempt 2/3 for image: https://example.com/prescription.png[K
[K
[K[33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 26/26[22m[K[33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 11/19[22m[K[33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 16/17[22m[K[33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 1/17[22m[K
[K[2m
 Test Files [31m[22m[1m3 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m46 failed[m[2m | [32m[22m[1m46 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m9.45s[K[60C[?2026l[?2026h
[90m[4;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Image format handling > should process PNG images successfully[m                     
OCR attempt 2 failed: (intermediate value) is not iterable                   
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 26/26[22m                                     [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 11/19[22m                                 [33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 16/17[22m                                     [33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 1/17[22m                                  
                                                                             [2m
 Test Files [31m[22m[1m3 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m46 failed[m[2m | [32m[22m[1m46 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m9.45s[K[60C[?2026l[?2026h
[13;1H                                                                             
[77C[90m[4;1Hstdout[2m | src/features/ocrService.test.ts > OCRService > performance considerations > should handle large text extraction[m[K
OCR Service initialized successfully[K
[K[90m
stdout[2m | src/features/ocrService.test.ts > OCRService > performance considerations > should handle large text extraction[m[K
Starting OCR processing for order large-text-test[K
OCR attempt 1/3 for image: https://example.com/large-image.jpg[K
[K[33m[1m[14;1H ❯ [msrc/features/authRoutes.test.ts[2m 26/26[22m
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 11/19[22m[K[33C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 16/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 1/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m3 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m46 failed[m[2m | [32m[22m[1m46 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m9.45s[K[60C[?2026l[?2026h
[90m[4;1Hstderr[2m | src/features/ocrService.test.ts > OCRService > performance considerations > should handle large text extraction[m                                  
OCR attempt 1 failed: (intermediate value) is not iterable                   
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 26/26[22m                                     [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 11/19[22m                                 [33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 16/17[22m                                     [33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 1/17[22m                                  
                                                                             [2m
 Test Files [31m[22m[1m3 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m46 failed[m[2m | [32m[22m[1m46 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m9.45s[K[60C
[77C[?2026l[?2026h[90m[4;1Hstdout[2m | src/features/ocrService.test.ts > OCRService > performance considerations > should handle large text extraction[m[K
OCR attempt 2/3 for image: https://example.com/large-image.jpg[K
[K
[K[33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 26/26[22m[K[33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 11/19[22m[K[33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 16/17[22m[K[33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 1/17[22m[K
[K[2m
 Test Files [31m[22m[1m3 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m46 failed[m[2m | [32m[22m[1m46 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m9.45s[K[60C[?2026l
[77C[?2026h[90m[4;1Hstderr[2m | src/features/ocrService.test.ts > OCRService > performance considerations > should handle large text extraction[m[K
OCR attempt 2 failed: (intermediate value) is not iterable[K
[K
[K[33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 26/26[22m[K[33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 11/19[22m[K[33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 16/17[22m[K[33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 1/17[22m[K
[K[2m
 Test Files [31m[22m[1m3 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m46 failed[m[2m | [32m[22m[1m46 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m9.45s[K[60C[?2026l[?2026h
[90m[4;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Image format handling > should process PNG images successfully[m                     
OCR attempt 3/3 for image: https://example.com/prescription.png              
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 26/26[22m                                     [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 11/19[22m                                 [33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 16/17[22m                                     [33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 1/17[22m                                  
                                                                             [2m
 Test Files [31m[22m[1m3 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m46 failed[m[2m | [32m[22m[1m46 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m9.45s[K[60C
[77C[?2026l[?2026h[90m[4;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Image format handling > should process PNG images successfully[m[K
OCR attempt 3 failed: (intermediate value) is not iterable[K
[K[90m
stderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Image format handling > should process PNG images successfully[m[K
OCR processing failed for order png-test: Error: OCR failed after 3 attempts. Last error: (intermediate value) is not iterable[K
    at OCRService.extractTextWithRetry [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.ts:103:11[90m)[K[m
    at OCRService.processImage [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features
[13;77Hs\ocrService.ts:34:32[90m)[K[56C[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrIntegration.test.ts:3
[13;77H318:22[72C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:20[61C
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 26/26[22m[K[37C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 11/19[22m[K[33C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 16/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 1/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m3 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m46 failed[m[2m | [32m[22m[1m46 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m9.45s[K[60C[?2026l[?2026h
[90m[4;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Image format handling > should process PDF documents successfully[m                  
OCR Service initialized successfully                                         
                                                                             [90m
stdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Image format handling > should process PDF documents successfully[m                  
Starting OCR processing for order pdf-test                                   
OCR attempt 1/3 for image: https://example.com/prescription.pdf              
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 26/26[22m[K[37C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 11/19[22m[K[33C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 16/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 1/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m3 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m46 failed[m[2m | [32m[22m[1m46 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m9.45s[K[60C[?2026l[?2026h
[77C[90m[4;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Image format handling > should process PDF documents successfully[m[K
OCR attempt 1 failed: (intermediate value) is not iterable[K
[K
[K[33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 26/26[22m[K[33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 11/19[22m[K[33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 16/17[22m[K[33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 1/17[22m[K
[K[2m
 Test Files [31m[22m[1m3 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[m
[2m      Tests [31m[22m[1m46 failed[m[2m | [32m[22m[1m46 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m9.45s[K[60C[?2026l
[77C]0;node (vitest 5)[?2026h[90m[4;1Hstdout[2m | src/features/ocrService.test.ts > OCRService > performance considerations > should handle large text extraction[m[K
OCR attempt 3/3 for image: https://example.com/large-image.jpg[K
[K[90m
stdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Image format handling > should process PDF documents successfully[m[K
OCR attempt 2/3 for image: https://example.com/prescription.pdf[K
[K
[K[33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 26/26[22m[K[33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 12/19[22m[K[33C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 17/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 1/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m48 failed[m[2m | [32m[22m[1m46 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m9.84s[K[60C
[77C[?2026l[?2026h[90m[4;1Hstderr[2m | src/features/ocrService.test.ts > OCRService > performance considerations > should handle large text extraction[m[K
OCR attempt 3 failed: (intermediate value) is not iterable[K
[K[90m
stderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Image format handling > should process PDF documents successfully[m[K
OCR attempt 2 failed: (intermediate value) is not iterable[K
[K[90m
stderr[2m | src/features/ocrService.test.ts > OCRService > performance considerations > should handle large text extraction[m[K
OCR processing failed for order large-text-test: Error: OCR failed after 3 at
[13;77Httempts. Last error: (intermediate value) is not iterable[21C
    at OCRService.extractTextWithRetry [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\
[13;77H\features\ocrService.ts:103:11[90m)[K[47C[m
    at OCRService.processImage [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features
[13;77Hs\ocrService.ts:34:32[90m)[K[56C[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.test.ts:284:2
[13;77H22[76C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:20[61C
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 26/26[22m[K[37C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 12/19[22m[K[33C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 17/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 1/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m48 failed[m[2m | [32m[22m[1m46 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m9.84s[K[60C[?2026l[?2026h
[12;1H                                                                             
                                                                             
[77C[4;1H [31m❯ [msrc/features/ocrService.test.ts [2m(17 tests | [31m[22m12 failed[m[2m)[33m[22m 4648[2mms[m[K[31m
   × OCRService[2m > [22mprocessImage[2m > [22mshould successfully extract text from image [33m535[2mms[m[K[31m
     → expected false to be true // Object.is equality[K
   × OCRService[2m > [22mprocessImage[2m > [22mshould handle empty text detection results [33m364[2mms[m[K[31m
     → expected 'OCR failed after 3 attempts. Last err…' to be 'OCR failed after 3 attempts. Last err…' // Object.is equality[K
   × OCRService[2m > [22mprocessImage[2m > [22mshould handle empty extracted text [33m477[2mms[31m[22m
     → expected 'OCR failed after 3 attempts. Last err…' to be 'OCR failed after 3 attempts. Last err…' // Object.is equality[m
[31m   × OCRService[2m > [22mprocessImage[2m > [22mshould retry on transient failures [33m334[2mms[m    
[31m     → expected false to be true // Object.is equality[23C[m
[31m   × OCRService[2m > [22mprocessImage[2m > [22mshould fail after max retries [33m563[2mms[m[K[9C
[31m     → expected 'OCR failed after 3 attempts. Last err…' to be 'OCR failed af[m
[31m[13;77Hfter 3 attempts. Last err…' // Object.is equality[29C[m
[31m   × OCRService[2m > [22mprocessImage[2m > [22mshould handle Vision API errors gracefully [33m3[m
[33m[13;77H350[2mms[22m[K[73C[m
[31m     → expected 'OCR failed after 3 attempts. Last err…' to contain 'QUOTA_EX[m
[31m[13;77HXCEEDED'[70C[m
   [32m✓ [mOCRService[2m > [22mvalidateImageForOCR[2m > [22mshould validate correct image URLs [32m15[m
[32m[13;77H5[2mms[22m[K[75C[m
   [32m✓ [mOCRService[2m > [22mvalidateImageForOCR[2m > [22mshould reject empty or invalid URLs [32m1[m
[32m[13;77H117[2mms[22m[K[73C[m
   [32m✓ [mOCRService[2m > [22mvalidateImageForOCR[2m > [22mshould reject unsupported file types 
[32m[13;77H 23[2mms[22m[K[73C[m
   [32m✓ [mOCRService[2m > [22mvalidateImageForOCR[2m > [22mshould accept supported file types [32m8[2mm[m
[32m[2m[13;77Hms[22m[K[76C[m
[31m   × OCRService[2m > [22mhealthCheck[2m > [22mshould return true when service is healthy [32m22[m
[32m[13;77H2[2mms[22m[K[75C[m
[31m     → expected "spy" to be called at least once[29C[m
[31m   × OCRService[2m > [22mhealthCheck[2m > [22mshould return false when service is unhealthy[m
[31m[13;77Hy[32m 10[2mms[22m[K[72C[m
[31m     → expected true to be false // Object.is equality[23C[m
[31m   × OCRService[2m > [22merror scenarios[2m > [22mshould handle malformed Vision API respon[m
[31m[13;77Hnses [33m333[2mms[31m[22m[K[68C[m
[31m     → expected 'OCR failed after 3 attempts. Last err…' to contain 'No text [m
[31m[13;77H detected in the image'[55C[m
   [33m[2m✓[m OCRService[2m > [22merror scenarios[2m > [22mshould handle null/undefined responses  [33m3[m
[33m[13;77H387[2mms[22m[K[73C[m
[31m   × OCRService[2m > [22merror scenarios[2m > [22mshould handle network timeouts [33m329[2mms[m     
[31m     → expected 'OCR failed after 3 attempts. Last err…' to contain 'TIMEOUT'[m
[31m   × OCRService[2m > [22mperformance considerations[2m > [22mshould process image within re[m
[31m[13;77Heasonable time [33m338[2mms[31m[22m[K[58C[m
[31m     → expected false to be true // Object.is equality[23C[m
[31m   × OCRService[2m > [22mperformance considerations[2m > [22mshould handle large text extra[m
[31m[13;77Haction [33m426[2mms[31m[22m[K[66C[m
[31m     → expected false to be true // Object.is equality[23C[m
[90mstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Image [m
[90m[2m[13;77H format handling > should process PDF documents successfully[22m[K[18C[m
OCR attempt 3/3 for image: https://example.com/prescription.pdf[14C
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 26/26[22m[K[37C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 12/19[22m[K[33C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 17/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 1/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m48 failed[m[2m | [32m[22m[1m46 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m9.84s[K[60C[?2026l[?2026h
[90m[4;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Image format handling > should process PDF documents successfully[m                  
OCR attempt 3 failed: (intermediate value) is not iterable                   
                                                                             [90m
stderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Image format handling > should process PDF documents successfully[m                  
OCR processing failed for order pdf-test: Error: OCR failed after 3 attempts. Last error: (intermediate value) is not iterable                            
    at OCRService.extractTextWithRetry [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.ts:103:11[90m)                                               [m
    at OCRService.processImage [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features
[13;77Hs\ocrService.ts:34:32[90m)[K[56C[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrIntegration.test.ts:3
[13;77H336:22[72C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:20[61C
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 26/26[22m[K[37C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 12/19[22m[K[33C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 17/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 1/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m48 failed[m[2m | [32m[22m[1m46 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m9.84s[K[60C[?2026l[?2026h
[90m[4;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Performance and scalability > should handle large prescription images[m              
OCR Service initialized successfully                                         
                                                                             [90m
stdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Performance and scalability > should handle large prescription images[m              
Starting OCR processing for order large-image-test                           
OCR attempt 1/3 for image: https://example.com/large-prescription.jpg        
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 26/26[22m[K[37C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 12/19[22m[K[33C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 17/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 1/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m48 failed[m[2m | [32m[22m[1m46 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m9.84s[K[60C[?2026l[?2026h
[13;1H                                                                             
[77C[90m[4;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Performance and scalability > should handle large prescription images[m[K
OCR attempt 1 failed: (intermediate value) is not iterable[K
[K
[K[33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 26/26[22m[K[33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 12/19[22m[K[33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 17/17[22m[K[33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 1/17[22m[K[2m[14;1H Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[m
[2m      Tests [31m[22m[1m48 failed[m[2m | [32m[22m[1m46 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m9.84s[K[60C[?2026l
[77C[?2026h[90m[4;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Performance and scalability > should handle large prescription images[m[K
OCR attempt 2/3 for image: https://example.com/large-prescription.jpg        
[K
[K[33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 26/26[22m[K[33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 13/19[22m[K[33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 17/17[22m[K[33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 1/17[22m[K
[K[2m
 Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m49 failed[m[2m | [32m[22m[1m46 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m10.19s[K[59C[?2026l[?2026h
[12;1H                                                                             
                                                                             
[77C[8;1H[K
[K
[K
[K[77C[90m[4;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Performance and scalability > should handle large prescription images[m[K
OCR attempt 2 failed: (intermediate value) is not iterable[K
[K[33m[1m[9;1H ❯ [msrc/features/authRoutes.test.ts[2m 26/26[33m[22m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 13/19[33m[22m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 17/17[33m[22m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 1/17[14;1H Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[m
[2m      Tests [31m[22m[1m49 failed[m[2m | [32m[22m[1m46 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m10.19s[K[59C[?2026l[?2026h
[77C[90m[4;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Performance and scalability > should handle large prescription images[m[K
OCR attempt 3/3 for image: https://example.com/large-prescription.jpg        
[K
[K[33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 26/26[22m[K[33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 13/19[22m[K[33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 17/17[22m[K[33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 1/17[22m[K
[K[2m
 Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m49 failed[m[2m | [32m[22m[1m46 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m10.19s[K[59C[?2026l[?2026h
[13;1H                                                                             
[77C[90m[4;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Performance and scalability > should handle large prescription images[m[K
OCR attempt 3 failed: (intermediate value) is not iterable[K
[K[90m
stderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Performance and scalability > should handle large prescription images[m[K
OCR processing failed for order large-image-test: Error: OCR failed after 3 attempts. Last error: (intermediate value) is not iterable[K
    at OCRService.extractTextWithRetry [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.ts:103:11[90m)[m
    at OCRService.processImage [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features
[13;77Hs\ocrService.ts:34:32[90m)[K[56C[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrIntegration.test.ts:3
[13;77H360:22[72C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:20[61C
[77C
[77C
[33m[1m ❯ [msrc/features/authRoutes.test.ts[2m 26/26[22m[K[37C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 13/19[22m[K[33C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 17/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 1/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m49 failed[m[2m | [32m[22m[1m46 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m10.19s[K[59C
[77C[?2026l[?2026h[90m[4;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Performance and scalability > should handle concurrent OCR requests[m[K
OCR Service initialized successfully[K
[K
[K
[K
[K
[K
[K
[K
[K[77C[33m[1m[9;1H ❯ [msrc/features/authRoutes.test.ts[2m 26/26[33m[22m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 13/19[33m[22m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 17/17[33m[22m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 1/17[14;1H Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[m
[2m      Tests [31m[22m[1m49 failed[m[2m | [32m[22m[1m46 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m10.19s[K[59C[?2026l[?2026h
[90m[4;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Performance and scalability > should handle concurrent OCR requests[m                
OCR attempt 1 failed: (intermediate value) is not iterable                   
OCR attempt 1 failed: (intermediate value) is not iterable                   
OCR attempt 1 failed: (intermediate value) is not iterable                   
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 26/26[22m                                     [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 13/19[22m                                 [33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 17/17[22m                                     [33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 1/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m49 failed[m[2m | [32m[22m[1m46 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m10.19s[K[59C[?2026l[?2026h
[90m[4;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Performance and scalability > should handle concurrent OCR requests[m                
Starting OCR processing for order concurrent-1                               
OCR attempt 1/3 for image: https://example.com/rx1.jpg                       
Starting OCR processing for order concurrent-2                               
OCR attempt 1/3 for image: https://example.com/rx2.jpg                       
Starting OCR processing for order concurrent-3                               
OCR attempt 1/3 for image: https://example.com/rx3.jpg                       
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/authRoutes.test.ts[2m 26/26[22m[K[37C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 13/19[22m[K[33C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 17/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 1/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m49 failed[m[2m | [32m[22m[1m46 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m10.19s[K[59C[?2026l
[77C[?2026h[90m[4;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Performance and scalability > should handle concurrent OCR requests[m[K
OCR attempt 2/3 for image: https://example.com/rx1.jpg[K
[K
[K[33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 13/19[22m[K[33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 17/17[22m[K[33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 2/17[22m[K
[K[2m
 Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[m[2m
      Tests [31m[22m[1m49 failed[m[2m | [32m[22m[1m47 passed[90m[22m (117)[K]0;node (vitest 4)[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m10.45s[K[59C[?2026l[?2026h
[9;1H                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
[77C[90m[5;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Performance and scalability > should handle concurrent OCR requests[m[K
OCR attempt 2 failed: (intermediate value) is not iterable[K
[K[33m[1m[10;1H ❯ [msrc/features/ocrIntegration.test.ts[2m 13/19[33m[22m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 17/17[33m[22m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 2/17[14;1H Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[m
[2m      Tests [31m[22m[1m49 failed[m[2m | [32m[22m[1m47 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m10.45s[K[59C
[77C[?2026l[?2026h[5;1H[K
[K
[K
[K
[K
[K
[K
[K
[K
[K[77C[90m[5;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Performance and scalability > should handle concurrent OCR requests[m
OCR attempt 2/3 for image: https://example.com/rx2.jpg[33m[1m[10;1H ❯ [msrc/features/ocrIntegration.test.ts[2m 13/19[33m[22m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 17/17[33m[22m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 2/17[14;1H Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[m
[2m      Tests [31m[22m[1m49 failed[m[2m | [32m[22m[1m47 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m10.45s[K[59C[?2026l[?2026h
[7;1H                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
[77C[90m[5;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Performance and scalability > should handle concurrent OCR requests[m[K
OCR attempt 2 failed: (intermediate value) is not iterable[33m[1m[10;1H ❯ [msrc/features/ocrIntegration.test.ts[2m 13/19[33m[22m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 17/17[33m[22m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 2/17[14;1H Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[m
[2m      Tests [31m[22m[1m49 failed[m[2m | [32m[22m[1m47 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m10.45s[K[59C[?2026l[?2026h
[8;1H                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
[77C[90m[5;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Performance and scalability > should handle concurrent OCR requests[m[K
OCR attempt 2/3 for image: https://example.com/rx3.jpg[K[33m[1m[10;1H ❯ [msrc/features/ocrIntegration.test.ts[2m 13/19[33m[22m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 17/17[33m[22m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 2/17[14;1H Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[m
[2m      Tests [31m[22m[1m49 failed[m[2m | [32m[22m[1m47 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m10.45s[K[59C[?2026l[?2026h
[90m[5;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Performance and scalability > should handle concurrent OCR requests[m                
OCR attempt 2 failed: (intermediate value) is not iterable                   
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 13/19[22m                                 [33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 17/17[22m                                     [33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 2/17[22m                                  
                                                                             [2m
 Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m49 failed[m[2m | [32m[22m[1m47 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m10.45s[K[59C[?2026l[?2026h
[90m[5;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Performance and scalability > should handle concurrent OCR requests[m                
OCR attempt 3/3 for image: https://example.com/rx1.jpg                       
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 13/19[22m                                 [33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 17/17[22m                                     [33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 2/17[22m                                  
                                                                             [2m
 Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m49 failed[m[2m | [32m[22m[1m47 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m10.45s[K[59C
[77C[?2026l[?2026h[90m[5;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Performance and scalability > should handle concurrent OCR requests[m[K
OCR attempt 3 failed: (intermediate value) is not iterable[K
[K[90m
stderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Performance and scalability > should handle concurrent OCR requests[m[K
OCR processing failed for order concurrent-1: Error: OCR failed after 3 attempts. Last error: (intermediate value) is not iterable[K
    at OCRService.extractTextWithRetry [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.ts:103:11[90m)[K[47C[m
[90m    at runNextTicks (node:internal/process/task_queues:65:5)[17C[m
[90m    at listOnTimeout (node:internal/timers:549:9)[28C[m
[90m    at processTimers (node:internal/timers:523:7)[28C[m
    at OCRService.processImage [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features
[13;77Hs\ocrService.ts:34:32[90m)[K[56C[m
    at async Promise.all (index 0)[43C
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrIntegration.test.ts:3
[13;77H387:23[72C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:20[61C
[77C
[77C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 13/19[22m[K[33C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 17/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 2/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m49 failed[m[2m | [32m[22m[1m47 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m10.45s[K[59C[?2026l[?2026h
[10;1H                                                                             
                                                                             
                                                                             
                                                                             
[77C[90m[5;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Performance and scalability > should handle concurrent OCR requests[m[K
OCR attempt 3/3 for image: https://example.com/rx2.jpg[K
[K
[K[33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 13/19[33m[22m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 17/17[33m[22m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 2/17[14;1H Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[m
[2m      Tests [31m[22m[1m49 failed[m[2m | [32m[22m[1m47 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m10.45s[K[59C[?2026l[?2026h
[90m[5;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Performance and scalability > should handle concurrent OCR requests[m                
OCR attempt 3 failed: (intermediate value) is not iterable                   
                                                                             [90m
stderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Performance and scalability > should handle concurrent OCR requests[m                
OCR processing failed for order concurrent-2: Error: OCR failed after 3 attempts. Last error: (intermediate value) is not iterable                        
    at OCRService.extractTextWithRetry [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.ts:103:11[90m)[K[47C[m
[90m    at runNextTicks (node:internal/process/task_queues:65:5)[17C[m
[90m    at listOnTimeout (node:internal/timers:549:9)[28C[m
[90m    at processTimers (node:internal/timers:523:7)[28C[m
    at OCRService.processImage [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features
[13;77Hs\ocrService.ts:34:32[90m)[K[56C[m
    at async Promise.all (index 1)[43C
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrIntegration.test.ts:3
[13;77H387:23[72C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:20[61C
[77C
[77C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 13/19[22m[K[33C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 17/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 2/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m49 failed[m[2m | [32m[22m[1m47 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m10.45s[K[59C[?2026l[?2026h
[90m[5;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Performance and scalability > should handle concurrent OCR requests[m                
OCR attempt 3/3 for image: https://example.com/rx3.jpg                       
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 13/19[22m                                 [33m[1m
 ❯ [msrc/features/ocrService.test.ts[2m 17/17[22m                                     [33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 2/17[22m                                  
                                                                             [2m
 Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m49 failed[m[2m | [32m[22m[1m47 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m10.45s[K[59C[?2026l[?2026h
[5;1H                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
[77C[90m[5;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Performance and scalability > should handle concurrent OCR requests[m
OCR attempt 3 failed: (intermediate value) is not iterable[90m[9;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Performance and scalability > should handle concurrent OCR requests[m
OCR processing failed for order concurrent-3: Error: OCR failed after 3 attempts. Last error: (intermediate value) is not iterable
    at OCRService.extractTextWithRetry [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.ts:103:11[90m)[m
    at OCRService.processImage [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features
[13;77Hs\ocrService.ts:34:32[90m)[K[56C[m
    at async Promise.all (index 2)[43C
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrIntegration.test.ts:3
[13;77H387:23[72C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:20[61C
[77C
[77C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 13/19[22m[K[33C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 17/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 2/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m49 failed[m[2m | [32m[22m[1m47 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m10.45s[K[59C[?2026l[?2026h
[90m[5;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Health check integration > should verify service connectivity[m                      
OCR Service initialized successfully                                         
                                                                             [90m
stdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Health check integration > should detect service unavailability[m                    
OCR Service initialized successfully                                         
                                                                             [90m
stdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Edge cases and boundary conditions > should handle images with no text[m[K[13C
OCR Service initialized successfully[41C
[77C
[90mstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Edge c[m
[90m[2m[13;77Hcases and boundary conditions > should handle images with no text[22m[K[13C[m
Starting OCR processing for order no-text-test[31C
OCR attempt 1/3 for image: https://example.com/blank-image.jpg[15C
[77C
[77C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 13/19[22m[K[33C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 17/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 2/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m49 failed[m[2m | [32m[22m[1m47 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m10.45s[K[59C[?2026l[?2026h
[90m[5;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Edge cases and boundary conditions > should handle images with no text[m             
OCR attempt 1 failed: (intermediate value) is not iterable                   
                                                                             [90m
stderr[2m | src/features/paymentService.test.ts > PaymentService > processPayment > should successfully process a PayPal payment[m                             
Failed to generate receipt for payment: mock-doc-id TypeError: this.receiptsCollection.where(...).where(...).orderBy is not a function                    
    at ReceiptService.generateReceiptNumber [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\receiptService.ts:146:8[90m)[K[39C[m
    at ReceiptService.generateReceipt [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\f
[13;77Hfeatures\receiptService.ts:78:38[90m)[K[45C[m
    at PaymentService.processPayment [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\fe
[13;77Heatures\paymentService.ts:118:34[90m)[K[45C[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\paymentService.test.ts:9
[13;77H95:22[73C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:20[61C
[77C
[77C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 13/19[22m[K[33C
[33m[1m ❯ [msrc/features/ocrService.test.ts[2m 17/17[22m[K[37C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 2/17[22m[K[34C
[77C
[2m Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m49 failed[m[2m | [32m[22m[1m47 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m10.45s[K[59C[?2026l
[77C[?2026h[90m[5;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Edge cases and boundary conditions > should handle images with no text[m[K
OCR attempt 2/3 for image: https://example.com/blank-image.jpg[K
[K
[K
[K
[K
[K
[K
[K[77C[33m[1m[10;1H ❯ [msrc/features/ocrIntegration.test.ts[2m 16/19[33m[22m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 2/17[33m[22m[1m
 ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/smsService.test.ts[2m [queued][22m

[2m Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m52 failed[m[2m | [32m[22m[1m47 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m10.86s[K[59C[?2026l[?2026h
[90m[4;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Edge cases and boundary conditions > should handle images with no text[m             
OCR attempt 2 failed: (intermediate value) is not iterable                   
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 16/19[22m                                 [33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 2/17[22m                                  [33m[1m
 ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][22m                     [33m[1m
 ❯ [msrc/features/smsService.test.ts[2m [queued][22m                                  
                                                                             [2m
 Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m52 failed[m[2m | [32m[22m[1m47 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m10.86s[K[59C[?2026l
[77C]0;node (vitest 3)[?2026h[10;1H[K
[K
[K
[K
[K[77C[90m[4;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Edge cases and boundary conditions > should handle images with no text[m[K
OCR attempt 3/3 for image: https://example.com/blank-image.jpg[K
[K
[K[33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 16/19[22m[K[33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 2/17[33m[22m[1m
 ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/smsService.test.ts[2m [queued][14;1H Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[m
[2m      Tests [31m[22m[1m52 failed[m[2m | [32m[22m[1m47 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m11.10s[K[59C[?2026l[?2026h
[90m[4;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Edge cases and boundary conditions > should handle images with no text[m             
OCR attempt 3 failed: (intermediate value) is not iterable                   
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 16/19[22m                                 [33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 2/17[22m                                  [33m[1m
 ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][22m                     [33m[1m
 ❯ [msrc/features/smsService.test.ts[2m [queued][22m                                  
                                                                             [2m
 Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m52 failed[m[2m | [32m[22m[1m47 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m11.10s[K[59C[?2026l
[77C[?2026h[90m[4;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Edge cases and boundary conditions > should handle images with no text[m[K
OCR processing failed for order no-text-test: Error: OCR failed after 3 attempts. Last error: (intermediate value) is not iterable[K
    at OCRService.extractTextWithRetry [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.ts:103:11[90m)[K[m
    at OCRService.processImage [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.ts:34:32[90m)[K[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrIntegration.test.ts:431:22[K
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:20[61C
[77C
[77C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 17/19[22m[K[33C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 2/17[22m[K[34C
[33m[1m ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][22m[K[21C
[33m[1m ❯ [msrc/features/smsService.test.ts[2m [queued][22m[K[34C
[77C
[2m Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m53 failed[m[2m | [32m[22m[1m47 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m11.32s[K[59C[?2026l
[77C[?2026h[6;1H[K
[K
[K
[K
[K
[K
[K
[K
[K[77C[90m[4;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Edge cases and boundary conditions > should handle corrupted image responses[m       
OCR Service initialized successfully[90m[8;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Edge cases and boundary conditions > should handle corrupted image responses[m
Starting OCR processing for order corrupted-test
OCR attempt 1/3 for image: https://example.com/corrupted.jpg[33m[1m[14;1H ❯ [msrc/features/ocrIntegration.test.ts[2m 17/19[22m
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 2/17[22m[K[34C
[33m[1m ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][22m[K[21C
[33m[1m ❯ [msrc/features/smsService.test.ts[2m [queued][22m[K[34C
[77C
[2m Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m53 failed[m[2m | [32m[22m[1m47 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m11.32s[K[59C[?2026l[?2026h
[8;1H                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
                                                                             
[77C[90m[4;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Edge cases and boundary conditions > should handle corrupted image responses[m       
OCR attempt 1 failed: (intermediate value) is not iterable[K
[K[77C[33m[1m[9;1H ❯ [msrc/features/ocrIntegration.test.ts[2m 17/19[33m[22m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 2/17[33m[22m[1m
 ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/smsService.test.ts[2m [queued][14;1H Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[m
[2m      Tests [31m[22m[1m53 failed[m[2m | [32m[22m[1m47 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m11.32s[K[59C[?2026l
[77C[?2026h[7;1H[K
[K
[K
[K
[K
[K
[K
[K[77C[90m[4;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Edge cases and boundary conditions > should handle corrupted image responses[m       
OCR attempt 2/3 for image: https://example.com/corrupted.jpg[K[33m[1m[9;1H ❯ [msrc/features/ocrIntegration.test.ts[2m 17/19[33m[22m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 2/17[33m[22m[1m
 ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/smsService.test.ts[2m [queued][14;1H Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[m
[2m      Tests [31m[22m[1m53 failed[m[2m | [32m[22m[1m47 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m11.32s[K[59C[?2026l[?2026h
[77C[9;1H[K
[K
[K
[K
[K
[K[77C[90m[4;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Edge cases and boundary conditions > should handle corrupted image responses[m       
OCR attempt 2 failed: (intermediate value) is not iterable[K
[K
[K[33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 17/19[33m[22m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 2/17[33m[22m[1m
 ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/smsService.test.ts[2m [queued][14;1H Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[m
[2m      Tests [31m[22m[1m53 failed[m[2m | [32m[22m[1m47 passed[90m[22m (117)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m11.32s[K[59C[?2026l
[77C[?2026h[90m[4;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Edge cases and boundary conditions > should handle corrupted image responses[m       
OCR attempt 3/3 for image: https://example.com/corrupted.jpg[K
[K
[K[33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 18/19[22m[K[33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 2/17[22m[K[33m[1m
 ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/smsService.test.ts[2m 0/36[22m[K
[K[2m
 Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m54 failed[m[2m | [32m[22m[1m47 passed[90m[22m (153)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m11.65s[K[59C[?2026l[?2026h
[77C[90m[4;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Edge cases and boundary conditions > should handle corrupted image responses[m       
OCR attempt 3 failed: (intermediate value) is not iterable[K
[K[90m
stderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Edge cases and boundary conditions > should handle corrupted image responses[m       
OCR processing failed for order corrupted-test: Error: OCR failed after 3 attempts. Last error: (intermediate value) is not iterable[K
    at OCRService.extractTextWithRetry [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.ts:103:11[90m)[K[m
    at OCRService.processImage [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features
[13;77Hs\ocrService.ts:34:32[90m)[K[56C[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrIntegration.test.ts:4
[13;77H447:22[72C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:20[61C
[77C
[77C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 18/19[22m[K[33C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 2/17[22m[K[34C
[33m[1m ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][22m[K[21C
[33m[1m ❯ [msrc/features/smsService.test.ts[2m 0/36[22m[K[38C
[77C
[2m Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m54 failed[m[2m | [32m[22m[1m47 passed[90m[22m (153)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m11.65s[K[59C[?2026l[?2026h
[90m[4;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Edge cases and boundary conditions > should handle malformed API responses[m         
OCR Service initialized successfully                                         
                                                                             [90m
stdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Edge cases and boundary conditions > should handle malformed API responses[m         
Starting OCR processing for order malformed-test                             
OCR attempt 1/3 for image: https://example.com/test.jpg                      
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 18/19[22m[K[33C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 2/17[22m[K[34C
[33m[1m ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][22m[K[21C
[33m[1m ❯ [msrc/features/smsService.test.ts[2m 0/36[22m[K[38C
[77C
[2m Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m54 failed[m[2m | [32m[22m[1m47 passed[90m[22m (153)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m11.65s[K[59C[?2026l[?2026h
[13;1H                                                                             
[77C[90m[4;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Edge cases and boundary conditions > should handle malformed API responses[m[K
OCR attempt 1 failed: (intermediate value) is not iterable[K
[K
[K[33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 18/19[22m[K[33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 2/17[22m[K[33m[1m
 ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/smsService.test.ts[2m 0/36[22m[K[2m[14;1H Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[m
[2m      Tests [31m[22m[1m54 failed[m[2m | [32m[22m[1m47 passed[90m[22m (153)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m11.65s[K[59C[?2026l[?2026h
[90m[4;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Edge cases and boundary conditions > should handle malformed API responses[m         
OCR attempt 2/3 for image: https://example.com/test.jpg                      
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 18/19[22m                                 [33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 2/17[22m                                  [33m[1m
 ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][22m                     [33m[1m
 ❯ [msrc/features/smsService.test.ts[2m 0/36[22m                                      
                                                                             [2m
 Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m54 failed[m[2m | [32m[22m[1m47 passed[90m[22m (153)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m11.65s[K[59C[?2026l[?2026h
[90m[4;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Edge cases and boundary conditions > should handle malformed API responses[m         
OCR attempt 2 failed: (intermediate value) is not iterable                   
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 18/19[22m                                 [33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 2/17[22m                                  [33m[1m
 ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][22m                     [33m[1m
 ❯ [msrc/features/smsService.test.ts[2m 0/36[22m                                      
                                                                             [2m
 Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m54 failed[m[2m | [32m[22m[1m47 passed[90m[22m (153)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m11.65s[K[59C[?2026l
[77C[?2026h[11;1H[K
[K
[K
[K[77C[6;1H[K
[K
[K
[K
[K[77C[90m[4;1Hstdout[2m | src/features/smsService.test.ts > SMSService > sendSMS > should send SMS successfully[m[K
SMS sent successfully: SM1234567890abcdef[90m[8;1Hstdout[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Edge cases and boundary conditions > should handle malformed API responses[m
OCR attempt 3/3 for image: https://example.com/test.jpg[33m[1m[13;1H ❯ [msrc/features/ocrIntegration.test.ts[2m 18/19[33m[22m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 2/17[22m
[33m[1m ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][22m[K[21C
[33m[1m ❯ [msrc/features/smsService.test.ts[2m 0/36[22m[K[38C
[33m[1m ❯ [msrc/features/whatsappService.test.ts[2m [queued][22m[K[29C
[77C
[2m Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m54 failed[m[2m | [32m[22m[1m47 passed[90m[22m (153)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m11.87s[K[59C[?2026l[?2026h
[13;1H                                                                             
[77C[90m[3;1Hstderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Edge cases and boundary conditions > should handle malformed API responses[m[K
OCR attempt 3 failed: (intermediate value) is not iterable[K
[K[90m
stderr[2m | src/features/ocrIntegration.test.ts > OCR Integration Tests > Edge cases and boundary conditions > should handle malformed API responses[m[K
OCR processing failed for order malformed-test: Error: OCR failed after 3 attempts. Last error: (intermediate value) is not iterable[K
    at OCRService.extractTextWithRetry [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.ts:103:11[90m)[K[m
    at OCRService.processImage [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrService.ts:34:32[90m)[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\ocrIntegration.test.ts:4
[13;77H461:22[72C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:20[61C
[77C
[77C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 18/19[22m[K[33C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 2/17[22m[K[34C
[33m[1m ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][22m[K[21C
[33m[1m ❯ [msrc/features/smsService.test.ts[2m 0/36[22m[K[38C
[33m[1m ❯ [msrc/features/whatsappService.test.ts[2m [queued][22m[K[29C
[77C
[2m Test Files [31m[22m[1m4 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m54 failed[m[2m | [32m[22m[1m47 passed[90m[22m (153)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m11.87s[K[59C[?2026l
[77C[?2026h[13;1H[K
[K[77C[3;1H [31m❯ [msrc/features/ocrIntegration.test.ts [2m(19 tests | [31m[22m18 failed[m[2m)[33m[22m 6945[2mms[m[K[31m
   × OCR Integration Tests[2m > [22mReal-world prescription text extraction[2m > [22mshould extract text from prescription image [33m540[2mms[m[K[31m
     → expected false to be true // Object.is equality[K
   × OCR Integration Tests[2m > [22mReal-world prescription text extraction[2m > [22mshould handle handwritten prescription with lower confidence [33m361[2mms[m[K[31m
     → expected false to be true // Object.is equality[K
   × OCR Integration Tests[2m > [22mReal-world prescription text extraction[2m > [22mshould handle poor quality image with partial text [33m486[2mms[m[K[31m
     → expected false to be true // Object.is equality[K
   × OCR Integration Tests[2m > [22mGoogle Cloud Vision API error scenarios[2m > [22mshould handle QUOTA_EXCEEDED error [33m370[2mms[m
[31m     → expected 'OCR failed after 3 attempts. Last err…' to contain 'Quota ex[m
[31m[13;77Hxceeded'[70C[m
[31m   × OCR Integration Tests[2m > [22mGoogle Cloud Vision API error scenarios[2m > [22mshould[m
[31m[13;77Hd handle PERMISSION_DENIED error [33m502[2mms[31m[22m[K[40C[m
[31m     → expected 'OCR failed after 3 attempts. Last err…' to contain 'permissi[m
[31m[13;77Hion'[74C[m
[31m   × OCR Integration Tests[2m > [22mGoogle Cloud Vision API error scenarios[2m > [22mshould[m
[31m[13;77Hd handle INVALID_ARGUMENT for unsupported image format [33m344[2mms[31m[22m[K[18C[m
[31m     → expected 'OCR failed after 3 attempts. Last err…' to contain 'Invalid [m
[31m[13;77H image format'[64C[m
[31m   × OCR Integration Tests[2m > [22mGoogle Cloud Vision API error scenarios[2m > [22mshould[m
[31m[13;77Hd handle network timeout errors [33m340[2mms[31m[22m[K[41C[m
[31m     → expected 'OCR failed after 3 attempts. Last err…' to contain 'Deadline[m
[31m[13;77He exceeded'[67C[m
[31m   × OCR Integration Tests[2m > [22mRetry logic with transient failures[2m > [22mshould suc[m
[31m[13;77Hcceed after transient network error [33m383[2mms[31m[22m[K[37C[m
[31m     → expected false to be true // Object.is equality[23C[m
[31m   × OCR Integration Tests[2m > [22mRetry logic with transient failures[2m > [22mshould fai[m
[31m[13;77Hil after max retries with persistent error [33m422[2mms[31m[22m[K[30C[m
[31m     → expected 'OCR failed after 3 attempts. Last err…' to contain 'Internal[m
[31m[13;77Hl server error'[63C[m
[31m   × OCR Integration Tests[2m > [22mImage format handling[2m > [22mshould process JPEG imag[m
[31m[13;77Hges successfully [33m388[2mms[31m[22m[K[56C[m
[31m     → expected false to be true // Object.is equality[23C[m
[31m   × OCR Integration Tests[2m > [22mImage format handling[2m > [22mshould process PNG image[m
[31m[13;77Hes successfully [33m338[2mms[31m[22m[K[57C[m
[31m     → expected false to be true // Object.is equality[23C[m
[31m   × OCR Integration Tests[2m > [22mImage format handling[2m > [22mshould process PDF docum[m
[31m[13;77Hments successfully [33m329[2mms[31m[22m[K[54C[m
[31m     → expected false to be true // Object.is equality[23C[m
[31m   × OCR Integration Tests[2m > [22mPerformance and scalability[2m > [22mshould handle larg[m
[31m[13;77Hge prescription images [33m346[2mms[31m[22m[K[50C[m
[31m     → expected false to be true // Object.is equality[23C[m
[31m   × OCR Integration Tests[2m > [22mPerformance and scalability[2m > [22mshould handle conc[m
[31m[13;77Hcurrent OCR requests [33m349[2mms[31m[22m[K[52C[m
[31m     → expected false to be true // Object.is equality[23C[m
[31m   × OCR Integration Tests[2m > [22mHealth check integration[2m > [22mshould verify service[m
[31m[13;77He connectivity [32m20[2mms[31m[22m[K[59C[m
[31m     → expected "spy" to be called at least once[29C[m
[31m   × OCR Integration Tests[2m > [22mHealth check integration[2m > [22mshould detect service[m
[31m[13;77He unavailability [32m9[2mms[31m[22m[K[58C[m
[31m     → expected true to be false // Object.is equality[23C[m
[31m   × OCR Integration Tests[2m > [22mEdge cases and boundary conditions[2m > [22mshould hand[m
[31m[13;77Hdle images with no text [33m338[2mms[31m[22m[K[49C[m
[31m     → expected 'OCR failed after 3 attempts. Last err…' to contain 'No text [m
[31m[13;77H detected'[68C[m
[31m   × OCR Integration Tests[2m > [22mEdge cases and boundary conditions[2m > [22mshould hand[m
[31m[13;77Hdle corrupted image responses [33m673[2mms[31m[22m[K[43C[m
[31m     → expected 'OCR failed after 3 attempts. Last err…' to contain 'Empty te[m
[31m[13;77Hext extracted'[64C[m
   [33m[2m✓[m OCR Integration Tests[2m > [22mEdge cases and boundary conditions[2m > [22mshould hand
[13;77Hdle malformed API responses  [33m391[2mms[m[K[44C
[77C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 19/19[22m[K[33C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 2/17[22m[K[34C
[33m[1m ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][22m[K[21C
[33m[1m ❯ [msrc/features/smsService.test.ts[2m 3/36[22m[K[38C
[33m[1m ❯ [msrc/features/whatsappService.test.ts[2m [queued][22m[K[29C
[77C
[2m Test Files [31m[22m[1m5 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m57 failed[m[2m | [32m[22m[1m48 passed[90m[22m (153)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m12.08s[K[59C[?2026l[?2026h
[90m[3;1Hstderr[2m | src/features/smsService.test.ts > SMSService > sendSMS > should handle network errors[m                                                            
Error sending SMS: Error: Network timeout                                    
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\smsService.test.ts:98:35
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:155:11                                                             
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:26                                                             
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1897:20                                                            
    at new Promise (<anonymous>)                                             
    at runWithTimeout (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/r
[13;77Hrunner/dist/chunk-hooks.js:1863:10)[43C
    at runTest (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/d
[13;77Hdist/chunk-hooks.js:1574:12)[50C
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
[77C
[77C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 19/19[22m[K[33C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 2/17[22m[K[34C
[33m[1m ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][22m[K[21C
[33m[1m ❯ [msrc/features/smsService.test.ts[2m 3/36[22m[K[38C
[33m[1m ❯ [msrc/features/whatsappService.test.ts[2m [queued][22m[K[29C
[77C
[2m Test Files [31m[22m[1m5 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m57 failed[m[2m | [32m[22m[1m48 passed[90m[22m (153)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m12.08s[K[59C
[77C[?2026l[?2026h[90m[3;1Hstdout[2m | src/features/smsService.test.ts > SMSService > sendSMS > should clean phone numbers correctly[m[K
SMS sent successfully: SM1234567890abcdef[K
[K[90m
stdout[2m | src/features/smsService.test.ts > SMSService > sendSMS > should validate phone numbers[m[K
SMS sent successfully: SM1234567890abcdef[K
[K[90m
stdout[2m | src/features/smsService.test.ts > SMSService > sendSMS > should handle empty message text[m[K
SMS sent successfully: SM1234567890abcdef[K
[K[77C
[77C
[33m[1m ❯ [msrc/features/ocrIntegration.test.ts[2m 19/19[22m[K[33C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 2/17[22m[K[34C
[33m[1m ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][22m[K[21C
[33m[1m ❯ [msrc/features/smsService.test.ts[2m 3/36[22m[K[38C
[33m[1m ❯ [msrc/features/whatsappService.test.ts[2m [queued][22m[K[29C
[77C
[2m Test Files [31m[22m[1m5 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m57 failed[m[2m | [32m[22m[1m48 passed[90m[22m (153)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m12.08s[K[59C[?2026l[?2026h
[90m[3;1Hstderr[2m | src/features/smsService.test.ts > SMSService > sendSMS > should handle rate limiting[m                                                             
Twilio SMS error: {                                                          
  code: [33m20003[m,                                                               
  message: [32m'Your account has exceeded the rate limit for this resource.'[m,    
  more_info: [32m'https://www.twilio.com/docs/errors/20003'[m,                     
  status: [33m429                                                                [m
}                                                                            
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 19/19[22m                                 [33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 2/17[22m[K[34C
[33m[1m ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][22m[K[21C
[33m[1m ❯ [msrc/features/smsService.test.ts[2m 3/36[22m[K[38C
[33m[1m ❯ [msrc/features/whatsappService.test.ts[2m [queued][22m[K[29C
[77C
[2m Test Files [31m[22m[1m5 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m57 failed[m[2m | [32m[22m[1m48 passed[90m[22m (153)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m12.08s[K[59C[?2026l
[77C[?2026h[90m[3;1Hstdout[2m | src/features/smsService.test.ts > SMSService > sendBulkSMS > should send bulk SMS with rate limiting[m[K
SMS sent successfully: SM1234567890abcdef[K
SMS sent successfully: SM1234567890abcdef[K
SMS sent successfully: SM1234567890abcdef[K
[K
[K[33m[1m
 ❯ [msrc/features/ocrIntegration.test.ts[2m 19/19[22m[K[33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 2/17[22m[K[33m[1m
 ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/smsService.test.ts[2m 3/36[22m[K[33m[1m
 ❯ [msrc/features/whatsappService.test.ts[2m [queued][22m[K[29C
[77C
[2m Test Files [31m[22m[1m5 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m57 failed[m[2m | [32m[22m[1m48 passed[90m[22m (153)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m12.08s[K[59C[?2026l
[77C[?2026h[90m[3;1Hstdout[2m | src/features/smsService.test.ts > SMSService > sendBulkSMS > should handle partial failures in bulk SMS[m[K
SMS sent successfully: SM1234567890abcdef[K
[K
[K[33m[1m
 ❯ [msrc/features/database.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 2/17[22m[K[33m[1m
 ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/smsService.test.ts[2m 32/36[22m[K[33m[1m
 ❯ [msrc/features/whatsappService.test.ts[2m [queued][22m[K
[K[2m
 Test Files [31m[22m[1m5 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m77 failed[m[2m | [32m[22m[1m57 passed[90m[22m (153)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m12.30s[K[59C[?2026l[?2026h
[90m[3;1Hstderr[2m | src/features/smsService.test.ts > SMSService > sendBulkSMS > should handle partial failures in bulk SMS[m                                          
Twilio SMS error: { code: [33m21211[m, message: [32m'Invalid phone number' [m}           
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/database.test.ts[2m [queued][22m                                    [33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 2/17[22m                                  [33m[1m
 ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][22m                     [33m[1m
 ❯ [msrc/features/smsService.test.ts[2m 32/36[22m                                     [33m[1m
 ❯ [msrc/features/whatsappService.test.ts[2m [queued][22m                             
                                                                             [2m
 Test Files [31m[22m[1m5 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m77 failed[m[2m | [32m[22m[1m57 passed[90m[22m (153)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m12.30s[K[59C
[77C[?2026l[?2026h[90m[3;1Hstdout[2m | src/features/smsService.test.ts > SMSService > sendBulkSMS > should respect rate limiting in bulk SMS[m[K
SMS sent successfully: SM1234567890abcdef[K
SMS sent successfully: SM1234567890abcdef[K
[K
[K[33m[1m
 ❯ [msrc/features/database.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 2/17[22m[K[33m[1m
 ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/smsService.test.ts[2m 32/36[22m[K[33m[1m
 ❯ [msrc/features/whatsappService.test.ts[2m [queued][22m[K
[K[77C
[2m Test Files [31m[22m[1m5 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m77 failed[m[2m | [32m[22m[1m57 passed[90m[22m (153)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m12.30s[K[59C[?2026l[?2026h
[90m[3;1Hstderr[2m | src/features/smsService.test.ts > SMSService > isConfigured > should return false when account SID is missing[m                                    
Twilio SMS credentials not configured. SMS messaging will not work.          
                                                                             [90m
stderr[2m | src/features/smsService.test.ts > SMSService > isConfigured > should return false when auth token is missing[m                                     
Twilio SMS credentials not configured. SMS messaging will not work.          
                                                                             [90m
stderr[2m | src/features/smsService.test.ts > SMSService > isConfigured > should return false when phone number is missing[m                                   
Twilio SMS credentials not configured. SMS messaging will not work.          
[77C
[90mstderr[2m | src/features/smsService.test.ts > SMSService > Service Initializatio[m
[90m[2m[13;77Hon > should handle missing environment variables gracefully[22m[K[19C[m
Twilio SMS credentials not configured. SMS messaging will not work.[10C
[77C
[77C
[33m[1m ❯ [msrc/features/database.test.ts[2m [queued][22m[K[36C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 2/17[22m[K[34C
[33m[1m ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][22m[K[21C
[33m[1m ❯ [msrc/features/smsService.test.ts[2m 32/36[22m[K[37C
[33m[1m ❯ [msrc/features/whatsappService.test.ts[2m [queued][22m[K[29C
[77C
[2m Test Files [31m[22m[1m5 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m77 failed[m[2m | [32m[22m[1m57 passed[90m[22m (153)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m12.30s[K[59C[?2026l
[77C[?2026h[K[77C[13;1H[K[77C[12;1H[K[77C[11;1H[K[77C[10;1H[K[77C[9;1H[K[77C[8;1H[K[77C[6;1H[K
[K[77C[5;1H[K[77C[90m[3;1Hstdout[2m | src/features/smsService.test.ts > SMSService > Rate Limiting and Performance > should handle concurrent SMS sending[m[K
SMS sent successfully: SM1234567890abcdef
SMS sent successfully: SM1234567890abcdef
SMS sent successfully: SM1234567890abcdef
SMS sent successfully: SM1234567890abcdef
SMS sent successfully: SM1234567890abcdef[33m[1m[12;1H ❯ [msrc/features/database.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 2/17[33m[22m[1m
 ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][22m
[33m[1m ❯ [msrc/features/smsService.test.ts[2m 35/36[22m[K[37C
[33m[1m ❯ [msrc/features/whatsappService.test.ts[2m [queued][22m[K[29C
[77C
[2m Test Files [31m[22m[1m5 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m77 failed[m[2m | [32m[22m[1m60 passed[90m[22m (153)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m12.44s[K[59C[?2026l
[77C[?2026h[3;1H[K
[K
[K
[K
[K
[K
[K
[K
[K
[K
[K
[K[77C[3;1H [31m❯ [msrc/features/smsService.test.ts [2m(36 tests | [31m[22m23 failed[m[2m)[33m[22m 580[2mms[31m[22m
   × SMSService[2m > [22msendSMS[2m > [22mshould send SMS successfully [32m127[2mms[31m[22m
     → expected undefined to deeply equal { …(4) }
   × SMSService[2m > [22msendSMS[2m > [22mshould handle Twilio API errors gracefully [32m39[2mms[31m[22m
     → expected 'Invalid phone number format' to be 'The To phone number is not a valid ph…' // Object.is equality
   × SMSService[2m > [22msendSMS[2m > [22mshould handle network errors [32m36[2mms[31m[22m
     → expected 'Network error while sending SMS' to be 'Failed to send SMS: Network timeout' // Object.is equality
   × SMSService[2m > [22msendSMS[2m > [22mshould clean phone numbers correctly [32m22[2mms[31m[22m
     → expected 'To=+22912345678&From=+15551234567&Bod…' to contain 'To=%2B22912345678'[m
[31m   × SMSService[2m > [22msendSMS[2m > [22mshould validate phone numbers [32m20[2mms[m[K[15C
[31m     → expected true to be false // Object.is equality[23C[m
[31m   × SMSService[2m > [22msendSMS[2m > [22mshould handle empty message text [32m8[2mms[m[K[13C
[31m     → expected true to be false // Object.is equality[23C[m
   [32m✓ [mSMSService[2m > [22msendSMS[2m > [22mshould handle rate limiting [32m15[2mms[m[K[17C
[31m   × SMSService[2m > [22msendSMS[2m > [22mshould handle long messages and calculate segment[m
[31m[13;77Hts [32m7[2mms[31m[22m[K[72C[m
[31m     → expected 'GSM' to be 'GSM-7' // Object.is equality[20C[m
[31m   × SMSService[2m > [22msendBulkSMS[2m > [22mshould send bulk SMS with rate limiting [32m22[2mms[m 
[31m     → expected undefined to deeply equal { totalSent: 3, totalFailed: +0, …([m
[31m[13;77H(1) }[73C[m
[31m   × SMSService[2m > [22msendBulkSMS[2m > [22mshould handle partial failures in bulk SMS [32m14[m
[32m[13;77H4[2mms[22m[K[75C[m
[31m     → expected undefined to deeply equal { totalSent: 2, totalFailed: 1, …(1[m
[31m[13;77H1) }[74C[m
[31m   × SMSService[2m > [22msendBulkSMS[2m > [22mshould respect rate limiting in bulk SMS [32m6[2mms[m 
[31m     → expected 1 to be greater than or equal to 100[25C[m
[31m   × SMSService[2m > [22msendBulkSMS[2m > [22mshould handle empty recipient list [32m7[2mms[m       
[31m     → expected undefined to be 'No recipients provided' // Object.is equalit[m
[31m[13;77Hty[76C[m
[31m   × SMSService[2m > [22mgetMessageStatus[2m > [22mshould retrieve message status successfu[m
[31m[13;77Hully [32m7[2mms[31m[22m[K[70C[m
[31m     → expected undefined to deeply equal { …(7) }[27C[m
[31m   × SMSService[2m > [22mgetMessageStatus[2m > [22mshould handle failed message status [32m5[2mms[m 
[31m     → expected undefined to be 'failed' // Object.is equality[15C[m
   [32m✓ [mSMSService[2m > [22mgetMessageStatus[2m > [22mshould handle non-existent message ID [32m3[2mm[m
[32m[2m[13;77Hms[22m[K[76C[m
[31m   × SMSService[2m > [22mgetAccountInfo[2m > [22mshould retrieve account information succes[m
[31m[13;77Hssfully [32m13[2mms[31m[22m[K[66C[m
[31m     → expected { sid: 'test-account-sid', …(5) } to deeply equal { Object (a[m
[31m[13;77HaccountSid, friendlyName, ...) }[46C[m
   [32m✓ [mSMSService[2m > [22mgetAccountInfo[2m > [22mshould handle account access errors [32m3[2mms[m   
   [32m✓ [mSMSService[2m > [22misConfigured[2m > [22mshould return true when all required config 
[13;77H is present [32m2[2mms[m[K[63C
   [32m✓ [mSMSService[2m > [22misConfigured[2m > [22mshould return false when account SID is miss
[13;77Hsing [32m3[2mms[m[K[70C
   [32m✓ [mSMSService[2m > [22misConfigured[2m > [22mshould return false when auth token is missi
[13;77Hing [32m2[2mms[m[K[71C
   [32m✓ [mSMSService[2m > [22misConfigured[2m > [22mshould return false when phone number is mis
[13;77Hssing [32m2[2mms[m[K[69C
[31m   × SMSService[2m > [22mformatPaymentMessage[2m > [22mshould format payment message for SM[m
[31m[13;77HMS correctly [32m8[2mms[31m[22m[K[62C[m
[31m     → cost.toFixed is not a function[40C[m
[31m   × SMSService[2m > [22mformatPaymentMessage[2m > [22mshould handle long medication names [m
[31m[13;77H by truncating [32m4[2mms[31m[22m[K[60C[m
[31m     → cost.toFixed is not a function[40C[m
[31m   × SMSService[2m > [22mformatPaymentMessage[2m > [22mshould format currency correctly for[m
[31m[13;77Hr different amounts [32m4[2mms[31m[22m[K[55C[m
[31m     → cost.toFixed is not a function[40C[m
[31m   × SMSService[2m > [22mgetMessageInfo[2m > [22mshould calculate message segments correctl[m
[31m[13;77Hly [32m6[2mms[31m[22m[K[72C[m
[31m     → expected 'GSM' to be 'GSM-7' // Object.is equality[20C[m
[31m   × SMSService[2m > [22mgetMessageInfo[2m > [22mshould detect Unicode encoding for special[m
[31m[13;77Hl characters [32m6[2mms[31m[22m[K[62C[m
[31m     → expected 'UCS2' to be 'UCS-2' // Object.is equality[19C[m
[31m   × SMSService[2m > [22mgetMessageInfo[2m > [22mshould estimate costs based on segments an[m
[31m[13;77Hnd destination [32m4[2mms[31m[22m[K[60C[m
[31m     → expected undefined to be close to 0.135, received difference is NaN, b[m
[31m[13;77Hbut expected 0.0005[59C[m
   [32m✓ [mSMSService[2m > [22mPhone Number Validation and Cleaning[2m > [22mshould accept valid 
[13;77H international phone numbers [32m5[2mms[m[K[46C
[31m   × SMSService[2m > [22mPhone Number Validation and Cleaning[2m > [22mshould reject invali[m
[31m[13;77Hid phone number formats [32m3[2mms[31m[22m[K[51C[m
[31m     → smsService.validatePhoneNumber is not a function[22C[m
   [32m✓ [mSMSService[2m > [22mPhone Number Validation and Cleaning[2m > [22mshould handle West A
[13;77HAfrican country codes correctly [32m3[2mms[m[K[43C
[31m   × SMSService[2m > [22mError Message Parsing[2m > [22mshould parse standard Twilio API er[m
[31m[13;77Hrrors [32m3[2mms[31m[22m[K[69C[m
[31m     → smsService.parseErrorMessage is not a function[24C[m
[31m   × SMSService[2m > [22mError Message Parsing[2m > [22mshould handle malformed error respo[m
[31m[13;77Honses [32m18[2mms[31m[22m[K[68C[m
[31m     → smsService.parseErrorMessage is not a function[24C[m
   [32m✓ [mSMSService[2m > [22mService Initialization[2m > [22mshould initialize with proper conf
[13;77Hfiguration [32m2[2mms[m[K[64C
   [32m✓ [mSMSService[2m > [22mService Initialization[2m > [22mshould handle missing environment 
[13;77H variables gracefully [32m9[2mms[m[K[53C
   [32m✓ [mSMSService[2m > [22mRate Limiting and Performance[2m > [22mshould implement delay func
[13;77Hction correctly [32m113[2mms[m[K[57C
   [32m✓ [mSMSService[2m > [22mRate Limiting and Performance[2m > [22mshould handle concurrent SM
[13;77HMS sending [32m6[2mms[m[K[64C
[90mstdout[2m | src/features/whatsappService.test.ts > WhatsAppService > sendMessage[m
[90m[2m[13;77He > should send a WhatsApp message successfully[22m[K[31C[m
WhatsApp message sent successfully: {[40C
  messaging_product: [32m'whatsapp'[m,[K[45C
  contacts: [ { wa_id: [32m'22912345678' [m} ],[K[36C
  messages: [ { id: [32m'msg_123' [m} ][K[44C
}[76C
[77C
[77C
[33m[1m ❯ [msrc/features/database.test.ts[2m [queued][22m[K[36C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 2/17[22m[K[34C
[33m[1m ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][22m[K[21C
[33m[1m ❯ [msrc/features/smsService.test.ts[2m 36/36[22m[K[37C
[33m[1m ❯ [msrc/features/whatsappService.test.ts[2m 1/26[22m[K[33C
[77C
[2m Test Files [31m[22m[1m6 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m78 failed[m[2m | [32m[22m[1m61 passed[90m[22m (179)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m13.05s[K[59C
[77C[?2026l[?2026h[90m[3;1Hstderr[2m | src/features/whatsappService.test.ts > WhatsAppService > sendMessage > should handle network errors[m[K
Error sending WhatsApp message: Error: Network timeout[K
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\whatsappService.test.ts:100:35[K
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:155:11[K
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:26[K
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1897:20[K
    at new Promise (<anonymous>)[K[45C
    at runWithTimeout (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/r
[13;77Hrunner/dist/chunk-hooks.js:1863:10)[43C
    at runTest (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/d
[13;77Hdist/chunk-hooks.js:1574:12)[50C
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
[77C
[77C
[33m[1m ❯ [msrc/features/database.test.ts[2m [queued][22m[K[36C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 2/17[22m[K[34C
[33m[1m ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][22m[K[21C
[33m[1m ❯ [msrc/features/smsService.test.ts[2m 36/36[22m[K[37C
[33m[1m ❯ [msrc/features/whatsappService.test.ts[2m 1/26[22m[K[33C
[77C
[2m Test Files [31m[22m[1m6 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m78 failed[m[2m | [32m[22m[1m61 passed[90m[22m (179)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m13.05s[K[59C[?2026l
[77C[?2026h[90m[3;1Hstdout[2m | src/features/whatsappService.test.ts > WhatsAppService > sendMessage > should clean phone numbers correctly[m[K
WhatsApp message sent successfully: {[K
  messaging_product: [32m'whatsapp'[m,[K
  contacts: [ { wa_id: [32m'22912345678' [m} ],[K
  messages: [ { id: [32m'msg_123' [m} ][K
}[K
[K[90m
stdout[2m | src/features/whatsappService.test.ts > WhatsAppService > sendMessage > should validate phone numbers[m[K
WhatsApp message sent successfully: {[K
  messaging_product: [32m'whatsapp'[m,[K[45C
  contacts: [ { wa_id: [32m'22912345678' [m} ],[K[36C
  messages: [ { id: [32m'msg_123' [m} ][K[44C
}[76C
[77C
[90mstdout[2m | src/features/whatsappService.test.ts > WhatsAppService > sendMessage[m
[90m[2m[13;77He > should handle empty message text[22m[K[42C[m
WhatsApp message sent successfully: {[40C
  messaging_product: [32m'whatsapp'[m,[K[45C
  contacts: [ { wa_id: [32m'22912345678' [m} ],[K[36C
  messages: [ { id: [32m'msg_123' [m} ][K[44C
}[76C
[77C
[77C
[33m[1m ❯ [msrc/features/database.test.ts[2m [queued][22m[K[36C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 2/17[22m[K[34C
[33m[1m ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][22m[K[21C
[33m[1m ❯ [msrc/features/smsService.test.ts[2m 36/36[22m[K[37C
[33m[1m ❯ [msrc/features/whatsappService.test.ts[2m 1/26[22m[K[33C
[77C
[2m Test Files [31m[22m[1m6 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m78 failed[m[2m | [32m[22m[1m61 passed[90m[22m (179)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m13.05s[K[59C[?2026l[?2026h
[77C[7;1H[K
[K
[K
[K
[K
[K
[K[77C[4;1H[K
[K
[K[77C[90m[3;1Hstderr[2m | src/features/whatsappService.test.ts > WhatsAppService > sendMessage > should handle rate limiting errors[m
WhatsApp API error: {
  error: { message: [32m'Rate limit exceeded'[m, type: [32m'OAuthException'[m, code: [33m4 [m}
}[90m[9;1Hstderr[2m | src/features/whatsappService.test.ts > WhatsAppService > sendTemplateMessage > should send a template message successfully[m
Error sending WhatsApp template message: TypeError: parameters.map is not a function
    at WhatsAppService.sendTemplateMessage [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\whatsappService.ts:123:38[90m)[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\whatsappService.test.ts:
[13;77H:195:44[71C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:155:11[61C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:26[61C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:1897:20[60C
    at new Promise (<anonymous>)[45C
    at runWithTimeout (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/r
[13;77Hrunner/dist/chunk-hooks.js:1863:10)[43C
    at runTest (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/d
[13;77Hdist/chunk-hooks.js:1574:12)[50C
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
[77C
[77C
[33m[1m ❯ [msrc/features/database.test.ts[2m [queued][22m[K[36C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 2/17[22m[K[34C
[33m[1m ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][22m[K[21C
[33m[1m ❯ [msrc/features/smsService.test.ts[2m 36/36[22m[K[37C
[33m[1m ❯ [msrc/features/whatsappService.test.ts[2m 1/26[22m[K[33C
[77C
[2m Test Files [31m[22m[1m6 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m78 failed[m[2m | [32m[22m[1m61 passed[90m[22m (179)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m13.05s[K[59C[?2026l
[77C[?2026h[7;1H[K
[K
[K
[K
[K
[K
[K
[K[77C[90m[3;1Hstderr[2m | src/features/whatsappService.test.ts > WhatsAppService > sendTemplateMessage > should handle template not found errors[m[K
Error sending WhatsApp template message: TypeError: parameters.map is not a function[K
    at WhatsAppService.sendTemplateMessage [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\whatsappService.ts:123:38[90m)[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\whatsappService.test.ts:230:44
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:155:11
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:26
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:1897:20[60C
    at new Promise (<anonymous>)[45C
    at runWithTimeout (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/r
[13;77Hrunner/dist/chunk-hooks.js:1863:10)[43C
    at runTest (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/d
[13;77Hdist/chunk-hooks.js:1574:12)[50C
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
[77C
[90mstderr[2m | src/features/whatsappService.test.ts > WhatsAppService > sendTemplat[m
[90m[2m[13;77HteMessage > should validate template parameters[22m[K[31C[m
Error sending WhatsApp template message: TypeError: parameters.map is not a f
[13;77Hfunction[70C
    at WhatsAppService.sendTemplateMessage [90m(C:\Users\akgte\PharmaRx\apps\api\[m
[90m[13;77H\[msrc\features\whatsappService.ts:123:38[90m)[K[38C[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\whatsappService.test.ts:
[13;77H:242:44[71C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:155:11[61C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:26[61C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:1897:20[60C
    at new Promise (<anonymous>)[45C
    at runWithTimeout (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/r
[13;77Hrunner/dist/chunk-hooks.js:1863:10)[43C
    at runTest (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/d
[13;77Hdist/chunk-hooks.js:1574:12)[50C
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
[77C
[90mstderr[2m | src/features/whatsappService.test.ts > WhatsAppService > isConfigure[m
[90m[2m[13;77Hed > should return false when access token is missing[22m[K[25C[m
WhatsApp API credentials not configured. WhatsApp messaging will not work.   
[77C
[90mstderr[2m | src/features/whatsappService.test.ts > WhatsAppService > isConfigure[m
[90m[2m[13;77Hed > should return false when phone number ID is missing[22m[K[22C[m
WhatsApp API credentials not configured. WhatsApp messaging will not work.   
[77C
[90mstderr[2m | src/features/whatsappService.test.ts > WhatsAppService > Service Ini[m
[90m[2m[13;77Hitialization > should handle missing environment variables gracefully[22m[K[9C[m
WhatsApp API credentials not configured. WhatsApp messaging will not work.   
[77C
[77C
[33m[1m ❯ [msrc/features/database.test.ts[2m 1/17[22m[K[40C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 2/17[22m[K[34C
[33m[1m ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][22m[K[21C
[33m[1m ❯ [msrc/features/smsService.test.ts[2m 36/36[22m[K[37C
[33m[1m ❯ [msrc/features/whatsappService.test.ts[2m 26/26[22m[K[32C
[77C
[2m Test Files [31m[22m[1m7 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m95 failed[m[2m | [32m[22m[1m70 passed[90m[22m (196)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m13.29s[K[59C[?2026l[?2026h
[90m[3;1Hstdout[2m | src/features/database.test.ts > DatabaseService > getDb > should initialize Firebase and return Firestore instance[m                               
🔧 Initializing Firebase Admin for test environment                          
📋 Project ID: pharmarx-dev                                                  
🧪 Using minimal configuration for Firebase emulators                        
✅ Firebase Admin initialized successfully                                   
                                                                             
 [31m❯ [msrc/features/whatsappService.test.ts [2m(26 tests | [31m[22m18 failed[m[2m)[33m[22m 381[2mms[m         [31m
   × WhatsAppService[2m > [22msendMessage[2m > [22mshould send a WhatsApp message successfully [32m131[2mms[m                                                                    [31m
     → expected undefined to deeply equal { messageId: 'msg_123', …(1) }     [m
   [32m✓ [mWhatsAppService[2m > [22msendMessage[2m > [22mshould handle API errors gracefully [32m5[2mms[m 
[31m   × WhatsAppService[2m > [22msendMessage[2m > [22mshould handle network errors [32m35[2mms[m       
[31m     → expected 'Network error while sending WhatsApp …' to be 'Failed to sen[m
[31m[13;77Hnd WhatsApp message: Netw…' // Object.is equality[29C[m
[31m   × WhatsAppService[2m > [22msendMessage[2m > [22mshould clean phone numbers correctly [32m12[2mm[m
[32m[2m[13;77Hms[22m[K[76C[m
[31m     → expected '+22912345678' to be '22912345678' // Object.is equality     [m
[31m   × WhatsAppService[2m > [22msendMessage[2m > [22mshould validate phone numbers [32m17[2mms[m      
[31m     → expected true to be false // Object.is equality[23C[m
[31m   × WhatsAppService[2m > [22msendMessage[2m > [22mshould handle empty message text [32m8[2mms[m    
[31m     → expected true to be false // Object.is equality[23C[m
   [32m✓ [mWhatsAppService[2m > [22msendMessage[2m > [22mshould handle rate limiting errors [32m6[2mms[m  
[31m   × WhatsAppService[2m > [22msendTemplateMessage[2m > [22mshould send a template message s[m
[31m[13;77Hsuccessfully [32m20[2mms[31m[22m[K[61C[m
[31m     → expected false to be true // Object.is equality[23C[m
[31m   × WhatsAppService[2m > [22msendTemplateMessage[2m > [22mshould handle template not found[m
[31m[13;77Hd errors [32m23[2mms[31m[22m[K[65C[m
[31m     → expected 'Network error while sending WhatsApp …' to be 'Template not [m
[31m[13;77H found' // Object.is equality[49C[m
[31m   × WhatsAppService[2m > [22msendTemplateMessage[2m > [22mshould validate template paramet[m
[31m[13;77Hters [32m17[2mms[31m[22m[K[69C[m
[31m     → expected 'Network error while sending WhatsApp …' to be 'Template name[m
[31m[13;77He cannot be empty' // Object.is equality[38C[m
   [32m✓ [mWhatsAppService[2m > [22misConfigured[2m > [22mshould return true when all required co
[13;77Honfig is present [32m2[2mms[m[K[58C
   [32m✓ [mWhatsAppService[2m > [22misConfigured[2m > [22mshould return false when access token i
[13;77His missing [32m3[2mms[m[K[64C
   [32m✓ [mWhatsAppService[2m > [22misConfigured[2m > [22mshould return false when phone number I
[13;77HID is missing [32m3[2mms[m[K[61C
[31m   × WhatsAppService[2m > [22misConfigured[2m > [22mshould return false when business accou[m
[31m[13;77Hunt ID is missing [32m6[2mms[31m[22m[K[57C[m
[31m     → expected true to be false // Object.is equality[23C[m
[31m   × WhatsAppService[2m > [22mgetBusinessProfile[2m > [22mshould retrieve business profile [m
[31m[13;77H successfully [32m23[2mms[31m[22m[K[60C[m
[31m     → expected { data: [ { …(5) } ] } to deeply equal { id: 'test-business-i[m
[31m[13;77Hid', …(4) }[67C[m
   [32m✓ [mWhatsAppService[2m > [22mgetBusinessProfile[2m > [22mshould handle business profile er
[13;77Hrrors [32m6[2mms[m[K[69C
[31m   × WhatsAppService[2m > [22mformatPaymentMessage[2m > [22mshould format payment message c[m
[31m[13;77Hcorrectly [32m4[2mms[31m[22m[K[65C[m
[31m     → cost.toFixed is not a function[40C[m
[31m   × WhatsAppService[2m > [22mformatPaymentMessage[2m > [22mshould handle long medication n[m
[31m[13;77Hnames [32m3[2mms[31m[22m[K[69C[m
[31m     → cost.toFixed is not a function[40C[m
[31m   × WhatsAppService[2m > [22mformatPaymentMessage[2m > [22mshould format currency correctl[m
[31m[13;77Hly [32m7[2mms[31m[22m[K[72C[m
[31m     → cost.toFixed is not a function[40C[m
[31m   × WhatsAppService[2m > [22mPhone Number Validation and Cleaning[2m > [22mshould accept v[m
[31m[13;77Hvalid international phone numbers [32m7[2mms[31m[22m[K[41C[m
[31m     → expected '+22912345678' not to contain '+'[28C[m
[31m   × WhatsAppService[2m > [22mPhone Number Validation and Cleaning[2m > [22mshould reject i[m
[31m[13;77Hinvalid phone number formats [32m3[2mms[31m[22m[K[46C[m
[31m     → whatsappService.validatePhoneNumber is not a function[17C[m
[31m   × WhatsAppService[2m > [22mPhone Number Validation and Cleaning[2m > [22mshould handle W[m
[31m[13;77HWest African country codes correctly [32m4[2mms[31m[22m[K[38C[m
[31m     → expected '+22912345678' to be '22912345678' // Object.is equality     [m
[31m   × WhatsAppService[2m > [22mError Message Parsing[2m > [22mshould parse standard WhatsApp[m
[31m[13;77Hp API errors [32m4[2mms[31m[22m[K[62C[m
[31m     → whatsappService.parseErrorMessage is not a function[19C[m
[31m   × WhatsAppService[2m > [22mError Message Parsing[2m > [22mshould handle malformed error [m
[31m[13;77H responses [32m4[2mms[31m[22m[K[64C[m
[31m     → whatsappService.parseErrorMessage is not a function[19C[m
   [32m✓ [mWhatsAppService[2m > [22mService Initialization[2m > [22mshould initialize with proper
[13;77Hr configuration [32m2[2mms[m[K[59C
   [32m✓ [mWhatsAppService[2m > [22mService Initialization[2m > [22mshould handle missing environ
[13;77Hnment variables gracefully [32m9[2mms[m[K[48C
[90mstdout[2m | src/features/database.test.ts > DatabaseService > getDb > should not[m
[90m[2m[13;77Ht reinitialize if already initialized[22m[K[41C[m
🔧 Initializing Firebase Admin for test environment[26C
📋 Project ID: pharmarx-dev[50C
🧪 Using minimal configuration for Firebase emulators[24C
✅ Firebase Admin initialized successfully[35C
[77C
[77C
[33m[1m ❯ [msrc/features/database.test.ts[2m 1/17[22m[K[40C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 2/17[22m[K[34C
[33m[1m ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][22m[K[21C
[33m[1m ❯ [msrc/features/smsService.test.ts[2m 36/36[22m[K[37C
[33m[1m ❯ [msrc/features/whatsappService.test.ts[2m 26/26[22m[K[32C
[77C
[2m Test Files [31m[22m[1m7 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m95 failed[m[2m | [32m[22m[1m70 passed[90m[22m (196)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m13.29s[K[59C[?2026l
[77C]0;node (vitest 2)[?2026h[90m[3;1Hstdout[2m | src/features/database.test.ts > DatabaseService > getDb > should initialize with development settings[m[K
🔧 Initializing Firebase Admin for development environment[K
📋 Project ID: test-project-dev[K
🧪 Using minimal configuration for Firebase emulators[K
✅ Firebase Admin initialized successfully[K
[K[90m
stdout[2m | src/features/database.test.ts > DatabaseService > getDb > should initialize with test settings[m[K
🔧 Initializing Firebase Admin for test environment[K
📋 Project ID: test-project[K
🧪 Using minimal configuration for Firebase emulators[K[24C
✅ Firebase Admin initialized successfully[35C
[77C
[90mstdout[2m | src/features/database.test.ts > DatabaseService > getDb > should use[m
[90m[2m[13;77He default project ID if not specified in development[22m[K[26C[m
🔧 Initializing Firebase Admin for development environment[19C
📋 Project ID: pharmarx-dev[50C
🧪 Using minimal configuration for Firebase emulators[24C
✅ Firebase Admin initialized successfully[35C
[77C
[90mstdout[2m | src/features/database.test.ts > DatabaseService > getDb > should ini[m
[90m[2m[13;77Hitialize with production settings[22m[K[45C[m
🚀 Initializing Firebase Admin for production[32C
🔐 Using service account credentials[41C
✅ Firebase Admin initialized successfully[35C
[77C
[90mstdout[2m | src/features/database.test.ts > DatabaseService > getDb > should use[m
[90m[2m[13;77He application default credentials in production if no service account key[22m     [m
🚀 Initializing Firebase Admin for production[32C
🔐 Using application default credentials[37C
✅ Firebase Admin initialized successfully[35C
[77C
[90mstdout[2m | src/features/database.test.ts > DatabaseService > healthCheck > shou[m
[90m[2m[13;77Huld return healthy status when database is accessible[22m[K[25C[m
🚀 Initializing Firebase Admin for production[32C
🔐 Using application default credentials[37C
✅ Firebase Admin initialized successfully[35C
[77C
[77C
[33m[1m ❯ [msrc/features/database.test.ts[2m 8/17[22m[K[40C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 3/17[22m[K[34C
[33m[1m ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][22m[K[21C
[33m[1m ❯ [msrc/features/smsService.test.ts[2m 36/36[22m[K[37C
[33m[1m ❯ [msrc/features/whatsappService.test.ts[2m 26/26[22m[K[32C
[77C
[2m Test Files [31m[22m[1m7 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m98 failed[m[2m | [32m[22m[1m75 passed[90m[22m (196)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m13.50s[K[59C[?2026l[?2026h
[90m[3;1Hstderr[2m | src/features/database.test.ts > DatabaseService > healthCheck > should return healthy status when database is accessible[m                         
Database health check failed: TypeError: db.collection(...).doc is not a function                                                                         
    at DatabaseService.healthCheck [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\database.ts:133:48[90m)                                                     [m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\database.test.ts:213:44 
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:155:11                                                             
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:26                                                             
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:1897:20[60C
    at new Promise (<anonymous>)[45C
    at runWithTimeout (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/r
[13;77Hrunner/dist/chunk-hooks.js:1863:10)[43C
    at runTest (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/d
[13;77Hdist/chunk-hooks.js:1574:12)[50C
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
[77C
[77C
[33m[1m ❯ [msrc/features/database.test.ts[2m 8/17[22m[K[40C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 3/17[22m[K[34C
[33m[1m ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][22m[K[21C
[33m[1m ❯ [msrc/features/smsService.test.ts[2m 36/36[22m[K[37C
[33m[1m ❯ [msrc/features/whatsappService.test.ts[2m 26/26[22m[K[32C
[77C
[2m Test Files [31m[22m[1m7 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m98 failed[m[2m | [32m[22m[1m75 passed[90m[22m (196)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m13.50s[K[59C[?2026l[?2026h
[90m[3;1Hstdout[2m | src/features/database.test.ts > DatabaseService > healthCheck > should return unhealthy status when database is not accessible[m                   
🚀 Initializing Firebase Admin for production                                
🔐 Using application default credentials                                     
✅ Firebase Admin initialized successfully                                   
                                                                             
                                                                             [33m[1m
 ❯ [msrc/features/database.test.ts[2m 8/17[22m                                        [33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 3/17[22m                                  [33m[1m
 ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][22m                     [33m[1m
 ❯ [msrc/features/smsService.test.ts[2m 36/36[22m                                     [33m[1m
 ❯ [msrc/features/whatsappService.test.ts[2m 26/26[22m[K[32C
[77C
[2m Test Files [31m[22m[1m7 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m98 failed[m[2m | [32m[22m[1m75 passed[90m[22m (196)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m13.50s[K[59C[?2026l
[77C[?2026h[90m[3;1Hstderr[2m | src/features/database.test.ts > DatabaseService > healthCheck > should return unhealthy status when database is not accessible[m[K
Database health check failed: TypeError: db.collection(...).doc is not a function[K
    at DatabaseService.healthCheck [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\database.ts:133:48[90m)[K[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\database.test.ts:234:44 
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:155:11[K
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:26[K
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:1897:20[60C
    at new Promise (<anonymous>)[45C
    at runWithTimeout (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/r
[13;77Hrunner/dist/chunk-hooks.js:1863:10)[43C
    at runTest (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/d
[13;77Hdist/chunk-hooks.js:1574:12)[50C
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
[77C
[90mstderr[2m | src/features/database.test.ts > DatabaseService > healthCheck > shou[m
[90m[2m[13;77Huld handle database initialization errors[22m[K[37C[m
Database health check failed: Error: Database initialization failed[10C
    at DatabaseService.<anonymous> [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\feat
[13;77Htures\database.test.ts:245:15[90m)[K[48C[m
    at DatabaseService.mockCall (file:///C:/Users/akgte/PharmaRx/node_modules
[13;77Hs/[4m@vitest[24m/spy/dist/index.js:96:15)[K[44C
    at DatabaseService.getDb (file:///C:/Users/akgte/PharmaRx/node_modules/[4mti[24m
[4m[13;77Hinyspy[24m/dist/index.js:47:103)[K[50C
    at DatabaseService.healthCheck [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\feat
[13;77Htures\database.ts:132:23[90m)[K[53C[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\database.test.ts:248:44 
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:155:11[61C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:26[61C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:1897:20[60C
    at new Promise (<anonymous>)[45C
    at runWithTimeout (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/r
[13;77Hrunner/dist/chunk-hooks.js:1863:10)[43C
[77C
[90mstderr[2m | src/features/paymentService.test.ts > PaymentService > processPaymen[m
[90m[2m[13;77Hnt > should successfully process an MTN Mobile Money payment[22m[K[18C[m
Failed to generate receipt for payment: mock-doc-id TypeError: this.receiptsC
[13;77HCollection.where(...).where(...).orderBy is not a function[20C
    at ReceiptService.generateReceiptNumber [90m(C:\Users\akgte\PharmaRx\apps\api[m
[90m[13;77Hi\[msrc\features\receiptService.ts:146:8[90m)[K[39C[m
    at ReceiptService.generateReceipt [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\f
[13;77Hfeatures\receiptService.ts:78:38[90m)[K[45C[m
    at PaymentService.processPayment [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\fe
[13;77Heatures\paymentService.ts:118:34[90m)[K[45C[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\paymentService.test.ts:1
[13;77H115:22[72C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:20[61C
[77C
[77C
[33m[1m ❯ [msrc/features/database.test.ts[2m 8/17[22m[K[40C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 3/17[22m[K[34C
[33m[1m ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][22m[K[21C
[33m[1m ❯ [msrc/features/smsService.test.ts[2m 36/36[22m[K[37C
[33m[1m ❯ [msrc/features/whatsappService.test.ts[2m 26/26[22m[K[32C
[77C
[2m Test Files [31m[22m[1m7 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m98 failed[m[2m | [32m[22m[1m75 passed[90m[22m (196)[K[38C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m13.50s[K[59C[?2026l
[77C[?2026h[3;1H [31m❯ [msrc/features/database.test.ts [2m(17 tests | [31m[22m9 failed[m[2m)[33m[22m 375[2mms[m[K
   [32m✓ [mDatabaseService[2m > [22mgetInstance[2m > [22mshould return singleton instance [32m18[2mms[m   
   [32m✓ [mDatabaseService[2m > [22mgetDb[2m > [22mshould initialize Firebase and return Firestore instance [32m19[2mms[m[K[31m
   × DatabaseService[2m > [22mgetDb[2m > [22mshould not reinitialize if already initialized[32m 69[2mms[m[K[31m
     → expected "spy" to be called at least once[K[m
   [32m✓ [mDatabaseService[2m > [22mgetDb[2m > [22mshould initialize with development settings [32m20[2mms[m[K
   [32m✓ [mDatabaseService[2m > [22mgetDb[2m > [22mshould initialize with test settings [32m7[2mms[m      
   [32m✓ [mDatabaseService[2m > [22mgetDb[2m > [22mshould use default project ID if not specified in development [32m8[2mms[m[K]0;node (vitest 5)[58C
[31m   × DatabaseService[2m > [22mgetDb[2m > [22mshould initialize with production settings [32m47[2mm[m
[32m[2m[13;77Hms[22m[K[76C[m
[31m     → expected "spy" to be called with arguments: [ { credential: Anything, [m
[31m[13;77H …(1) } ][69C[m
[90m[77C[m
[90mReceived:[68C[m
[90m[77C[m
[90m[1m  1st spy call:[22m[K[62C[m
[90m[77C[m
[90m[2m  [[22m[K[74C[m
[90m[2m    {[22m[K[72C[m
[32m-     "credential": Anything,[48C[m
[31m+     "credential": undefined,[47C[m
[90m[2m      "projectId": "pharmarx-prod",[22m[K[42C[m
[90m[2m    },[22m[K[71C[m
[90m[2m  ][22m[K[74C[m
[90m[77C[m
[90m[77C[m
[90mNumber of calls: [1m1[22m[K[59C[m
[90m[77C[m
[31m   × DatabaseService[2m > [22mgetDb[2m > [22mshould use application default credentials in [m
[31m[13;77H production if no service account key [32m12[2mms[31m[22m[K[36C[m
[31m     → expected "spy" to be called with arguments: [ { credential: Anything, [m
[31m[13;77H …(1) } ][69C[m
[90m[77C[m
[90mReceived:[68C[m
[90m[77C[m
[90m[1m  1st spy call:[22m[K[62C[m
[90m[77C[m
[90m[2m  [[22m[K[74C[m
[90m[2m    {[22m[K[72C[m
[32m-     "credential": Anything,[48C[m
[31m+     "credential": undefined,[47C[m
[90m[2m      "projectId": "pharmarx-prod",[22m[K[42C[m
[90m[2m    },[22m[K[71C[m
[90m[2m  ][22m[K[74C[m
[90m[77C[m
[90m[77C[m
[90mNumber of calls: [1m1[22m[K[59C[m
[90m[77C[m
[31m   × DatabaseService[2m > [22mhealthCheck[2m > [22mshould return healthy status when databa[m
[31m[13;77Hase is accessible [32m39[2mms[31m[22m[K[56C[m
[31m     → expected { status: 'unhealthy', …(2) } to deeply equal { status: 'heal[m
[31m[13;77Hlthy', connected: true }[54C[m
[31m   × DatabaseService[2m > [22mhealthCheck[2m > [22mshould return unhealthy status when data[m
[31m[13;77Habase is not accessible [32m25[2mms[31m[22m[K[50C[m
[31m     → expected { status: 'unhealthy', …(2) } to deeply equal { status: 'unhe[m
[31m[13;77Healthy', …(1) }[63C[m
[31m   × DatabaseService[2m > [22mhealthCheck[2m > [22mshould handle database initialization er[m
[31m[13;77Hrrors [32m16[2mms[31m[22m[K[68C[m
[31m     → expected { status: 'unhealthy', …(2) } to deeply equal { status: 'unhe[m
[31m[13;77Healthy', …(1) }[63C[m
[31m   × DatabaseService[2m > [22mclose[2m > [22mshould close all Firebase apps [32m7[2mms[m[K[12C
[31m     → expected "spy" to be called at least once[29C[m
[31m   × DatabaseService[2m > [22mclose[2m > [22mshould handle apps array with null values [32m5[2mms[m 
[31m     → expected "spy" to be called at least once[29C[m
   [32m✓ [mDatabaseService[2m > [22mclose[2m > [22mshould handle empty apps array [32m7[2mms[m[K[12C
   [32m✓ [mDatabaseService[2m > [22mclose[2m > [22mshould handle app deletion errors gracefully [32m1[m
[32m[13;77H13[2mms[22m[K[74C[m
   [32m✓ [mDatabaseService[2m > [22merror handling[2m > [22mshould handle malformed service accou
[13;77Hunt key [32m45[2mms[m[K[66C
[31m   × DatabaseService[2m > [22msingleton behavior[2m > [22mshould maintain singleton pattern[m
[31m[13;77Hn across multiple requires [32m5[2mms[31m[22m[K[48C[m
[31m     → Database initialization failed[40C[m
[77C
[33m[1m ❯ [msrc/features/database.test.ts[2m 17/17[22m[K[39C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 3/17[22m[K[34C
[33m[1m ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][22m[K[21C
[33m[1m ❯ [msrc/features/whatsappService.test.ts[2m 26/26[22m[K[32C
[77C
[2m Test Files [31m[22m[1m8 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m104 failed[m[2m | [32m[22m[1m78 passed[90m[22m (196)[K[37C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m14.14s[K[59C[?2026l
[77C[?2026h[9;1H[K
[K
[K
[K
[K
[K[77C[?2026l[4;1H[K
[K[33m[1m
 ❯ [msrc/features/database.test.ts[2m 17/17[22m[K[33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 3/17[22m[K[33m[1m
 ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m [queued][22m[K[2m[10;1H Test Files [31m[22m[1m8 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[m[2m
      Tests [31m[22m[1m104 failed[m[2m | [32m[22m[1m78 passed[90m[22m (196)[m[2m
   Start at [22m08:15:18[2m
   Duration [22m14.26s]0;node (vitest 4)[?2026h[?2026l[4;1H[K
[K[33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 3/17[22m[K[33m[1m
 ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m 0/27[22m[K[33m[1m
 ❯ [msrc/index.test.ts[2m [queued][22m[K
[K[2m
 Test Files [31m[22m[1m8 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[m[2m
      Tests [31m[22m[1m104 failed[m[2m | [32m[22m[1m78 passed[90m[22m (223)[K[m[2m
   Start at [22m08:15:18[K[2m
   Duration [22m14.52s[K
[K[77C[?2026h[?2026l[4;1H[K
[K[33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 3/17[22m[K[33m[1m
 ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m 1/27[22m[K[33m[1m
 ❯ [msrc/index.test.ts[2m [queued][22m[K
[K[2m
 Test Files [31m[22m[1m8 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[m[2m
      Tests [31m[22m[1m105 failed[m[2m | [32m[22m[1m78 passed[90m[22m (223)[K[m[2m
   Start at [22m08:15:18[K[2m
   Duration [22m14.62s[K
[K[77C]0;node (vitest 3)[?2026h[?2026l[4;1H[K
[K[33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 3/17[22m[K[33m[1m
 ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m 2/27[22m[K[33m[1m
 ❯ [msrc/index.test.ts[2m [queued][22m[K
[K[2m
 Test Files [31m[22m[1m8 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[m[2m
      Tests [31m[22m[1m106 failed[m[2m | [32m[22m[1m78 passed[90m[22m (223)[K[m[2m
   Start at [22m08:15:18[K[2m
   Duration [22m14.72s[K
[K[77C[?2026h[K[77C[13;1H[K[77C[12;1H[K[77C[11;1H[K[77C[10;1H[K[77C[9;1H[K[77C[8;1H[K[77C[7;1H[K[77C[6;1H[K[77C[4;1H[K
[K[77C[?2026l[33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 3/17[33m[22m[1m
 ❯ [msrc/features/prescriptionOrderRoutes.test.ts[2m 7/27[33m[22m[1m
 ❯ [msrc/index.test.ts[2m [queued][10;1H Test Files [31m[22m[1m8 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[m[2m
      Tests [31m[22m[1m110 failed[m[2m | [32m[22m[1m79 passed[90m[22m (223)[m[2m
   Start at [22m08:15:18[2m
   Duration [22m14.94s[?2026h[4;1H [31m❯ [msrc/features/prescriptionOrderRoutes.test.ts [2m(27 tests | [31m[22m23 failed[m[2m)[33m[22m 1030[2mms[31m[22m
   × Prescription Order Routes[2m > [22mPOST /orders[2m > [22mshould create prescription order and trigger OCR processing [32m90[2mms[m[K[31m
     → Cannot find module './ocrService'[K
Require stack:[K
- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.ts[K
   × Prescription Order Routes[2m > [22mPOST /orders[2m > [22mshould return 400 for missing patient profile ID [32m7[2mms[m[K[31m
     → Cannot find module './ocrService'[K
Require stack:[K[63C[m
[31m- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.[m
[31m[13;77H.ts[75C[m
[31m   × Prescription Order Routes[2m > [22mPOST /orders[2m > [22mshould return 400 for missing[m
[31m[13;77Hg image URL [32m7[2mms[31m[22m[K[63C[m
[31m     → Cannot find module './ocrService'[37C[m
[31mRequire stack:[63C[m
[31m- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.[m
[31m[13;77H.ts[75C[m
[31m   × Prescription Order Routes[2m > [22mPOST /orders[2m > [22mshould return 400 for invalid[m
[31m[13;77Hd image URL [32m5[2mms[31m[22m[K[63C[m
[31m     → Cannot find module './ocrService'[37C[m
[31mRequire stack:[63C[m
[31m- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.[m
[31m[13;77H.ts[75C[m
[31m   × Prescription Order Routes[2m > [22mPOST /orders[2m > [22mshould handle database errors[m
[31m[13;77Hs during order creation [32m4[2mms[31m[22m[K[51C[m
[31m     → Cannot find module './ocrService'[37C[m
[31mRequire stack:[63C[m
[31m- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.[m
[31m[13;77H.ts[75C[m
[31m   × Prescription Order Routes[2m > [22mGET /orders[2m > [22mshould return orders for valid[m
[31m[13;77Hd patient [32m9[2mms[31m[22m[K[65C[m
[31m     → Cannot find module './database'[39C[m
[31mRequire stack:[63C[m
[31m- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.[m
[31m[13;77H.ts[75C[m
   [32m✓ [mPrescription Order Routes[2m > [22mGET /orders[2m > [22mshould return 400 for missing 
[13;77H patient ID [32m148[2mms[m[K[61C
[31m   × Prescription Order Routes[2m > [22mGET /orders[2m > [22mshould return empty array for [m
[31m[13;77H patient with no orders [32m6[2mms[31m[22m[K[51C[m
[31m     → Cannot find module './database'[39C[m
[31mRequire stack:[63C[m
[31m- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.[m
[31m[13;77H.ts[75C[m
[31m   × Prescription Order Routes[2m > [22mGET /orders/:orderId[2m > [22mshould return specifi[m
[31m[13;77Hic order by ID [32m8[2mms[31m[22m[K[60C[m
[31m     → Cannot find module './database'[39C[m
[31mRequire stack:[63C[m
[31m- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.[m
[31m[13;77H.ts[75C[m
[31m   × Prescription Order Routes[2m > [22mGET /orders/:orderId[2m > [22mshould return 404 for[m
[31m[13;77Hr non-existent order [32m6[2mms[31m[22m[K[54C[m
[31m     → Cannot find module './database'[39C[m
[31mRequire stack:[63C[m
[31m- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.[m
[31m[13;77H.ts[75C[m
[31m   × Prescription Order Routes[2m > [22mPUT /orders/:orderId/status[2m > [22mshould update [m
[31m[13;77H order status successfully [32m6[2mms[31m[22m[K[48C[m
[31m     → Cannot find module './database'[39C[m
[31mRequire stack:[63C[m
[31m- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.[m
[31m[13;77H.ts[75C[m
   [33m[2m✓[m Prescription Order Routes[2m > [22mPUT /orders/:orderId/status[2m > [22mshould return 
[13;77H 400 for invalid status  [33m341[2mms[m[K[48C
   [32m✓ [mPrescription Order Routes[2m > [22mPUT /orders/:orderId/status[2m > [22mshould return 
[13;77H 400 for missing status [32m151[2mms[m[K[49C
[31m   × Prescription Order Routes[2m > [22mPUT /orders/:orderId/manual-text[2m > [22mshould ac[m
[31m[13;77Hccept manual text entry when OCR failed [32m11[2mms[31m[22m[K[34C[m
[31m     → Cannot find module './database'[39C[m
[31mRequire stack:[63C[m
[31m- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.[m
[31m[13;77H.ts[75C[m
[31m   × Prescription Order Routes[2m > [22mPUT /orders/:orderId/manual-text[2m > [22mshould ac[m
[31m[13;77Hccept manual text entry when OCR pending [32m24[2mms[31m[22m[K[33C[m
[31m     → Cannot find module './database'[39C[m
[31mRequire stack:[63C[m
[31m- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.[m
[31m[13;77H.ts[75C[m
[31m   × Prescription Order Routes[2m > [22mPUT /orders/:orderId/manual-text[2m > [22mshould re[m
[31m[13;77Heturn 409 if OCR already completed [32m5[2mms[31m[22m[K[40C[m
[31m     → Cannot find module './database'[39C[m
[31mRequire stack:[63C[m
[31m- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.[m
[31m[13;77H.ts[75C[m
   [32m✓ [mPrescription Order Routes[2m > [22mPUT /orders/:orderId/manual-text[2m > [22mshould re
[13;77Heturn 400 for empty text [32m31[2mms[m[K[49C
[31m   × Prescription Order Routes[2m > [22mPUT /orders/:orderId/manual-text[2m > [22mshould re[m
[31m[13;77Heturn 404 for non-existent order [32m5[2mms[31m[22m[K[42C[m
[31m     → Cannot find module './database'[39C[m
[31mRequire stack:[63C[m
[31m- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.[m
[31m[13;77H.ts[75C[m
[31m   × Prescription Order Routes[2m > [22mOCR processing integration[2m > [22mshould validate[m
[31m[13;77He image before processing [32m8[2mms[31m[22m[K[49C[m
[31m     → Cannot find module './ocrService'[37C[m
[31mRequire stack:[63C[m
[31m- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.[m
[31m[13;77H.ts[75C[m
[31m   × Order History Endpoints[2m > [22mGET /orders/history[2m > [22mshould return order hist[m
[31m[13;77Htory with pagination [32m6[2mms[31m[22m[K[54C[m
[31m     → Cannot find module './database'[39C[m
[31mRequire stack:[63C[m
[31m- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.[m
[31m[13;77H.ts[75C[m
[31m   × Order History Endpoints[2m > [22mGET /orders/history[2m > [22mshould return 400 if pat[m
[31m[13;77HtientId is missing [32m85[2mms[31m[22m[K[55C[m
[31m     → expected 404 to be 400 // Object.is equality[26C[m
[31m   × Order History Endpoints[2m > [22mGET /orders/history[2m > [22mshould handle pagination[m
[31m[13;77Hn correctly [32m6[2mms[31m[22m[K[63C[m
[31m     → Cannot find module './database'[39C[m
[31mRequire stack:[63C[m
[31m- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.[m
[31m[13;77H.ts[75C[m
[31m   × Order History Endpoints[2m > [22mReceipt Download Endpoints[2m > [22mshould download r[m
[31m[13;77Hreceipt for delivered order [32m5[2mms[31m[22m[K[47C[m
[31m     → Cannot find module './database'[39C[m
[31mRequire stack:[63C[m
[31m- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.[m
[31m[13;77H.ts[75C[m
[31m   × Order History Endpoints[2m > [22mReceipt Download Endpoints[2m > [22mshould return 404[m
[31m[13;77H4 if order not found [32m4[2mms[31m[22m[K[54C[m
[31m     → Cannot find module './database'[39C[m
[31mRequire stack:[63C[m
[31m- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.[m
[31m[13;77H.ts[75C[m
[31m   × Order History Endpoints[2m > [22mReceipt Download Endpoints[2m > [22mshould return 403[m
[31m[13;77H3 if order does not belong to patient [32m4[2mms[31m[22m[K[37C[m
[31m     → Cannot find module './database'[39C[m
[31mRequire stack:[63C[m
[31m- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.[m
[31m[13;77H.ts[75C[m
[31m   × Order History Endpoints[2m > [22mReceipt Download Endpoints[2m > [22mshould return 400[m
[31m[13;77H0 if order is not delivered [32m4[2mms[31m[22m[K[47C[m
[31m     → Cannot find module './database'[39C[m
[31mRequire stack:[63C[m
[31m- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.[m
[31m[13;77H.ts[75C[m
[31m   × Order History Endpoints[2m > [22mReceipt Download Endpoints[2m > [22mshould return 400[m
[31m[13;77H0 if patientId is missing [32m29[2mms[31m[22m[K[48C[m
[31m     → expected 404 to be 400 // Object.is equality[26C[m
[77C
[33m[1m ❯ [msrc/features/paymentLinkRoutes.test.ts[2m [queued][22m[K[27C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 4/17[22m[K[34C
[33m[1m ❯ [msrc/index.test.ts[2m [queued][22m[K[48C
[77C
[2m Test Files [31m[22m[1m9 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m127 failed[m[2m | [32m[22m[1m83 passed[90m[22m (223)[K[37C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m15.75s[K[59C[?2026l
[77C[?2026h[5;1H[K[33m[1m
 ❯ [msrc/features/paymentLinkRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentLinkService.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 4/17[22m[K[33m[1m
 ❯ [msrc/index.test.ts[2m [queued][22m[K
[K[2m
 Test Files [31m[22m[1m9 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[m[2m
      Tests [31m[22m[1m127 failed[m[2m | [32m[22m[1m83 passed[90m[22m (223)[K[m[2m
   Start at [22m08:15:18[K[2m
   Duration [22m15.95s[K[59C[?2026l
[77C[?2026h[12;1H[K
[K
[K[77C[4;1H[K[33m[1m
 ❯ [msrc/features/paymentLinkRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentLinkService.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 4/17[22m[K[33m[1m
 ❯ [msrc/index.test.ts[2m [queued][22m[K
[K[2m
 Test Files [31m[22m[1m9 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[m[2m
      Tests [31m[22m[1m127 failed[m[2m | [32m[22m[1m83 passed[90m[22m (223)[m[2m
   Start at [22m08:15:18[2m
   Duration [22m16.33s[?2026l
[77C[?2026h[?2026l[3;1H[K[33m[1m
 ❯ [msrc/features/paymentLinkRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentLinkService.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 4/17[22m[K[33m[1m
 ❯ [msrc/index.test.ts[2m [queued][22m[K
[K[2m
 Test Files [31m[22m[1m9 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[m[2m
      Tests [31m[22m[1m127 failed[m[2m | [32m[22m[1m83 passed[90m[22m (223)[K[m[2m
   Start at [22m08:15:18[K[2m
   Duration [22m16.58s[K
[K[77C[?2026h[?2026l[3;1H[K[33m[1m
 ❯ [msrc/features/paymentLinkRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentLinkService.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 4/17[22m[K[33m[1m
 ❯ [msrc/index.test.ts[2m [queued][22m[K
[K[2m
 Test Files [31m[22m[1m9 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[m[2m
      Tests [31m[22m[1m127 failed[m[2m | [32m[22m[1m83 passed[90m[22m (223)[K[m[2m
   Start at [22m08:15:18[K[2m
   Duration [22m16.79s[K
[K[77C]0;node (vitest 6)[?2026h[12;1H[K
[K
[K[77C[5;1H[K
[K
[K
[K
[K
[K
[K[77C[4;1H[K[77C[?2026l[3;1H[K[33m[1m
 ❯ [msrc/features/paymentLinkRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/paymentLinkService.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/paymentRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 4/17[33m[22m[1m
 ❯ [msrc/index.test.ts[2m [queued][10;1H Test Files [31m[22m[1m9 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[m[2m
      Tests [31m[22m[1m127 failed[m[2m | [32m[22m[1m83 passed[90m[22m (223)[m[2m
   Start at [22m08:15:18[2m
   Duration [22m17.55s[?2026h[3;1H[K[33m[1m
 ❯ [msrc/features/paymentLinkRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentLinkService.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 4/17[22m[K[33m[1m
 ❯ [msrc/features/profileRoutes.integration.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/index.test.ts[2m [queued][22m[K
[K[2m
 Test Files [31m[22m[1m9 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[m[2m
      Tests [31m[22m[1m127 failed[m[2m | [32m[22m[1m83 passed[90m[22m (223)[K[m[2m
   Start at [22m08:15:18[K[2m
   Duration [22m17.91s[K[59C[?2026l
[77C]0;node (vitest 4)[?2026h[K[77C[10;1H[K
[K
[K
[K[77C[9;1H[K[77C[4;1H[K
[K
[K
[K
[K[77C[2;1H[K[33m[1m
 ❯ [msrc/features/paymentLinkRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentLinkService.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/paymentRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 5/17[33m[22m[1m
 ❯ [msrc/features/profileRoutes.integration.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/index.test.ts[2m [queued][10;1H Test Files [31m[22m[1m9 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[m[2m
      Tests [31m[22m[1m127 failed[m[2m | [32m[22m[1m84 passed[90m[22m (223)[m[2m
   Start at [22m08:15:18[2m
   Duration [22m18.54s[?2026l]0;node (vitest 5)[?2026h[2;1H[K[33m[1m
 ❯ [msrc/features/paymentLinkRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentLinkService.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 7/17[22m[K[33m[1m
 ❯ [msrc/features/profileRoutes.integration.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/profileRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/index.test.ts[2m [queued][22m[K
[K[2m
 Test Files [31m[22m[1m9 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[m[2m
      Tests [31m[22m[1m127 failed[m[2m | [32m[22m[1m86 passed[90m[22m (223)[K[m[2m
   Start at [22m08:15:18[K[2m
   Duration [22m19.27s[K[59C[?2026l
[77C[?2026h[?2026l[H[K[33m[1m
 ❯ [msrc/features/paymentLinkRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentLinkService.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 7/17[22m[K[33m[1m
 ❯ [msrc/features/profileRoutes.integration.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/profileRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/index.test.ts[2m [queued][22m[K
[K[2m
 Test Files [31m[22m[1m9 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[m[2m
      Tests [31m[22m[1m127 failed[m[2m | [32m[22m[1m86 passed[90m[22m (223)[K[m[2m
   Start at [22m08:15:18[K[2m
   Duration [22m19.60s[K
[K[77C[?2026h[H[K[33m[1m
 ❯ [msrc/features/paymentLinkRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentLinkService.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentService.test.ts[2m 7/17[22m[K[33m[1m
 ❯ [msrc/features/profileRoutes.integration.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/profileRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/publicPaymentRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/index.test.ts[2m [queued][22m[K
[K[2m
 Test Files [31m[22m[1m9 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[m[2m
      Tests [31m[22m[1m127 failed[m[2m | [32m[22m[1m86 passed[90m[22m (223)[K[m[2m
   Start at [22m08:15:18[K[2m
   Duration [22m20.60s[K[59C[?2026l
[77C[?2026h[2;1H[K
[K
[K
[K
[K
[K
[K
[K
[K
[K
[K
[K
[K[77C[90m[Hstderr[2m | src/features/paymentService.test.ts > PaymentService > processPayment > should validate order exists and is in correct state[m
Failed to generate receipt for payment: mock-doc-id TypeError: this.receiptsCollection.where(...).where(...).orderBy is not a function
    at ReceiptService.generateReceiptNumber [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\receiptService.ts:146:8[90m)[m
    at ReceiptService.generateReceipt [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\receiptService.ts:78:38[90m)[m
    at PaymentService.processPayment [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\paymentService.ts:118:34[90m)[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\paymentService.test.ts:211:7
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20
[77C
[2m8:15:39 AM[22m [33m[1m[vite][m [33m[2m(ssr)[m [33mwarning: This assignment will throw because "firestor[m
[33m[13;77Hre" is an import[62C[m
[33m50 |[73C[m
[33m51 |      (PaymentLinkService as any).mockImplementation(() => mockPaymentLin[m
[33m[13;77HnkService);[67C[m
[33m52 |      (firestore as any) = mockFirestore;[32C[m
[33m   |       ^[65C[m
[33m53 |    });[66C[m
[33m54 |[73C[m
[33m[77C[m
  Plugin: [35mvite:esbuild[K[55C[m
  File: [36mC:/Users/akgte/PharmaRx/apps/api/src/features/publicPaymentRoutes.tes[m
[36m[13;77Hst.ts[73C[m
[77C
[33m[1m ❯ [msrc/features/paymentLinkRoutes.test.ts[2m [queued][22m[K[27C
[33m[1m ❯ [msrc/features/paymentLinkService.test.ts[2m [queued][22m[K[26C
[33m[1m ❯ [msrc/features/paymentRoutes.test.ts[2m [queued][22m[K[31C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 8/17[22m[K[34C
[33m[1m ❯ [msrc/features/profileRoutes.integration.test.ts[2m [queued][22m[K[19C
[33m[1m ❯ [msrc/features/profileRoutes.test.ts[2m [queued][22m[K[31C
[33m[1m ❯ [msrc/features/publicPaymentRoutes.test.ts[2m [queued][22m[K[25C
[33m[1m ❯ [msrc/index.test.ts[2m [queued][22m[K[48C
[77C
[2m Test Files [31m[22m[1m9 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[41C[m
[2m      Tests [31m[22m[1m128 failed[m[2m | [32m[22m[1m86 passed[90m[22m (223)[K[37C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m20.93s[K[59C
[77C[?2026l]0;node (vitest 3)[?2026h[K[77C[13;1H[K[77C[12;1H[K[77C[11;1H[K[77C[5;1H[K
[K
[K
[K
[K
[K[77C[H [31m❯ [msrc/features/paymentService.test.ts [2m(17 tests | [31m[22m7 failed[m[2m)[33m[22m 14053[2mms[m[K
   [33m[2m✓[m PaymentService[2m > [22mprocessPayment[2m > [22mshould successfully process a Stripe payment  [33m2124[2mms[m[K
   [33m[2m✓[m PaymentService[2m > [22mprocessPayment[2m > [22mshould successfully process a PayPal payment  [33m1525[2mms[m
   [33m[2m✓[m PaymentService[2m > [22mprocessPayment[2m > [22mshould successfully process an MTN Mobile Money payment  [33m3047[2mms[m
   [33m[2m✓[m PaymentService[2m > [22mprocessPayment[2m > [22mshould fail Stripe payment with card ending in 0000  [33m2049[2mms[m
   [33m[2m✓[m PaymentService[2m > [22mprocessPayment[2m > [22mshould fail MTN payment with phone number containing 0000  [33m3035[2mms[m
   [32m✓ [mPaymentService[2m > [22mprocessPayment[2m > [22mshould validate required Stripe payment data [32m7[2mms[m
   [32m✓ [mPaymentService[2m > [22mprocessPayment[2m > [22mshould validate required MTN payment d
[13;77Hdata [32m7[2mms[m[K[70C
[31m   × PaymentService[2m > [22mprocessPayment[2m > [22mshould validate order exists and is in[m
[31m[13;77Hn correct state [33m2153[2mms[31m[22m[K[56C[m
[31m     → promise resolved "{ paymentId: 'mock-doc-id', …(3) }" instead of rejec[m
[31m[13;77Hcting[73C[m
   [32m✓ [mPaymentService[2m > [22mprocessPayment[2m > [22mshould validate payment amount [32m7[2mms[m    
   [32m✓ [mPaymentService[2m > [22mprocessPayment[2m > [22mshould reject unsupported payment gate
[13;77Heway [32m5[2mms[m[K[70C
[31m   × PaymentService[2m > [22mgetPayment[2m > [22mshould return payment when it exists [32m15[2mms[m 
[31m     → expected { orderId: 'test-order-1', …(2) } to deeply equal { paymentId[m
[31m[13;77Hd: 'test-payment-1', …(3) }[51C[m
[31m   × PaymentService[2m > [22mgetPayment[2m > [22mshould return null when payment does not e[m
[31m[13;77Hexist [32m11[2mms[31m[22m[K[68C[m
[31m     → expected { orderId: 'test-order-1', …(2) } to be null[17C[m
[31m   × PaymentService[2m > [22mgetPaymentsForOrder[2m > [22mshould return payments for an ord[m
[31m[13;77Hder [32m15[2mms[31m[22m[K[70C[m
[31m     → expected [] to deeply equal [ …(2) ][34C[m
[31m   × PaymentService[2m > [22mprocessWebhook[2m > [22mshould process Stripe webhook successf[m
[31m[13;77Hfully [32m13[2mms[31m[22m[K[68C[m
[31m     → promise rejected "Error: Payment not found for transaction …" instead [m
[31m[13;77H of resolving[65C[m
[31m   × PaymentService[2m > [22mprocessWebhook[2m > [22mshould process PayPal webhook successf[m
[31m[13;77Hfully [32m8[2mms[31m[22m[K[69C[m
[31m     → promise rejected "Error: Payment not found for transaction …" instead [m
[31m[13;77H of resolving[65C[m
[31m   × PaymentService[2m > [22mprocessWebhook[2m > [22mshould process MTN webhook successfull[m
[31m[13;77Hly [32m8[2mms[31m[22m[K[72C[m
[31m     → promise rejected "Error: Payment not found for transaction …" instead [m
[31m[13;77H of resolving[65C[m
   [32m✓ [mPaymentService[2m > [22mprocessWebhook[2m > [22mshould reject webhook with invalid sig
[13;77Hgnature [32m3[2mms[m[K[67C
[77C
[33m[1m ❯ [msrc/features/paymentLinkRoutes.test.ts[2m [queued][22m[K[27C
[33m[1m ❯ [msrc/features/paymentLinkService.test.ts[2m [queued][22m[K[26C
[33m[1m ❯ [msrc/features/paymentRoutes.test.ts[2m [queued][22m[K[31C
[33m[1m ❯ [msrc/features/paymentService.test.ts[2m 17/17[22m[K[33C
[33m[1m ❯ [msrc/features/profileRoutes.integration.test.ts[2m [queued][22m[K[19C
[33m[1m ❯ [msrc/features/profileRoutes.test.ts[2m [queued][22m[K[31C
[33m[1m ❯ [msrc/features/publicPaymentRoutes.test.ts[2m [queued][22m[K[25C
[33m[1m ❯ [msrc/index.test.ts[2m [queued][22m[K[48C
[77C
[2m Test Files [31m[22m[1m10 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[40C[m
[2m      Tests [31m[22m[1m134 failed[m[2m | [32m[22m[1m89 passed[90m[22m (223)[K[37C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m21.93s[K[59C[?2026l
[77C]0;node (vitest 1)[?2026h[11;1H[K
[K
[K
[K[77C[H[K
[K
[K
[K
[K
[K
[K
[K
[K
[K[77C[33m[1m[2;1H ❯ [msrc/features/paymentLinkRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/paymentLinkService.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/paymentRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/profileRoutes.integration.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/profileRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/publicPaymentRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/receiptService.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/index.test.ts[2m [queued][11;1H Test Files [31m[22m[1m10 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[m[2m
      Tests [31m[22m[1m134 failed[m[2m | [32m[22m[1m89 passed[90m[22m (223)[m[2m
   Start at [22m08:15:18[2m
   Duration [22m22.67s[?2026l
[77C[?2026h[H[K
[K
[K
[K
[K
[K
[K
[K
[K
[K
[K
[K
[K
[K[77C[H[K[33m[1m
 ❯ [msrc/features/paymentLinkRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/paymentLinkService.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/paymentRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/profileRoutes.integration.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/profileRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/publicPaymentRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/receiptService.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/index.test.ts[2m [queued][11;1H Test Files [31m[22m[1m10 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[m[2m
      Tests [31m[22m[1m134 failed[m[2m | [32m[22m[1m89 passed[90m[22m (223)[m[2m
   Start at [22m08:15:18[2m
   Duration [22m22.88s[?2026l
[77C[?2026h[7;1H[K
[K
[K
[K
[K
[K
[K
[K[77C[6;1H[K[77C[5;1H[K[77C[H[K[33m[1m
 ❯ [msrc/features/paymentLinkRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentLinkService.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/profileRoutes.integration.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/profileRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/publicPaymentRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/receiptService.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/index.test.ts[2m [queued][11;1H Test Files [31m[22m[1m10 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[m[2m
      Tests [31m[22m[1m134 failed[m[2m | [32m[22m[1m89 passed[90m[22m (223)[m[2m
   Start at [22m08:15:18[2m
   Duration [22m22.99s[?2026l
[77C[?2026h[K[77C[11;1H[K
[K
[K[77C[4;1H[K
[K
[K
[K
[K
[K
[K[77C[90m[Hstdout[2m | src/index.test.ts[m[K
Using Google Cloud Application Default Credentials[K
OCR Service initialized successfully[K[33m[1m[6;1H ❯ [msrc/features/paymentLinkRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/paymentLinkService.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/paymentRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/profileRoutes.integration.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/profileRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/publicPaymentRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/receiptService.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/index.test.ts[2m [queued][22m

[2m Test Files [31m[22m[1m10 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[40C[m
[2m      Tests [31m[22m[1m134 failed[m[2m | [32m[22m[1m89 passed[90m[22m (223)[K[37C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m23.89s[K[59C[?2026l
[77C[?2026h[K[77C[13;1H[K[77C[12;1H[K[77C[11;1H[K[77C[10;1H[K[77C[9;1H[K[77C[8;1H[K[77C[7;1H[K[77C[6;1H[K[77C[5;1H[K[77C[90m[Hstderr[2m | src/index.test.ts[m[K
No explicit Google Cloud credentials found. Falling back to Application Default Credentials (ADC)[K
[K[33m[1m[6;1H ❯ [msrc/features/paymentLinkRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/paymentLinkService.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/paymentRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/profileRoutes.integration.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/profileRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/publicPaymentRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/receiptService.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/index.test.ts[2m [queued][22m

[2m Test Files [31m[22m[1m10 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[40C[m
[2m      Tests [31m[22m[1m134 failed[m[2m | [32m[22m[1m89 passed[90m[22m (223)[K[37C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m23.89s[K[59C[?2026l
[77C]0;node (vitest 3)[?2026h[K[77C[13;1H[K[77C[12;1H[K[77C[10;1H[K
[K]0;node (vitest 5)[77C[H(node:26360) MetadataLookupWarning: received unexpected error = All promises were rejected code = UNKNOWN[K
(Use `node --trace-warnings ...` to show where the warning was created)      
[K[33m[1m
 ❯ [msrc/features/paymentLinkRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentLinkService.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/profileRoutes.integration.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/profileRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/publicPaymentRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/receiptService.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/webhookRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/index.test.ts[2m [queued][22m

[2m Test Files [31m[22m[1m10 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[40C[m
[2m      Tests [31m[22m[1m134 failed[m[2m | [32m[22m[1m89 passed[90m[22m (223)[K[37C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m24.94s[K[59C[?2026l
[77C[?2026h[H[K[33m[1m
 ❯ [msrc/features/paymentLinkRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentLinkService.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/profileRoutes.integration.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/profileRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/publicPaymentRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/receiptService.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/webhookRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/index.test.ts[2m [queued][22m[K
[K[2m
 Test Files [31m[22m[1m10 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[m[2m
      Tests [31m[22m[1m134 failed[m[2m | [32m[22m[1m89 passed[90m[22m (223)[K[m[2m
   Start at [22m08:15:18[K[57C
[2m   Duration [22m25.38s[K[59C[?2026l
[77C[?2026h[H[K[33m[1m
 ❯ [msrc/features/paymentLinkRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentLinkService.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/profileRoutes.integration.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/profileRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/publicPaymentRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/receiptService.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/webhookRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/index.test.ts[2m [queued][22m[K
[K[2m
 Test Files [31m[22m[1m10 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[m[2m
      Tests [31m[22m[1m134 failed[m[2m | [32m[22m[1m89 passed[90m[22m (223)[K[m[2m
   Start at [22m08:15:18[K[57C
[2m   Duration [22m25.71s[K[59C
[77C[?2026l[?2026h[K[77C[13;1H[K[77C[12;1H[K[77C[11;1H[K[77C[10;1H[K[77C[9;1H[K[77C[8;1H[K[77C[7;1H[K[77C[6;1H[K[77C[5;1H[K[77C[H[K
[K
[K
[K[77C[33m[1m[2;1H ❯ [msrc/features/paymentLinkRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/paymentLinkService.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/paymentRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/profileRoutes.integration.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/profileRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/publicPaymentRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/receiptService.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/webhookRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/index.test.ts[2m [queued][12;1H Test Files [31m[22m[1m10 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[m[2m
      Tests [31m[22m[1m134 failed[m[2m | [32m[22m[1m89 passed[90m[22m (223)[m[2m
   Start at [22m08:15:18
[2m   Duration [22m25.92s[K[59C[?2026l
[77C[?2026h[6;1H[K
[K
[K
[K
[K
[K
[K
[K
[K[77C[90m[Hstdout[2m | src/features/profileRoutes.integration.test.ts[m[K
Using Google Cloud Application Default Credentials[K
OCR Service initialized successfully[K
[K
[K[33m[1m
 ❯ [msrc/features/paymentLinkRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/paymentLinkService.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/paymentRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/profileRoutes.integration.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/profileRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/publicPaymentRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/receiptService.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/userRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/webhookRoutes.test.ts[2m [queued][22m
[33m[1m ❯ [msrc/index.test.ts[2m [queued][22m[K[48C
[77C
[2m Test Files [31m[22m[1m10 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[40C[m
[2m      Tests [31m[22m[1m134 failed[m[2m | [32m[22m[1m89 passed[90m[22m (223)[K[37C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m26.44s[K[59C
[77C[?2026l[?2026h[12;1H[K
[K
[K[77C[11;1H[K[77C[2;1H[K
[K
[K
[K
[K
[K
[K
[K
[K[77C[90m[Hstderr[2m | src/features/profileRoutes.integration.test.ts[m[K
No explicit Google Cloud credentials found. Falling back to Application Default Credentials (ADC)[33m[1m[6;1H ❯ [msrc/features/paymentLinkRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/paymentLinkService.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/paymentRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/profileRoutes.integration.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/profileRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/publicPaymentRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/receiptService.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/userRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/webhookRoutes.test.ts[2m [queued][22m
[33m[1m ❯ [msrc/index.test.ts[2m [queued][22m[K[48C
[77C
[2m Test Files [31m[22m[1m10 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[40C[m
[2m      Tests [31m[22m[1m134 failed[m[2m | [32m[22m[1m89 passed[90m[22m (223)[K[37C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m26.44s[K[59C[?2026l
[77C[?2026h[11;1H[K
[K
[K
[K[77C[9;1H[K
[K[77C[H[K[33m[1m
 ❯ [msrc/features/paymentLinkRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentLinkService.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/profileRoutes.integration.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/profileRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/publicPaymentRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/receiptService.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/userRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/users.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/webhookRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/index.test.ts[2m [queued][14;1H Test Files [31m[22m[1m10 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[m
[2m      Tests [31m[22m[1m134 failed[m[2m | [32m[22m[1m89 passed[90m[22m (223)[K[37C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m26.57s[K[59C[?2026l
[77C[?2026h[8;1H[K
[K
[K
[K
[K
[K
[K[77C[H[K
[K
[K
[K
[K
[K
[K[77C[H[K[33m[1m
 ❯ [msrc/features/paymentLinkRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/paymentLinkService.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/paymentRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/profileRoutes.integration.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/profileRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/publicPaymentRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/receiptService.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/userRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/users.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/webhookRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/index.test.ts[2m [queued][14;1H Test Files [31m[22m[1m10 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[m
[2m      Tests [31m[22m[1m134 failed[m[2m | [32m[22m[1m89 passed[90m[22m (223)[K[37C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m26.95s[K[59C
[77C[?2026l[?2026h[H[K
[K
[K
[K
[K
[K
[K
[K
[K
[K
[K
[K
[K
[K[77C[H(node:14128) MetadataLookupWarning: received unexpected error = All promises were rejected code = UNKNOWN
(Use `node --trace-warnings ...` to show where the warning was created)[33m[1m[5;1H ❯ [msrc/features/paymentLinkRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/paymentLinkService.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/paymentRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/profileRoutes.integration.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/profileRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/publicPaymentRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/receiptService.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/userRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/users.test.ts[2m 0/21[33m[22m[1m
 ❯ [msrc/features/webhookRoutes.test.ts[2m [queued][22m
[33m[1m ❯ [msrc/index.test.ts[2m [queued][22m[K[48C
[77C
[2m Test Files [31m[22m[1m10 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[40C[m
[2m      Tests [31m[22m[1m134 failed[m[2m | [32m[22m[1m89 passed[90m[22m (244)[K[37C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m27.17s[K[59C[?2026l
[77C[?2026h[12;1H[K
[K
[K[77C[8;1H[K
[K
[K
[K[77C[4;1H[K
[K
[K
[K[77C[3;1H[K[77C[90m[Hstdout[2m | src/features/profileRoutes.test.ts[m[K
Using Google Cloud Application Default Credentials[K
OCR Service initialized successfully[33m[1m[6;1H ❯ [msrc/features/paymentLinkRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/paymentLinkService.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/paymentRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/profileRoutes.integration.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/profileRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/publicPaymentRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/receiptService.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/userRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/users.test.ts[2m 1/21[22m
[33m[1m ❯ [msrc/features/webhookRoutes.test.ts[2m [queued][22m[K[31C
[33m[1m ❯ [msrc/index.test.ts[2m [queued][22m[K[48C
[77C
[2m Test Files [31m[22m[1m10 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[40C[m
[2m      Tests [31m[22m[1m134 failed[m[2m | [32m[22m[1m90 passed[90m[22m (244)[K[37C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m27.41s[K[59C
[77C[?2026l[?2026h[7;1H[K
[K
[K
[K
[K
[K
[K
[K]0;node (vitest 2)[77C[6;1H[K[77C[5;1H[K[77C[4;1H[K[77C[H[K
[K
[K[77C[H[K[77C[H[K[77C[90m[Hstderr[2m | src/features/profileRoutes.test.ts[m
No explicit Google Cloud credentials found. Falling back to Application Default Credentials (ADC)[90m[5;1Hstderr[2m | src/features/users.test.ts > UserService > createUser > should reject invalid user data[m
Error creating user: Error: Validation failed: role is required and must be one of: patient, caregiver, doctor, pharmacist, displayName is required and must be a non-empty string, Either email or phoneNumber must be provided
    at UserService.createUser [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\users.ts:25:15[90m)[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\users.test.ts:119:32
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:155:11
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:26[61C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:1897:20[60C
    at new Promise (<anonymous>)[45C
    at runWithTimeout (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/r
[13;77Hrunner/dist/chunk-hooks.js:1863:10)[43C
    at runTest (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/d
[13;77Hdist/chunk-hooks.js:1574:12)[50C
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
[77C
[77C
[33m[1m ❯ [msrc/features/paymentLinkRoutes.test.ts[2m [queued][22m[K[27C
[33m[1m ❯ [msrc/features/paymentLinkService.test.ts[2m [queued][22m[K[26C
[33m[1m ❯ [msrc/features/paymentRoutes.test.ts[2m [queued][22m[K[31C
[33m[1m ❯ [msrc/features/profileRoutes.integration.test.ts[2m [queued][22m[K[19C
[33m[1m ❯ [msrc/features/profileRoutes.test.ts[2m [queued][22m[K[31C
[33m[1m ❯ [msrc/features/publicPaymentRoutes.test.ts[2m [queued][22m[K[25C
[33m[1m ❯ [msrc/features/receiptService.test.ts[2m [queued][22m[K[30C
[33m[1m ❯ [msrc/features/userRoutes.test.ts[2m [queued][22m[K[34C
[33m[1m ❯ [msrc/features/users.test.ts[2m 1/21[22m[K[43C
[33m[1m ❯ [msrc/features/webhookRoutes.test.ts[2m [queued][22m[K[31C
[33m[1m ❯ [msrc/index.test.ts[2m [queued][22m[K[48C
[77C
[2m Test Files [31m[22m[1m10 failed[m[2m | [32m[22m[1m0 passed[90m[22m (21)[K[40C[m
[2m      Tests [31m[22m[1m134 failed[m[2m | [32m[22m[1m90 passed[90m[22m (244)[K[37C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m27.41s[K[59C
[77C[?2026l[?2026h[9;1H[K
[K
[K
[K
[K
[K[77C[7;1H[K
[K[77C[5;1H[K
[K[77C[4;1H[K[77C[90m[Hstderr[2m | src/features/users.test.ts > UserService > createUser > should handle database errors[m[K
Error creating user: Error: Firestore error[K
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\users.test.ts:125:37
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:155:11
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:26
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1897:20
    at new Promise (<anonymous>)
    at runWithTimeout (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1863:10)
    at runTest (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/d
[13;77Hdist/chunk-hooks.js:1574:12)[50C
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
[77C
[90mstderr[2m | src/features/users.test.ts > UserService > getUserById > should reje[m
[90m[2m[13;77Hect invalid uid[22m[K[63C[m
Error getting user: Error: Valid UID is required[29C
    at UserService.getUserById [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features
[13;77Hs\users.ts:65:15[90m)[K[61C[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\users.test.ts:187:32    
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:155:11[61C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:26[61C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:1897:20[60C
    at new Promise (<anonymous>)[45C
    at runWithTimeout (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/r
[13;77Hrunner/dist/chunk-hooks.js:1863:10)[43C
    at runTest (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/d
[13;77Hdist/chunk-hooks.js:1574:12)[50C
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
[77C
[90mstderr[2m | src/features/users.test.ts > UserService > getUserById > should reje[m
[90m[2m[13;77Hect invalid uid[22m[K[63C[m
Error getting user: Error: Valid UID is required[29C
    at UserService.getUserById [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features
[13;77Hs\users.ts:65:15[90m)[K[61C[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\users.test.ts:190:32    
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:20[61C
[77C
[90mstderr[2m | src/features/users.test.ts > UserService > getUserById > should hand[m
[90m[2m[13;77Hdle database errors[22m[K[59C[m
Error getting user: Error: Firestore error[35C
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\users.test.ts:196:37    
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:155:11[61C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:26[61C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:1897:20[60C
    at new Promise (<anonymous>)[45C
    at runWithTimeout (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/r
[13;77Hrunner/dist/chunk-hooks.js:1863:10)[43C
    at runTest (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/d
[13;77Hdist/chunk-hooks.js:1574:12)[50C
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
[77C
[90mstderr[2m | src/features/users.test.ts > UserService > updateUser > should rejec[m
[90m[2m[13;77Hct update for non-existent user[22m[K[47C[m
Error updating user: Error: User not found[35C
    at UserService.updateUser [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\features\
[13;77H\users.ts:107:15[90m)[K[61C[m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
[77C
[90mstderr[2m | src/features/users.test.ts > UserService > updateUser > should handl[m
[90m[2m[13;77Hle database errors[22m[K[60C[m
Error updating user: Error: Firestore error[34C
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\users.test.ts:251:40    
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:155:11[61C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:26[61C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:1897:20[60C
    at new Promise (<anonymous>)[45C
    at runWithTimeout (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/r
[13;77Hrunner/dist/chunk-hooks.js:1863:10)[43C
    at runTest (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/d
[13;77Hdist/chunk-hooks.js:1574:12)[50C
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
[77C
[90mstderr[2m | src/features/users.test.ts > UserService > deleteUser > should handl[m
[90m[2m[13;77Hle database errors[22m[K[60C[m
Error deleting user: Error: Firestore error[34C
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\users.test.ts:293:40    
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:155:11[61C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:26[61C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:1897:20[60C
    at new Promise (<anonymous>)[45C
    at runWithTimeout (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/r
[13;77Hrunner/dist/chunk-hooks.js:1863:10)[43C
    at runTest (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/d
[13;77Hdist/chunk-hooks.js:1574:12)[50C
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
[77C
[90mstderr[2m | src/features/users.test.ts > UserService > getUsersByRole > should r[m
[90m[2m[13;77Hreject invalid role[22m[K[59C[m
Error getting users by role: Error: Invalid user role[24C
    at UserService.getUsersByRole [90m(C:\Users\akgte\PharmaRx\apps\api\[msrc\featu
[13;77Hures\users.ts:182:15[90m)[K[57C[m
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\users.test.ts:338:32    
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:155:11[61C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:26[61C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:1897:20[60C
    at new Promise (<anonymous>)[45C
    at runWithTimeout (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/r
[13;77Hrunner/dist/chunk-hooks.js:1863:10)[43C
    at runTest (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/d
[13;77Hdist/chunk-hooks.js:1574:12)[50C
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
[77C
[90mstderr[2m | src/features/users.test.ts > UserService > getUsersByRole > should h[m
[90m[2m[13;77Hhandle database errors[22m[K[56C[m
Error getting users by role: Error: Firestore error[26C
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\users.test.ts:343:44    
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:155:11[61C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:26[61C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:1897:20[60C
    at new Promise (<anonymous>)[45C
    at runWithTimeout (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/r
[13;77Hrunner/dist/chunk-hooks.js:1863:10)[43C
    at runTest (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/d
[13;77Hdist/chunk-hooks.js:1574:12)[50C
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
[77C
[90mstderr[2m | src/features/users.test.ts > UserService > userExists > should retur[m
[90m[2m[13;77Hrn false on errors[22m[K[60C[m
Error checking user existence: Error: Database error[25C
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\users.test.ts:372:62    
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:155:11[61C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:26[61C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:1897:20[60C
    at new Promise (<anonymous>)[45C
    at runWithTimeout (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/r
[13;77Hrunner/dist/chunk-hooks.js:1863:10)[43C
    at runTest (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/d
[13;77Hdist/chunk-hooks.js:1574:12)[50C
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
[77C
[77C
[33m[1m ❯ [msrc/features/paymentLinkRoutes.test.ts[2m [queued][22m[K[27C
[33m[1m ❯ [msrc/features/paymentLinkService.test.ts[2m [queued][22m[K[26C
[33m[1m ❯ [msrc/features/paymentRoutes.test.ts[2m [queued][22m[K[31C
[33m[1m ❯ [msrc/features/profileRoutes.integration.test.ts[2m [queued][22m[K[19C
[33m[1m ❯ [msrc/features/profileRoutes.test.ts[2m [queued][22m[K[31C
[33m[1m ❯ [msrc/features/publicPaymentRoutes.test.ts[2m [queued][22m[K[25C
[33m[1m ❯ [msrc/features/receiptService.test.ts[2m [queued][22m[K[30C
[33m[1m ❯ [msrc/features/userRoutes.test.ts[2m [queued][22m[K[34C
[33m[1m ❯ [msrc/features/webhookRoutes.test.ts[2m [queued][22m[K[31C
[33m[1m ❯ [msrc/index.test.ts[2m [queued][22m[K[48C
[77C
[2m Test Files [31m[22m[1m10 failed[m[2m | [32m[22m[1m1 passed[90m[22m (21)[K[40C[m
[2m      Tests [31m[22m[1m134 failed[m[2m | [32m[22m[1m110 passed[90m[22m (244)[K[36C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m27.93s[K[59C[?2026l[?2026h
[H [32m✓ [msrc/features/users.test.ts [2m(21 tests)[33m[22m 386[2mms[m[K
[K[33m[1m
 ❯ [msrc/features/paymentLinkRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentLinkService.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/profileRoutes.integration.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/profileRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/publicPaymentRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/receiptService.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/userRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/webhookRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/index.test.ts[2m [queued][22m[K
[K[2m
 Test Files [31m[22m[1m10 failed[m[2m | [32m[22m[1m1 passed[90m[22m (21)[K[40C[m
[2m      Tests [31m[22m[1m134 failed[m[2m | [32m[22m[1m110 passed[90m[22m (244)[K[36C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m27.93s[K[59C[?2026l
[77C[?2026h[5;1H[K
[K
[K
[K
[K
[K
[K
[K
[K
[K[77C[H[K
[K
[K
[K[77C[H[K[33m[1m
 ❯ [msrc/features/paymentLinkRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/paymentLinkService.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/paymentRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/profileRoutes.integration.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/profileRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/publicPaymentRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/receiptService.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/userRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/webhookRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/index.test.ts[2m [queued][13;1H Test Files [31m[22m[1m10 failed[m[2m | [32m[22m[1m1 passed[90m[22m (21)[m[2m
      Tests [31m[22m[1m134 failed[m[2m | [32m[22m[1m110 passed[90m[22m (244)[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m28.17s[K[59C[?2026l
[77C[?2026h[2;1H[K
[K
[K
[K
[K
[K
[K
[K
[K
[K
[K
[K
[K[77C[H(node:8628) MetadataLookupWarning: received unexpected error = All promises were rejected code = UNKNOWN
(Use `node --trace-warnings ...` to show where the warning was created)[33m[1m[5;1H ❯ [msrc/features/paymentLinkRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/paymentLinkService.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/paymentRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/profileRoutes.integration.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/profileRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/publicPaymentRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/receiptService.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/features/userRoutes.test.ts[2m 0/20[33m[22m[1m
 ❯ [msrc/features/webhookRoutes.test.ts[2m [queued][33m[22m[1m
 ❯ [msrc/index.test.ts[2m [queued][22m
[77C
[2m Test Files [31m[22m[1m10 failed[m[2m | [32m[22m[1m1 passed[90m[22m (21)[K[40C[m
[2m      Tests [31m[22m[1m134 failed[m[2m | [32m[22m[1m110 passed[90m[22m (264)[K[36C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m28.50s[K[59C[?2026l
[77C[?2026h[K[77C[H[K[33m[1m
 ❯ [msrc/features/paymentLinkRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentLinkService.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/paymentRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/profileRoutes.integration.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/profileRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/publicPaymentRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/receiptService.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/features/userRoutes.test.ts[2m 0/20[22m[K[33m[1m
 ❯ [msrc/features/webhookRoutes.test.ts[2m [queued][22m[K[33m[1m
 ❯ [msrc/index.test.ts[2m [queued][22m[K
[K[2m
 Test Files [31m[22m[1m10 failed[m[2m | [32m[22m[1m1 passed[90m[22m (21)[K[m[2m
      Tests [31m[22m[1m134 failed[m[2m | [32m[22m[1m110 passed[90m[22m (264)[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m28.99s[K[59C
[77C[?2026l]0;node (vitest 5)[?2026h[90m[Hstderr[2m | src/features/userRoutes.test.ts > User Routes > POST /users > should handle service errors[m[K
Error in POST /users: Error: Service error[K
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\userRoutes.test.ts:109:57[K
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:155:11[K
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:26[K
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1897:20[K
    at new Promise (<anonymous>)[K
    at runWithTimeout (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1863:10)[K[43C
    at runTest (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/d
[13;77Hdist/chunk-hooks.js:1574:12)[50C
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
[77C
[90mstderr[2m | src/features/userRoutes.test.ts > User Routes > POST /users > should[m
[90m[2m[13;77Hd handle unknown errors[22m[K[55C[m
Error in POST /users: Unknown error[42C
[77C
[77C
[33m[1m ❯ [msrc/features/paymentLinkRoutes.test.ts[2m [queued][22m[K[27C
[33m[1m ❯ [msrc/features/paymentLinkService.test.ts[2m [queued][22m[K[26C
[33m[1m ❯ [msrc/features/paymentRoutes.test.ts[2m [queued][22m[K[31C
[33m[1m ❯ [msrc/features/profileRoutes.integration.test.ts[2m [queued][22m[K[19C
[33m[1m ❯ [msrc/features/profileRoutes.test.ts[2m [queued][22m[K[31C
[33m[1m ❯ [msrc/features/publicPaymentRoutes.test.ts[2m [queued][22m[K[25C
[33m[1m ❯ [msrc/features/receiptService.test.ts[2m [queued][22m[K[30C
[33m[1m ❯ [msrc/features/userRoutes.test.ts[2m 4/20[22m[K[38C
[33m[1m ❯ [msrc/features/webhookRoutes.test.ts[2m [queued][22m[K[31C
[33m[1m ❯ [msrc/index.test.ts[2m [queued][22m[K[48C
[77C
[2m Test Files [31m[22m[1m10 failed[m[2m | [32m[22m[1m1 passed[90m[22m (21)[K[40C[m
[2m      Tests [31m[22m[1m134 failed[m[2m | [32m[22m[1m114 passed[90m[22m (264)[K[36C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m29.21s[K[59C[?2026l
[77C[?2026h[8;1H[K
[K
[K
[K
[K
[K
[K[77C[90m[Hstderr[2m | src/features/userRoutes.test.ts > User Routes > GET /users/:uid > should handle service errors[m[K
Error in GET /users/:uid: Error: Service error[K
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\userRoutes.test.ts:176:58[K
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:155:11[K
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:26
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1897:20
    at new Promise (<anonymous>)
    at runWithTimeout (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1863:10)
    at runTest (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/d
[13;77Hdist/chunk-hooks.js:1574:12)[50C
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
[77C
[90mstderr[2m | src/features/userRoutes.test.ts > User Routes > PUT /users/:uid > sh[m
[90m[2m[13;77Hhould return 404 when user not found[22m[K[42C[m
Error in PUT /users/:uid: Error: User not found[30C
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\userRoutes.test.ts:222:5
[13;77H57[76C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:155:11[61C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:26[61C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:1897:20[60C
    at new Promise (<anonymous>)[45C
    at runWithTimeout (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/r
[13;77Hrunner/dist/chunk-hooks.js:1863:10)[43C
    at runTest (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/d
[13;77Hdist/chunk-hooks.js:1574:12)[50C
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
[77C
[90mstderr[2m | src/features/userRoutes.test.ts > User Routes > PUT /users/:uid > sh[m
[90m[2m[13;77Hhould handle validation errors[22m[K[48C[m
Error in PUT /users/:uid: Error: Validation failed[27C
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\userRoutes.test.ts:235:5
[13;77H57[76C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:155:11[61C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:26[61C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:1897:20[60C
    at new Promise (<anonymous>)[45C
    at runWithTimeout (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/r
[13;77Hrunner/dist/chunk-hooks.js:1863:10)[43C
    at runTest (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/d
[13;77Hdist/chunk-hooks.js:1574:12)[50C
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
[77C
[77C
[33m[1m ❯ [msrc/features/paymentLinkRoutes.test.ts[2m [queued][22m[K[27C
[33m[1m ❯ [msrc/features/paymentLinkService.test.ts[2m [queued][22m[K[26C
[33m[1m ❯ [msrc/features/paymentRoutes.test.ts[2m [queued][22m[K[31C
[33m[1m ❯ [msrc/features/profileRoutes.integration.test.ts[2m [queued][22m[K[19C
[33m[1m ❯ [msrc/features/profileRoutes.test.ts[2m [queued][22m[K[31C
[33m[1m ❯ [msrc/features/publicPaymentRoutes.test.ts[2m [queued][22m[K[25C
[33m[1m ❯ [msrc/features/receiptService.test.ts[2m [queued][22m[K[30C
[33m[1m ❯ [msrc/features/userRoutes.test.ts[2m 9/20[22m[K[38C
[33m[1m ❯ [msrc/features/webhookRoutes.test.ts[2m [queued][22m[K[31C
[33m[1m ❯ [msrc/index.test.ts[2m [queued][22m[K[48C
[77C
[2m Test Files [31m[22m[1m10 failed[m[2m | [32m[22m[1m1 passed[90m[22m (21)[K[40C[m
[2m      Tests [31m[22m[1m134 failed[m[2m | [32m[22m[1m119 passed[90m[22m (264)[K[36C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m29.41s[K[59C[?2026l
[77C]0;node (vitest 1)[?2026h[90m[Hstderr[2m | src/features/userRoutes.test.ts > User Routes > DELETE /users/:uid > should handle service errors[m[K
Error in DELETE /users/:uid: Error: Service error[K
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\userRoutes.test.ts:277:57[K
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:155:11[K
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:26[K
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1897:20[K
    at new Promise (<anonymous>)[K
    at runWithTimeout (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1863:10)[K[43C
    at runTest (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/d
[13;77Hdist/chunk-hooks.js:1574:12)[50C
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
[77C
[90mstderr[2m | src/features/userRoutes.test.ts > User Routes > GET /users/role/:rol[m
[90m[2m[13;77Hle > should handle service errors[22m[K[45C[m
Error in GET /users/role/:role: Error: Service error[25C
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\userRoutes.test.ts:336:6
[13;77H61[76C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:155:11[61C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:752:26[61C
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk
[13;77Hk-hooks.js:1897:20[60C
    at new Promise (<anonymous>)[45C
    at runWithTimeout (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/r
[13;77Hrunner/dist/chunk-hooks.js:1863:10)[43C
    at runTest (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/d
[13;77Hdist/chunk-hooks.js:1574:12)[50C
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
[77C
[77C
[33m[1m ❯ [msrc/features/paymentLinkRoutes.test.ts[2m [queued][22m[K[27C
[33m[1m ❯ [msrc/features/paymentLinkService.test.ts[2m [queued][22m[K[26C
[33m[1m ❯ [msrc/features/paymentRoutes.test.ts[2m [queued][22m[K[31C
[33m[1m ❯ [msrc/features/profileRoutes.integration.test.ts[2m [queued][22m[K[19C
[33m[1m ❯ [msrc/features/profileRoutes.test.ts[2m [queued][22m[K[31C
[33m[1m ❯ [msrc/features/publicPaymentRoutes.test.ts[2m [queued][22m[K[25C
[33m[1m ❯ [msrc/features/receiptService.test.ts[2m [queued][22m[K[30C
[33m[1m ❯ [msrc/features/userRoutes.test.ts[2m 15/20[22m[K[37C
[33m[1m ❯ [msrc/features/webhookRoutes.test.ts[2m [queued][22m[K[31C
[33m[1m ❯ [msrc/index.test.ts[2m [queued][22m[K[48C
[77C
[2m Test Files [31m[22m[1m10 failed[m[2m | [32m[22m[1m1 passed[90m[22m (21)[K[40C[m
[2m      Tests [31m[22m[1m134 failed[m[2m | [32m[22m[1m125 passed[90m[22m (264)[K[36C[m
[2m   Start at [22m08:15:18[K[57C
[2m   Duration [22m29.63s[K[59C[?2026l
[77C[K[77C[90m[Hstderr[2m | src/features/userRoutes.test.ts > User Routes > GET /users/:uid/exists > should handle service errors[m[K
Error in GET /users/:uid/exists: Error: Service error[K
    at [90mC:\Users\akgte\PharmaRx\apps\api\[msrc\features\userRoutes.test.ts:382:57[K
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:155:11[K
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:26[K
    at file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1897:20[K
    at new Promise (<anonymous>)[K
    at runWithTimeout (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:1863:10)
    at runTest (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/d
[13;77Hdist/chunk-hooks.js:1574:12)[50C
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)   [m
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
    at runSuite (file:///C:/Users/akgte/PharmaRx/node_modules/[4m@vitest[24m/runner/
[13;77H/dist/chunk-hooks.js:1729:8)[50C
[77C
 [32m✓ [msrc/features/userRoutes.test.ts [2m(20 tests)[33m[22m 1053[2mms[m[K[25C
   [33m[2m✓[m User Routes[2m > [22mPOST /users[2m > [22mshould create a user successfully  [33m358[2mms[m    
[77C
[31m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[39m[41m[1m Failed Suites 9 [31m[49m[22m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[m
[77C
[77C[41m[1m FAIL [m src/index.test.ts[2m [ src/index.test.ts ][22m
[41m[1m FAIL [m src/features/profileRoutes.test.ts[2m [ src/features/profileRoutes.test.t[22m
[2m[13;77Hts ][22m[K[74C
[77C[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'collection')[m
[36m [2m❯[22m ReceiptService.<instance_members_initializer> src/features/receiptService.[m
[36m[13;77H.ts:[2m64:44[22m[K[69C[m
[77C     [90m62| [m
     [90m63| [35mclass [33mReceiptService [m{[K[46C
     [90m64|   [35mprivate [mreadonly receiptsCollection [33m= [mdb[33m.[34mcollection[m([32m'receipts'[m)[33m;  [m
       [90m|[44X[31m[44C^[K[24C[m
     [90m65|   [35mprivate [mreadonly paymentsCollection [33m= [mdb[33m.[34mcollection[m([32m'payments'[m)[33m;  [m
     [90m66|[K[69C[m
[77C[90m [2m❯[22m new ReceiptService src/features/receiptService.ts:[2m63:1[m
[77C[90m [2m❯[22m src/features/receiptService.ts:[2m493:31[m
[90m [2m❯[22m src/features/prescriptionOrderRoutes.ts:[2m5:1[m[K[31C
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[1/143]⎯[m
[77C
[77C[41m[1m FAIL [m src/features/paymentLinkRoutes.test.ts[2m [ src/features/paymentLinkRoute[22m
[2m[13;77Hes.test.ts ][22m[K[66C
[77C[31m[1mError[22m: [vitest] There was an error when mocking a module. If you are using "v[m
[31m[13;77Hvi.mock" factory, make sure there are no top level variables inside, since thi[m
[31m[13;77His call is hoisted to top of the file. Read more: https://vitest.dev/api/vi.ht[m
[31m[13;77Html#vi-mock[67C[m
[77C[36m [2m❯[22m src/features/paymentLinkRoutes.ts:[2m2:1[m
[77C      [90m1| [35mimport [m{ [33mRouter, Request, Response [m} [35mfrom [32m'express'[33m;[m
      [90m2| [35mimport [m{ authenticateToken } [35mfrom [32m'../middleware/auth'[33m;[K[13C[m
       [90m| [31m^[K[67C[m
      [90m3| [35mimport [m{ validateRequest } [35mfrom [32m'../middleware/validation'[33m;[K[9C[m
      [90m4| [35mimport [m{ [33mPaymentLinkService [m} [35mfrom [32m'./paymentLinkService'[33m;[K[10C[m
[77C
[31m[1mCaused by: ReferenceError[22m: Cannot access 'mockAuthenticateToken' before initi[m
[31m[13;77Hialization[68C[m
[77C[36m [2m❯[22m src/features/paymentLinkRoutes.test.ts:[2m22:22[m
[90m [2m❯[22m src/features/paymentLinkRoutes.ts:[2m2:1[m[K[37C
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[2/143]⎯[m
[77C
[41m[1m FAIL [m src/features/paymentLinkService.test.ts[2m [ src/features/paymentLinkServ[22m
[2m[13;77Hvice.test.ts ][22m[K[64C
[77C[31m[1mError[22m: [vitest] There was an error when mocking a module. If you are using "v[m
[31m[13;77Hvi.mock" factory, make sure there are no top level variables inside, since thi[m
[31m[13;77His call is hoisted to top of the file. Read more: https://vitest.dev/api/vi.ht[m
[31m[13;77Html#vi-mock[67C[m
[36m [2m❯[22m src/features/paymentLinkService.ts:[2m1:1[m[K[36C
[77C      [90m1| [35mimport [m{ firestore } [35mfrom [32m'../config/firebase'[33m;[m
       [90m| [31m^[K[67C[m
      [90m2| [mimport { PaymentLink, PaymentLinkRequest, PaymentLinkResponse, Pres…
      [90m3| [35mimport [m{ [33mWhatsAppService [m} [35mfrom [32m'./whatsappService'[33m;[K[16C[m
[77C
[31m[1mCaused by: ReferenceError[22m: Cannot access 'mockFirestore' before initializatio[m
[31m[13;77Hon[76C[m
[77C[36m [2m❯[22m src/features/paymentLinkService.test.ts:[2m33:14[m
[90m [2m❯[22m src/features/paymentLinkService.ts:[2m1:1[m[K[36C
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[3/143]⎯[m
[77C
[41m[1m FAIL [m src/features/paymentRoutes.test.ts[2m [ src/features/paymentRoutes.test.t[22m
[2m[13;77Hts ][22m[K[74C
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'collection')        [m
[36m [2m❯[22m ReceiptService.<instance_members_initializer> src/features/receiptService.[m
[36m[13;77H.ts:[2m64:44[22m[K[69C[m
[77C     [90m62| [m
     [90m63| [35mclass [33mReceiptService [m{[K[46C
     [90m64|   [35mprivate [mreadonly receiptsCollection [33m= [mdb[33m.[34mcollection[m([32m'receipts'[m)[33m;  [m
       [90m|[44X[31m[44C^[K[24C[m
     [90m65|   [35mprivate [mreadonly paymentsCollection [33m= [mdb[33m.[34mcollection[m([32m'payments'[m)[33m;  [m
     [90m66|[K[69C[m
[90m [2m❯[22m new ReceiptService src/features/receiptService.ts:[2m63:1[m[K]0;node (vitest 6)[20C
[90m [2m❯[22m src/features/receiptService.ts:[2m493:31[m[K[37C
[90m [2m❯[22m src/features/paymentService.ts:[2m4:1[m[K[40C
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[4/143]⎯[m
[77C
[41m[1m FAIL [m src/features/profileRoutes.integration.test.ts[2m [ src/features/profileR[22m
[2m[13;77HRoutes.integration.test.ts ][22m[K[50C
[31m[1mError[22m: Cannot find module './profiles' imported from 'C:/Users/akgte/PharmaRx[m
[31m[13;77Hx/apps/api/src/features/profileRoutes.ts'[37C[m
[36m [2m❯[22m src/features/profileRoutes.ts:[2m3:1[m[K[41C
[77C      [90m1| [35mimport [m{ [33mRouter, Request, Response [m} [35mfrom [32m'express'[33m;[m
      [90m2| [mimport { CreateProfileRequest, UpdateProfileRequest } from '@pharma…
      [90m3| [35mimport [mprofileService [35mfrom [32m'./profiles'[33m;[K[28C[m
       [90m| [31m^[K[67C[m
      [90m4|[K[69C[m
      [90m5| [35mconst [mrouter [33m= Router[m()[33m;[K[44C[m
[77C
[77C[31m[1mCaused by: Error[22m: Failed to load url ./profiles (resolved id: ./profiles) in [m
[31m[13;77H C:/Users/akgte/PharmaRx/apps/api/src/features/profileRoutes.test.ts. Does the[m
[31m[13;77He file exist?[65C[m
[90m [2m❯[22m loadAndTransform ../../node_modules/vite/dist/node/chunks/dep-Bg4HVnP5.js:[m
[90m[13;77H:[2m26447:33[22m[K[69C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[5/143]⎯[m
[77C
[77C[41m[1m FAIL [m src/features/publicPaymentRoutes.test.ts[2m [ src/features/publicPaymentR[22m
[2m[13;77HRoutes.test.ts ][22m[K[62C
[31m[1mError[22m: [vitest] There was an error when mocking a module. If you are using "v[m
[31m[13;77Hvi.mock" factory, make sure there are no top level variables inside, since thi[m
[31m[13;77His call is hoisted to top of the file. Read more: https://vitest.dev/api/vi.ht[m
[31m[13;77Html#vi-mock[67C[m
[36m [2m❯[22m src/features/publicPaymentRoutes.ts:[2m2:1[m[K[35C
[77C      [90m1| [35mimport [m{ [33mRouter, Request, Response [m} [35mfrom [32m'express'[33m;[m
      [90m2| [35mimport [m{ validateRequest } [35mfrom [32m'../middleware/validation'[33m;[K[9C[m
       [90m| [31m^[K[67C[m
      [90m3| [35mimport [m{ [33mPaymentLinkService [m} [35mfrom [32m'./paymentLinkService'[33m;[K[10C[m
      [90m4| [mimport { PublicPaymentInfo, PublicPaymentRequest, PublicPaymentResp…
[77C
[31m[1mCaused by: ReferenceError[22m: Cannot access 'mockValidateRequest' before initial[m
[31m[13;77Hlization[70C[m
[36m [2m❯[22m src/features/publicPaymentRoutes.test.ts:[2m18:20[m[K[28C
[90m [2m❯[22m src/features/publicPaymentRoutes.ts:[2m2:1[m[K[35C
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[6/143]⎯[m
[77C
[77C[41m[1m FAIL [m src/features/receiptService.test.ts[2m [ src/features/receiptService.test[22m
[2m[13;77Ht.ts ][22m[K[72C
[77C[31m[1mError[22m: Transform failed with 1 error:[m
[31mC:/Users/akgte/PharmaRx/apps/api/src/features/receiptService.test.ts:47:16: E[m
[31m[13;77HERROR: Expected "}" but found ")"[45C[m
  Plugin: [35mvite:esbuild[K[55C[m
  File: [36mC:/Users/akgte/PharmaRx/apps/api/src/features/receiptService.test.ts[m:
[13;77H:47:16[72C
[33m[77C[m
[33m  Expected "}" but found ")"[49C[m
[33m  45 |                  empty: true,[41C[m
[33m  46 |                  docs: [][45C[m
[33m  47 |                }))[52C[m
[33m     |                  ^[52C[m
[33m  48 |              }))[54C[m
[33m  49 |            }))[56C[m
[33m[77C[m
[90m [2m❯[22m failureErrorWithLog ../../node_modules/esbuild/lib/main.js:[2m1467:15[m        
[90m [2m❯[22m ../../node_modules/esbuild/lib/main.js:[2m736:50[m[K[29C
[77C[90m [2m❯[22m responseCallbacks.<computed> ../../node_modules/esbuild/lib/main.js:[2m603:9[m
[90m [2m❯[22m handleIncomingPacket ../../node_modules/esbuild/lib/main.js:[2m658:12[m        
[90m [2m❯[22m Socket.readFromStdout ../../node_modules/esbuild/lib/main.js:[2m581:7[m        
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[7/143]⎯[m
[77C
[41m[1m FAIL [m src/features/webhookRoutes.test.ts[2m [ src/features/webhookRoutes.test.t[22m
[2m[13;77Hts ][22m[K[74C
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'collection')        [m
[36m [2m❯[22m ReceiptService.<instance_members_initializer> src/features/receiptService.[m
[36m[13;77H.ts:[2m64:44[22m[K[69C[m
     [90m62|[K[69C[m
     [90m63| [35mclass [33mReceiptService [m{[K[46C
     [90m64|   [35mprivate [mreadonly receiptsCollection [33m= [mdb[33m.[34mcollection[m([32m'receipts'[m)[33m;  [m
       [90m|[44X[31m[44C^[K[24C[m
     [90m65|   [35mprivate [mreadonly paymentsCollection [33m= [mdb[33m.[34mcollection[m([32m'payments'[m)[33m;  [m
     [90m66|[K[69C[m
[77C[90m [2m❯[22m new ReceiptService src/features/receiptService.ts:[2m63:1[m
[90m [2m❯[22m src/features/receiptService.ts:[2m493:31[m[K[37C
[90m [2m❯[22m src/features/paymentService.ts:[2m4:1[m[K[40C
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[8/143]⎯[m
[77C
[77C
[31m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[39m[41m[1m Failed Tests 134 [31m[49m[22m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[m
[77C
[41m[1m FAIL [m src/features/authRoutes.test.ts[2m > [22mAuth Routes[2m > [22mPOST /auth/register[2m > [22m
[2m[13;77H [22msuccessfully registers a new user with email[33C
[31m[1mAssertionError[22m: expected 500 to be 201 // Object.is equality[K[17C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- 201[72C[m
[31m+ 500[72C[m
[77C
[36m [2m❯[22m src/features/authRoutes.test.ts:[2m87:31[m[K[37C
[77C     [90m85|[9X[33m[9C.[34msend[m(validRegistrationData)[33m;[m
     [90m86|[K[69C[m
     [90m87|       [34mexpect[m(response[33m.[mstatus)[33m.[34mtoBe[m([34m201[m)[33m;[K[28C[m
       [90m|[31X[31m[31C^[K[37C[m
     [90m88|       [34mexpect[m(response[33m.[mbody)[33m.[34mtoEqual[m({[K[31C
     [90m89|[9X[m[9Csuccess[33m: [35mtrue[33m,[K[46C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[9/143]⎯[m
[77C
[41m[1m FAIL [m src/features/authRoutes.test.ts[2m > [22mAuth Routes[2m > [22mPOST /auth/register[2m > [22m
[2m[13;77H [22msuccessfully registers a new user with phone number[26C
[31m[1mAssertionError[22m: expected 500 to be 201 // Object.is equality[K[17C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- 201[72C[m
[31m+ 500[72C[m
[77C
[36m [2m❯[22m src/features/authRoutes.test.ts:[2m135:31[m[K[36C
    [90m133|[9X[33m[9C.[34msend[m(phoneData)[33m;[K[43C[m
    [90m134|[K[69C[m
    [90m135|       [34mexpect[m(response[33m.[mstatus)[33m.[34mtoBe[m([34m201[m)[33m;[K[28C[m
       [90m|[31X[31m[31C^[K[37C[m
    [90m136|       [34mexpect[m(mockUserService[33m.[mcreateUser)[33m.[34mtoHaveBeenCalledWith[m(      
    [90m137|[9X[32m[9C'test-uid-123'[33m,[K[45C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[10/143]⎯[m
[77C
[41m[1m FAIL [m src/features/authRoutes.test.ts[2m > [22mAuth Routes[2m > [22mPOST /auth/register[2m > [22m
[2m[13;77H [22mreturns 401 with invalid token[47C
[31m[1mAssertionError[22m: expected 500 to be 401 // Object.is equality[K[17C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- 401[72C[m
[31m+ 500[72C[m
[77C
[36m [2m❯[22m src/features/authRoutes.test.ts:[2m163:31[m[K[36C
[77C    [90m161|[9X[33m[9C.[34msend[m(validRegistrationData)[33m;[m
    [90m162|[K[69C[m
    [90m163|       [34mexpect[m(response[33m.[mstatus)[33m.[34mtoBe[m([34m401[m)[33m;[K[28C[m
       [90m|[31X[31m[31C^[K[37C[m
    [90m164|       [34mexpect[m(response[33m.[mbody[33m.[merror)[33m.[34mtoContain[m([32m'Unauthorized'[m)[33m;        [m
    [90m165|     [m})[33m;[K[61C[m
[77C
[77C[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[11/143]⎯[m
[77C
[77C[41m[1m FAIL [m src/features/authRoutes.test.ts[2m > [22mAuth Routes[2m > [22mPOST /auth/register[2m > [22m
[2m[13;77H [22mreturns 403 when token UID does not match request UID[24C
[77C[31m[1mAssertionError[22m: expected 500 to be 403 // Object.is equality[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- 403[72C[m
[31m+ 500[72C[m
[77C
[77C[36m [2m❯[22m src/features/authRoutes.test.ts:[2m239:31[m
    [90m237|[9X[33m[9C.[34msend[m(mismatchedData)[33m;[K[38C[m
    [90m238|[K[69C[m
    [90m239|       [34mexpect[m(response[33m.[mstatus)[33m.[34mtoBe[m([34m403[m)[33m;[K[28C[m
       [90m|[31X[31m[31C^[K[37C[m
    [90m240|       [mexpect(response.body.error).toBe('Token UID does not match re…
    [90m241|     [m})[33m;[K[61C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[12/143]⎯[m
[77C
[41m[1m FAIL [m src/features/authRoutes.test.ts[2m > [22mAuth Routes[2m > [22mPOST /auth/register[2m > [22m
[2m[13;77H [22mreturns 409 when user already exists[41C
[77C[31m[1mAssertionError[22m: expected 500 to be 409 // Object.is equality[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- 409[72C[m
[31m+ 500[72C[m
[77C
[77C[36m [2m❯[22m src/features/authRoutes.test.ts:[2m257:31[m
[77C    [90m255|[9X[33m[9C.[34msend[m(validRegistrationData)[33m;[m
    [90m256|[K[69C[m
    [90m257|       [34mexpect[m(response[33m.[mstatus)[33m.[34mtoBe[m([34m409[m)[33m;[K[28C[m
       [90m|[31X[31m[31C^[K[37C[m
    [90m258|       [34mexpect[m(response[33m.[mbody[33m.[merror)[33m.[34mtoBe[m([32m'User already exists'[m)[33m;      [m
    [90m259|     [m})[33m;[K[61C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[13/143]⎯[m
[77C
[41m[1m FAIL [m src/features/authRoutes.test.ts[2m > [22mAuth Routes[2m > [22mPOST /auth/register[2m > [22m
[2m[13;77H [22mhandles user service validation errors[39C
[77C[31m[1mAssertionError[22m: expected 500 to be 400 // Object.is equality[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- 400[72C[m
[31m+ 500[72C[m
[77C
[36m [2m❯[22m src/features/authRoutes.test.ts:[2m272:31[m[K[36C
    [90m270|[9X[33m[9C.[34msend[m(validRegistrationData)[33m;[K[31C[m
    [90m271|[K[69C[m
    [90m272|       [34mexpect[m(response[33m.[mstatus)[33m.[34mtoBe[m([34m400[m)[33m;[K[28C[m
       [90m|[31X[31m[31C^[K[37C[m
    [90m273|       [34mexpect[m(response[33m.[mbody[33m.[merror)[33m.[34mtoContain[m([32m'Validation failed'[m)[33m;   [m
    [90m274|     [m})[33m;[K[61C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[14/143]⎯[m
[77C
[41m[1m FAIL [m src/features/authRoutes.test.ts[2m > [22mAuth Routes[2m > [22mPOST /auth/register[2m > [22m
[2m[13;77H [22mcontinues registration even if custom claims fail[28C
[77C[31m[1mAssertionError[22m: expected 500 to be 201 // Object.is equality[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- 201[72C[m
[31m+ 500[72C[m
[77C
[36m [2m❯[22m src/features/authRoutes.test.ts:[2m305:31[m[K[36C
    [90m303|[9X[33m[9C.[34msend[m(validRegistrationData)[33m;[K[31C[m
    [90m304|[K[69C[m
    [90m305|       [34mexpect[m(response[33m.[mstatus)[33m.[34mtoBe[m([34m201[m)[33m;[K[28C[m
       [90m|[31X[31m[31C^[K[37C[m
    [90m306|       [34mexpect[m(response[33m.[mbody[33m.[msuccess)[33m.[34mtoBe[m([35mtrue[m)[33m;[K[21C[m
    [90m307|     [m})[33m;[K[61C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[15/143]⎯[m
[77C
[41m[1m FAIL [m src/features/authRoutes.test.ts[2m > [22mAuth Routes[2m > [22mGET /auth/me[2m > [22mreturns
[13;77Hs current user profile[56C
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[K[17C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- 200[72C[m
[31m+ 500[72C[m
[77C
[36m [2m❯[22m src/features/authRoutes.test.ts:[2m326:31[m[K[36C
[77C    [90m324|[9X[33m[9C.[35mset[m([32m'Authorization'[33m, [32m`Bearer [36m${[mmockToken[36m}[32m`[m)[33m;[m
    [90m325|[K[69C[m
    [90m326|       [34mexpect[m(response[33m.[mstatus)[33m.[34mtoBe[m([34m200[m)[33m;[K[28C[m
       [90m|[31X[31m[31C^[K[37C[m
    [90m327|       [34mexpect[m(response[33m.[mbody)[33m.[34mtoEqual[m({[K[31C
    [90m328|[9X[m[9Csuccess[33m: [35mtrue[33m,[K[46C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[16/143]⎯[m
[77C
[41m[1m FAIL [m src/features/authRoutes.test.ts[2m > [22mAuth Routes[2m > [22mGET /auth/me[2m > [22mreturns
[13;77Hs 404 when user profile not found[45C
[31m[1mAssertionError[22m: expected 500 to be 404 // Object.is equality[K[17C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- 404[72C[m
[31m+ 500[72C[m
[77C
[36m [2m❯[22m src/features/authRoutes.test.ts:[2m349:31[m[K[36C
    [90m347|[9X[33m[9C.[35mset[m([32m'Authorization'[33m, [32m`Bearer [36m${[mmockToken[36m}[32m`[m)[33m;[K[15C[m
    [90m348|[K[69C[m
    [90m349|       [34mexpect[m(response[33m.[mstatus)[33m.[34mtoBe[m([34m404[m)[33m;[K[28C[m
       [90m|[31X[31m[31C^[K[37C[m
    [90m350|       [34mexpect[m(response[33m.[mbody[33m.[merror)[33m.[34mtoBe[m([32m'User profile not found'[m)[33m;   [m
    [90m351|     [m})[33m;[K[61C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[17/143]⎯[m
[77C
[41m[1m FAIL [m src/features/authRoutes.test.ts[2m > [22mAuth Routes[2m > [22mPUT /auth/profile[2m > [22msu
[13;77Huccessfully updates user profile[46C
[31m[1mAssertionError[22m: expected 400 to be 200 // Object.is equality[K[17C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- 200[72C[m
[31m+ 400[72C[m
[77C
[36m [2m❯[22m src/features/authRoutes.test.ts:[2m376:31[m[K[36C
[77C    [90m374|[9X[33m[9C.[34msend[m(updateData)[33m;[m
    [90m375|[K[69C[m
    [90m376|       [34mexpect[m(response[33m.[mstatus)[33m.[34mtoBe[m([34m200[m)[33m;[K[28C[m
       [90m|[31X[31m[31C^[K[37C[m
    [90m377|       [34mexpect[m(response[33m.[mbody)[33m.[34mtoEqual[m({[K[31C
    [90m378|[9X[m[9Csuccess[33m: [35mtrue[33m,[K[46C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[18/143]⎯[m
[77C
[41m[1m FAIL [m src/features/authRoutes.test.ts[2m > [22mAuth Routes[2m > [22mPUT /auth/profile[2m > [22mre
[13;77Hemoves uid from update data[51C
[31m[1mAssertionError[22m: expected "spy" to be called with arguments: [ 'test-uid-123',[m
[31m[13;77H, …(1) ][70C[m
[90m[77C[m
[90mNumber of calls: [1m0[22m[K[59C[m
[90m[77C[m
[36m [2m❯[22m src/features/authRoutes.test.ts:[2m404:42[m[K[36C
[77C    [90m402|[9X[33m[9C.[34msend[m(updateData)[33m;[m
    [90m403|[K[69C[m
    [90m404|       [mexpect(mockUserService.updateUser).toHaveBeenCalledWith('test…
       [90m|[42X[31m[42C^[K[26C[m
    [90m405|[9X[m[9CdisplayName[33m: [32m'Updated Name'[K[33C[m
    [90m406|       [m})[33m;[K[59C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[19/143]⎯[m
[77C
[41m[1m FAIL [m src/features/authRoutes.test.ts[2m > [22mAuth Routes[2m > [22mPUT /auth/profile[2m > [22mre
[13;77Heturns 404 when user not found[48C
[31m[1mAssertionError[22m: expected 400 to be 404 // Object.is equality[K[17C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- 404[72C[m
[31m+ 400[72C[m
[77C
[36m [2m❯[22m src/features/authRoutes.test.ts:[2m417:31[m[K[36C
[77C    [90m415|[9X[33m[9C.[34msend[m({ displayName[33m: [32m'Updated Name' [m})[33m;[m
    [90m416|[K[69C[m
    [90m417|       [34mexpect[m(response[33m.[mstatus)[33m.[34mtoBe[m([34m404[m)[33m;[K[28C[m
       [90m|[31X[31m[31C^[K[37C[m
    [90m418|     [m})[33m;[K[61C[m
    [90m419|   [m})[33m;[K[63C[m
[77C
[77C[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[20/143]⎯[m
[77C
[41m[1m FAIL [m src/features/authRoutes.test.ts[2m > [22mAuth Routes[2m > [22mPOST /auth/login[2m > [22msuc
[13;77Hccessfully returns user profile for authenticated user[24C
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[K[17C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- 200[72C[m
[31m+ 500[72C[m
[77C
[36m [2m❯[22m src/features/authRoutes.test.ts:[2m437:31[m[K[36C
    [90m435|[9X[33m[9C.[35mset[m([32m'Authorization'[33m, [32m`Bearer [36m${[mmockToken[36m}[32m`[m)[33m;[K[15C[m
    [90m436|[K[69C[m
    [90m437|       [34mexpect[m(response[33m.[mstatus)[33m.[34mtoBe[m([34m200[m)[33m;[K[28C[m
       [90m|[31X[31m[31C^[K[37C[m
    [90m438|       [34mexpect[m(response[33m.[mbody)[33m.[34mtoEqual[m({[K[31C
    [90m439|[9X[m[9Csuccess[33m: [35mtrue[33m,[K[46C[m
[77C
[77C[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[21/143]⎯[m
[77C
[41m[1m FAIL [m src/features/authRoutes.test.ts[2m > [22mAuth Routes[2m > [22mPOST /auth/login[2m > [22mret
[13;77Hturns 401 when invalid token[50C
[77C[31m[1mAssertionError[22m: expected 500 to be 401 // Object.is equality[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- 401[72C[m
[31m+ 500[72C[m
[77C
[36m [2m❯[22m src/features/authRoutes.test.ts:[2m468:31[m[K[36C
[77C    [90m466|[9X[33m[9C.[35mset[m([32m'Authorization'[33m, [32m'Bearer invalid-token'[m)[33m;[m
    [90m467|[K[69C[m
    [90m468|       [34mexpect[m(response[33m.[mstatus)[33m.[34mtoBe[m([34m401[m)[33m;[K[28C[m
       [90m|[31X[31m[31C^[K[37C[m
    [90m469|       [34mexpect[m(response[33m.[mbody)[33m.[34mtoEqual[m({[K[31C
    [90m470|[9X[m[9Cerror[33m: [32m'Unauthorized - Invalid token'[K[23C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[22/143]⎯[m
[77C
[41m[1m FAIL [m src/features/authRoutes.test.ts[2m > [22mAuth Routes[2m > [22mPOST /auth/login[2m > [22mret
[13;77Hturns 404 when user profile not found[41C
[31m[1mAssertionError[22m: expected 500 to be 404 // Object.is equality[K[17C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- 404[72C[m
[31m+ 500[72C[m
[77C
[36m [2m❯[22m src/features/authRoutes.test.ts:[2m481:31[m[K[36C
    [90m479|[9X[33m[9C.[35mset[m([32m'Authorization'[33m, [32m`Bearer [36m${[mmockToken[36m}[32m`[m)[33m;[K[15C[m
    [90m480|[K[69C[m
    [90m481|       [34mexpect[m(response[33m.[mstatus)[33m.[34mtoBe[m([34m404[m)[33m;[K[28C[m
       [90m|[31X[31m[31C^[K[37C[m
    [90m482|       [34mexpect[m(response[33m.[mbody)[33m.[34mtoEqual[m({[K[31C
    [90m483|[9X[m[9Cerror[33m: [32m'User profile not found. Please contact support.'    [m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[23/143]⎯[m
[77C
[41m[1m FAIL [m src/features/authRoutes.test.ts[2m > [22mAuth Routes[2m > [22mPOST /auth/login[2m > [22mhan
[13;77Hndles database errors gracefully[46C
[31m[1mAssertionError[22m: expected { Object (error) } to deeply equal { error: 'Databas[m
[31m[13;77Hse connection failed' }[55C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[2m  {[22m[K[74C
[32m-   "error": "Database connection failed",[35C[m
[31m+   "error": "Cannot read properties of undefined (reading 'uid')",[10C[m
[2m  }[22m[K[74C
[77C
[36m [2m❯[22m src/features/authRoutes.test.ts:[2m496:29[m[K[36C
[77C    [90m494| [m
    [90m495|       [34mexpect[m(response[33m.[mstatus)[33m.[34mtoBe[m([34m500[m)[33m;[K[28C[m
    [90m496|       [34mexpect[m(response[33m.[mbody)[33m.[34mtoEqual[m({[K[31C
       [90m|[29X[31m[29C^[K[39C[m
    [90m497|[9X[m[9Cerror[33m: [32m'Database connection failed'[K[25C[m
    [90m498|       [m})[33m;[K[59C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[24/143]⎯[m
[77C
[77C[41m[1m FAIL [m src/features/authRoutes.test.ts[2m > [22mAuth Routes[2m > [22mPOST /auth/login[2m > [22mhan
[13;77Hndles unexpected errors[55C
[31m[1mAssertionError[22m: expected { Object (error) } to deeply equal { Object (error) [m
[31m[13;77H }[76C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[2m  {[22m[K[74C
[32m-   "error": "Login failed. Please try again.",[30C[m
[31m+   "error": "Cannot read properties of undefined (reading 'uid')",[10C[m
[2m  }[22m[K[74C
[77C
[36m [2m❯[22m src/features/authRoutes.test.ts:[2m509:29[m[K[36C
    [90m507|[K[69C[m
    [90m508|       [34mexpect[m(response[33m.[mstatus)[33m.[34mtoBe[m([34m500[m)[33m;[K[28C[m
    [90m509|       [34mexpect[m(response[33m.[mbody)[33m.[34mtoEqual[m({[K[31C
       [90m|[29X[31m[29C^[K[39C[m
    [90m510|[9X[m[9Cerror[33m: [32m'Login failed. Please try again.'[K[20C[m
    [90m511|       [m})[33m;[K[59C[m
]0;node (vitest 4)[77C
[77C[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[25/143]⎯[m
[77C
[41m[1m FAIL [m src/features/authRoutes.test.ts[2m > [22mAuth Routes[2m > [22mPOST /auth/login[2m > [22mver
[13;77Hrifies Firebase token with correct parameters[33C
[31m[1mAssertionError[22m: expected "spy" to be called with arguments: [ 'mock-firebase-[m
[31m[13;77H-token' ][69C[m
[90m[77C[m
[90mNumber of calls: [1m0[22m[K[59C[m
[90m[77C[m
[36m [2m❯[22m src/features/authRoutes.test.ts:[2m529:33[m[K[36C
    [90m527|[9X[33m[9C.[35mset[m([32m'Authorization'[33m, [32m`Bearer [36m${[mmockToken[36m}[32m`[m)[33m;[K[15C[m
    [90m528|[K[69C[m
    [90m529|       [34mexpect[m(mockVerifyIdToken)[33m.[34mtoHaveBeenCalledWith[m(mockToken)[33m;    [m
       [90m|[33X[31m[33C^[K[35C[m
    [90m530|     [m})[33m;[K[61C[m
    [90m531|   [m})[33m;[K[63C[m
[77C
[77C[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[26/143]⎯[m
[77C
[41m[1m FAIL [m src/features/database.test.ts[2m > [22mDatabaseService[2m > [22mgetDb[2m > [22mshould not r
[13;77Hreinitialize if already initialized[43C
[31m[1mAssertionError[22m: expected "spy" to be called at least once[K[20C[m
[36m [2m❯[22m src/features/database.test.ts:[2m114:31[m[K[38C
[77C    [90m112|       // initializeApp should not be called again[m
    [90m113|       [34mexpect[m(admin[33m.[minitializeApp)[33m.[mnot[33m.[34mtoHaveBeenCalled[m()[33m;[K[11C[m
    [90m114|       [34mexpect[m(admin[33m.[mfirestore)[33m.[34mtoHaveBeenCalled[m()[33m;[K[19C[m
       [90m|[31X[31m[31C^[K[37C[m
    [90m115|     [m})[33m;[K[61C[m
    [90m116|[K[69C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[27/143]⎯[m
[77C
[41m[1m FAIL [m src/features/database.test.ts[2m > [22mDatabaseService[2m > [22mgetDb[2m > [22mshould initi
[13;77Hialize with production settings[47C
[31m[1mAssertionError[22m: expected "spy" to be called with arguments: [ { credential: A[m
[31m[13;77HAnything, …(1) } ][60C[m
[90m[77C[m
[90mReceived:[68C[m
[90m[77C[m
[90m[1m  1st spy call:[22m[K[62C[m
[90m[77C[m
[90m[2m  [[22m[K[74C[m
[90m[2m    {[22m[K[72C[m
[32m-     "credential": Anything,[48C[m
[31m+     "credential": undefined,[47C[m
[90m[2m      "projectId": "pharmarx-prod",[22m[K[42C[m
[90m[2m    },[22m[K[71C[m
[90m[2m  ][22m[K[74C[m
[90m[77C[m
[90m[77C[m
[90mNumber of calls: [1m1[22m[K[59C[m
[90m[77C[m
[36m [2m❯[22m src/features/database.test.ts:[2m173:35[m[K[38C
    [90m171|[K[69C[m
    [90m172|       [34mexpect[m(admin[33m.[mcredential[33m.[mcert)[33m.[34mtoHaveBeenCalled[m()[33m;[K[13C[m
    [90m173|       [34mexpect[m(admin[33m.[minitializeApp)[33m.[34mtoHaveBeenCalledWith[m({[K[12C
       [90m|[35X[31m[35C^[K[33C[m
    [90m174|[9X[m[9Ccredential[33m: [mexpect[33m.[34manything[m()[33m,[K[30C[m
    [90m175|[9X[m[9CprojectId[33m: [32m'pharmarx-prod'[K[34C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[28/143]⎯[m
[77C
[41m[1m FAIL [m src/features/database.test.ts[2m > [22mDatabaseService[2m > [22mgetDb[2m > [22mshould use a
[13;77Happlication default credentials in production if no service account key       
[77C[31m[1mAssertionError[22m: expected "spy" to be called with arguments: [ { credential: A[m
[31m[13;77HAnything, …(1) } ][60C[m
[90m[77C[m
[90mReceived:[68C[m
[90m[77C[m
[90m[1m  1st spy call:[22m[K[62C[m
[90m[77C[m
[90m[2m  [[22m[K[74C[m
[90m[2m    {[22m[K[72C[m
[32m-     "credential": Anything,[48C[m
[31m+     "credential": undefined,[47C[m
[90m[2m      "projectId": "pharmarx-prod",[22m[K[42C[m
[90m[2m    },[22m[K[71C[m
[90m[2m  ][22m[K[74C[m
[90m[77C[m
[90m[77C[m
[90mNumber of calls: [1m1[22m[K[59C[m
[90m[77C[m
[36m [2m❯[22m src/features/database.test.ts:[2m192:35[m[K[38C
    [90m190|[K[69C[m
    [90m191|       [mexpect(admin.credential.applicationDefault).toHaveBeenCalled(…
    [90m192|       [34mexpect[m(admin[33m.[minitializeApp)[33m.[34mtoHaveBeenCalledWith[m({[K[12C
       [90m|[35X[31m[35C^[K[33C[m
    [90m193|[9X[m[9Ccredential[33m: [mexpect[33m.[34manything[m()[33m,[K[30C[m
    [90m194|[9X[m[9CprojectId[33m: [32m'pharmarx-prod'[K[34C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[29/143]⎯[m
[77C
[41m[1m FAIL [m src/features/database.test.ts[2m > [22mDatabaseService[2m > [22mhealthCheck[2m > [22mshould
[13;77Hd return healthy status when database is accessible[27C
[31m[1mAssertionError[22m: expected { status: 'unhealthy', …(2) } to deeply equal { stat[m
[31m[13;77Htus: 'healthy', connected: true }[45C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[2m  {[22m[K[74C
[32m-   "connected": true,[55C[m
[32m-   "status": "healthy",[53C[m
[31m+   "projectId": "unknown",[50C[m
[31m+   "status": "unhealthy",[51C[m
[31m+   "timestamp": 2025-07-29T12:15:31.946Z,[35C[m
[2m  }[22m[K[74C
[77C
[36m [2m❯[22m src/features/database.test.ts:[2m215:22[m[K[38C
    [90m213|       [35mconst [mresult [33m= [35mawait [mdatabaseService[33m.[34mhealthCheck[m()[33m;[K[11C[m
    [90m214|[K[69C[m
    [90m215|       [34mexpect[m(result)[33m.[34mtoEqual[m({[K[38C
       [90m|[22X[31m[22C^[K[46C[m
    [90m216|[9X[m[9Cstatus[33m: [32m'healthy'[33m,[K[42C[m
    [90m217|[9X[m[9Cconnected[33m: [35mtrue[K[45C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[30/143]⎯[m
[77C
[41m[1m FAIL [m src/features/database.test.ts[2m > [22mDatabaseService[2m > [22mhealthCheck[2m > [22mshould
[13;77Hd return unhealthy status when database is not accessible[21C
[31m[1mAssertionError[22m: expected { status: 'unhealthy', …(2) } to deeply equal { stat[m
[31m[13;77Htus: 'unhealthy', …(1) }[54C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[2m  {[22m[K[74C
[32m-   "connected": false,[54C[m
[31m+   "projectId": "unknown",[50C[m
[2m    "status": "unhealthy",[22m[K[51C
[31m+   "timestamp": 2025-07-29T12:15:31.985Z,[35C[m
[2m  }[22m[K[74C
[77C
[36m [2m❯[22m src/features/database.test.ts:[2m236:22[m[K[38C
    [90m234|       [35mconst [mresult [33m= [35mawait [mdatabaseService[33m.[34mhealthCheck[m()[33m;[K[11C[m
    [90m235|[K[69C[m
    [90m236|       [34mexpect[m(result)[33m.[34mtoEqual[m({[K[38C
       [90m|[22X[31m[22C^[K[46C[m
    [90m237|[9X[m[9Cstatus[33m: [32m'unhealthy'[33m,[K[40C[m
    [90m238|[9X[m[9Cconnected[33m: [35mfalse[K[44C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[31/143]⎯[m
[77C
[41m[1m FAIL [m src/features/database.test.ts[2m > [22mDatabaseService[2m > [22mhealthCheck[2m > [22mshould
[13;77Hd handle database initialization errors[39C
[77C[31m[1mAssertionError[22m: expected { status: 'unhealthy', …(2) } to deeply equal { stat[m
[31m[13;77Htus: 'unhealthy', …(1) }[54C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[2m  {[22m[K[74C
[32m-   "connected": false,[54C[m
[31m+   "projectId": "unknown",[50C[m
[2m    "status": "unhealthy",[22m[K[51C
[31m+   "timestamp": 2025-07-29T12:15:32.002Z,[35C[m
[2m  }[22m[K[74C
[77C
[36m [2m❯[22m src/features/database.test.ts:[2m250:22[m[K[38C
    [90m248|       [35mconst [mresult [33m= [35mawait [mdatabaseService[33m.[34mhealthCheck[m()[33m;[K[11C[m
    [90m249|[K[69C[m
    [90m250|       [34mexpect[m(result)[33m.[34mtoEqual[m({[K[38C
       [90m|[22X[31m[22C^[K[46C[m
    [90m251|[9X[m[9Cstatus[33m: [32m'unhealthy'[33m,[K[40C[m
    [90m252|[9X[m[9Cconnected[33m: [35mfalse[K[44C[m
]0;node (vitest 3)[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[32/143]⎯[m
[77C
[41m[1m FAIL [m src/features/database.test.ts[2m > [22mDatabaseService[2m > [22mclose[2m > [22mshould close
[13;77He all Firebase apps[59C
[31m[1mAssertionError[22m: expected "spy" to be called at least once[K[20C[m
[36m [2m❯[22m src/features/database.test.ts:[2m267:31[m[K[38C
[77C    [90m265|       [35mawait [mdatabaseService[33m.[34mclose[m()[33m;[m
    [90m266|[K[69C[m
    [90m267|       [34mexpect[m(mockApp1[33m.[35mdelete[m)[33m.[34mtoHaveBeenCalled[m()[33m;[K[19C[m
       [90m|[31X[31m[31C^[K[37C[m
    [90m268|       [34mexpect[m(mockApp2[33m.[35mdelete[m)[33m.[34mtoHaveBeenCalled[m()[33m;[K[19C[m
    [90m269|     [m})[33m;[K[61C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[33/143]⎯[m
[77C
[41m[1m FAIL [m src/features/database.test.ts[2m > [22mDatabaseService[2m > [22mclose[2m > [22mshould handl
[13;77Hle apps array with null values[48C
[31m[1mAssertionError[22m: expected "spy" to be called at least once[K[20C[m
[36m [2m❯[22m src/features/database.test.ts:[2m279:30[m[K[38C
    [90m277|       [35mawait [mdatabaseService[33m.[34mclose[m()[33m;[K[32C[m
    [90m278|[K[69C[m
    [90m279|       [34mexpect[m(mockApp[33m.[35mdelete[m)[33m.[34mtoHaveBeenCalled[m()[33m;[K[20C[m
       [90m|[30X[31m[30C^[K[38C[m
    [90m280|       // Should not throw error for null app[K[24C[m
    [90m281|     [m})[33m;[K[61C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[34/143]⎯[m
[77C
[77C[41m[1m FAIL [m src/features/database.test.ts[2m > [22mDatabaseService[2m > [22msingleton behavior[2m >[22m
[2m[13;77H>
 [22mshould maintain singleton pattern across multiple requires[K[18C
[31m[1mError[22m: Database initialization failed[K[40C[m
[36m [2m❯[22m DatabaseService.<anonymous> src/features/database.test.ts:[2m245:15[m[K[10C
    [90m243|       // Mock getDb to throw an error[K[31C[m
    [90m244|       [mvi[33m.[34mspyOn[m(databaseService[33m, [32m'getDb'[m)[33m.[34mmockImplementation[m(() [33m=> [m{ 
    [90m245|[9X[35m[9Cthrow new [33mError[m([32m'Database initialization failed'[m)[33m;[K[10C[m
       [90m|[15X[31m[15C^[K[53C[m
    [90m246|       [m})[33m;[K[59C[m
    [90m247|[K[69C[m
[90m [2m❯[22m src/features/database.test.ts:[2m323:23[m[K[38C
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[35/143]⎯[m
[77C
[41m[1m FAIL [m src/features/deliveryTrackingRoutes.test.ts[2m > [22mDelivery Tracking Routes
[13;77Hs[2m > [22mGET /orders/:orderId/delivery-tracking[2m > [22mshould handle server errors grace
[13;77Hefully[72C
[31m[1mAssertionError[22m: expected undefined to be false // Object.is equality[K[9C[m
[77C
[32m- Expected:[66C[m
false[72C
[77C
[31m+ Received:[66C[m
undefined[68C
[77C
[36m [2m❯[22m src/features/deliveryTrackingRoutes.test.ts:[2m119:37[m[K[24C
[77C    [90m117|[9X[33m[9C.[34mexpect[m([34m500[m)[33m;[m
    [90m118|[K[69C[m
    [90m119|       [34mexpect[m(response[33m.[mbody[33m.[msuccess)[33m.[34mtoBe[m([35mfalse[m)[33m;[K[20C[m
       [90m|[37X[31m[37C^[K[31C[m
    [90m120|       [mexpect(response.body.error).toBe('Failed to fetch delivery tr…
    [90m121|[K[69C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[36/143]⎯[m
[77C
[77C[41m[1m FAIL [m src/features/deliveryTrackingRoutes.test.ts[2m > [22mDelivery Tracking Routes
[13;77Hs[2m > [22mPOST /orders/:orderId/delivery-location[2m > [22mshould reject requests with inva
[13;77Halid coordinates[62C
[31m[1mError[22m: expected 400 "Bad Request", got 200 "OK"[K[30C[m
[36m [2m❯[22m src/features/deliveryTrackingRoutes.test.ts:[2m186:12[m[K[24C
    [90m184|[11X[33m[11C.[34mpost[m([32m'/orders/test-order-123/delivery-location'[m)[K[9C
    [90m185|[11X[33m[11C.[34msend[m(update)[K[45C
    [90m186|[11X[33m[11C.[34mexpect[m([34m400[m)[33m;[K[45C[m
       [90m|[12X[31m[12C^[K[56C[m
    [90m187|[K[69C[m
    [90m188|[9X[34m[9Cexpect[m(response[33m.[mbody[33m.[msuccess)[33m.[34mtoBe[m([35mfalse[m)[33m;[K[18C[m
[90m [2m❯[22m Test._assertStatus ../../node_modules/supertest/lib/test.js:[2m309:14[m        
[90m [2m❯[22m ../../node_modules/supertest/lib/test.js:[2m365:13[m[K[27C
[90m [2m❯[22m Test._assertFunction ../../node_modules/supertest/lib/test.js:[2m342:13[m      
[90m [2m❯[22m Test.assert ../../node_modules/supertest/lib/test.js:[2m195:23[m[K[15C
[90m [2m❯[22m localAssert ../../node_modules/supertest/lib/test.js:[2m138:14[m[K[15C
[90m [2m❯[22m Server.<anonymous> ../../node_modules/supertest/lib/test.js:[2m152:11[m        
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[37/143]⎯[m
[77C
[41m[1m FAIL [m src/features/deliveryTrackingRoutes.test.ts[2m > [22mDelivery Tracking Routes
[13;77Hs[2m > [22mPOST /orders/:orderId/delivery-location[2m > [22mshould handle extreme but valid 
[13;77H coordinate values[60C
[77C[31m[1mError[22m: expected 200 "OK", got 400 "Bad Request"[m
[77C[36m [2m❯[22m src/features/deliveryTrackingRoutes.test.ts:[2m204:12[m
[77C    [90m202|[11X[33m[11C.[34mpost[m([32m'/orders/test-order-123/delivery-location'[m)
    [90m203|[11X[33m[11C.[34msend[m(coords)[K[45C
    [90m204|[11X[33m[11C.[34mexpect[m([34m200[m)[33m;[K[45C[m
       [90m|[12X[31m[12C^[K[56C[m
    [90m205|[K[69C[m
    [90m206|[9X[34m[9Cexpect[m(response[33m.[mbody[33m.[msuccess)[33m.[34mtoBe[m([35mtrue[m)[33m;[K[19C[m
[77C[90m [2m❯[22m Test._assertStatus ../../node_modules/supertest/lib/test.js:[2m309:14[m
[77C[90m [2m❯[22m ../../node_modules/supertest/lib/test.js:[2m365:13[m
[90m [2m❯[22m Test._assertFunction ../../node_modules/supertest/lib/test.js:[2m342:13[m      
[90m [2m❯[22m Test.assert ../../node_modules/supertest/lib/test.js:[2m195:23[m[K[15C
[90m [2m❯[22m localAssert ../../node_modules/supertest/lib/test.js:[2m138:14[m[K[15C
[90m [2m❯[22m Server.<anonymous> ../../node_modules/supertest/lib/test.js:[2m152:11[m        
[77C
[77C[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[38/143]⎯[m
[77C
[77C[41m[1m FAIL [m src/features/deliveryTrackingRoutes.test.ts[2m > [22mDelivery Tracking Routes
[13;77Hs[2m > [22mPOST /orders/:orderId/delivery-location[2m > [22mshould handle server errors duri
[13;77Hing location update[59C
[77C[31m[1mAssertionError[22m: expected undefined to be false // Object.is equality[m
[77C
[32m- Expected:[66C[m
false[72C
[77C
[31m+ Received:[66C[m
undefined[68C
[77C
[36m [2m❯[22m src/features/deliveryTrackingRoutes.test.ts:[2m225:37[m[K[24C
    [90m223|[9X[33m[9C.[34mexpect[m([34m500[m)[33m;[K[47C[m
    [90m224|[K[69C[m
    [90m225|       [34mexpect[m(response[33m.[mbody[33m.[msuccess)[33m.[34mtoBe[m([35mfalse[m)[33m;[K[20C[m
       [90m|[37X[31m[37C^[K[31C[m
    [90m226|       [mexpect(response.body.error).toBe('Failed to update delivery l…
    [90m227|[K[69C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[39/143]⎯[m
[77C
[77C[41m[1m FAIL [m src/features/deliveryTrackingRoutes.test.ts[2m > [22mDelivery Tracking Routes
[13;77Hs[2m > [22mPOST /orders/:orderId/delivery-notifications[2m > [22mshould handle server errors
[13;77Hs during preference update[52C
[31m[1mAssertionError[22m: expected undefined to be false // Object.is equality[K[9C[m
[77C
[32m- Expected:[66C[m
false[72C
[77C
[31m+ Received:[66C[m
undefined[68C
[77C
[36m [2m❯[22m src/features/deliveryTrackingRoutes.test.ts:[2m373:37[m[K[24C
    [90m371|[9X[33m[9C.[34mexpect[m([34m500[m)[33m;[K[47C[m
    [90m372|[K[69C[m
    [90m373|       [34mexpect[m(response[33m.[mbody[33m.[msuccess)[33m.[34mtoBe[m([35mfalse[m)[33m;[K[20C[m
       [90m|[37X[31m[37C^[K[31C[m
    [90m374|       [mexpect(response.body.error).toBe('Failed to update notificati…
    [90m375|[K[69C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[40/143]⎯[m
[77C
[41m[1m FAIL [m src/features/ocrIntegration.test.ts[2m > [22mOCR Integration Tests[2m > [22mReal-wor
[13;77Hrld prescription text extraction[2m > [22mshould extract text from prescription image
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[K[14C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- true[71C[m
[31m+ false[70C[m
[77C
[77C[36m [2m❯[22m src/features/ocrIntegration.test.ts:[2m97:30[m
[77C     [90m95|       [35mconst [mresult [33m= [35mawait [mocrService[33m.[34mprocessImage[m(request)[33m;[m
     [90m96|[K[69C[m
     [90m97|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mtrue[m)[33m;[K[28C[m
       [90m|[30X[31m[30C^[K[38C[m
     [90m98|       [34mexpect[m(result[33m.[mextractedText)[33m.[34mtoBe[m(prescriptionText)[33m;[K[10C[m
     [90m99|       [34mexpect[m(result[33m.[mextractedText)[33m.[34mtoContain[m([32m'Amoxicillin 500mg'[m)[33m;  [m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[41/143]⎯[m
[77C
[41m[1m FAIL [m src/features/ocrIntegration.test.ts[2m > [22mOCR Integration Tests[2m > [22mReal-wor
[13;77Hrld prescription text extraction[2m > [22mshould handle handwritten prescription with
[13;77Hh lower confidence[60C
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[K[14C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- true[71C[m
[31m+ false[70C[m
[77C
[36m [2m❯[22m src/features/ocrIntegration.test.ts:[2m128:30[m[K[32C
    [90m126|       [35mconst [mresult [33m= [35mawait [mocrService[33m.[34mprocessImage[m(request)[33m;        [m
    [90m127|[K[69C[m
    [90m128|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mtrue[m)[33m;[K[28C[m
       [90m|[30X[31m[30C^[K[38C[m
    [90m129|       [34mexpect[m(result[33m.[mextractedText)[33m.[34mtoBe[m(handwrittenText)[33m;[K[11C[m
    [90m130|       [34mexpect[m(result[33m.[mextractedText)[33m.[34mtoContain[m([32m'Lisinopril'[m)[33m;[K[9C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[42/143]⎯[m
[77C
[41m[1m FAIL [m src/features/ocrIntegration.test.ts[2m > [22mOCR Integration Tests[2m > [22mReal-wor
[13;77Hrld prescription text extraction[2m > [22mshould handle poor quality image with parti
[13;77Hial text[70C
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[K[14C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- true[71C[m
[31m+ false[70C[m
[77C
[36m [2m❯[22m src/features/ocrIntegration.test.ts:[2m155:30[m[K[32C
    [90m153|       [35mconst [mresult [33m= [35mawait [mocrService[33m.[34mprocessImage[m(request)[33m;        [m
    [90m154|[K[69C[m
    [90m155|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mtrue[m)[33m;[K[28C[m
       [90m|[30X[31m[30C^[K[38C[m
    [90m156|       [34mexpect[m(result[33m.[mextractedText)[33m.[34mtoBe[m(partialText)[33m;[K[15C[m
    [90m157|       [34mexpect[m(result[33m.[mextractedText)[33m.[34mtoContain[m([32m'[UNCLEAR]'[m)[33m;[K[10C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[43/143]⎯[m
[77C
[41m[1m FAIL [m src/features/ocrIntegration.test.ts[2m > [22mOCR Integration Tests[2m > [22mGoogle C
[13;77HCloud Vision API error scenarios[2m > [22mshould handle QUOTA_EXCEEDED error[K[9C
[31m[1mAssertionError[22m: expected 'OCR failed after 3 attempts. Last err…' to contain [m
[31m[13;77H 'Quota exceeded'[61C[m
[77C
Expected: [32m"Quota exceeded"[K[51C[m
Received: [31m"OCR failed after 3 attempts. Last error: (intermediate value) is n[m
[31m[13;77Hnot iterable"[65C[m
[77C
[77C[36m [2m❯[22m src/features/ocrIntegration.test.ts:[2m177:28[m
    [90m175|[K[69C[m
    [90m176|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mfalse[m)[33m;[K[27C[m
    [90m177|       [34mexpect[m(result[33m.[merror)[33m.[34mtoContain[m([32m'Quota exceeded'[m)[33m;[K[13C[m
       [90m|[28X[31m[28C^[K[40C[m
    [90m178|     [m})[33m;[K[61C[m
    [90m179|[K[69C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[44/143]⎯[m
[77C
[41m[1m FAIL [m src/features/ocrIntegration.test.ts[2m > [22mOCR Integration Tests[2m > [22mGoogle C
[13;77HCloud Vision API error scenarios[2m > [22mshould handle PERMISSION_DENIED error      
[31m[1mAssertionError[22m: expected 'OCR failed after 3 attempts. Last err…' to contain [m
[31m[13;77H 'permission'[65C[m
[77C
Expected: [32m"permission"[K[55C[m
Received: [31m"OCR failed after 3 attempts. Last error: (intermediate value) is n[m
[31m[13;77Hnot iterable"[65C[m
[77C
[36m [2m❯[22m src/features/ocrIntegration.test.ts:[2m195:28[m[K[32C
    [90m193|[K[69C[m
    [90m194|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mfalse[m)[33m;[K[27C[m
    [90m195|       [34mexpect[m(result[33m.[merror)[33m.[34mtoContain[m([32m'permission'[m)[33m;[K[17C[m
       [90m|[28X[31m[28C^[K[40C[m
    [90m196|     [m})[33m;[K[61C[m
    [90m197|[K[69C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[45/143]⎯[m
[77C
[41m[1m FAIL [m src/features/ocrIntegration.test.ts[2m > [22mOCR Integration Tests[2m > [22mGoogle C
[13;77HCloud Vision API error scenarios[2m > [22mshould handle INVALID_ARGUMENT for unsuppor
[13;77Hrted image format[61C
[31m[1mAssertionError[22m: expected 'OCR failed after 3 attempts. Last err…' to contain [m
[31m[13;77H 'Invalid image format'[55C[m
[77C
Expected: [32m"Invalid image format"[K[45C[m
Received: [31m"OCR failed after 3 attempts. Last error: (intermediate value) is n[m
[31m[13;77Hnot iterable"[65C[m
[77C
[36m [2m❯[22m src/features/ocrIntegration.test.ts:[2m213:28[m[K[32C
    [90m211|[K[69C[m
    [90m212|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mfalse[m)[33m;[K[27C[m
    [90m213|       [34mexpect[m(result[33m.[merror)[33m.[34mtoContain[m([32m'Invalid image format'[m)[33m;       [m
       [90m|[28X[31m[28C^[K[40C[m
    [90m214|     [m})[33m;[K[61C[m
    [90m215|[K[69C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[46/143]⎯[m
[77C
[41m[1m FAIL [m src/features/ocrIntegration.test.ts[2m > [22mOCR Integration Tests[2m > [22mGoogle C
[13;77HCloud Vision API error scenarios[2m > [22mshould handle network timeout errors       
[31m[1mAssertionError[22m: expected 'OCR failed after 3 attempts. Last err…' to contain [m
[31m[13;77H 'Deadline exceeded'[58C[m
[77C
Expected: [32m"Deadline exceeded"[K[48C[m
Received: [31m"OCR failed after 3 attempts. Last error: (intermediate value) is n[m
[31m[13;77Hnot iterable"[65C[m
[77C
[36m [2m❯[22m src/features/ocrIntegration.test.ts:[2m231:28[m[K[32C
    [90m229|[K[69C[m
    [90m230|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mfalse[m)[33m;[K[27C[m
    [90m231|       [34mexpect[m(result[33m.[merror)[33m.[34mtoContain[m([32m'Deadline exceeded'[m)[33m;[K[10C[m
       [90m|[28X[31m[28C^[K[40C[m
    [90m232|     [m})[33m;[K[61C[m
    [90m233|   [m})[33m;[K[63C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[47/143]⎯[m
[77C
[41m[1m FAIL [m src/features/ocrIntegration.test.ts[2m > [22mOCR Integration Tests[2m > [22mRetry lo
[13;77Hogic with transient failures[2m > [22mshould succeed after transient network error   
[77C[31m[1mAssertionError[22m: expected false to be true // Object.is equality[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- true[71C[m
[31m+ false[70C[m
[77C
[36m [2m❯[22m src/features/ocrIntegration.test.ts:[2m257:30[m[K[32C
    [90m255|       [35mconst [mresult [33m= [35mawait [mocrService[33m.[34mprocessImage[m(request)[33m;        [m
    [90m256|[K[69C[m
    [90m257|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mtrue[m)[33m;[K[28C[m
       [90m|[30X[31m[30C^[K[38C[m
    [90m258|       [34mexpect[m(result[33m.[mextractedText)[33m.[34mtoBe[m(prescriptionText)[33m;[K[10C[m
    [90m259|       [34mexpect[m(mockTextDetection)[33m.[34mtoHaveBeenCalledTimes[m([34m2[m)[33m;[K[11C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[48/143]⎯[m
[77C
[41m[1m FAIL [m src/features/ocrIntegration.test.ts[2m > [22mOCR Integration Tests[2m > [22mRetry lo
[13;77Hogic with transient failures[2m > [22mshould fail after max retries with persistent e
[13;77Herror[73C
[31m[1mAssertionError[22m: expected 'OCR failed after 3 attempts. Last err…' to contain [m
[31m[13;77H 'Internal server error'[54C[m
[77C
Expected: [32m"Internal server error"[K[44C[m
Received: [31m"OCR failed after 3 attempts. Last error: (intermediate value) is n[m
[31m[13;77Hnot iterable"[65C[m
[77C
[36m [2m❯[22m src/features/ocrIntegration.test.ts:[2m279:28[m[K[32C
    [90m277|[K[69C[m
    [90m278|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mfalse[m)[33m;[K[27C[m
    [90m279|       [34mexpect[m(result[33m.[merror)[33m.[34mtoContain[m([32m'Internal server error'[m)[33m;      [m
       [90m|[28X[31m[28C^[K[40C[m
    [90m280|       [mexpect(mockTextDetection).toHaveBeenCalledTimes(3); // maxRet…
    [90m281|     [m})[33m;[K[61C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[49/143]⎯[m
[77C
[77C[41m[1m FAIL [m src/features/ocrIntegration.test.ts[2m > [22mOCR Integration Tests[2m > [22mImage fo
[13;77Hormat handling[2m > [22mshould process JPEG images successfully[K[22C
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[K[14C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- true[71C[m
[31m+ false[70C[m
[77C
[77C[36m [2m❯[22m src/features/ocrIntegration.test.ts:[2m299:30[m
    [90m297|       [35mconst [mresult [33m= [35mawait [mocrService[33m.[34mprocessImage[m(request)[33m;        [m
    [90m298|[K[69C[m
    [90m299|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mtrue[m)[33m;[K[28C[m
       [90m|[30X[31m[30C^[K[38C[m
    [90m300|       [34mexpect[m(mockTextDetection)[33m.[34mtoHaveBeenCalledWith[m({[K[14C
    [90m301|[9X[m[9Cimage[33m: [m{ source[33m: [m{ imageUri[33m: [mrequest[33m.[mimageUrl } }[33m,[K[10C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[50/143]⎯[m
[77C
[41m[1m FAIL [m src/features/ocrIntegration.test.ts[2m > [22mOCR Integration Tests[2m > [22mImage fo
[13;77Hormat handling[2m > [22mshould process PNG images successfully[K[23C
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[K[14C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- true[71C[m
[31m+ false[70C[m
[77C
[36m [2m❯[22m src/features/ocrIntegration.test.ts:[2m320:30[m[K[32C
    [90m318|       [35mconst [mresult [33m= [35mawait [mocrService[33m.[34mprocessImage[m(request)[33m;        [m
    [90m319|[K[69C[m
    [90m320|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mtrue[m)[33m;[K[28C[m
       [90m|[30X[31m[30C^[K[38C[m
    [90m321|       [34mexpect[m(result[33m.[mextractedText)[33m.[34mtoBe[m(extractedText)[33m;[K[13C[m
    [90m322|     [m})[33m;[K[61C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[51/143]⎯[m
[77C
[41m[1m FAIL [m src/features/ocrIntegration.test.ts[2m > [22mOCR Integration Tests[2m > [22mImage fo
[13;77Hormat handling[2m > [22mshould process PDF documents successfully[K[20C
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[K[14C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- true[71C[m
[31m+ false[70C[m
[77C
[36m [2m❯[22m src/features/ocrIntegration.test.ts:[2m338:30[m[K[32C
    [90m336|       [35mconst [mresult [33m= [35mawait [mocrService[33m.[34mprocessImage[m(request)[33m;        [m
    [90m337|[K[69C[m
    [90m338|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mtrue[m)[33m;[K[28C[m
       [90m|[30X[31m[30C^[K[38C[m
    [90m339|       [34mexpect[m(result[33m.[mextractedText)[33m.[34mtoBe[m(extractedText)[33m;[K[13C[m
    [90m340|     [m})[33m;[K[61C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[52/143]⎯[m
[77C
[77C[41m[1m FAIL [m src/features/ocrIntegration.test.ts[2m > [22mOCR Integration Tests[2m > [22mPerforma
[13;77Hance and scalability[2m > [22mshould handle large prescription images[K[16C
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[K[14C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- true[71C[m
[31m+ false[70C[m
[77C
[36m [2m❯[22m src/features/ocrIntegration.test.ts:[2m363:30[m[K[32C
    [90m361|       [35mconst [mduration [33m= Date.[34mnow[m() [33m- [mstartTime[33m;[K[22C[m
    [90m362|[K[69C[m
    [90m363|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mtrue[m)[33m;[K[28C[m
       [90m|[30X[31m[30C^[K[38C[m
    [90m364|       [34mexpect[m(result[33m.[mextractedText)[33m.[34mtoBe[m(largeText)[33m;[K[17C[m
    [90m365|       [mexpect(duration).toBeLessThan(10000); // Should complete with…
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[53/143]⎯[m
[77C
[41m[1m FAIL [m src/features/ocrIntegration.test.ts[2m > [22mOCR Integration Tests[2m > [22mPerforma
[13;77Hance and scalability[2m > [22mshould handle concurrent OCR requests[K[18C
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[K[14C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- true[71C[m
[31m+ false[70C[m
[77C
[77C[36m [2m❯[22m src/features/ocrIntegration.test.ts:[2m392:32[m
    [90m390|       [34mexpect[m(results)[33m.[34mtoHaveLength[m([34m3[m)[33m;[K[30C[m
    [90m391|       [mresults[33m.[34mforEach[m((result[33m, [mindex) [33m=> [m{[K[26C
    [90m392|[9X[34m[9Cexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mtrue[m)[33m;[K[26C[m
       [90m|[32X[31m[32C^[K[36C[m
    [90m393|[9X[34m[9Cexpect[m(result[33m.[mextractedText)[33m.[34mtoBe[m(mockTexts[index])[33m;        [m
    [90m394|       [m})[33m;[K[59C[m
[90m [2m❯[22m src/features/ocrIntegration.test.ts:[2m391:15[m[K[32C
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[54/143]⎯[m
[77C
[41m[1m FAIL [m src/features/ocrIntegration.test.ts[2m > [22mOCR Integration Tests[2m > [22mHealth c
[13;77Hcheck integration[2m > [22mshould verify service connectivity[K[24C
[31m[1mAssertionError[22m: expected "spy" to be called at least once[K[20C[m
[36m [2m❯[22m src/features/ocrIntegration.test.ts:[2m408:32[m[K[32C
    [90m406|[K[69C[m
    [90m407|       [34mexpect[m(isHealthy)[33m.[34mtoBe[m([35mtrue[m)[33m;[K[33C[m
    [90m408|       [34mexpect[m(mockGetProjectId)[33m.[34mtoHaveBeenCalled[m()[33m;[K[18C[m
       [90m|[32X[31m[32C^[K[36C[m
    [90m409|     [m})[33m;[K[61C[m
    [90m410|[K[69C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[55/143]⎯[m
[77C
[41m[1m FAIL [m src/features/ocrIntegration.test.ts[2m > [22mOCR Integration Tests[2m > [22mHealth c
[13;77Hcheck integration[2m > [22mshould detect service unavailability[K[22C
[31m[1mAssertionError[22m: expected true to be false // Object.is equality[K[14C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- false[70C[m
[31m+ true[71C[m
[77C
[36m [2m❯[22m src/features/ocrIntegration.test.ts:[2m416:25[m[K[32C
    [90m414|       [35mconst [misHealthy [33m= [35mawait [mocrService[33m.[34mhealthCheck[m()[33m;[K[13C[m
    [90m415|[K[69C[m
    [90m416|       [34mexpect[m(isHealthy)[33m.[34mtoBe[m([35mfalse[m)[33m;[K[32C[m
       [90m|[25X[31m[25C^[K[43C[m
    [90m417|     [m})[33m;[K[61C[m
    [90m418|   [m})[33m;[K[63C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[56/143]⎯[m
[77C
[41m[1m FAIL [m src/features/ocrIntegration.test.ts[2m > [22mOCR Integration Tests[2m > [22mEdge cas
[13;77Hses and boundary conditions[2m > [22mshould handle images with no text[K[15C
[31m[1mAssertionError[22m: expected 'OCR failed after 3 attempts. Last err…' to contain [m
[31m[13;77H 'No text detected'[59C[m
[77C
Expected: [32m"No text detected"[K[49C[m
Received: [31m"OCR failed after 3 attempts. Last error: (intermediate value) is n[m
[31m[13;77Hnot iterable"[65C[m
[77C
[36m [2m❯[22m src/features/ocrIntegration.test.ts:[2m434:28[m[K[32C
[77C    [90m432| [m
    [90m433|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mfalse[m)[33m;[K[27C[m
    [90m434|       [34mexpect[m(result[33m.[merror)[33m.[34mtoContain[m([32m'No text detected'[m)[33m;[K[11C[m
       [90m|[28X[31m[28C^[K[40C[m
    [90m435|     [m})[33m;[K[61C[m
    [90m436|[K[69C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[57/143]⎯[m
[77C
[41m[1m FAIL [m src/features/ocrIntegration.test.ts[2m > [22mOCR Integration Tests[2m > [22mEdge cas
[13;77Hses and boundary conditions[2m > [22mshould handle corrupted image responses[K[9C
[31m[1mAssertionError[22m: expected 'OCR failed after 3 attempts. Last err…' to contain [m
[31m[13;77H 'Empty text extracted'[55C[m
[77C
Expected: [32m"Empty text extracted"[K[45C[m
Received: [31m"OCR failed after 3 attempts. Last error: (intermediate value) is n[m
[31m[13;77Hnot iterable"[65C[m
[77C
[36m [2m❯[22m src/features/ocrIntegration.test.ts:[2m450:28[m[K[32C
    [90m448|[K[69C[m
    [90m449|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mfalse[m)[33m;[K[27C[m
    [90m450|       [34mexpect[m(result[33m.[merror)[33m.[34mtoContain[m([32m'Empty text extracted'[m)[33m;       [m
       [90m|[28X[31m[28C^[K[40C[m
    [90m451|     [m})[33m;[K[61C[m
    [90m452|[K[69C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[58/143]⎯[m
[77C
[41m[1m FAIL [m src/features/ocrRoutes.test.ts[2m > [22mOCR Routes[2m > [22merror handling[2m > [22mshould 
[13;77H handle invalid JSON in request body[42C
[31m[1mError[22m: expected 400 "Bad Request", got 500 "Internal Server Error"[K[11C[m
[36m [2m❯[22m src/features/ocrRoutes.test.ts:[2m430:10[m[K[37C
[77C    [90m428|[9X[33m[9C.[34mpost[m([32m'/api/orders/test/process-ocr'[m)
    [90m429|[9X[33m[9C.[34msend[m([32m'invalid json'[m)[K[39C
    [90m430|[9X[33m[9C.[34mexpect[m([34m400[m)[33m;[K[47C[m
       [90m|[10X[31m[10C^[K[58C[m
    [90m431|     [m})[33m;[K[61C[m
    [90m432|[K[69C[m
[90m [2m❯[22m Test._assertStatus ../../node_modules/supertest/lib/test.js:[2m309:14[m        
[90m [2m❯[22m ../../node_modules/supertest/lib/test.js:[2m365:13[m[K[27C
[90m [2m❯[22m Test._assertFunction ../../node_modules/supertest/lib/test.js:[2m342:13[m      
[90m [2m❯[22m Test.assert ../../node_modules/supertest/lib/test.js:[2m195:23[m[K[15C
[90m [2m❯[22m localAssert ../../node_modules/supertest/lib/test.js:[2m138:14[m[K[15C
[90m [2m❯[22m Server.<anonymous> ../../node_modules/supertest/lib/test.js:[2m152:11[m        
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[59/143]⎯[m
[77C
[41m[1m FAIL [m src/features/ocrService.test.ts[2m > [22mOCRService[2m > [22mprocessImage[2m > [22mshould s
[13;77Hsuccessfully extract text from image[42C
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[K[14C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- true[71C[m
[31m+ false[70C[m
[77C
[36m [2m❯[22m src/features/ocrService.test.ts:[2m70:30[m[K[37C
[77C     [90m68|       [35mconst [mresult [33m= [35mawait [mocrService[33m.[34mprocessImage[m(mockRequest)[33m;[m
     [90m69|[K[69C[m
     [90m70|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mtrue[m)[33m;[K[28C[m
       [90m|[30X[31m[30C^[K[38C[m
     [90m71|       [34mexpect[m(result[33m.[mextractedText)[33m.[34mtoBe[m(mockExtractedText)[33m;[K[9C[m
     [90m72|       [34mexpect[m(result[33m.[merror)[33m.[34mtoBeUndefined[m()[33m;[K[25C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[60/143]⎯[m
[77C
[41m[1m FAIL [m src/features/ocrService.test.ts[2m > [22mOCRService[2m > [22mprocessImage[2m > [22mshould h
[13;77Hhandle empty text detection results[43C
[31m[1mAssertionError[22m: expected 'OCR failed after 3 attempts. Last err…' to be 'OCR [m
[31m[13;77H failed after 3 attempts. Last err…' // Object.is equality[20C[m
[77C
Expected: [32m"OCR failed after 3 attempts. Last error: [7mNo text detected in the i[m
[32m[7m[13;77Himag[27me"[K[72C[m
Received: [31m"OCR failed after 3 attempts. Last error: [7m(intermediate value) is n[m
[31m[7m[13;77Hnot iterabl[27me"[K[65C[m
[77C
[36m [2m❯[22m src/features/ocrService.test.ts:[2m87:28[m[K[37C
     [90m85|[K[69C[m
     [90m86|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mfalse[m)[33m;[K[27C[m
     [90m87|       [mexpect(result.error).toBe('OCR failed after 3 attempts. Last …
       [90m|[28X[31m[28C^[K[40C[m
     [90m88|       [34mexpect[m(result[33m.[mextractedText)[33m.[34mtoBeUndefined[m()[33m;[K[17C[m
     [90m89|     [m})[33m;[K[61C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[61/143]⎯[m
[77C
[41m[1m FAIL [m src/features/ocrService.test.ts[2m > [22mOCRService[2m > [22mprocessImage[2m > [22mshould h
[13;77Hhandle empty extracted text[51C
[31m[1mAssertionError[22m: expected 'OCR failed after 3 attempts. Last err…' to be 'OCR [m
[31m[13;77H failed after 3 attempts. Last err…' // Object.is equality[20C[m
[77C
Expected: [32m"OCR failed after 3 attempts. Last error: [7mEmpty text extracted from[m
[32m[7m[13;77Hm imag[27me"[K[70C[m
Received: [31m"OCR failed after 3 attempts. Last error: [7m(intermediate value) is n[m
[31m[7m[13;77Hnot iterabl[27me"[K[65C[m
[77C
[36m [2m❯[22m src/features/ocrService.test.ts:[2m101:28[m[K[36C
[77C     [90m99| [m
    [90m100|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mfalse[m)[33m;[K[27C[m
    [90m101|       [mexpect(result.error).toBe('OCR failed after 3 attempts. Last …
       [90m|[28X[31m[28C^[K[40C[m
    [90m102|     [m})[33m;[K[61C[m
    [90m103|[K[69C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[62/143]⎯[m
[77C
[41m[1m FAIL [m src/features/ocrService.test.ts[2m > [22mOCRService[2m > [22mprocessImage[2m > [22mshould r
[13;77Hretry on transient failures[51C
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[K[14C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- true[71C[m
[31m+ false[70C[m
[77C
[36m [2m❯[22m src/features/ocrService.test.ts:[2m118:30[m[K[36C
    [90m116|       [35mconst [mresult [33m= [35mawait [mocrService[33m.[34mprocessImage[m(mockRequest)[33m;    [m
    [90m117|[K[69C[m
    [90m118|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mtrue[m)[33m;[K[28C[m
       [90m|[30X[31m[30C^[K[38C[m
    [90m119|       [34mexpect[m(result[33m.[mextractedText)[33m.[34mtoBe[m(mockExtractedText)[33m;[K[9C[m
    [90m120|       [34mexpect[m(mockTextDetection)[33m.[34mtoHaveBeenCalledTimes[m([34m2[m)[33m;[K[11C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[63/143]⎯[m
[77C
[41m[1m FAIL [m src/features/ocrService.test.ts[2m > [22mOCRService[2m > [22mprocessImage[2m > [22mshould f
[13;77Hfail after max retries[56C
[31m[1mAssertionError[22m: expected 'OCR failed after 3 attempts. Last err…' to be 'OCR [m
[31m[13;77H failed after 3 attempts. Last err…' // Object.is equality[20C[m
[77C
Expected: [32m"OCR failed after 3 attempts. Last error: [7mPersistent API error[27m"    [m
Received: [31m"OCR failed after 3 attempts. Last error: [7m(intermediate value) is n[m
[31m[7m[13;77Hnot iterable[27m"[K[65C[m
[77C
[36m [2m❯[22m src/features/ocrService.test.ts:[2m130:28[m[K[36C
    [90m128|[K[69C[m
    [90m129|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mfalse[m)[33m;[K[27C[m
    [90m130|       [mexpect(result.error).toBe('OCR failed after 3 attempts. Last …
       [90m|[28X[31m[28C^[K[40C[m
    [90m131|       [34mexpect[m(mockTextDetection)[33m.[34mtoHaveBeenCalledTimes[m([34m3[m)[33m;[K[11C[m
    [90m132|     [m})[33m;[K[61C[m
[77C
[77C[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[64/143]⎯[m
[77C
[41m[1m FAIL [m src/features/ocrService.test.ts[2m > [22mOCRService[2m > [22mprocessImage[2m > [22mshould h
[13;77Hhandle Vision API errors gracefully[43C
[31m[1mAssertionError[22m: expected 'OCR failed after 3 attempts. Last err…' to contain [m
[31m[13;77H 'QUOTA_EXCEEDED'[61C[m
[77C
Expected: [32m"QUOTA_EXCEEDED"[K[51C[m
Received: [31m"OCR failed after 3 attempts. Last error: (intermediate value) is n[m
[31m[13;77Hnot iterable"[65C[m
[77C
[36m [2m❯[22m src/features/ocrService.test.ts:[2m140:28[m[K[36C
    [90m138|[K[69C[m
    [90m139|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mfalse[m)[33m;[K[27C[m
    [90m140|       [34mexpect[m(result[33m.[merror)[33m.[34mtoContain[m([32m'QUOTA_EXCEEDED'[m)[33m;[K[13C[m
       [90m|[28X[31m[28C^[K[40C[m
    [90m141|     [m})[33m;[K[61C[m
    [90m142|   [m})[33m;[K[63C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[65/143]⎯[m
[77C
[41m[1m FAIL [m src/features/ocrService.test.ts[2m > [22mOCRService[2m > [22mhealthCheck[2m > [22mshould re
[13;77Heturn true when service is healthy[44C
[31m[1mAssertionError[22m: expected "spy" to be called at least once[K[20C[m
[36m [2m❯[22m src/features/ocrService.test.ts:[2m211:32[m[K[36C
    [90m209|[K[69C[m
    [90m210|       [34mexpect[m(result)[33m.[34mtoBe[m([35mtrue[m)[33m;[K[36C[m
    [90m211|       [34mexpect[m(mockGetProjectId)[33m.[34mtoHaveBeenCalled[m()[33m;[K[18C[m
       [90m|[32X[31m[32C^[K[36C[m
    [90m212|     [m})[33m;[K[61C[m
    [90m213|[K[69C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[66/143]⎯[m
[77C
[41m[1m FAIL [m src/features/ocrService.test.ts[2m > [22mOCRService[2m > [22mhealthCheck[2m > [22mshould re
[13;77Heturn false when service is unhealthy[41C
[31m[1mAssertionError[22m: expected true to be false // Object.is equality[K[14C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- false[70C[m
[31m+ true[71C[m
[77C
[36m [2m❯[22m src/features/ocrService.test.ts:[2m219:22[m[K[36C
    [90m217|       [35mconst [mresult [33m= [35mawait [mocrService[33m.[34mhealthCheck[m()[33m;[K[16C[m
    [90m218|[K[69C[m
    [90m219|       [34mexpect[m(result)[33m.[34mtoBe[m([35mfalse[m)[33m;[K[35C[m
       [90m|[22X[31m[22C^[K[46C[m
    [90m220|     [m})[33m;[K[61C[m
    [90m221|   [m})[33m;[K[63C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[67/143]⎯[m
[77C
[41m[1m FAIL [m src/features/ocrService.test.ts[2m > [22mOCRService[2m > [22merror scenarios[2m > [22mshoul
[13;77Hld handle malformed Vision API responses[38C
[31m[1mAssertionError[22m: expected 'OCR failed after 3 attempts. Last err…' to contain [m
[31m[13;77H 'No text detected in the image'[46C[m
[77C
Expected: [32m"[7mNo text detected in the imag[27me"[K[36C[m
Received: [31m"[7mOCR failed after 3 attempts. Last error: (intermediate value) is n[m
[31m[7m[13;77Hnot iterabl[27me"[K[65C[m
[77C
[36m [2m❯[22m src/features/ocrService.test.ts:[2m233:28[m[K[36C
    [90m231|[K[69C[m
    [90m232|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mfalse[m)[33m;[K[27C[m
    [90m233|       [mexpect(result.error).toContain('No text detected in the image…
       [90m|[28X[31m[28C^[K[40C[m
    [90m234|     [m})[33m;[K[61C[m
    [90m235|[K[69C[m
[77C
[77C[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[68/143]⎯[m
[77C
[41m[1m FAIL [m src/features/ocrService.test.ts[2m > [22mOCRService[2m > [22merror scenarios[2m > [22mshoul
[13;77Hld handle network timeouts[52C
[31m[1mAssertionError[22m: expected 'OCR failed after 3 attempts. Last err…' to contain [m
[31m[13;77H 'TIMEOUT'[68C[m
[77C
Expected: [32m"TIMEOUT"[K[58C[m
Received: [31m"OCR failed after 3 attempts. Last error: (intermediate value) is n[m
[31m[13;77Hnot iterable"[65C[m
[77C
[36m [2m❯[22m src/features/ocrService.test.ts:[2m256:28[m[K[36C
    [90m254|[K[69C[m
    [90m255|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mfalse[m)[33m;[K[27C[m
    [90m256|       [34mexpect[m(result[33m.[merror)[33m.[34mtoContain[m([32m'TIMEOUT'[m)[33m;[K[20C[m
       [90m|[28X[31m[28C^[K[40C[m
    [90m257|     [m})[33m;[K[61C[m
    [90m258|   [m})[33m;[K[63C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[69/143]⎯[m
[77C
[41m[1m FAIL [m src/features/ocrService.test.ts[2m > [22mOCRService[2m > [22mperformance considerati
[13;77Hions[2m > [22mshould process image within reasonable time[K[28C
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[K[14C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- true[71C[m
[31m+ false[70C[m
[77C
[36m [2m❯[22m src/features/ocrService.test.ts:[2m274:30[m[K[36C
[77C    [90m272|       [35mconst [mduration [33m= Date.[34mnow[m() [33m- [mstartTime[33m;[m
    [90m273|[K[69C[m
    [90m274|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mtrue[m)[33m;[K[28C[m
       [90m|[30X[31m[30C^[K[38C[m
    [90m275|       [mexpect(duration).toBeLessThan(5000); // Should finish within …
    [90m276|     [m})[33m;[K[61C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[70/143]⎯[m
[77C
[41m[1m FAIL [m src/features/ocrService.test.ts[2m > [22mOCRService[2m > [22mperformance considerati
[13;77Hions[2m > [22mshould handle large text extraction[K[36C
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[K[14C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- true[71C[m
[31m+ false[70C[m
[77C
[36m [2m❯[22m src/features/ocrService.test.ts:[2m289:30[m[K[36C
    [90m287|       [m})[33m;[K[59C[m
    [90m288|[K[69C[m
    [90m289|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mtrue[m)[33m;[K[28C[m
       [90m|[30X[31m[30C^[K[38C[m
    [90m290|       [34mexpect[m(result[33m.[mextractedText)[33m.[34mtoBe[m(largeText)[33m;[K[17C[m
    [90m291|     [m})[33m;[K[61C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[71/143]⎯[m
[77C
[41m[1m FAIL [m src/features/paymentService.test.ts[2m > [22mPaymentService[2m > [22mprocessPayment[2m [22m
[2m[13;77H > [22mshould validate order exists and is in correct state[K[23C
[31m[1mAssertionError[22m: promise resolved "{ paymentId: 'mock-doc-id', …(3) }" instead[m
[31m[13;77Hd of rejecting[64C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- Error {[68C[m
[32m-   "message": "rejected promise",[43C[m
[31m+ {[74C[m
[31m+   "gatewayResponse": {[53C[m
[31m+     "amount": 4550,[56C[m
[31m+     "created": 1753791339,[49C[m
[31m+     "currency": "usd",[53C[m
[31m+     "id": "ch_bavfc0ekz5p",[48C[m
[31m+     "payment_method": {[52C[m
[31m+       "card": {[60C[m
[31m+         "brand": "visa",[51C[m
[31m+         "last4": "4242",[51C[m
[31m+       },[67C[m
[31m+     },[69C[m
[31m+     "status": "succeeded",[49C[m
[31m+   },[71C[m
[31m+   "paymentId": "mock-doc-id",[46C[m
[31m+   "status": "succeeded",[51C[m
[31m+   "transactionId": "ch_bavfc0ekz5p",[39C[m
[2m  }[22m[K[74C
[77C
[36m [2m❯[22m src/features/paymentService.test.ts:[2m211:75[m[K[32C
[77C    [90m209|       [m}[33m;[m
    [90m210|[K[69C[m
    [90m211|       [mawait expect(paymentService.processPayment(request, 'test-use…
       [90m|                                                                     [14;147H[m
      [31m^[K[70C[m
    [90m212|[9X[m[9C.rejects.toThrow('Order validation failed: Order not found'…
    [90m213|     [m})[33m;[K[61C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[72/143]⎯[m
[77C
[41m[1m FAIL [m src/features/paymentService.test.ts[2m > [22mPaymentService[2m > [22mgetPayment[2m > [22msh
[13;77Hhould return payment when it exists[43C
[31m[1mAssertionError[22m: expected { orderId: 'test-order-1', …(2) } to deeply equal { [m
[31m[13;77H paymentId: 'test-payment-1', …(3) }[42C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[2m  {[22m[K[74C
[32m-   "amount": 45.5,[58C[m
[31m+   "cost": 45.5,[60C[m
[2m    "orderId": "test-order-1",[22m[K[47C
[32m-   "paymentId": "test-payment-1",[43C[m
[32m-   "status": "succeeded",[51C[m
[31m+   "status": "awaiting_payment",[44C[m
[2m  }[22m[K[74C
[77C
[36m [2m❯[22m src/features/paymentService.test.ts:[2m269:22[m[K[32C
    [90m267|       [mconst result = await paymentService.getPayment('test-payment-…
    [90m268|[K[69C[m
    [90m269|       [34mexpect[m(result)[33m.[34mtoEqual[m(mockPayment)[33m;[K[26C[m
       [90m|[22X[31m[22C^[K[46C[m
    [90m270|     [m})[33m;[K[61C[m
    [90m271|[K[69C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[73/143]⎯[m
[77C
[41m[1m FAIL [m src/features/paymentService.test.ts[2m > [22mPaymentService[2m > [22mgetPayment[2m > [22msh
[13;77Hhould return null when payment does not exist[33C
[77C[31m[1mAssertionError[22m: expected { orderId: 'test-order-1', …(2) } to be null[m
[77C
[32m- Expected:[66C[m
null[73C
[77C
[31m+ Received:[66C[m
{[76C
  "cost": 45.5,[62C
  "orderId": "test-order-1",[49C
  "status": "awaiting_payment",[46C
}[76C
[77C
[36m [2m❯[22m src/features/paymentService.test.ts:[2m285:22[m[K[32C
    [90m283|       [mconst result = await paymentService.getPayment('non-existent-…
    [90m284|[K[69C[m
    [90m285|       [34mexpect[m(result)[33m.[34mtoBeNull[m()[33m;[K[36C[m
       [90m|[22X[31m[22C^[K[46C[m
    [90m286|     [m})[33m;[K[61C[m
    [90m287|   [m})[33m;[K[63C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[74/143]⎯[m
[77C
[41m[1m FAIL [m src/features/paymentService.test.ts[2m > [22mPaymentService[2m > [22mgetPaymentsForO
[13;77HOrder[2m > [22mshould return payments for an order[K[35C
[31m[1mAssertionError[22m: expected [] to deeply equal [ …(2) ][K[25C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- [[74C[m
[32m-   {[72C[m
[32m-     "amount": 45.5,[56C[m
[32m-     "orderId": "test-order-1",[45C[m
[32m-     "paymentId": "payment-1",[46C[m
[32m-     "status": "succeeded",[49C[m
[32m-   },[71C[m
[32m-   {[72C[m
[32m-     "amount": 45.5,[56C[m
[32m-     "orderId": "test-order-1",[45C[m
[32m-     "paymentId": "payment-2",[46C[m
[32m-     "status": "failed",[52C[m
[32m-   },[71C[m
[32m- ][74C[m
[31m+ [][73C[m
[77C
[36m [2m❯[22m src/features/paymentService.test.ts:[2m326:22[m[K[32C
    [90m324|       [mconst result = await paymentService.getPaymentsForOrder('test…
    [90m325|[K[69C[m
    [90m326|       [34mexpect[m(result)[33m.[34mtoEqual[m(mockPayments)[33m;[K[25C[m
       [90m|[22X[31m[22C^[K[46C[m
    [90m327|       [mexpect(mockWhere).toHaveBeenCalledWith('orderId', '==', 'test…
    [90m328|       [34mexpect[m(mockOrderBy)[33m.[34mtoHaveBeenCalledWith[m([32m'createdAt'[33m, [32m'desc'[m)[33m;[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[75/143]⎯[m
[77C
[77C[41m[1m FAIL [m src/features/paymentService.test.ts[2m > [22mPaymentService[2m > [22mprocessWebhook[2m [22m
[2m[13;77H > [22mshould process Stripe webhook successfully[K[33C
[31m[1mAssertionError[22m: promise rejected "Error: Payment not found for transaction …"[m
[31m[13;77H" instead of resolving[56C[m
[36m [2m❯[22m src/features/paymentService.test.ts:[2m372:93[m[K[32C
    [90m370|       [m})[33m;[K[59C[m
    [90m371|[K[69C[m
    [90m372|       [mawait expect(paymentService.processWebhook('stripe', stripePa…
       [90m|                                                                     [14;147H[m
[31m[24C^[K[52C[m
    [90m373|[9X[33m[9C.[mresolves[33m.[mnot[33m.[34mtoThrow[m()[33m;[K[36C[m
    [90m374|     [m})[33m;[K[61C[m
[77C
[31m[1mCaused by: Error[22m: Payment not found for transaction pi_test_123[K[14C[m
[36m [2m❯[22m PaymentService.updatePaymentStatusFromWebhook src/features/paymentService.[m
[36m[13;77H.ts:[2m546:13[22m[K[68C[m
[90m [2m❯[22m PaymentService.processStripeWebhook src/features/paymentService.ts:[2m489:9[m  
[90m [2m❯[22m PaymentService.processWebhook src/features/paymentService.ts:[2m457:9[m        
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[76/143]⎯[m
[77C
[41m[1m FAIL [m src/features/paymentService.test.ts[2m > [22mPaymentService[2m > [22mprocessWebhook[2m [22m
[2m[13;77H > [22mshould process PayPal webhook successfully[K[33C
[77C[31m[1mAssertionError[22m: promise rejected "Error: Payment not found for transaction …"[m
[31m[13;77H" instead of resolving[56C[m
[36m [2m❯[22m src/features/paymentService.test.ts:[2m412:93[m[K[32C
    [90m410|       [m})[33m;[K[59C[m
    [90m411|[K[69C[m
    [90m412|       [mawait expect(paymentService.processWebhook('paypal', paypalPa…
       [90m|                                                                     [14;147H[m
[31m[24C^[K[52C[m
    [90m413|[9X[33m[9C.[mresolves[33m.[mnot[33m.[34mtoThrow[m()[33m;[K[36C[m
    [90m414|     [m})[33m;[K[61C[m
[77C
[31m[1mCaused by: Error[22m: Payment not found for transaction CAPTURE123[K[15C[m
[36m [2m❯[22m PaymentService.updatePaymentStatusFromWebhook src/features/paymentService.[m
[36m[13;77H.ts:[2m546:13[22m[K[68C[m
[90m [2m❯[22m PaymentService.processPayPalWebhook src/features/paymentService.ts:[2m508:9[m  
[90m [2m❯[22m PaymentService.processWebhook src/features/paymentService.ts:[2m460:9[m        
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[77/143]⎯[m
[77C
[41m[1m FAIL [m src/features/paymentService.test.ts[2m > [22mPaymentService[2m > [22mprocessWebhook[2m [22m
[2m[13;77H > [22mshould process MTN webhook successfully[K[36C
[31m[1mAssertionError[22m: promise rejected "Error: Payment not found for transaction …"[m
[31m[13;77H" instead of resolving[56C[m
[36m [2m❯[22m src/features/paymentService.test.ts:[2m450:87[m[K[32C
[77C    [90m448|       [m})[33m;[m
    [90m449|[K[69C[m
    [90m450|       [mawait expect(paymentService.processWebhook('mtn', mtnPayload,…
       [90m|                                                                     [14;147H[m
[31m[18C^[K[58C[m
    [90m451|[9X[33m[9C.[mresolves[33m.[mnot[33m.[34mtoThrow[m()[33m;[K[36C[m
    [90m452|     [m})[33m;[K[61C[m
[77C
[31m[1mCaused by: Error[22m: Payment not found for transaction MTN123[K[19C[m
[36m [2m❯[22m PaymentService.updatePaymentStatusFromWebhook src/features/paymentService.[m
[36m[13;77H.ts:[2m546:13[22m[K[68C[m
[90m [2m❯[22m PaymentService.processMTNWebhook src/features/paymentService.ts:[2m525:7[m     
[90m [2m❯[22m PaymentService.processWebhook src/features/paymentService.ts:[2m463:9[m        
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[78/143]⎯[m
[77C
[41m[1m FAIL [m src/features/prescriptionOrderRoutes.test.ts[2m > [22mPrescription Order Rout
[13;77Htes[2m > [22mPOST /orders[2m > [22mshould create prescription order and trigger OCR processi
[13;77Hing[75C
[41m[1m FAIL [m src/features/prescriptionOrderRoutes.test.ts[2m > [22mPrescription Order Rout
[13;77Htes[2m > [22mPOST /orders[2m > [22mshould return 400 for missing patient profile ID[K[9C
[41m[1m FAIL [m src/features/prescriptionOrderRoutes.test.ts[2m > [22mPrescription Order Rout
[13;77Htes[2m > [22mPOST /orders[2m > [22mshould return 400 for missing image URL[K[18C
[41m[1m FAIL [m src/features/prescriptionOrderRoutes.test.ts[2m > [22mPrescription Order Rout
[13;77Htes[2m > [22mPOST /orders[2m > [22mshould return 400 for invalid image URL[K[18C
[41m[1m FAIL [m src/features/prescriptionOrderRoutes.test.ts[2m > [22mPrescription Order Rout
[13;77Htes[2m > [22mPOST /orders[2m > [22mshould handle database errors during order creation      
[31m[1mError[22m: Cannot find module './ocrService'[K[37C[m
[31mRequire stack:[63C[m
[31m- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.[m
[31m[13;77H.ts[75C[m
[36m [2m❯[22m src/features/prescriptionOrderRoutes.test.ts:[2m52:17[m[K[24C
[77C     [90m50| [m
     [90m51|     [34mbeforeEach[m(() [33m=> [m{[K[46C
     [90m52|       [mvi.mocked(require('./ocrService')).ocrService.validateImageFo…
       [90m|[17X[31m[17C^[K[51C[m
     [90m53|[9X[m[9CisValid[33m: [35mtrue[33m,[K[46C[m
     [90m54|[9X[m[9Cerrors[33m: [m[][K[50C
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[79/143]⎯[m
[77C
[41m[1m FAIL [m src/features/prescriptionOrderRoutes.test.ts[2m > [22mPrescription Order Rout
[13;77Htes[2m > [22mGET /orders[2m > [22mshould return orders for valid patient[K[20C
[31m[1mError[22m: Cannot find module './database'[K[39C[m
[31mRequire stack:[63C[m
[31m- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.[m
[31m[13;77H.ts[75C[m
[36m [2m❯[22m src/features/prescriptionOrderRoutes.test.ts:[2m186:17[m[K[23C
    [90m184|       [m}[33m;[K[60C[m
    [90m185|[K[69C[m
    [90m186|       [mvi.mocked(require('./database')).db.collection.mockReturnValu…
       [90m|[17X[31m[17C^[K[51C[m
    [90m187|[K[69C[m
    [90m188|       [35mconst [mresponse [33m= [35mawait [34mrequest[m(app)[K[27C
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[80/143]⎯[m
[77C
[41m[1m FAIL [m src/features/prescriptionOrderRoutes.test.ts[2m > [22mPrescription Order Rout
[13;77Htes[2m > [22mGET /orders[2m > [22mshould return empty array for patient with no orders      
[77C[31m[1mError[22m: Cannot find module './database'[m
[31mRequire stack:[63C[m
[31m- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.[m
[31m[13;77H.ts[75C[m
[36m [2m❯[22m src/features/prescriptionOrderRoutes.test.ts:[2m219:17[m[K[23C
    [90m217|       [m}[33m;[K[60C[m
    [90m218|[K[69C[m
    [90m219|       [mvi.mocked(require('./database')).db.collection.mockReturnValu…
       [90m|[17X[31m[17C^[K[51C[m
    [90m220|[K[69C[m
    [90m221|       [35mconst [mresponse [33m= [35mawait [34mrequest[m(app)[K[27C
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[81/143]⎯[m
[77C
[41m[1m FAIL [m src/features/prescriptionOrderRoutes.test.ts[2m > [22mPrescription Order Rout
[13;77Htes[2m > [22mGET /orders/:orderId[2m > [22mshould return specific order by ID[K[15C
[31m[1mError[22m: Cannot find module './database'[K[39C[m
[31mRequire stack:[63C[m
[31m- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.[m
[31m[13;77H.ts[75C[m
[36m [2m❯[22m src/features/prescriptionOrderRoutes.test.ts:[2m255:17[m[K[23C
    [90m253|       [m}[33m;[K[60C[m
    [90m254|[K[69C[m
    [90m255|       [mvi.mocked(require('./database')).db.collection.mockReturnValu…
       [90m|[17X[31m[17C^[K[51C[m
    [90m256|[9X[m[9Cdoc[33m: [mvi[33m.[34mfn[m(() [33m=> [mmockDocRef)[K[32C
    [90m257|       [m})[33m;[K[59C[m
[77C
[77C[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[82/143]⎯[m
[77C
[41m[1m FAIL [m src/features/prescriptionOrderRoutes.test.ts[2m > [22mPrescription Order Rout
[13;77Htes[2m > [22mGET /orders/:orderId[2m > [22mshould return 404 for non-existent order[K[9C
[31m[1mError[22m: Cannot find module './database'[K[39C[m
[31mRequire stack:[63C[m
[31m- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.[m
[31m[13;77H.ts[75C[m
[36m [2m❯[22m src/features/prescriptionOrderRoutes.test.ts:[2m274:17[m[K[23C
    [90m272|       [m}[33m;[K[60C[m
    [90m273|[K[69C[m
    [90m274|       [mvi.mocked(require('./database')).db.collection.mockReturnValu…
       [90m|[17X[31m[17C^[K[51C[m
    [90m275|[9X[m[9Cdoc[33m: [mvi[33m.[34mfn[m(() [33m=> [mmockDocRef)[K[32C
    [90m276|       [m})[33m;[K[59C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[83/143]⎯[m
[77C
[41m[1m FAIL [m src/features/prescriptionOrderRoutes.test.ts[2m > [22mPrescription Order Rout
[13;77Htes[2m > [22mPUT /orders/:orderId/status[2m > [22mshould update order status successfully   
[31m[1mError[22m: Cannot find module './database'[K[39C[m
[31mRequire stack:[63C[m
[31m- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.[m
[31m[13;77H.ts[75C[m
[36m [2m❯[22m src/features/prescriptionOrderRoutes.test.ts:[2m319:17[m[K[23C
    [90m317|       [m}[33m;[K[60C[m
    [90m318|[K[69C[m
    [90m319|       [mvi.mocked(require('./database')).db.collection.mockReturnValu…
       [90m|[17X[31m[17C^[K[51C[m
    [90m320|[9X[m[9Cdoc[33m: [mvi[33m.[34mfn[m(() [33m=> [mmockDocRef)[K[32C
    [90m321|       [m})[33m;[K[59C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[84/143]⎯[m
[77C
[77C[41m[1m FAIL [m src/features/prescriptionOrderRoutes.test.ts[2m > [22mPrescription Order Rout
[13;77Htes[2m > [22mPUT /orders/:orderId/manual-text[2m > [22mshould accept manual text entry when 
[13;77H OCR failed[67C
[31m[1mError[22m: Cannot find module './database'[K[39C[m
[31mRequire stack:[63C[m
[31m- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.[m
[31m[13;77H.ts[75C[m
[36m [2m❯[22m src/features/prescriptionOrderRoutes.test.ts:[2m388:17[m[K[23C
    [90m386|       [m}[33m;[K[60C[m
    [90m387|[K[69C[m
    [90m388|       [mvi.mocked(require('./database')).db.collection.mockReturnValu…
       [90m|[17X[31m[17C^[K[51C[m
    [90m389|[9X[m[9Cdoc[33m: [mvi[33m.[34mfn[m(() [33m=> [mmockDocRef)[K[32C
    [90m390|       [m})[33m;[K[59C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[85/143]⎯[m
[77C
[41m[1m FAIL [m src/features/prescriptionOrderRoutes.test.ts[2m > [22mPrescription Order Rout
[13;77Htes[2m > [22mPUT /orders/:orderId/manual-text[2m > [22mshould accept manual text entry when 
[13;77H OCR pending[66C
[31m[1mError[22m: Cannot find module './database'[K[39C[m
[31mRequire stack:[63C[m
[31m- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.[m
[31m[13;77H.ts[75C[m
[36m [2m❯[22m src/features/prescriptionOrderRoutes.test.ts:[2m429:17[m[K[23C
    [90m427|       [m}[33m;[K[60C[m
    [90m428|[K[69C[m
    [90m429|       [mvi.mocked(require('./database')).db.collection.mockReturnValu…
       [90m|[17X[31m[17C^[K[51C[m
    [90m430|[9X[m[9Cdoc[33m: [mvi[33m.[34mfn[m(() [33m=> [mmockDocRef)[K[32C
    [90m431|       [m})[33m;[K[59C[m
[77C
[77C[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[86/143]⎯[m
[77C
[41m[1m FAIL [m src/features/prescriptionOrderRoutes.test.ts[2m > [22mPrescription Order Rout
[13;77Htes[2m > [22mPUT /orders/:orderId/manual-text[2m > [22mshould return 409 if OCR already comp
[13;77Hpleted[72C
[31m[1mError[22m: Cannot find module './database'[K[39C[m
[31mRequire stack:[63C[m
[31m- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.[m
[31m[13;77H.ts[75C[m
[36m [2m❯[22m src/features/prescriptionOrderRoutes.test.ts:[2m457:17[m[K[23C
    [90m455|       [m}[33m;[K[60C[m
    [90m456|[K[69C[m
    [90m457|       [mvi.mocked(require('./database')).db.collection.mockReturnValu…
       [90m|[17X[31m[17C^[K[51C[m
    [90m458|[9X[m[9Cdoc[33m: [mvi[33m.[34mfn[m(() [33m=> [mmockDocRef)[K[32C
    [90m459|       [m})[33m;[K[59C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[87/143]⎯[m
[77C
[41m[1m FAIL [m src/features/prescriptionOrderRoutes.test.ts[2m > [22mPrescription Order Rout
[13;77Htes[2m > [22mPUT /orders/:orderId/manual-text[2m > [22mshould return 404 for non-existent or
[13;77Hrder[74C
[31m[1mError[22m: Cannot find module './database'[K[39C[m
[31mRequire stack:[63C[m
[31m- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.[m
[31m[13;77H.ts[75C[m
[36m [2m❯[22m src/features/prescriptionOrderRoutes.test.ts:[2m486:17[m[K[23C
    [90m484|       [m}[33m;[K[60C[m
    [90m485|[K[69C[m
    [90m486|       [mvi.mocked(require('./database')).db.collection.mockReturnValu…
       [90m|[17X[31m[17C^[K[51C[m
    [90m487|[9X[m[9Cdoc[33m: [mvi[33m.[34mfn[m(() [33m=> [mmockDocRef)[K[32C
    [90m488|       [m})[33m;[K[59C[m
[77C
[77C[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[88/143]⎯[m
[77C
[41m[1m FAIL [m src/features/prescriptionOrderRoutes.test.ts[2m > [22mPrescription Order Rout
[13;77Htes[2m > [22mOCR processing integration[2m > [22mshould validate image before processing    
[31m[1mError[22m: Cannot find module './ocrService'[K[37C[m
[31mRequire stack:[63C[m
[31m- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.[m
[31m[13;77H.ts[75C[m
[36m [2m❯[22m src/features/prescriptionOrderRoutes.test.ts:[2m507:17[m[K[23C
    [90m505|       [m}[33m;[K[60C[m
    [90m506|[K[69C[m
    [90m507|       [mvi.mocked(require('./ocrService')).ocrService.validateImageFo…
       [90m|[17X[31m[17C^[K[51C[m
    [90m508|[9X[m[9CisValid[33m: [35mfalse[33m,[K[45C[m
    [90m509|[9X[m[9Cerrors[33m: [m[[32m'Invalid file format'[m][K[29C
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[89/143]⎯[m
[77C
[41m[1m FAIL [m src/features/prescriptionOrderRoutes.test.ts[2m > [22mOrder History Endpoints
[13;77Hs[2m > [22mGET /orders/history[2m > [22mshould return order history with pagination[K[9C
[77C[31m[1mError[22m: Cannot find module './database'[m
[31mRequire stack:[63C[m
[31m- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.[m
[31m[13;77H.ts[75C[m
[36m [2m❯[22m src/features/prescriptionOrderRoutes.test.ts:[2m579:17[m[K[23C
    [90m577|       [35mconst [mmockCount [33m= [mvi[33m.[34mfn[m()[33m;[K[36C[m
    [90m578|[K[69C[m
    [90m579|       [mvi.mocked(require('./database')).db.collection.mockReturnValu…
       [90m|[17X[31m[17C^[K[51C[m
    [90m580|[9X[m[9Cwhere[33m: [mmockWhere[33m,[K[43C[m
    [90m581|[9X[m[9CorderBy[33m: [mmockOrderBy[33m,[K[39C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[90/143]⎯[m
[77C
[41m[1m FAIL [m src/features/prescriptionOrderRoutes.test.ts[2m > [22mOrder History Endpoints
[13;77Hs[2m > [22mGET /orders/history[2m > [22mshould return 400 if patientId is missing[K[11C
[31m[1mAssertionError[22m: expected 404 to be 400 // Object.is equality[K[17C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- 400[72C[m
[31m+ 404[72C[m
[77C
[36m [2m❯[22m src/features/prescriptionOrderRoutes.test.ts:[2m639:31[m[K[23C
    [90m637|[9X[33m[9C.[34mquery[m({ page[33m: [32m'1'[33m, [mlimit[33m: [32m'10' [m})[33m;[K[25C[m
    [90m638|[K[69C[m
    [90m639|       [34mexpect[m(response[33m.[mstatus)[33m.[34mtoBe[m([34m400[m)[33m;[K[28C[m
       [90m|[31X[31m[31C^[K[37C[m
    [90m640|       [34mexpect[m(response[33m.[mbody[33m.[msuccess)[33m.[34mtoBe[m([35mfalse[m)[33m;[K[20C[m
    [90m641|       [34mexpect[m(response[33m.[mbody[33m.[merror)[33m.[34mtoBe[m([32m'Patient ID is required'[m)[33m;   [m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[91/143]⎯[m
[77C
[41m[1m FAIL [m src/features/prescriptionOrderRoutes.test.ts[2m > [22mOrder History Endpoints
[13;77Hs[2m > [22mGET /orders/history[2m > [22mshould handle pagination correctly[K[18C
[77C[31m[1mError[22m: Cannot find module './database'[m
[31mRequire stack:[63C[m
[31m- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.[m
[31m[13;77H.ts[75C[m
[36m [2m❯[22m src/features/prescriptionOrderRoutes.test.ts:[2m658:17[m[K[23C
    [90m656|       [35mconst [mmockCount [33m= [mvi[33m.[34mfn[m()[33m;[K[36C[m
    [90m657|[K[69C[m
    [90m658|       [mvi.mocked(require('./database')).db.collection.mockReturnValu…
       [90m|[17X[31m[17C^[K[51C[m
    [90m659|[9X[m[9Cwhere[33m: [mmockWhere[33m,[K[43C[m
    [90m660|[9X[m[9CorderBy[33m: [mmockOrderBy[33m,[K[39C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[92/143]⎯[m
[77C
[41m[1m FAIL [m src/features/prescriptionOrderRoutes.test.ts[2m > [22mOrder History Endpoints
[13;77Hs[2m > [22mReceipt Download Endpoints[2m > [22mshould download receipt for delivered order  
[31m[1mError[22m: Cannot find module './database'[K[39C[m
[31mRequire stack:[63C[m
[31m- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.[m
[31m[13;77H.ts[75C[m
[77C[36m [2m❯[22m src/features/prescriptionOrderRoutes.test.ts:[2m747:17[m
    [90m745|       [35mconst [mmockLimit [33m= [mvi[33m.[34mfn[m()[33m;[K[36C[m
    [90m746|[K[69C[m
    [90m747|       [mvi.mocked(require('./database')).db.collection.mockReturnValu…
       [90m|[17X[31m[17C^[K[51C[m
    [90m748|[9X[m[9Cdoc[33m: [mvi[33m.[34mfn[m(() [33m=> [mmockDocRef)[33m,[K[31C[m
    [90m749|[9X[m[9Cwhere[33m: [mmockWhere[33m,[K[43C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[93/143]⎯[m
[77C
[41m[1m FAIL [m src/features/prescriptionOrderRoutes.test.ts[2m > [22mOrder History Endpoints
[13;77Hs[2m > [22mReceipt Download Endpoints[2m > [22mshould return 404 if order not found[K[9C
[31m[1mError[22m: Cannot find module './database'[K[39C[m
[31mRequire stack:[63C[m
[31m- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.[m
[31m[13;77H.ts[75C[m
[36m [2m❯[22m src/features/prescriptionOrderRoutes.test.ts:[2m782:17[m[K[23C
    [90m780|       [m}[33m;[K[60C[m
    [90m781|[K[69C[m
    [90m782|       [mvi.mocked(require('./database')).db.collection.mockReturnValu…
       [90m|[17X[31m[17C^[K[51C[m
    [90m783|[9X[m[9Cdoc[33m: [mvi[33m.[34mfn[m(() [33m=> [mmockDocRef)[K[32C
    [90m784|       [m})[33m;[K[59C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[94/143]⎯[m
[77C
[41m[1m FAIL [m src/features/prescriptionOrderRoutes.test.ts[2m > [22mOrder History Endpoints
[13;77Hs[2m > [22mReceipt Download Endpoints[2m > [22mshould return 403 if order does not belong to
[13;77Ho patient[69C
[77C[31m[1mError[22m: Cannot find module './database'[m
[31mRequire stack:[63C[m
[31m- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.[m
[31m[13;77H.ts[75C[m
[36m [2m❯[22m src/features/prescriptionOrderRoutes.test.ts:[2m808:17[m[K[23C
    [90m806|       [m}[33m;[K[60C[m
    [90m807|[K[69C[m
    [90m808|       [mvi.mocked(require('./database')).db.collection.mockReturnValu…
       [90m|[17X[31m[17C^[K[51C[m
    [90m809|[9X[m[9Cdoc[33m: [mvi[33m.[34mfn[m(() [33m=> [mmockDocRef)[K[32C
    [90m810|       [m})[33m;[K[59C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[95/143]⎯[m
[77C
[41m[1m FAIL [m src/features/prescriptionOrderRoutes.test.ts[2m > [22mOrder History Endpoints
[13;77Hs[2m > [22mReceipt Download Endpoints[2m > [22mshould return 400 if order is not delivered  
[31m[1mError[22m: Cannot find module './database'[K[39C[m
[31mRequire stack:[63C[m
[31m- C:\Users\akgte\PharmaRx\apps\api\src\features\prescriptionOrderRoutes.test.[m
[31m[13;77H.ts[75C[m
[36m [2m❯[22m src/features/prescriptionOrderRoutes.test.ts:[2m834:17[m[K[23C
[77C    [90m832|       [m}[33m;[m
    [90m833|[K[69C[m
    [90m834|       [mvi.mocked(require('./database')).db.collection.mockReturnValu…
       [90m|[17X[31m[17C^[K[51C[m
    [90m835|[9X[m[9Cdoc[33m: [mvi[33m.[34mfn[m(() [33m=> [mmockDocRef)[K[32C
    [90m836|       [m})[33m;[K[59C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[96/143]⎯[m
[77C
[41m[1m FAIL [m src/features/prescriptionOrderRoutes.test.ts[2m > [22mOrder History Endpoints
[13;77Hs[2m > [22mReceipt Download Endpoints[2m > [22mshould return 400 if patientId is missing    
[31m[1mAssertionError[22m: expected 404 to be 400 // Object.is equality[K[17C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- 400[72C[m
[31m+ 404[72C[m
[77C
[36m [2m❯[22m src/features/prescriptionOrderRoutes.test.ts:[2m851:31[m[K[23C
    [90m849|[9X[33m[9C.[35mget[m([32m`/orders/[36m${[mmockOrderId[36m}[32m/receipt`[m)[33m;[K[21C[m
    [90m850|[K[69C[m
    [90m851|       [34mexpect[m(response[33m.[mstatus)[33m.[34mtoBe[m([34m400[m)[33m;[K[28C[m
       [90m|[31X[31m[31C^[K[37C[m
    [90m852|       [34mexpect[m(response[33m.[mbody[33m.[msuccess)[33m.[34mtoBe[m([35mfalse[m)[33m;[K[20C[m
    [90m853|       [34mexpect[m(response[33m.[mbody[33m.[merror)[33m.[34mtoBe[m([32m'Patient ID is required'[m)[33m;   [m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[97/143]⎯[m
[77C
[41m[1m FAIL [m src/features/smsService.test.ts[2m > [22mSMSService[2m > [22msendSMS[2m > [22mshould send S
[13;77HSMS successfully[62C
[77C[31m[1mAssertionError[22m: expected undefined to deeply equal { …(4) }[m
[77C
[32m- Expected:[66C[m
{[76C
  "cost": null,[62C
  "messageId": "SM1234567890abcdef",[41C
  "status": "queued",[56C
  "to": "+22912345678",[54C
}[76C
[77C
[31m+ Received:[66C[m
undefined[68C
[77C
[36m [2m❯[22m src/features/smsService.test.ts:[2m57:27[m[K[37C
[77C     [90m55| [m
     [90m56|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mtrue[m)[33m;[K[28C[m
     [90m57|       [34mexpect[m(result[33m.[mdata)[33m.[34mtoEqual[m({[K[33C
       [90m|[27X[31m[27C^[K[41C[m
     [90m58|[9X[m[9CmessageId[33m: [32m'SM1234567890abcdef'[33m,[K[28C[m
     [90m59|[9X[m[9Cstatus[33m: [32m'queued'[33m,[K[43C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[98/143]⎯[m
[77C
[41m[1m FAIL [m src/features/smsService.test.ts[2m > [22mSMSService[2m > [22msendSMS[2m > [22mshould handle
[13;77He Twilio API errors gracefully[48C
[31m[1mAssertionError[22m: expected 'Invalid phone number format' to be 'The To phone nu[m
[31m[13;77Humber is not a valid ph…' // Object.is equality[31C[m
[77C
Expected: [32m"[7mThe To phone number is not a [27mvalid phone number[7m.[27m"[K[17C[m
Received: [31m"[7mIn[27mvalid phone number[7m format[27m"[K[38C[m
[77C
[36m [2m❯[22m src/features/smsService.test.ts:[2m94:28[m[K[37C
     [90m92|[K[69C[m
     [90m93|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mfalse[m)[33m;[K[27C[m
     [90m94|       [mexpect(result.error).toBe('The To phone number is not a valid…
       [90m|[28X[31m[28C^[K[40C[m
     [90m95|     [m})[33m;[K[61C[m
     [90m96|[K[69C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[99/143]⎯[m
[77C
[41m[1m FAIL [m src/features/smsService.test.ts[2m > [22mSMSService[2m > [22msendSMS[2m > [22mshould handle
[13;77He network errors[62C
[31m[1mAssertionError[22m: expected 'Network error while sending SMS' to be 'Failed to s[m
[31m[13;77Hsend SMS: Network timeout' // Object.is equality[30C[m
[77C
Expected: [32m"[7mFailed to[27m send SMS[7m: Network timeout[27m"[K[30C[m
Received: [31m"[7mNetwork error while[27m send[7ming[27m SMS"[K[34C[m
[77C
[77C[36m [2m❯[22m src/features/smsService.test.ts:[2m103:28[m
    [90m101|[K[69C[m
    [90m102|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mfalse[m)[33m;[K[27C[m
    [90m103|       [mexpect(result.error).toBe('Failed to send SMS: Network timeou…
       [90m|[28X[31m[28C^[K[40C[m
    [90m104|     [m})[33m;[K[61C[m
    [90m105|[K[69C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[100/143]⎯[m
[77C
[41m[1m FAIL [m src/features/smsService.test.ts[2m > [22mSMSService[2m > [22msendSMS[2m > [22mshould clean 
[13;77H phone numbers correctly[54C
[31m[1mAssertionError[22m: expected 'To=+22912345678&From=+15551234567&Bod…' to contain [m
[31m[13;77H 'To=%2B22912345678'[58C[m
[77C
Expected: [32m"To=[7m%2B[27m22912345678"[K[48C[m
Received: [31m"To=[7m+[27m22912345678[7m&From=+15551234567&Body=Test+message[27m"[K[14C[m
[77C
[36m [2m❯[22m src/features/smsService.test.ts:[2m132:22[m[K[36C
    [90m130|[9X[m[9Cconst lastCall = mockFetch.mock.calls[mockFetch.mock.calls.…
    [90m131|[9X[35m[9Cconst [mbody [33m= [34mdecodeURIComponent[m(lastCall[[34m1[m][33m.[mbody)[33m;[K[10C[m
    [90m132|[9X[34m[9Cexpect[m(body)[33m.[34mtoContain[m([32m'To=%2B22912345678'[m)[33m;[K[16C[m
       [90m|[22X[31m[22C^[K[46C[m
    [90m133|       [m}[K[61C
    [90m134|     [m})[33m;[K[61C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[101/143]⎯[m
[77C
[41m[1m FAIL [m src/features/smsService.test.ts[2m > [22mSMSService[2m > [22msendSMS[2m > [22mshould valida
[13;77Hate phone numbers[61C
[31m[1mAssertionError[22m: expected true to be false // Object.is equality[K[14C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- false[70C[m
[31m+ true[71C[m
[77C
[36m [2m❯[22m src/features/smsService.test.ts:[2m147:32[m[K[36C
[77C    [90m145|       [35mfor [m([35mconst [mphoneNumber [35mof [minvalidPhoneNumbers) {
    [90m146|[9X[m[9Cconst result = await smsService.sendSMS(phoneNumber, 'Test …
    [90m147|[9X[34m[9Cexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mfalse[m)[33m;[K[25C[m
       [90m|[32X[31m[32C^[K[36C[m
    [90m148|[9X[34m[9Cexpect[m(result[33m.[merror)[33m.[34mtoContain[m([32m'Invalid phone number'[m)[33m;     [m
    [90m149|       [m}[K[61C
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[102/143]⎯[m
[77C
[41m[1m FAIL [m src/features/smsService.test.ts[2m > [22mSMSService[2m > [22msendSMS[2m > [22mshould handle
[13;77He empty message text[58C
[31m[1mAssertionError[22m: expected true to be false // Object.is equality[K[14C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- false[70C[m
[31m+ true[71C[m
[77C
[36m [2m❯[22m src/features/smsService.test.ts:[2m155:30[m[K[36C
    [90m153|       [35mconst [mresult [33m= [35mawait [msmsService[33m.[34msendSMS[m([32m'+22912345678'[33m, [32m''[m)[33m;  [m
    [90m154|[K[69C[m
    [90m155|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mfalse[m)[33m;[K[27C[m
       [90m|[30X[31m[30C^[K[38C[m
    [90m156|       [34mexpect[m(result[33m.[merror)[33m.[34mtoBe[m([32m'Message text cannot be empty'[m)[33m;    [m
    [90m157|     [m})[33m;[K[61C[m
[77C
[77C[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[103/143]⎯[m
[77C
[41m[1m FAIL [m src/features/smsService.test.ts[2m > [22mSMSService[2m > [22msendSMS[2m > [22mshould handle
[13;77He long messages and calculate segments[40C
[31m[1mAssertionError[22m: expected 'GSM' to be 'GSM-7' // Object.is equality[K[11C[m
[77C
Expected: [32m"GSM[7m-7[27m"[K[60C[m
Received: [31m"GSM"[K[62C[m
[77C
[36m [2m❯[22m src/features/smsService.test.ts:[2m195:36[m[K[36C
    [90m193|       [mconst messageInfo = smsService.getMessageInfo(longMessage, '+…
    [90m194|       [mexpect(messageInfo.segments).toBe(3); // 320 chars = 3 segmen…
    [90m195|       [34mexpect[m(messageInfo[33m.[mencoding)[33m.[34mtoBe[m([32m'GSM-7'[m)[33m;[K[19C[m
       [90m|[36X[31m[36C^[K[32C[m
    [90m196|[K[69C[m
    [90m197|       [35mawait [msmsService[33m.[34msendSMS[m([32m'+22912345678'[33m, [mlongMessage)[33m;        [m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[104/143]⎯[m
[77C
[41m[1m FAIL [m src/features/smsService.test.ts[2m > [22mSMSService[2m > [22msendBulkSMS[2m > [22mshould se
[13;77Hend bulk SMS with rate limiting[47C
[77C[31m[1mAssertionError[22m: expected undefined to deeply equal { totalSent: 3, totalFaile[m
[31m[13;77Hed: +0, …(1) }[64C[m
[77C
[32m- Expected:[66C[m
{[76C
  "results": ArrayContaining [[47C
    ObjectContaining {[55C
      "success": true,[55C
    },[71C
    ObjectContaining {[55C
      "success": true,[55C
    },[71C
    ObjectContaining {[55C
      "success": true,[55C
    },[71C
  ],[73C
  "totalFailed": 0,[58C
  "totalSent": 3,[60C
}[76C
[77C
[31m+ Received:[66C[m
undefined[68C
[77C
[36m [2m❯[22m src/features/smsService.test.ts:[2m220:27[m[K[36C
[77C    [90m218| [m
    [90m219|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mtrue[m)[33m;[K[28C[m
    [90m220|       [34mexpect[m(result[33m.[mdata)[33m.[34mtoEqual[m({[K[33C
       [90m|[27X[31m[27C^[K[41C[m
    [90m221|[9X[m[9CtotalSent[33m: [34m3[33m,[K[47C[m
    [90m222|[9X[m[9CtotalFailed[33m: [34m0[33m,[K[45C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[105/143]⎯[m
[77C
[41m[1m FAIL [m src/features/smsService.test.ts[2m > [22mSMSService[2m > [22msendBulkSMS[2m > [22mshould ha
[13;77Handle partial failures in bulk SMS[44C
[31m[1mAssertionError[22m: expected undefined to deeply equal { totalSent: 2, totalFaile[m
[31m[13;77Hed: 1, …(1) }[65C[m
[77C
[32m- Expected:[66C[m
{[76C
  "results": ArrayContaining [[47C
    ObjectContaining {[55C
      "success": true,[55C
    },[71C
    ObjectContaining {[55C
      "error": "Invalid phone number",[39C
      "success": false,[54C
    },[71C
    ObjectContaining {[55C
      "success": true,[55C
    },[71C
  ],[73C
  "totalFailed": 1,[58C
  "totalSent": 2,[60C
}[76C
[77C
[31m+ Received:[66C[m
undefined[68C
[77C
[36m [2m❯[22m src/features/smsService.test.ts:[2m265:27[m[K[36C
    [90m263|[K[69C[m
    [90m264|       [mexpect(result.success).toBe(true); // Overall success even wi…
    [90m265|       [34mexpect[m(result[33m.[mdata)[33m.[34mtoEqual[m({[K[33C
       [90m|[27X[31m[27C^[K[41C[m
    [90m266|[9X[m[9CtotalSent[33m: [34m2[33m,[K[47C[m
    [90m267|[9X[m[9CtotalFailed[33m: [34m1[33m,[K[45C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[106/143]⎯[m
[77C
[77C[41m[1m FAIL [m src/features/smsService.test.ts[2m > [22mSMSService[2m > [22msendBulkSMS[2m > [22mshould re
[13;77Hespect rate limiting in bulk SMS[46C
[31m[1mAssertionError[22m: expected 1 to be greater than or equal to 100[K[16C[m
[36m [2m❯[22m src/features/smsService.test.ts:[2m297:25[m[K[36C
    [90m295|[K[69C[m
    [90m296|       // Should take at least 100ms due to rate limiting[K[12C[m
    [90m297|       [34mexpect[m(timeTaken)[33m.[34mtoBeGreaterThanOrEqual[m([34m100[m)[33m;[K[16C[m
       [90m|[25X[31m[25C^[K[43C[m
    [90m298|     [m})[33m;[K[61C[m
    [90m299|[K[69C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[107/143]⎯[m
[77C
[41m[1m FAIL [m src/features/smsService.test.ts[2m > [22mSMSService[2m > [22msendBulkSMS[2m > [22mshould ha
[13;77Handle empty recipient list[52C
[77C[31m[1mAssertionError[22m: expected undefined to be 'No recipients provided' // Object.i[m
[31m[13;77His equality[67C[m
[77C
[32m- Expected:[66C[m
"No recipients provided"[53C
[77C
[31m+ Received:[66C[m
undefined[68C
[77C
[36m [2m❯[22m src/features/smsService.test.ts:[2m304:28[m[K[36C
    [90m302|[K[69C[m
    [90m303|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mfalse[m)[33m;[K[27C[m
    [90m304|       [34mexpect[m(result[33m.[merror)[33m.[34mtoBe[m([32m'No recipients provided'[m)[33m;[K[10C[m
       [90m|[28X[31m[28C^[K[40C[m
    [90m305|     [m})[33m;[K[61C[m
    [90m306|   [m})[33m;[K[63C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[108/143]⎯[m
[77C
[41m[1m FAIL [m src/features/smsService.test.ts[2m > [22mSMSService[2m > [22mgetMessageStatus[2m > [22mshou
[13;77Huld retrieve message status successfully[38C
[31m[1mAssertionError[22m: expected undefined to deeply equal { …(7) }[K[18C[m
[77C
[32m- Expected:[66C[m
{[76C
  "cost": -0.0075,[59C
  "dateSent": "2024-12-19T12:00:00Z",[40C
  "errorCode": null,[57C
  "errorMessage": null,[54C
  "messageId": "SM1234567890abcdef",[41C
  "status": "delivered",[53C
  "to": "+22912345678",[54C
}[76C
[77C
[31m+ Received:[66C[m
undefined[68C
[77C
[36m [2m❯[22m src/features/smsService.test.ts:[2m330:27[m[K[36C
[77C    [90m328| [m
    [90m329|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mtrue[m)[33m;[K[28C[m
    [90m330|       [34mexpect[m(result[33m.[mdata)[33m.[34mtoEqual[m({[K[33C
       [90m|[27X[31m[27C^[K[41C[m
    [90m331|[9X[m[9CmessageId[33m: [32m'SM1234567890abcdef'[33m,[K[28C[m
    [90m332|[9X[m[9Cstatus[33m: [32m'delivered'[33m,[K[40C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[109/143]⎯[m
[77C
[41m[1m FAIL [m src/features/smsService.test.ts[2m > [22mSMSService[2m > [22mgetMessageStatus[2m > [22mshou
[13;77Huld handle failed message status[46C
[31m[1mAssertionError[22m: expected undefined to be 'failed' // Object.is equality      [m
[77C
[32m- Expected:[66C[m
"failed"[69C
[77C
[31m+ Received:[66C[m
undefined[68C
[77C
[36m [2m❯[22m src/features/smsService.test.ts:[2m367:35[m[K[36C
    [90m365|[K[69C[m
    [90m366|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mtrue[m)[33m;[K[28C[m
    [90m367|       [34mexpect[m(result[33m.[mdata[33m?.[mstatus)[33m.[34mtoBe[m([32m'failed'[m)[33m;[K[19C[m
       [90m|[35X[31m[35C^[K[33C[m
    [90m368|       [34mexpect[m(result[33m.[mdata[33m?.[merrorCode)[33m.[34mtoBe[m([34m30008[m)[33m;[K[19C[m
    [90m369|       [34mexpect[m(result[33m.[mdata[33m?.[merrorMessage)[33m.[34mtoBe[m([32m'Unknown error'[m)[33m;      [m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[110/143]⎯[m
[77C
[41m[1m FAIL [m src/features/smsService.test.ts[2m > [22mSMSService[2m > [22mgetAccountInfo[2m > [22mshould
[13;77Hd retrieve account information successfully[35C
[31m[1mAssertionError[22m: expected { sid: 'test-account-sid', …(5) } to deeply equal { [m
[31m[13;77H Object (accountSid, friendlyName, ...) }[37C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[2m  {[22m[K[74C
[32m-   "accountSid": "test-account-sid",[40C[m
[32m-   "dateCreated": "2024-01-01T00:00:00Z",[35C[m
[32m-   "dateUpdated": "2024-12-19T12:00:00Z",[35C[m
[32m-   "friendlyName": "PharmaRx SMS Account",[34C[m
[31m+   "date_created": "2024-01-01T00:00:00Z",[34C[m
[31m+   "date_updated": "2024-12-19T12:00:00Z",[34C[m
[31m+   "friendly_name": "PharmaRx SMS Account",[33C[m
[31m+   "sid": "test-account-sid",[47C[m
[2m    "status": "active",[22m[K[54C
[2m    "type": "Full",[22m[K[58C
[2m  }[22m[K[74C
[77C
[77C[36m [2m❯[22m src/features/smsService.test.ts:[2m410:27[m
    [90m408|[K[69C[m
    [90m409|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mtrue[m)[33m;[K[28C[m
    [90m410|       [34mexpect[m(result[33m.[mdata)[33m.[34mtoEqual[m({[K[33C
       [90m|[27X[31m[27C^[K[41C[m
    [90m411|[9X[m[9CaccountSid[33m: [32m'test-account-sid'[33m,[K[29C[m
    [90m412|[9X[m[9CfriendlyName[33m: [32m'PharmaRx SMS Account'[33m,[K[23C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[111/143]⎯[m
[77C
[41m[1m FAIL [m src/features/smsService.test.ts[2m > [22mSMSService[2m > [22mformatPaymentMessage[2m > [22m
[2m[13;77H [22mshould format payment message for SMS correctly[30C
[77C[31m[1mTypeError[22m: cost.toFixed is not a function[m
[36m [2m❯[22m SMSService.formatPaymentMessage src/features/smsService.ts:[2m321:82[m[K[9C
[77C    [90m319|   [mformatPaymentMessage(paymentUrl: string, medicationName: string, …
    [90m320|     [35mreturn [32m`PharmaRx Payment Request\n\n` [33m+[K[25C[m
    [90m321|[12X[m[12C`Someone needs help paying for medication: ${medicationN…
       [90m|                                                                     [14;147H[m
[31m[13C^[K[63C[m
    [90m322|[12X[32m[12C`Secure payment link: [36m${[mpaymentUrl[36m}[32m\n\n` [33m+[K[15C[m
    [90m323|[12X[32m[12C`Link expires in 48 hours. Thank you for helping!`[33m;      [m
[90m [2m❯[22m src/features/smsService.test.ts:[2m479:34[m[K[36C
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[112/143]⎯[m
[77C
[77C[41m[1m FAIL [m src/features/smsService.test.ts[2m > [22mSMSService[2m > [22mformatPaymentMessage[2m > [22m
[2m[13;77H [22mshould handle long medication names by truncating[28C
[31m[1mTypeError[22m: cost.toFixed is not a function[K[36C[m
[36m [2m❯[22m SMSService.formatPaymentMessage src/features/smsService.ts:[2m321:82[m[K[9C
    [90m319|   [mformatPaymentMessage(paymentUrl: string, medicationName: string, …
    [90m320|     [35mreturn [32m`PharmaRx Payment Request\n\n` [33m+[K[25C[m
    [90m321|[12X[m[12C`Someone needs help paying for medication: ${medicationN…
       [90m|                                                                     [14;147H[m
[31m[13C^[K[63C[m
    [90m322|[12X[32m[12C`Secure payment link: [36m${[mpaymentUrl[36m}[32m\n\n` [33m+[K[15C[m
    [90m323|[12X[32m[12C`Link expires in 48 hours. Thank you for helping!`[33m;      [m
[90m [2m❯[22m src/features/smsService.test.ts:[2m496:34[m[K[36C
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[113/143]⎯[m
[77C
[41m[1m FAIL [m src/features/smsService.test.ts[2m > [22mSMSService[2m > [22mformatPaymentMessage[2m > [22m
[2m[13;77H [22mshould format currency correctly for different amounts[23C
[31m[1mTypeError[22m: cost.toFixed is not a function[K[36C[m
[36m [2m❯[22m SMSService.formatPaymentMessage src/features/smsService.ts:[2m321:82[m[K[9C
[77C    [90m319|   [mformatPaymentMessage(paymentUrl: string, medicationName: string, …
    [90m320|     [35mreturn [32m`PharmaRx Payment Request\n\n` [33m+[K[25C[m
    [90m321|[12X[m[12C`Someone needs help paying for medication: ${medicationN…
       [90m|                                                                     [14;147H[m
[31m[13C^[K[63C[m
    [90m322|[12X[32m[12C`Secure payment link: [36m${[mpaymentUrl[36m}[32m\n\n` [33m+[K[15C[m
    [90m323|[12X[32m[12C`Link expires in 48 hours. Thank you for helping!`[33m;      [m
[90m [2m❯[22m src/features/smsService.test.ts:[2m515:36[m[K[36C
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[114/143]⎯[m
[77C
[41m[1m FAIL [m src/features/smsService.test.ts[2m > [22mSMSService[2m > [22mgetMessageInfo[2m > [22mshould
[13;77Hd calculate message segments correctly[40C
[31m[1mAssertionError[22m: expected 'GSM' to be 'GSM-7' // Object.is equality[K[11C[m
[77C
Expected: [32m"GSM[7m-7[27m"[K[60C[m
Received: [31m"GSM"[K[62C[m
[77C
[36m [2m❯[22m src/features/smsService.test.ts:[2m538:31[m[K[36C
    [90m536|[9X[m[9Cconst info = smsService.getMessageInfo(testCase.message, '+…
    [90m537|[9X[34m[9Cexpect[m(info[33m.[msegments)[33m.[34mtoBe[m(testCase[33m.[mexpected[33m.[msegments)[33m;     [m
    [90m538|[9X[34m[9Cexpect[m(info[33m.[mencoding)[33m.[34mtoBe[m(testCase[33m.[mexpected[33m.[mencoding)[33m;     [m
       [90m|[31X[31m[31C^[K[37C[m
    [90m539|       [m}[K[61C
    [90m540|     [m})[33m;[K[61C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[115/143]⎯[m
[77C
[41m[1m FAIL [m src/features/smsService.test.ts[2m > [22mSMSService[2m > [22mgetMessageInfo[2m > [22mshould
[13;77Hd detect Unicode encoding for special characters[30C
[31m[1mAssertionError[22m: expected 'UCS2' to be 'UCS-2' // Object.is equality[K[10C[m
[77C
Expected: [32m"UCS[7m-[27m2"[K[60C[m
Received: [31m"UCS2"[K[61C[m
[77C
[36m [2m❯[22m src/features/smsService.test.ts:[2m546:29[m[K[36C
    [90m544|       [mconst info = smsService.getMessageInfo(unicodeMessage, '+2291…
    [90m545|[K[69C[m
    [90m546|       [34mexpect[m(info[33m.[mencoding)[33m.[34mtoBe[m([32m'UCS-2'[m)[33m;[K[26C[m
       [90m|[29X[31m[29C^[K[39C[m
    [90m547|       [34mexpect[m(info[33m.[mlength)[33m.[34mtoBe[m(unicodeMessage[33m.[mlength)[33m;[K[14C[m
    [90m548|     [m})[33m;[K[61C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[116/143]⎯[m
[77C
[41m[1m FAIL [m src/features/smsService.test.ts[2m > [22mSMSService[2m > [22mgetMessageInfo[2m > [22mshould
[13;77Hd estimate costs based on segments and destination[28C
[31m[1mAssertionError[22m: expected undefined to be close to 0.135, received difference [m
[31m[13;77H is NaN, but expected 0.0005[50C[m
[36m [2m❯[22m src/features/smsService.test.ts:[2m562:36[m[K[36C
    [90m560|       [35mfor [m([35mconst [mtestCase [35mof [mtestCases) {[K[27C
    [90m561|[9X[m[9Cconst info = smsService.getMessageInfo(message, testCase.ph…
    [90m562|[9X[m[9Cexpect(info.estimatedCost).toBeCloseTo(testCase.expectedCos…
       [90m|[36X[31m[36C^[K[32C[m
    [90m563|       [m}[K[61C
    [90m564|     [m})[33m;[K[61C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[117/143]⎯[m
[77C
[41m[1m FAIL [m src/features/smsService.test.ts[2m > [22mSMSService[2m > [22mPhone Number Validation
[13;77Hn and Cleaning[2m > [22mshould reject invalid phone number formats[K[19C
[31m[1mTypeError[22m: smsService.validatePhoneNumber is not a function[K[18C[m
[36m [2m❯[22m src/features/smsService.test.ts:[2m596:57[m[K[36C
[77C    [90m594| [m
    [90m595|       [35mfor [m([35mconst [mnumber [35mof [minvalidNumbers) {[K[24C
    [90m596|[9X[35m[9Cconst [misValid [33m= [msmsService[[32m'validatePhoneNumber'[m](number)[33m;  [m
       [90m|[57X[31m[57C^[K[11C[m
    [90m597|[9X[34m[9Cexpect[m(isValid)[33m.[34mtoBe[m([35mfalse[m)[33m;[K[32C[m
    [90m598|       [m}[K[61C
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[118/143]⎯[m
[77C
[41m[1m FAIL [m src/features/smsService.test.ts[2m > [22mSMSService[2m > [22mError Message Parsing[2m >[22m
[2m[13;77H>
 [22mshould parse standard Twilio API errors[K[37C
[31m[1mTypeError[22m: smsService.parseErrorMessage is not a function[K[20C[m
[36m [2m❯[22m src/features/smsService.test.ts:[2m633:54[m[K[36C
    [90m631|[K[69C[m
    [90m632|       [35mfor [m([35mconst [mtestCase [35mof [merrors) {[K[30C
    [90m633|[9X[m[9Cconst parsed = smsService['parseErrorMessage'](testCase.res…
       [90m|[54X[31m[54C^[K[14C[m
    [90m634|[9X[34m[9Cexpect[m(parsed)[33m.[34mtoBe[m(testCase[33m.[mexpected)[33m;[K[21C[m
    [90m635|       [m}[K[61C
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[119/143]⎯[m
[77C
[41m[1m FAIL [m src/features/smsService.test.ts[2m > [22mSMSService[2m > [22mError Message Parsing[2m >[22m
[2m[13;77H>
 [22mshould handle malformed error responses[K[37C
[31m[1mTypeError[22m: smsService.parseErrorMessage is not a function[K[20C[m
[36m [2m❯[22m src/features/smsService.test.ts:[2m647:54[m[K[36C
[77C    [90m645| [m
    [90m646|       [35mfor [m([35mconst [mresponse [35mof [mmalformedResponses) {[K[18C
    [90m647|[9X[35m[9Cconst [mparsed [33m= [msmsService[[32m'parseErrorMessage'[m](response)[33m;   [m
       [90m|[54X[31m[54C^[K[14C[m
    [90m648|[9X[34m[9Cexpect[m(parsed)[33m.[34mtoBe[m([32m'Unknown SMS service error'[m)[33m;[K[11C[m
    [90m649|       [m}[K[61C
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[120/143]⎯[m
[77C
[41m[1m FAIL [m src/features/whatsappService.test.ts[2m > [22mWhatsAppService[2m > [22msendMessage[2m >[22m
[2m[13;77H>
 [22mshould send a WhatsApp message successfully[K[33C
[31m[1mAssertionError[22m: expected undefined to deeply equal { messageId: 'msg_123', …([m
[31m[13;77H(1) }[73C[m
[77C
[32m- Expected:[66C[m
{[76C
  "messageId": "msg_123",[52C
  "recipientId": "22912345678",[46C
}[76C
[77C
[31m+ Received:[66C[m
undefined[68C
[77C
[36m [2m❯[22m src/features/whatsappService.test.ts:[2m53:27[m[K[32C
[77C     [90m51| [m
     [90m52|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mtrue[m)[33m;[K[28C[m
     [90m53|       [34mexpect[m(result[33m.[mdata)[33m.[34mtoEqual[m({[K[33C
       [90m|[27X[31m[27C^[K[41C[m
     [90m54|[9X[m[9CmessageId[33m: [32m'msg_123'[33m,[K[39C[m
     [90m55|[9X[m[9CrecipientId[33m: [32m'22912345678'[K[34C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[121/143]⎯[m
[77C
[41m[1m FAIL [m src/features/whatsappService.test.ts[2m > [22mWhatsAppService[2m > [22msendMessage[2m >[22m
[2m[13;77H>
 [22mshould handle network errors[K[48C
[31m[1mAssertionError[22m: expected 'Network error while sending WhatsApp …' to be 'Fail[m
[31m[13;77Hled to send WhatsApp message: Netw…' // Object.is equality[20C[m
[77C
Expected: [32m"[7mFailed to[27m send WhatsApp message[7m: Network timeout[27m"[K[17C[m
Received: [31m"[7mNetwork error while[27m send[7ming[27m WhatsApp message"[K[21C[m
[77C
[36m [2m❯[22m src/features/whatsappService.test.ts:[2m105:28[m[K[31C
    [90m103|[K[69C[m
    [90m104|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mfalse[m)[33m;[K[27C[m
    [90m105|       [mexpect(result.error).toBe('Failed to send WhatsApp message: N…
       [90m|[28X[31m[28C^[K[40C[m
    [90m106|     [m})[33m;[K[61C[m
    [90m107|[K[69C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[122/143]⎯[m
[77C
[41m[1m FAIL [m src/features/whatsappService.test.ts[2m > [22mWhatsAppService[2m > [22msendMessage[2m >[22m
[2m[13;77H>
 [22mshould clean phone numbers correctly[K[40C
[31m[1mAssertionError[22m: expected '+22912345678' to be '22912345678' // Object.is equa[m
[31m[13;77Hality[73C[m
[77C
Expected: [32m"22912345678"[K[54C[m
Received: [31m"[7m+[27m22912345678"[K[53C[m
[77C
[36m [2m❯[22m src/features/whatsappService.test.ts:[2m133:32[m[K[31C
    [90m131|[9X[m[9Cconst lastCall = mockFetch.mock.calls[mockFetch.mock.calls.…
    [90m132|[9X[35m[9Cconst [mrequestBody [33m= JSON.[34mparse[m(lastCall[[34m1[m][33m.[mbody)[33m;[K[11C[m
    [90m133|[9X[34m[9Cexpect[m(requestBody[33m.[mto)[33m.[34mtoBe[m([32m'22912345678'[m)[33m;[K[17C[m
       [90m|[32X[31m[32C^[K[36C[m
    [90m134|       [m}[K[61C
    [90m135|     [m})[33m;[K[61C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[123/143]⎯[m
[77C
[41m[1m FAIL [m src/features/whatsappService.test.ts[2m > [22mWhatsAppService[2m > [22msendMessage[2m >[22m
[2m[13;77H>
 [22mshould validate phone numbers[K[47C
[31m[1mAssertionError[22m: expected true to be false // Object.is equality[K[14C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- false[70C[m
[31m+ true[71C[m
[77C
[36m [2m❯[22m src/features/whatsappService.test.ts:[2m148:32[m[K[31C
    [90m146|       [35mfor [m([35mconst [mphoneNumber [35mof [minvalidPhoneNumbers) {[K[14C
    [90m147|[9X[m[9Cconst result = await whatsappService.sendMessage(phoneNumbe…
    [90m148|[9X[34m[9Cexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mfalse[m)[33m;[K[25C[m
       [90m|[32X[31m[32C^[K[36C[m
    [90m149|[9X[34m[9Cexpect[m(result[33m.[merror)[33m.[34mtoContain[m([32m'Invalid phone number'[m)[33m;     [m
    [90m150|       [m}[K[61C
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[124/143]⎯[m
[77C
[41m[1m FAIL [m src/features/whatsappService.test.ts[2m > [22mWhatsAppService[2m > [22msendMessage[2m >[22m
[2m[13;77H>
 [22mshould handle empty message text[K[44C
[31m[1mAssertionError[22m: expected true to be false // Object.is equality[K[14C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- false[70C[m
[31m+ true[71C[m
[77C
[36m [2m❯[22m src/features/whatsappService.test.ts:[2m156:30[m[K[31C
    [90m154|       [mconst result = await whatsappService.sendMessage('+2291234567…
    [90m155|[K[69C[m
    [90m156|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mfalse[m)[33m;[K[27C[m
       [90m|[30X[31m[30C^[K[38C[m
    [90m157|       [34mexpect[m(result[33m.[merror)[33m.[34mtoBe[m([32m'Message text cannot be empty'[m)[33m;    [m
    [90m158|     [m})[33m;[K[61C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[125/143]⎯[m
[77C
[41m[1m FAIL [m src/features/whatsappService.test.ts[2m > [22mWhatsAppService[2m > [22msendTemplateM
[13;77HMessage[2m > [22mshould send a template message successfully[K[25C
[77C[31m[1mAssertionError[22m: expected false to be true // Object.is equality[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- true[71C[m
[31m+ false[70C[m
[77C
[36m [2m❯[22m src/features/whatsappService.test.ts:[2m202:30[m[K[31C
    [90m200|       [m)[33m;[K[60C[m
    [90m201|[K[69C[m
    [90m202|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mtrue[m)[33m;[K[28C[m
       [90m|[30X[31m[30C^[K[38C[m
    [90m203|       [34mexpect[m(result[33m.[mdata)[33m.[34mtoEqual[m({[K[33C
    [90m204|[9X[m[9CmessageId[33m: [32m'msg_template_123'[33m,[K[30C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[126/143]⎯[m
[77C
[41m[1m FAIL [m src/features/whatsappService.test.ts[2m > [22mWhatsAppService[2m > [22msendTemplateM
[13;77HMessage[2m > [22mshould handle template not found errors[K[29C
[31m[1mAssertionError[22m: expected 'Network error while sending WhatsApp …' to be 'Temp[m
[31m[13;77Hplate not found' // Object.is equality[40C[m
[77C
Expected: [32m"Template not found"[K[47C[m
Received: [31m"Network error while sending WhatsApp template message"[K[12C[m
[77C
[36m [2m❯[22m src/features/whatsappService.test.ts:[2m238:28[m[K[31C
    [90m236|[K[69C[m
    [90m237|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mfalse[m)[33m;[K[27C[m
    [90m238|       [34mexpect[m(result[33m.[merror)[33m.[34mtoBe[m([32m'Template not found'[m)[33m;[K[14C[m
       [90m|[28X[31m[28C^[K[40C[m
    [90m239|     [m})[33m;[K[61C[m
    [90m240|[K[69C[m
[77C
[77C[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[127/143]⎯[m
[77C
[41m[1m FAIL [m src/features/whatsappService.test.ts[2m > [22mWhatsAppService[2m > [22msendTemplateM
[13;77HMessage[2m > [22mshould validate template parameters[K[33C
[31m[1mAssertionError[22m: expected 'Network error while sending WhatsApp …' to be 'Temp[m
[31m[13;77Hplate name cannot be empty' // Object.is equality[29C[m
[77C
Expected: [32m"Template name cannot be empty"[K[36C[m
Received: [31m"Network error while sending WhatsApp template message"[K[12C[m
[77C
[36m [2m❯[22m src/features/whatsappService.test.ts:[2m250:28[m[K[31C
    [90m248|[K[69C[m
    [90m249|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mfalse[m)[33m;[K[27C[m
    [90m250|       [34mexpect[m(result[33m.[merror)[33m.[34mtoBe[m([32m'Template name cannot be empty'[m)[33m;   [m
       [90m|[28X[31m[28C^[K[40C[m
    [90m251|     [m})[33m;[K[61C[m
    [90m252|   [m})[33m;[K[63C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[128/143]⎯[m
[77C
[77C[41m[1m FAIL [m src/features/whatsappService.test.ts[2m > [22mWhatsAppService[2m > [22misConfigured[2m [22m
[2m[13;77H > [22mshould return false when business account ID is missing[K[20C
[31m[1mAssertionError[22m: expected true to be false // Object.is equality[K[14C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[32m- false[70C[m
[31m+ true[71C[m
[77C
[36m [2m❯[22m src/features/whatsappService.test.ts:[2m277:46[m[K[31C
[77C    [90m275|       [mwhatsappService [33m= [35mnew [33mWhatsAppService[m()[33m;[m
    [90m276|[K[69C[m
    [90m277|       [34mexpect[m(whatsappService[33m.[34misConfigured[m())[33m.[34mtoBe[m([35mfalse[m)[33m;[K[11C[m
       [90m|[46X[31m[46C^[K[22C[m
    [90m278|     [m})[33m;[K[61C[m
    [90m279|   [m})[33m;[K[63C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[129/143]⎯[m
[77C
[41m[1m FAIL [m src/features/whatsappService.test.ts[2m > [22mWhatsAppService[2m > [22mgetBusinessPr
[13;77Hrofile[2m > [22mshould retrieve business profile successfully[K[24C
[31m[1mAssertionError[22m: expected { data: [ { …(5) } ] } to deeply equal { id: 'test-b[m
[31m[13;77Hbusiness-id', …(4) }[58C[m
[77C
[32m- Expected[67C[m
[31m+ Received[67C[m
[77C
[2m  {[22m[K[74C
[31m+   "data": [[64C[m
[31m+     {[70C[m
[2m        "category": "HEALTH",[22m[K[48C
[2m        "description": "Online pharmacy service",[22m[K[28C
[2m        "id": "test-business-id",[22m[K[44C
[2m        "name": "PharmaRx",[22m[K[50C
[32m-   "profilePictureUrl": "https://example.com/profile.jpg",[18C[m
[31m+       "profile_picture_url": "https://example.com/profile.jpg",[12C[m
[31m+     },[69C[m
[31m+   ],[71C[m
[2m  }[22m[K[74C
[77C
[36m [2m❯[22m src/features/whatsappService.test.ts:[2m301:27[m[K[31C
    [90m299|[K[69C[m
    [90m300|       [34mexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mtrue[m)[33m;[K[28C[m
    [90m301|       [34mexpect[m(result[33m.[mdata)[33m.[34mtoEqual[m({[K[33C
       [90m|[27X[31m[27C^[K[41C[m
    [90m302|[9X[m[9Cid[33m: [32m'test-business-id'[33m,[K[37C[m
    [90m303|[9X[m[9Cname[33m: [32m'PharmaRx'[33m,[K[43C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[130/143]⎯[m
[77C
[41m[1m FAIL [m src/features/whatsappService.test.ts[2m > [22mWhatsAppService[2m > [22mformatPayment
[13;77HtMessage[2m > [22mshould format payment message correctly[K[28C
[77C[31m[1mTypeError[22m: cost.toFixed is not a function[m
[36m [2m❯[22m WhatsAppService.formatPaymentMessage src/features/whatsappService.ts:[2m293:3[m
[36m[2m[13;77H34[22m[K[76C[m
[77C    [90m291|[12X[m[12C`Someone has requested your help to pay for their medica…
    [90m292|[12X[32m[12C`💊 *Medication:* [36m${[mmedicationName[36m}[32m\n` [33m+[K[17C[m
    [90m293|[12X[32m[12C`💰 *Amount:* $[36m${[mcost[33m.[34mtoFixed[m([34m2[m)[36m}[32m\n\n` [33m+[K[17C[m
       [90m|[34X[31m[34C^[K[34C[m
    [90m294|[12X[m[12C`Please use this secure link to complete the payment:\n`…
    [90m295|[12X[32m[12C`🔗 [36m${[mpaymentUrl[36m}[32m\n\n` [33m+[K[33C[m
[90m [2m❯[22m src/features/whatsappService.test.ts:[2m344:39[m[K[31C
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[131/143]⎯[m
[77C
[41m[1m FAIL [m src/features/whatsappService.test.ts[2m > [22mWhatsAppService[2m > [22mformatPayment
[13;77HtMessage[2m > [22mshould handle long medication names[K[32C
[31m[1mTypeError[22m: cost.toFixed is not a function[K[36C[m
[36m [2m❯[22m WhatsAppService.formatPaymentMessage src/features/whatsappService.ts:[2m293:3[m
[36m[2m[13;77H34[22m[K[76C[m
    [90m291|[12X[m[12C`Someone has requested your help to pay for their medica…
    [90m292|[12X[32m[12C`💊 *Medication:* [36m${[mmedicationName[36m}[32m\n` [33m+[K[17C[m
    [90m293|[12X[32m[12C`💰 *Amount:* $[36m${[mcost[33m.[34mtoFixed[m([34m2[m)[36m}[32m\n\n` [33m+[K[17C[m
       [90m|[34X[31m[34C^[K[34C[m
    [90m294|[12X[m[12C`Please use this secure link to complete the payment:\n`…
    [90m295|[12X[32m[12C`🔗 [36m${[mpaymentUrl[36m}[32m\n\n` [33m+[K[33C[m
[90m [2m❯[22m src/features/whatsappService.test.ts:[2m361:39[m[K[31C
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[132/143]⎯[m
[77C
[41m[1m FAIL [m src/features/whatsappService.test.ts[2m > [22mWhatsAppService[2m > [22mformatPayment
[13;77HtMessage[2m > [22mshould format currency correctly[K[35C
[31m[1mTypeError[22m: cost.toFixed is not a function[K[36C[m
[77C[36m [2m❯[22m WhatsAppService.formatPaymentMessage src/features/whatsappService.ts:[2m293:3[m
[36m[2m[13;77H34[22m[K[76C[m
    [90m291|[12X[m[12C`Someone has requested your help to pay for their medica…
    [90m292|[12X[32m[12C`💊 *Medication:* [36m${[mmedicationName[36m}[32m\n` [33m+[K[17C[m
    [90m293|[12X[32m[12C`💰 *Amount:* $[36m${[mcost[33m.[34mtoFixed[m([34m2[m)[36m}[32m\n\n` [33m+[K[17C[m
       [90m|[34X[31m[34C^[K[34C[m
    [90m294|[12X[m[12C`Please use this secure link to complete the payment:\n`…
    [90m295|[12X[32m[12C`🔗 [36m${[mpaymentUrl[36m}[32m\n\n` [33m+[K[33C[m
[90m [2m❯[22m src/features/whatsappService.test.ts:[2m380:41[m[K[31C
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[133/143]⎯[m
[77C
[41m[1m FAIL [m src/features/whatsappService.test.ts[2m > [22mWhatsAppService[2m > [22mPhone Number 
[13;77H Validation and Cleaning[2m > [22mshould accept valid international phone numbers    
[31m[1mAssertionError[22m: expected '+22912345678' not to contain '+'[K[19C[m
[77C
Expected: [32m"+"[K[64C[m
Received: [31m"+[7m22912345678[27m"[K[53C[m
[77C
[36m [2m❯[22m src/features/whatsappService.test.ts:[2m405:29[m[K[31C
    [90m403|[9X[35m[9Cconst [mcleaned [33m= [mwhatsappService[[32m'cleanPhoneNumber'[m](number)[33m;[m
    [90m404|[9X[34m[9Cexpect[m(cleaned)[33m.[34mtoBeTruthy[m()[33m;[K[31C[m
    [90m405|[9X[34m[9Cexpect[m(cleaned)[33m.[mnot[33m.[34mtoContain[m([32m'+'[m)[33m;[K[25C[m
       [90m|[29X[31m[29C^[K[39C[m
    [90m406|[9X[34m[9Cexpect[m(cleaned)[33m.[mnot[33m.[34mtoContain[m([32m' '[m)[33m;[K[25C[m
    [90m407|[9X[34m[9Cexpect[m(cleaned)[33m.[mnot[33m.[34mtoContain[m([32m'-'[m)[33m;[K[25C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[134/143]⎯[m
[77C
[41m[1m FAIL [m src/features/whatsappService.test.ts[2m > [22mWhatsAppService[2m > [22mPhone Number 
[13;77H Validation and Cleaning[2m > [22mshould reject invalid phone number formats[K[9C
[77C[31m[1mTypeError[22m: whatsappService.validatePhoneNumber is not a function[m
[36m [2m❯[22m src/features/whatsappService.test.ts:[2m421:62[m[K[31C
    [90m419|[K[69C[m
    [90m420|       [35mfor [m([35mconst [mnumber [35mof [minvalidNumbers) {[K[24C
    [90m421|[9X[m[9Cconst isValid = whatsappService['validatePhoneNumber'](numb…
       [90m|[62X[31m[62C^      [m
    [90m422|[9X[34m[9Cexpect[m(isValid)[33m.[34mtoBe[m([35mfalse[m)[33m;[K[32C[m
    [90m423|       [m}[K[61C
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[135/143]⎯[m
[77C
[41m[1m FAIL [m src/features/whatsappService.test.ts[2m > [22mWhatsAppService[2m > [22mPhone Number 
[13;77H Validation and Cleaning[2m > [22mshould handle West African country codes correctly 
[31m[1mAssertionError[22m: expected '+22912345678' to be '22912345678' // Object.is equa[m
[31m[13;77Hality[73C[m
[77C
Expected: [32m"22912345678"[K[54C[m
Received: [31m"[7m+[27m22912345678"[K[53C[m
[77C
[36m [2m❯[22m src/features/whatsappService.test.ts:[2m439:25[m[K[31C
    [90m437|       [35mfor [m([35mconst [mtestCase [35mof [mcountryNumbers) {[K[22C
    [90m438|[9X[m[9Cconst cleaned = whatsappService['cleanPhoneNumber'](testCas…
    [90m439|[9X[34m[9Cexpect[m(cleaned)[33m.[34mtoBe[m(testCase[33m.[mexpected)[33m;[K[20C[m
       [90m|[25X[31m[25C^[K[43C[m
    [90m440|       [m}[K[61C
    [90m441|     [m})[33m;[K[61C[m
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[136/143]⎯[m
[77C
[41m[1m FAIL [m src/features/whatsappService.test.ts[2m > [22mWhatsAppService[2m > [22mError Message
[13;77He Parsing[2m > [22mshould parse standard WhatsApp API errors[K[25C
[31m[1mTypeError[22m: whatsappService.parseErrorMessage is not a function[K[15C[m
[36m [2m❯[22m src/features/whatsappService.test.ts:[2m462:59[m[K[31C
    [90m460|[K[69C[m
    [90m461|       [35mfor [m([35mconst [mtestCase [35mof [merrors) {[K[30C
    [90m462|[9X[m[9Cconst parsed = whatsappService['parseErrorMessage'](testCas…
       [90m|[59X[31m[59C^[K[9C[m
    [90m463|[9X[34m[9Cexpect[m(parsed)[33m.[34mtoBe[m(testCase[33m.[mexpected)[33m;[K[21C[m
    [90m464|       [m}[K[61C
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[137/143]⎯[m
[77C
[41m[1m FAIL [m src/features/whatsappService.test.ts[2m > [22mWhatsAppService[2m > [22mError Message
[13;77He Parsing[2m > [22mshould handle malformed error responses[K[27C
[77C[31m[1mTypeError[22m: whatsappService.parseErrorMessage is not a function[m
[36m [2m❯[22m src/features/whatsappService.test.ts:[2m477:59[m[K[31C
    [90m475|[K[69C[m
    [90m476|       [35mfor [m([35mconst [mresponse [35mof [mmalformedResponses) {[K[18C
    [90m477|[9X[m[9Cconst parsed = whatsappService['parseErrorMessage'](respons…
       [90m|[59X[31m[59C^[K[9C[m
    [90m478|[9X[34m[9Cexpect[m(parsed)[33m.[34mtoBe[m([32m'Unknown WhatsApp API error'[m)[33m;[K[10C[m
    [90m479|       [m}[K[61C
[77C
[31m[2m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[138/143]⎯[m
[77C
[31m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[39m[41m[1m Unhandled Errors [31m[49m[22m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[m
[77C
[31m[1mVitest caught 1 unhandled error during the test run.[22m[K[25C[m
[31m[1mThis might cause false positive tests. Resolve unhandled errors to make sure [m
[31m[1m[13;77H your tests are not affected.[22m[K[49C[m
[77C
[31m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[39m[41m[1m Unhandled Rejection [31m[49m[22m⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[m
[31m[1mAssertionError[22m: expected 'WhatsApp API not configured' to contain 'WhatsApp s[m
[31m[13;77Hservice not configured'[55C[m
[77C
Expected: [32m"WhatsApp [7mservice[27m not configured"[K[34C[m
Received: [31m"WhatsApp [7mAPI[27m not configured"[K[38C[m
[77C
[36m [2m❯[22m src/features/whatsappService.test.ts:[2m502:30[m[K[31C
    [90m500|[9X[m[9Cconst result = await service.sendMessage('+22912345678', 'T…
    [90m501|[9X[34m[9Cexpect[m(result[33m.[msuccess)[33m.[34mtoBe[m([35mfalse[m)[33m;[K[25C[m
    [90m502|[9X[m[9Cexpect(result.error).toContain('WhatsApp service not config…
       [90m|[30X[31m[30C^[K[38C[m
    [90m503|       [m})[33m.[mnot[33m.[34mtoThrow[m()[33m;[K[45C[m
    [90m504|     [m})[33m;[K[61C[m
[90m [2m❯[22m processTicksAndRejections node:internal/process/task_queues:[2m105:5[m[K[9C
[77C
[31mThis error originated in "[1msrc/features/whatsappService.test.ts[22m" test file. It[m
[31m[13;77Ht doesn't mean the error was thrown inside the file itself, but while it was r[m
[31m[13;77Hrunning.[70C